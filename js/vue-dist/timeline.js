import{d as nt,r as D,c as pe,b as Qe,k as et,n as Ve,w as We,a as at,f as R,h as z,j as d,C as Re,D as Ze,l as J,u as v,z as we,E as ot,t as U,_ as st,G as rt,y as it,p as lt,H as ct,q as ae,F as le,I as Je,s as Te,i as ke,A as ut,B as dt}from"./assets/_plugin-vue_export-helper.js";function qe(I){const M=Math.max(1,I.fps||1);return I.duration||I.total_frames/M}const tt=nt("timeline",()=>{const I=D({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0}),M=D([]),e=D(-1),S=D(0),B=D(0),F=D(!1),A=D({enabled:!1,drawing:!1,erase:!1,brush:20}),oe=D({enabled:!1,data:null}),ce=D({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),G=pe(()=>e.value>=0&&e.value<M.value.length?M.value[e.value]:null),ee=pe(()=>M.value.filter(f=>f.type==="foreground")),W=pe(()=>M.value.find(f=>f.type==="background"));function H(f){const P=Math.max(1,f.fps??I.value.fps),E=typeof f.duration=="number",w=typeof f.total_frames=="number",k={...I.value,...f,fps:P};E&&!w?k.total_frames=Math.max(1,Math.round((k.duration||0)*P)):w&&!E?(k.total_frames=Math.max(1,Math.round(k.total_frames)),k.duration=k.total_frames/P):(k.total_frames=Math.max(1,Math.round(k.total_frames||k.duration*P)),k.duration=k.duration||k.total_frames/P),Object.assign(I.value,k)}function O(f){M.value.push(f),e.value=M.value.length-1}function se(f){f>=0&&f<M.value.length&&(M.value.splice(f,1),e.value>=M.value.length&&(e.value=M.value.length-1))}function te(){M.value=[],e.value=-1}function Y(f){f>=0&&f<M.value.length&&(e.value=f)}function ue(f,P){f>=0&&f<M.value.length&&Object.assign(M.value[f],P)}function re(f){const P=qe(I.value);S.value=Math.max(0,Math.min(f,P)),B.value=Math.floor(S.value*I.value.fps)}function fe(f){const P=Math.max(1,Math.round(I.value.total_frames||qe(I.value)*I.value.fps));B.value=Math.max(0,Math.min(f,P-1)),S.value=B.value/I.value.fps}let C=null,Z=0;function N(){F.value=!F.value,F.value?$():X()}function $(){C===null&&(Z=performance.now(),Q())}function Q(){if(!F.value)return;const f=performance.now(),P=(f-Z)/1e3;Z=f;let E=S.value+P;const w=qe(I.value);E>=w&&(E=0),re(E),C=requestAnimationFrame(Q)}function X(){C!==null&&(cancelAnimationFrame(C),C=null)}function ie(){F.value=!1,X(),re(0)}function he(f){if(!f)return;const P=f.project||{},E=P.fps||I.value.fps||30,w=P.duration??(P.total_frames?P.total_frames/Math.max(1,E):I.value.duration),k=P.total_frames??Math.max(1,Math.round((w||I.value.duration)*E));H({width:P.width||1280,height:P.height||720,fps:E,duration:w,total_frames:k,mask_expansion:P.mask_expansion||0,mask_feather:P.mask_feather||0}),M.value=(f.layers||[]).map(x=>({id:x.id,name:x.name,type:x.type,image_data:x.image_data,x:x.x||0,y:x.y||0,scale:x.scale||1,rotation:x.rotation||0,opacity:x.opacity!==void 0?x.opacity:1,rotationX:x.rotationX||0,rotationY:x.rotationY||0,rotationZ:x.rotationZ||0,anchorX:x.anchorX||0,anchorY:x.anchorY||0,perspective:x.perspective||1e3,mask_size:x.mask_size||0,customMask:x.customMask,bezierPath:x.bezierPath,usePathAnimation:x.usePathAnimation||!1,keyframes:x.keyframes||{},bg_mode:x.bg_mode||"fit"}))}function xe(){const f=G.value;if(!f)return;const P=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];f.keyframes||(f.keyframes={});for(const E of P){let w=f[E];w===void 0&&(E==="scale"||E==="opacity"?w=1:E==="perspective"?w=1e3:w=0),f.keyframes[E]||(f.keyframes[E]=[]),f.keyframes[E]=f.keyframes[E].filter(k=>k.time!==S.value),f.keyframes[E].push({time:S.value,value:w}),f.keyframes[E].sort((k,x)=>k.time-x.time)}}function Me(){const f=G.value;if(!f||!f.keyframes)return;const P=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];for(const E of P)f.keyframes[E]&&(f.keyframes[E]=f.keyframes[E].filter(w=>w.time!==S.value))}function _e(){const f=G.value;f&&(f.keyframes={})}function Ce(){return{project:{...I.value},layers:M.value.map(f=>({id:f.id,name:f.name,type:f.type,image_data:f.image_data,x:f.x,y:f.y,scale:f.scale,rotation:f.rotation,opacity:f.opacity,rotationX:f.rotationX,rotationY:f.rotationY,rotationZ:f.rotationZ,anchorX:f.anchorX,anchorY:f.anchorY,perspective:f.perspective,mask_size:f.mask_size,customMask:f.customMask,bezierPath:f.bezierPath,usePathAnimation:f.usePathAnimation,keyframes:f.keyframes,bg_mode:f.bg_mode}))}}return{project:I,layers:M,currentLayerIndex:e,currentTime:S,currentFrame:B,isPlaying:F,maskMode:A,pathMode:oe,extractMode:ce,currentLayer:G,foregroundLayers:ee,backgroundLayer:W,setProject:H,addLayer:O,removeLayer:se,clearLayers:te,selectLayer:Y,updateLayer:ue,setCurrentTime:re,setCurrentFrame:fe,togglePlayback:N,stopPlayback:ie,addKeyframe:xe,deleteKeyframe:Me,clearAllKeyframes:_e,loadAnimation:he,exportAnimation:Ce}}),ft={class:"canvas-wrapper"},mt=["width","height"],pt=["width","height"],ht={class:"canvas-info"},yt={key:0},gt={key:0,class:"gpu-badge"},vt={key:1},bt=Qe({__name:"CanvasPreview",setup(I,{expose:M}){const e=tt(),S=D(),B=D(),F=D();let A=!1,oe=0,ce=0,G=0,ee=0;const W=D(!1);let H=!1,O=null;const se=new Map,te=new Map;let Y=null;et(async()=>{S.value&&(O=S.value.getContext("2d",{alpha:!1,desynchronized:!0})),await re(),await Ve(),setTimeout(()=>{ue()},0),F.value&&typeof ResizeObserver<"u"&&(Y=new ResizeObserver(()=>{requestAnimationFrame(()=>{ue()})}),Y.observe(F.value)),We(()=>[e.project.width,e.project.height],()=>{Ve(()=>{ue()})}),C()}),at(()=>{Y&&(Y.disconnect(),Y=null),se.clear(),fe()});function ue(){if(!F.value)return;const t=F.value,s=t.clientWidth,r=t.clientHeight,i=s||t.offsetWidth||0,u=r||t.offsetHeight||0;if(i===0||u===0){setTimeout(()=>{ue()},100);return}const c=e.project.width||1280,h=e.project.height||720,b=c/h,y=10,a=i-y*2,n=u-y*2;let o=a,l=a/b;l>n&&(l=n,o=n*b),o<100&&(o=100),l<100&&(l=100);const m=S.value,p=B.value;m&&(m.style.width=o+"px",m.style.height=l+"px",m.style.maxWidth="100%",m.style.maxHeight="100%"),p&&(p.style.width=o+"px",p.style.height=l+"px",p.style.maxWidth="100%",p.style.maxHeight="100%")}async function re(){console.log("[Timeline GPU] GPU rendering disabled, using Canvas 2D for stability"),W.value=!1}function fe(){for(const t of te.values())t.destroy();te.clear()}function C(){H||(H=!0,requestAnimationFrame(()=>{H=!1,ie()}))}We(()=>[e.layers,e.currentLayer,e.currentTime],()=>{C()},{deep:!0}),We(()=>e.extractMode.enabled,()=>{me=!1,C()});function Z(){{he();return}}function N(t){if(t.img)return t.img;if(!t.image_data)return null;const s=t.id;if(se.has(s)){const i=se.get(s);return i.complete?(t.img=i,i):null}const r=new Image;return r.onload=()=>{t.img=r,C()},r.src=t.image_data,se.set(s,r),null}function $(t,s,r){if(!t||t.length===0)return r;const i=[...t].sort((u,c)=>u.time-c.time);if(s<=i[0].time)return i[0].value;if(s>=i[i.length-1].time)return i[i.length-1].value;for(let u=0;u<i.length-1;u++)if(s>=i[u].time&&s<=i[u+1].time){const c=(s-i[u].time)/(i[u+1].time-i[u].time);return i[u].value+(i[u+1].value-i[u].value)*c}return r}function Q(t,s,r){if(!t||t.length<2)return null;const i=s/r,c=t.length-1,h=Math.min(Math.floor(i*c),c-1),b=i*c-h,y=t[h],a=t[h+1];if(!y||!a)return null;const n=y.cp2x??y.x+(a.x-y.x)/3,o=y.cp2y??y.y+(a.y-y.y)/3,l=a.cp1x??y.x+(a.x-y.x)*2/3,m=a.cp1y??y.y+(a.y-y.y)*2/3,p=1-b,g=p*p,L=g*p,_=b*b,T=_*b;return{x:L*y.x+3*g*b*n+3*p*_*l+T*a.x,y:L*y.y+3*g*b*o+3*p*_*m+T*a.y}}function X(t){const s=e.currentTime,r=t.keyframes||{};let i=$(r.x,s,t.x||0),u=$(r.y,s,t.y||0);if(t.usePathAnimation&&t.bezierPath&&t.bezierPath.length>=2){const c=Q(t.bezierPath,s,e.project.duration);c&&(i=c.x,u=c.y)}return{x:i,y:u,scale:$(r.scale,s,t.scale||1),rotation:$(r.rotation,s,t.rotation||0),opacity:$(r.opacity,s,t.opacity??1),mask_size:$(r.mask_size,s,t.mask_size||0),rotationX:$(r.rotationX,s,t.rotationX||0),rotationY:$(r.rotationY,s,t.rotationY||0),rotationZ:$(r.rotationZ,s,t.rotationZ||0),anchorX:$(r.anchorX,s,t.anchorX||0),anchorY:$(r.anchorY,s,t.anchorY||0),perspective:$(r.perspective,s,t.perspective||1e3)}}function ie(){if(W.value){Z();return}he()}function he(){var s;if(!S.value||!O)return;O.fillStyle="#000",O.fillRect(0,0,e.project.width,e.project.height);const t=e.layers.find(r=>r.type==="background");t&&_e(O,t),e.layers.filter(r=>r.type!=="background").forEach(r=>{Ce(O,r)}),e.pathMode.enabled&&((s=e.currentLayer)!=null&&s.bezierPath)&&xe(O,e.currentLayer.bezierPath),e.extractMode.enabled&&Ee(O)}function xe(t,s){if(!s||s.length===0)return;const r=e.project.width/2,i=e.project.height/2;t.save(),t.strokeStyle="#ff6b6b",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath(),t.moveTo(r+s[0].x,i+s[0].y);for(let u=1;u<s.length;u++){const c=s[u-1],h=s[u],b=c.cp2x??c.x+(h.x-c.x)/3,y=c.cp2y??c.y+(h.y-c.y)/3,a=h.cp1x??c.x+(h.x-c.x)*2/3,n=h.cp1y??c.y+(h.y-c.y)*2/3;t.bezierCurveTo(r+b,i+y,r+a,i+n,r+h.x,i+h.y)}if(t.stroke(),t.setLineDash([]),s.forEach((u,c)=>{t.beginPath(),t.arc(r+u.x,i+u.y,6,0,Math.PI*2),t.fillStyle=c===0?"#4ecdc4":c===s.length-1?"#ff6b6b":"#ffe66d",t.fill(),t.strokeStyle="#fff",t.lineWidth=2,t.stroke()}),s.length>=2){const u=s.length-1,c=s[u-1],h=s[u],b=c.cp2x??c.x+(h.x-c.x)/3,y=c.cp2y??c.y+(h.y-c.y)/3,a=h.cp1x??c.x+(h.x-c.x)*2/3,n=h.cp1y??c.y+(h.y-c.y)*2/3,o=.99,l=1-o,m=3*l*l*(b-c.x)+6*l*o*(a-b)+3*o*o*(h.x-a),p=3*l*l*(y-c.y)+6*l*o*(n-y)+3*o*o*(h.y-n),g=Math.atan2(p,m),L=r+h.x,_=i+h.y,T=18;t.beginPath(),t.moveTo(L,_),t.lineTo(L-T*Math.cos(g-Math.PI/6),_-T*Math.sin(g-Math.PI/6)),t.moveTo(L,_),t.lineTo(L-T*Math.cos(g+Math.PI/6),_-T*Math.sin(g+Math.PI/6)),t.strokeStyle="#ff6b6b",t.lineWidth=2,t.stroke()}t.restore()}function Me(t,s,r){if(t.maskCanvas||!t.customMask)return;const i=new Image;i.onload=()=>{const u=document.createElement("canvas");u.width=i.width||s,u.height=i.height||r;const c=u.getContext("2d");c&&(c.drawImage(i,0,0,u.width,u.height),t.maskCanvas=u,C())},i.src=t.customMask}function _e(t,s){const r=N(s);if(!r||r.width===0||r.height===0)return;const i=X(s);t.save(),t.globalAlpha=i.opacity;const u=s.bg_mode||"fit",c=e.project.width,h=e.project.height,b=r.width,y=r.height;let a=1;b>0&&y>0&&(u==="fit"?a=Math.min(c/b,h/y):u==="fill"?a=Math.max(c/b,h/y):u==="stretch"&&(a=Math.min(c/b,h/y))),(!Number.isFinite(a)||a<=0)&&(a=1),t.translate(c/2+i.x,h/2+i.y),t.rotate(i.rotation*Math.PI/180),t.scale(i.scale*a,i.scale*a),t.drawImage(r,-b/2,-y/2,b,y),s===e.currentLayer&&(t.strokeStyle="#3a7bc8",t.lineWidth=2/(i.scale*a),t.strokeRect(-b/2-2,-y/2-2,b+4,y+4)),t.restore()}function Ce(t,s){const r=N(s);if(!r||r.width===0||r.height===0)return;const i=X(s),u=r.width,c=r.height;if(Me(s,u,c),t.save(),t.translate(e.project.width/2+i.x,e.project.height/2+i.y),i.rotationX!==0||i.rotationY!==0){const y=i.perspective||1e3,a=i.rotationX*Math.PI/180,n=i.rotationY*Math.PI/180,o=Math.cos(a),l=Math.sin(a),m=Math.cos(n),p=Math.sin(n),g=1/(1+(p*u/2+l*c/2)/y);t.transform(m*g,l*p*g,0,o*g,0,0)}t.rotate(i.rotation*Math.PI/180),t.scale(i.scale,i.scale),t.globalAlpha=i.opacity;const h=(i.anchorX||0)*u,b=(i.anchorY||0)*c;if(s.maskCanvas){const y=document.createElement("canvas");y.width=u,y.height=c;const a=y.getContext("2d");a?(a.clearRect(0,0,u,c),a.drawImage(r,0,0,u,c),a.globalCompositeOperation="destination-in",a.drawImage(s.maskCanvas,0,0,u,c),t.drawImage(y,-u/2-h,-c/2-b,u,c)):t.drawImage(r,-u/2-h,-c/2-b,u,c)}else t.drawImage(r,-u/2-h,-c/2-b,u,c);if(s===e.currentLayer&&s.img){t.strokeStyle="#3a7bc8",t.lineWidth=2/i.scale;const y=s.img.width,a=s.img.height;t.strokeRect(-y/2-2,-a/2-2,y+4,a+4),t.fillStyle="#3a7bc8",[[-y/2,-a/2],[y/2,-a/2],[y/2,a/2],[-y/2,a/2]].forEach(([o,l])=>{t.fillRect(o-4/i.scale,l-4/i.scale,8/i.scale,8/i.scale)})}if(i.mask_size>0){t.strokeStyle="#3ac88e",t.lineWidth=2/i.scale,t.setLineDash([5/i.scale,5/i.scale]);const y=s.img?s.img.width:512,a=s.img?s.img.height:512,n=y*i.mask_size,o=a*i.mask_size;t.strokeRect(-n/2,-o/2,n,o),t.setLineDash([])}t.restore()}function f(){return W.value?B.value||null:S.value||null}function P(t){const s=f();if(!s)return{x:0,y:0};const r=s.getBoundingClientRect(),i=e.project.width/r.width,u=e.project.height/r.height;return{x:(t.clientX-r.left)*i,y:(t.clientY-r.top)*u}}let E=!1,w=null,k=null,x=null,me=!1,ye=null,Le=!1,de=-1;function ze(t){var i;if((i=f())==null||i.focus(),t.shiftKey,t.altKey,!e.currentLayer)return;const s=P(t);if(e.extractMode.enabled){if(!Pe()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}me=!0,Ye(s.x,s.y,t.button===2||t.altKey);return}if(e.maskMode.enabled){E=!0,ge(),Xe(s.x,s.y);return}if(e.pathMode.enabled){Ne(s);return}A=!0,oe=s.x,ce=s.y;const r=X(e.currentLayer);G=r.x,ee=r.y}function Ae(t){const s=P(t);if(e.extractMode.enabled&&me){Ye(s.x,s.y,(t.buttons&2)===2||t.altKey);return}if(E&&e.maskMode.enabled){Xe(s.x,s.y);return}if(Le&&de>=0){He(s);return}if(!A||!e.currentLayer)return;let r=s.x-oe,i=s.y-ce;t.shiftKey&&(Math.abs(r)>Math.abs(i)?i=0:r=0);const u=G+r,c=ee+i;K(e.currentLayer,"x",u),K(e.currentLayer,"y",c),C()}function K(t,s,r){const i=e.currentTime;if(t.keyframes&&t.keyframes[s]&&t.keyframes[s].length>0){const u=t.keyframes[s].findIndex(c=>Math.abs(c.time-i)<.05);u>=0?t.keyframes[s][u]={time:t.keyframes[s][u].time,value:r}:(t.keyframes[s].push({time:i,value:r}),t.keyframes[s].sort((c,h)=>c.time-h.time))}e.updateLayer(e.currentLayerIndex,{[s]:r})}function ge(){const t=e.currentLayer;if(!(!t||!t.img)){if(t.maskCanvas)w=t.maskCanvas.getContext("2d");else if(t.maskCanvas=document.createElement("canvas"),t.maskCanvas.width=t.img.width,t.maskCanvas.height=t.img.height,w=t.maskCanvas.getContext("2d"),w)if(t.customMask){const s=new Image;s.onload=()=>{w==null||w.drawImage(s,0,0),C()},s.src=t.customMask}else w.globalCompositeOperation="source-over",w.fillStyle="white",w.fillRect(0,0,t.maskCanvas.width,t.maskCanvas.height)}}function Xe(t,s){const r=e.currentLayer;if(!r||((!w||!r.maskCanvas)&&ge(),!r.img||!w||!r.maskCanvas))return;const i=X(r),u=e.project.width/2+i.x,c=e.project.height/2+i.y,h=(t-u)/i.scale+r.img.width/2,b=(s-c)/i.scale+r.img.height/2,y=e.maskMode.brush||20;w.save(),w.beginPath(),w.arc(h,b,y,0,Math.PI*2),e.maskMode.erase?(w.globalCompositeOperation="source-over",w.fillStyle="white"):(w.globalCompositeOperation="destination-out",w.fillStyle="black"),w.fill(),w.restore(),C()}function Pe(){const t=e.layers.find(r=>r.type==="background");if(!t)return null;const s=N(t);return s?((!k||!x||k.width!==s.width||k.height!==s.height||ye!==t.id)&&(k=document.createElement("canvas"),k.width=s.width,k.height=s.height,x=k.getContext("2d"),x&&x.clearRect(0,0,s.width,s.height),ye=t.id||null),{layer:t,img:s,ctx:x}):null}function Ye(t,s,r=!1){const i=Pe();if(!i)return;const{layer:u,img:c,ctx:h}=i,b=X(u),y=e.project.width/2+(b.x??0),a=e.project.height/2+(b.y??0),n=b.scale??1,o=(t-y)/n+c.width/2,l=(s-a)/n+c.height/2,m=Math.max(1,e.extractMode.brush||30);h.beginPath(),h.arc(o,l,m,0,Math.PI*2),h.fillStyle=r?"black":"white",h.fill(),C()}function Ee(t){if(!e.extractMode.enabled||!k||!ye)return;const s=e.layers.find(h=>h.id===ye);if(!s)return;const r=N(s);if(!r)return;const i=X(s);t.save(),t.translate(e.project.width/2+(i.x??0),e.project.height/2+(i.y??0)),t.rotate((i.rotation??0)*Math.PI/180),t.scale(i.scale??1,i.scale??1);const u=-r.width/2,c=-r.height/2;t.fillStyle="rgba(0, 0, 0, 0.65)",t.fillRect(u,c,r.width,r.height),t.globalCompositeOperation="destination-out",t.drawImage(k,u,c,r.width,r.height),t.restore()}function $e(){x&&k&&(x.clearRect(0,0,k.width,k.height),C())}function Ke(){if(!x||!k)return!1;const t=x.getImageData(0,0,k.width,k.height).data;for(let s=0;s<t.length;s+=4)if(t[s]>10)return!0;return!1}function Oe(t,s,r){const i=t.canvas,u=document.createElement("canvas");u.width=s,u.height=r;const c=u.getContext("2d");if(!c)return null;c.drawImage(i,0,0);const h=20;c.globalCompositeOperation="destination-over";for(let b=0;b<h;b++)c.drawImage(u,1,0),c.drawImage(u,-1,0),c.drawImage(u,0,1),c.drawImage(u,0,-1),b%2===0&&(c.drawImage(u,1,1),c.drawImage(u,-1,-1),c.drawImage(u,1,-1),c.drawImage(u,-1,1));for(let b=0;b<10;b++)c.drawImage(u,2,0),c.drawImage(u,-2,0),c.drawImage(u,0,2),c.drawImage(u,0,-2),c.drawImage(u,2,2),c.drawImage(u,-2,-2),c.drawImage(u,2,-2),c.drawImage(u,-2,2);return u.toDataURL("image/png")}function Be(){const t=Pe();if(!t||!k||!x)return{error:"èƒŒæ™¯å›¾å±‚å°šæœªå‡†å¤‡å¥½"};if(!Ke())return null;const{img:s}=t,r=document.createElement("canvas");r.width=s.width,r.height=s.height;const i=r.getContext("2d");if(!i)return{error:"æ— æ³•åˆ›å»ºä¸´æ—¶ç”»å¸ƒ"};i.drawImage(s,0,0),i.globalCompositeOperation="destination-in",i.drawImage(k,0,0);const u=r.toDataURL("image/png"),c=document.createElement("canvas");c.width=s.width,c.height=s.height;const h=c.getContext("2d");if(!h)return{error:"æ— æ³•åˆ›å»ºèƒŒæ™¯ç”»å¸ƒ"};h.drawImage(s,0,0),h.globalCompositeOperation="destination-out",h.drawImage(k,0,0),h.globalCompositeOperation="source-over";const b=Oe(h,s.width,s.height)||s.src,y=k.toDataURL("image/png");return{foregroundDataUrl:u,backgroundDataUrl:b,extractMaskDataUrl:y}}function Ne(t,s){const r=e.currentLayer;if(!r)return;r.bezierPath||(r.bezierPath=[]);const i=Ge(t);if(i>=0)de=i,Le=!0;else{const u=e.project.width/2,c=e.project.height/2;r.bezierPath.push({x:t.x-u,y:t.y-c}),r.bezierPath.length>=2&&(r.usePathAnimation=!0),C()}}function Ge(t){const s=e.currentLayer;if(!s||!s.bezierPath)return-1;const r=e.project.width/2,i=e.project.height/2,u=10;for(let c=0;c<s.bezierPath.length;c++){const h=s.bezierPath[c],b=h.x+r-t.x,y=h.y+i-t.y;if(Math.sqrt(b*b+y*y)<u)return c}return-1}function He(t){const s=e.currentLayer;if(!s||!s.bezierPath||de<0)return;const r=e.project.width/2,i=e.project.height/2;s.bezierPath[de].x=t.x-r,s.bezierPath[de].y=t.y-i,C()}function ve(){A=!1,E=!1,me=!1,Le=!1,de=-1}function Fe(t){if(!e.currentLayer)return;const s=t.deltaY>0?-.05:.05,r=e.currentLayer;if(t.shiftKey){const u=X(r).rotation+(s>0?5:-5);K(r,"rotation",u)}else if(t.altKey){const i=X(r),u=Math.max(0,Math.min(1,i.opacity+s));K(r,"opacity",u)}else{const i=X(r),u=Math.max(.1,Math.min(5,i.scale+s));K(r,"scale",u)}C()}function Ue(t){if(!e.currentLayer)return;const s=t.shiftKey?10:1,r=e.currentLayer,i=X(r);switch(t.key){case"ArrowLeft":K(r,"x",i.x-s),C(),t.preventDefault();break;case"ArrowRight":K(r,"x",i.x+s),C(),t.preventDefault();break;case"ArrowUp":K(r,"y",i.y-s),C(),t.preventDefault();break;case"ArrowDown":K(r,"y",i.y+s),C(),t.preventDefault();break;case"r":case"R":K(r,"x",0),K(r,"y",0),K(r,"scale",1),K(r,"rotation",0),K(r,"opacity",1),C(),t.preventDefault();break;case"Delete":case"Backspace":confirm("åˆ é™¤å½“å‰å›¾å±‚?")&&e.removeLayer(e.currentLayerIndex),t.preventDefault();break}}return M({clearExtractSelection:$e,applyExtractSelection:Be}),(t,s)=>(z(),R("div",{class:"canvas-preview",ref_key:"containerRef",ref:F},[d("div",ft,[Re(d("canvas",{ref_key:"gpuCanvasRef",ref:B,width:v(e).project.width,height:v(e).project.height,onMousedown:ze,onMousemove:Ae,onMouseup:ve,onMouseleave:ve,onWheel:J(Fe,["prevent"]),onContextmenu:s[0]||(s[0]=J(()=>{},["prevent"])),tabindex:"0",onKeydown:Ue},null,40,mt),[[Ze,W.value]]),Re(d("canvas",{ref_key:"canvasRef",ref:S,width:v(e).project.width,height:v(e).project.height,onMousedown:ze,onMousemove:Ae,onMouseup:ve,onMouseleave:ve,onWheel:J(Fe,["prevent"]),onContextmenu:s[1]||(s[1]=J(()=>{},["prevent"])),tabindex:"0",onKeydown:Ue},null,40,pt),[[Ze,!W.value]]),d("div",ht,[v(e).currentLayer?(z(),R("span",yt,[W.value?(z(),R("span",gt,"GPU")):we("",!0),ot(" Layer "+U(v(e).currentLayerIndex+1)+" | X:"+U(Math.round(v(e).currentLayer.x||0))+" Y:"+U(Math.round(v(e).currentLayer.y||0))+" S:"+U((v(e).currentLayer.scale||1).toFixed(2))+" R:"+U(Math.round(v(e).currentLayer.rotation||0))+"Â° ",1)])):(z(),R("span",vt,"No layer selected"))])])],512))}}),kt=st(bt,[["__scopeId","data-v-e93eff11"]]),wt={class:"root"},xt={class:"canvas-area"},Mt={class:"toolbar-area"},_t={class:"toolbar-left"},Ct={class:"toolbar-center"},Lt={key:1,class:"extract-actions"},Pt={class:"tb-time"},Et={class:"params-area"},jt={class:"param-label"},St={class:"param-group"},It=["value"],Tt={class:"param-group"},Dt=["value"],Rt={class:"param-group"},zt=["value"],At={class:"param-group"},Xt=["value"],Yt={class:"param-group"},Ft=["value"],Ut={class:"param-value"},Wt={class:"param-group"},$t={class:"param-value"},Kt={class:"param-group"},Ot={class:"param-value"},Bt={key:1,class:"param-empty"},Nt={class:"bottom-area"},Gt={class:"layers-sidebar"},Ht={class:"layers-header"},qt={class:"layer-actions"},Vt=["disabled"],Zt=["disabled"],Jt=["onClick"],Qt=["checked","onChange","aria-label"],en=["onClick"],tn=["title"],nn=["onClick"],an={class:"tick-label"},on=["onClick"],sn=["onClick"],rn=["onClick"],ln=["onDblclick"],cn=["title","onMousedown","onClick","onContextmenu"],De=60,un=Qe({__name:"TimelineApp",props:{node:{}},setup(I){const M=I,e=tt(),S=D(null),B=D(),F=D(),A=D(),oe=D(0);let ce="foreground",G=!1,ee=null;const W=a=>{var n,o;return(o=(n=M.node)==null?void 0:n.widgets)==null?void 0:o.find(l=>l.name===a)};function H(a,n){const o=typeof a=="number"?a:parseFloat(a);return Number.isFinite(o)?o:n}const O=rt({width:e.project.width,height:e.project.height,fps:e.project.fps,total_frames:e.project.total_frames}),se=D("fit"),te=pe(()=>{const a=Math.max(1,e.project.fps||1);return e.project.duration||e.project.total_frames/a||0}),Y=pe(()=>{var l;const a=Math.max(.001,te.value||0),n=oe.value||((l=A.value)==null?void 0:l.clientWidth)||0,o=n?n/a:De;return Math.max(De,o)}),ue=pe(()=>Math.max(te.value*Y.value+120,oe.value||0));We(()=>e.extractMode.enabled,a=>{var n,o;a||(o=(n=S.value)==null?void 0:n.clearExtractSelection)==null||o.call(n)});function re(){var o;if(!A.value)return;const a=((o=A.value.parentElement)==null?void 0:o.clientWidth)||A.value.getBoundingClientRect().width||0,n=typeof window<"u"?window.innerWidth:a;oe.value=Math.min(a||n,n)}et(()=>{K(),re(),typeof ResizeObserver<"u"&&A.value?(ee=new ResizeObserver(a=>{const n=a[0];n!=null&&n.contentRect&&(oe.value=n.contentRect.width)}),ee.observe(A.value)):window.addEventListener("resize",re)});let fe=!1,C=null;const Z=D(new Set([0])),N=D(null),$=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"scale",label:"Scl"},{key:"rotation",label:"Rot"},{key:"opacity",label:"Op"}],Q=pe(()=>{const a=e.currentLayer;if(!a)return{x:0,y:0,scale:1,rotation:0,opacity:1};const n=e.currentTime,o=a.keyframes||{};return{x:X(o.x,n,a.x||0),y:X(o.y,n,a.y||0),scale:X(o.scale,n,a.scale||1),rotation:X(o.rotation,n,a.rotation||0),opacity:X(o.opacity,n,a.opacity??1)}});function X(a,n,o){if(!a||a.length===0)return o;const l=[...a].sort((m,p)=>m.time-p.time);if(n<=l[0].time)return l[0].value;if(n>=l[l.length-1].time)return l[l.length-1].value;for(let m=0;m<l.length-1;m++)if(n>=l[m].time&&n<=l[m+1].time){const p=(n-l[m].time)/(l[m+1].time-l[m].time);return l[m].value+(l[m+1].value-l[m].value)*p}return o}function ie(a,n){const o=e.currentLayer;if(!o)return;const l=parseFloat(n.target.value);if(isNaN(l))return;const m=e.currentTime;if(o.keyframes&&o.keyframes[a]&&o.keyframes[a].length>0){const p=o.keyframes[a].findIndex(g=>Math.abs(g.time-m)<.05);p>=0?o.keyframes[a][p]={time:o.keyframes[a][p].time,value:l}:(o.keyframes[a].push({time:m,value:l}),o.keyframes[a].sort((g,L)=>g.time-L.time))}e.updateLayer(e.currentLayerIndex,{[a]:l})}function he(a){const n=Math.floor(a/60),o=Math.floor(a%60),l=Math.floor(a%1*e.project.fps);return`${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}.${l.toString().padStart(2,"0")}`}function xe(a,n){return!a.keyframes||!a.keyframes[n]?[]:a.keyframes[n].map(o=>({time:o.time,value:o.value}))}function Me(a,n){return n==="opacity"?(a*100).toFixed(0)+"%":a.toFixed(1)}function _e(a){Z.value.has(a)?Z.value.delete(a):Z.value.add(a)}function Ce(a){console.log("Toggle vis",a.id)}function f(a){if(!A.value)return 0;const n=A.value.querySelector(".timeline-content");if(!n)return 0;const o=n.getBoundingClientRect(),l=A.value.scrollLeft,m=a.clientX-o.left+l,p=Y.value||De;if(m<=10)return 0;const g=m/p;return Math.max(0,Math.min(g,te.value))}function P(a){a.preventDefault(),G=!0,e.setCurrentTime(f(a));const n=l=>{G&&e.setCurrentTime(f(l))},o=()=>{G=!1,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",o)}function E(a){G&&e.setCurrentTime(f(a))}function w(){G=!1}function k(a){if(!e.currentLayer)return;const n=f(a);e.setCurrentTime(n),e.addKeyframe()}function x(a,n,o){const m=a.currentTarget.getBoundingClientRect(),p=a.clientX-m.left,g=Y.value||De,L=Math.max(0,p/g),_=e.layers[n];if(!_)return;const T=_[o]??(o==="scale"||o==="opacity"?1:0);_.keyframes||(_.keyframes={}),_.keyframes[o]||(_.keyframes[o]=[]),_.keyframes[o].find(q=>Math.abs(q.time-L)<.05)||(_.keyframes[o].push({time:L,value:T}),_.keyframes[o].sort((q,j)=>q.time-j.time))}function me(a,n,o){N.value={layerIdx:a,prop:n,time:o},e.selectLayer(a),e.setCurrentTime(o)}function ye(a,n,o){const l=N.value;return l?l.layerIdx===a&&l.prop===n&&Math.abs(l.time-o)<.01:!1}function Le(a,n,o,l){a.preventDefault(),fe=!0,C={layerIdx:n,prop:o,originalTime:l.time},me(n,o,l.time);const m=a.clientX,p=l.time,g=Y.value||De,L=T=>{var je;if(!fe||!C)return;const q=(T.clientX-m)/g;let j=Math.max(0,p+q);const V=e.layers[C.layerIdx];if((je=V==null?void 0:V.keyframes)!=null&&je[C.prop]){const Se=V.keyframes[C.prop],Ie=Se.findIndex(be=>Math.abs(be.time-C.originalTime)<.01);Ie>=0&&(Se[Ie].time=j,C.originalTime=j,N.value.time=j,e.setCurrentTime(j))}},_=()=>{var ne;fe=!1,C=null,document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",_);const T=e.layers[n];(ne=T==null?void 0:T.keyframes)!=null&&ne[o]&&T.keyframes[o].sort((q,j)=>q.time-j.time)};document.addEventListener("mousemove",L),document.addEventListener("mouseup",_)}function de(a,n,o){var m,p,g,L;const l=e.layers[a];(m=l==null?void 0:l.keyframes)!=null&&m[n]&&(l.keyframes[n]=l.keyframes[n].filter(_=>Math.abs(_.time-o)>.01),((p=N.value)==null?void 0:p.layerIdx)===a&&((g=N.value)==null?void 0:g.prop)===n&&Math.abs(((L=N.value)==null?void 0:L.time)-o)<.01&&(N.value=null))}function ze(a){if(A.value){const n=a.target,o=A.value.querySelector(".timeline-tracks");o&&(o.scrollTop=n.scrollTop)}}function Ae(a){const n=a.target,o=document.querySelector(".layers-list");o&&(o.scrollTop=n.scrollTop)}function K(){var T,ne,q,j,V,je,Se,Ie;if(!((T=M.node)!=null&&T.widgets))return;const a=H((ne=W("width"))==null?void 0:ne.value,e.project.width),n=H((q=W("height"))==null?void 0:q.value,e.project.height),o=Math.max(1,H((j=W("fps"))==null?void 0:j.value,e.project.fps)),l=Math.max(1,Math.round(H((V=W("total_frames"))==null?void 0:V.value,e.project.total_frames))),m=H((je=W("mask_expansion"))==null?void 0:je.value,e.project.mask_expansion),p=H((Se=W("mask_feather"))==null?void 0:Se.value,e.project.mask_feather);let g=[];const L=(Ie=W("layers_keyframes"))==null?void 0:Ie.value;if(typeof L=="string"&&L.trim())try{const be=JSON.parse(L);Array.isArray(be)&&(g=be)}catch(be){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",be)}else Array.isArray(L)&&(g=L);const _={width:a,height:n,fps:o,total_frames:l,duration:l/o,mask_expansion:m,mask_feather:p};e.loadAnimation({project:_,layers:g}),O.width=e.project.width,O.height=e.project.height,O.fps=e.project.fps,O.total_frames=e.project.total_frames,e.layers.length>0&&e.currentLayerIndex<0&&e.selectLayer(0)}function ge(a,n){return a.type==="background"?"BG":`Layer ${n+1}`}function Xe(){const a=e.exportAnimation(),n=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),l=document.createElement("a");l.href=o,l.download=`ae_project_${Date.now()}.json`,l.click(),URL.revokeObjectURL(o)}function Pe(){var a;(a=F.value)==null||a.click()}function Ye(a){var l;const n=(l=a.target.files)==null?void 0:l[0];if(!n)return;const o=new FileReader;o.onload=m=>{var p;try{const g=JSON.parse((p=m.target)==null?void 0:p.result);e.loadAnimation(g),console.log("Project loaded successfully")}catch(g){console.error("Failed to parse project file",g),alert("å·¥ç¨‹æ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯")}},o.readAsText(n),F.value&&(F.value.value="")}function Ee(){var L,_,T,ne,q;if(!((L=M.node)!=null&&L.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}const a=j=>M.node.widgets.find(V=>V.name===j);console.log("[AE Timeline] Saving..."),e.layers.forEach(j=>{j.maskCanvas&&(j.customMask=j.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${j.id}: Saved mask (len=${j.customMask.length})`))});const n=e.exportAnimation();n.layers.forEach((j,V)=>{j.bezierPath&&j.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${j.id}: Exporting Path with ${j.bezierPath.length} points`)});const o=a("layers_keyframes");if(o){const j=JSON.stringify(n.layers);if(o.value=j,console.log(`[AE Timeline] Saved layers_keyframes (len=${j.length})`),o.inputEl&&(o.inputEl.value=j,o.inputEl.dispatchEvent(new Event("input"))),o.callback&&o.callback(j),M.node.widgets_values){const V=M.node.widgets.indexOf(o);V>=0&&(M.node.widgets_values[V]=j)}(T=(_=M.node).setDirtyCanvas)==null||T.call(_,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");const l=a("width");l&&(l.value=e.project.width,l.inputEl&&(l.inputEl.value=e.project.width,l.inputEl.dispatchEvent(new Event("input"))),l.callback&&l.callback(e.project.width));const m=a("height");m&&(m.value=e.project.height,m.inputEl&&(m.inputEl.value=e.project.height,m.inputEl.dispatchEvent(new Event("input"))),m.callback&&m.callback(e.project.height));const p=a("fps");p&&(p.value=e.project.fps,p.inputEl&&(p.inputEl.value=e.project.fps,p.inputEl.dispatchEvent(new Event("input"))),p.callback&&p.callback(e.project.fps));const g=a("total_frames");g&&(g.value=e.project.total_frames,g.inputEl&&(g.inputEl.value=e.project.total_frames,g.inputEl.dispatchEvent(new Event("input"))),g.callback&&g.callback(e.project.total_frames)),(q=(ne=M.node).setDirtyCanvas)==null||q.call(ne,!0,!1)}function $e(){Ee();const a=document.querySelector(".ae-timeline-dialog");a&&a.close()}function Ke(){e.addKeyframe()}function Oe(){e.deleteKeyframe()}function Be(){e.setCurrentTime(0)}function Ne(){if(!e.currentLayer||!confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å…³é”®å¸§å—ï¼Ÿ"))return;const a=e.currentLayer;["x","y","scale","rotation","opacity","mask_size"].forEach(o=>{var l;(l=a.keyframes)!=null&&l[o]&&(a.keyframes[o]=[])})}function Ge(){e.layers.forEach((a,n)=>{n!==e.currentLayerIndex&&a.image_data&&console.log(`[AE Timeline] Clearing cache for layer ${a.id}`)})}function He(){var a,n;(n=(a=S.value)==null?void 0:a.scheduleRender)==null||n.call(a),console.log("[AE Timeline] Preview refreshed")}function ve(){var a,n;M.node&&M.node.graph&&window.app&&((n=(a=window.app).queuePrompt)==null||n.call(a,0))}function Fe(){var n,o;const a=!e.maskMode.enabled;e.maskMode.enabled=a,a&&(e.pathMode.enabled=!1,e.extractMode.enabled&&(e.extractMode.enabled=!1,(o=(n=S.value)==null?void 0:n.clearExtractSelection)==null||o.call(n)))}function Ue(){var n,o;const a=!e.pathMode.enabled;e.pathMode.enabled=a,a&&(e.maskMode.enabled=!1,e.extractMode.enabled&&(e.extractMode.enabled=!1,(o=(n=S.value)==null?void 0:n.clearExtractSelection)==null||o.call(n)))}function t(){var n,o;const a=!e.extractMode.enabled;if(a){if(!e.layers.find(m=>m.type==="background")){alert("è¯·å…ˆæ·»åŠ èƒŒæ™¯å›¾å±‚å†ä½¿ç”¨æå–åŠŸèƒ½");return}e.maskMode.enabled=!1,e.pathMode.enabled=!1}else(o=(n=S.value)==null?void 0:n.clearExtractSelection)==null||o.call(n);e.extractMode.enabled=a}function s(){var a,n;(n=(a=S.value)==null?void 0:a.clearExtractSelection)==null||n.call(a)}function r(){var m,p;const a=S.value;if(!a||typeof a.applyExtractSelection!="function")return;const n=a.applyExtractSelection();if(!n){alert("è¯·å…ˆç»˜åˆ¶æå–é€‰åŒº");return}if("error"in n){alert(n.error);return}const o=new Image;o.onload=()=>{const g=e.layers.filter(L=>{var _;return(_=L.id)==null?void 0:_.startsWith("extracted_")}).length;e.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${g+1}`,type:"foreground",image_data:n.foregroundDataUrl,img:o,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},o.src=n.foregroundDataUrl;const l=e.layers.find(g=>g.type==="background");if(l&&n.backgroundDataUrl){const g=new Image;g.onload=()=>{l.image_data=n.backgroundDataUrl,l.img=g,e.updateLayer(e.layers.indexOf(l),{image_data:n.backgroundDataUrl})},g.src=n.backgroundDataUrl}e.extractMode.enabled=!1,(p=(m=S.value)==null?void 0:m.clearExtractSelection)==null||p.call(m)}function i(){var a;ce="foreground",(a=B.value)==null||a.click()}function u(){var a;ce="background",(a=B.value)==null||a.click()}function c(a){const n=a.target.files;n&&(Array.from(n).forEach((o,l)=>{const m=new FileReader;m.onload=p=>{var _;const g=(_=p.target)==null?void 0:_.result,L=new Image;L.onload=()=>{e.addLayer({id:"uploaded_"+Date.now()+"_"+l,name:o.name.replace(/\.[^/.]+$/,""),type:ce,image_data:g,img:L,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},L.src=g},m.readAsDataURL(o)}),B.value&&(B.value.value=""))}function h(){y(-1)}function b(){y(1)}function y(a){const n=e.currentLayerIndex;if(n<0)return;const o=n+a;if(o>=0&&o<e.layers.length){const l=e.layers[n];e.layers.splice(n,1),e.layers.splice(o,0,l),e.selectLayer(o)}}return it(()=>{ee&&A.value&&(ee.disconnect(),ee=null),window.removeEventListener("resize",re),Ee()}),(a,n)=>(z(),R("div",wt,[d("div",xt,[lt(kt,{ref_key:"canvasPreviewRef",ref:S},null,512)]),d("div",Mt,[d("div",_t,[d("button",{class:"tb-btn accent",onClick:Xe,title:"ä¿å­˜å·¥ç¨‹æ–‡ä»¶ (.json)"},"ðŸ’¾ Save Proj"),d("button",{class:"tb-btn",onClick:Pe,title:"åŠ è½½å·¥ç¨‹æ–‡ä»¶"},"ðŸ“‚ Load Proj"),d("button",{class:"tb-btn",onClick:Ge,title:"æ¸…ç†æœªé€‰å›¾å±‚çš„å›¾åƒç¼“å­˜"},"ðŸ§¹ æ¸…ç¼“å­˜"),Re(d("select",{class:"tb-select","onUpdate:modelValue":n[0]||(n[0]=o=>se.value=o),title:"èƒŒæ™¯é€‚é…æ¨¡å¼"},[...n[11]||(n[11]=[d("option",{value:"fit"},"Fit",-1),d("option",{value:"fill"},"Fill",-1),d("option",{value:"stretch"},"Stretch",-1)])],512),[[ct,se.value]])]),d("div",Ct,[d("button",{class:"tb-btn btn-green",onClick:i,title:"æ·»åŠ å‰æ™¯å›¾å±‚"},"ï¼‹å›¾ç‰‡"),d("button",{class:"tb-btn btn-blue",onClick:u,title:"æ·»åŠ èƒŒæ™¯å›¾å±‚"},"ï¼‹èƒŒæ™¯"),n[12]||(n[12]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:"tb-btn",onClick:Be,title:"å›žåˆ°èµ·ç‚¹"},"|â—€"),d("button",{class:ae(["tb-btn btn-play",{active:v(e).isPlaying}]),onClick:n[1]||(n[1]=(...o)=>v(e).togglePlayback&&v(e).togglePlayback(...o)),title:"æ’­æ”¾/æš‚åœ"},U(v(e).isPlaying?"â– ":"â–¶"),3),n[13]||(n[13]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:"tb-btn btn-amber",onClick:Ke,title:"æ·»åŠ å…³é”®å¸§ (K)"},"â—† Key"),d("button",{class:"tb-btn btn-red",onClick:Oe,title:"åˆ é™¤å…³é”®å¸§"},"âœ• Key"),d("button",{class:"tb-btn btn-red",onClick:Ne,title:"æ¸…é™¤æ‰€æœ‰å…³é”®å¸§"},"ALL"),n[14]||(n[14]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:ae(["tb-btn btn-mask",{active:v(e).maskMode.enabled}]),onClick:Fe,title:"é®ç½©ç»˜åˆ¶æ¨¡å¼"},"ðŸ–Œ Mask",2),v(e).maskMode.enabled?(z(),R("button",{key:0,class:ae(["tb-btn",{active:v(e).maskMode.erase}]),onClick:n[2]||(n[2]=o=>v(e).maskMode.erase=!v(e).maskMode.erase),title:"åˆ‡æ¢æ©¡çš®æ“¦/è¿˜åŽŸ"}," ðŸ§½ Erase ",2)):we("",!0),d("button",{class:ae(["tb-btn btn-path",{active:v(e).pathMode.enabled}]),onClick:Ue,title:"è·¯å¾„åŠ¨ç”»æ¨¡å¼"},"ðŸ“ Path",2),d("button",{class:ae(["tb-btn btn-extract",{active:v(e).extractMode.enabled}]),onClick:t,title:"èƒŒæ™¯æå–æ¨¡å¼"},"âœ‚ Extract",2),v(e).extractMode.enabled?(z(),R("div",Lt,[d("button",{class:"tb-btn accent",onClick:r,title:"åº”ç”¨æå–ç»“æžœå¹¶ç”Ÿæˆå‰æ™¯å›¾å±‚"},"âœ“ Apply"),d("button",{class:"tb-btn",onClick:s,title:"æ¸…ç©ºæå–é€‰åŒº"},"âŸ² Clear")])):we("",!0),d("button",{class:"tb-btn",onClick:He,title:"åˆ·æ–°é¢„è§ˆï¼ˆä»Žç¼“å­˜åŠ è½½ï¼‰"},"ðŸ”„"),d("button",{class:"tb-btn btn-run",onClick:ve,title:"è¿è¡ŒèŠ‚ç‚¹"},"âš¡ Run"),n[15]||(n[15]=d("span",{class:"tb-sep"},null,-1)),d("span",Pt,U(he(v(e).currentTime)),1),d("button",{class:"tb-btn save",onClick:Ee},"ä¿å­˜åˆ°èŠ‚ç‚¹"),d("button",{class:"tb-btn close",onClick:$e},"âœ•")])]),d("div",Et,[v(e).currentLayer?(z(),R(le,{key:0},[d("span",jt,"Layer "+U(v(e).currentLayerIndex+1)+" ("+U(v(e).currentLayer.type==="background"?"BG":"FG")+")",1),d("div",St,[n[16]||(n[16]=d("label",null,"X",-1)),d("input",{type:"number",value:Q.value.x.toFixed(0),onInput:n[3]||(n[3]=o=>ie("x",o)),step:"1",class:"param-input"},null,40,It)]),d("div",Tt,[n[17]||(n[17]=d("label",null,"Y",-1)),d("input",{type:"number",value:Q.value.y.toFixed(0),onInput:n[4]||(n[4]=o=>ie("y",o)),step:"1",class:"param-input"},null,40,Dt)]),d("div",Rt,[n[18]||(n[18]=d("label",null,"Scale",-1)),d("input",{type:"number",value:Q.value.scale.toFixed(2),onInput:n[5]||(n[5]=o=>ie("scale",o)),step:"0.01",min:"0.1",max:"5",class:"param-input"},null,40,zt)]),d("div",At,[n[19]||(n[19]=d("label",null,"Rotate",-1)),d("input",{type:"number",value:Q.value.rotation.toFixed(0),onInput:n[6]||(n[6]=o=>ie("rotation",o)),step:"1",class:"param-input"},null,40,Xt)]),d("div",Yt,[n[20]||(n[20]=d("label",null,"Opacity",-1)),d("input",{type:"range",value:Q.value.opacity,onInput:n[7]||(n[7]=o=>ie("opacity",o)),min:"0",max:"1",step:"0.01",class:"param-slider"},null,40,Ft),d("span",Ut,U((Q.value.opacity*100).toFixed(0))+"%",1)]),v(e).maskMode.enabled?(z(),R(le,{key:0},[n[22]||(n[22]=d("div",{class:"param-sep"},null,-1)),d("div",Wt,[n[21]||(n[21]=d("label",null,"Mask Brush",-1)),Re(d("input",{type:"range","onUpdate:modelValue":n[8]||(n[8]=o=>v(e).maskMode.brush=o),min:"1",max:"100",step:"1",class:"param-slider"},null,512),[[Je,v(e).maskMode.brush,void 0,{number:!0}]]),d("span",$t,U(v(e).maskMode.brush)+"px",1)])],64)):we("",!0),v(e).extractMode.enabled?(z(),R(le,{key:1},[n[24]||(n[24]=d("div",{class:"param-sep"},null,-1)),d("div",Kt,[n[23]||(n[23]=d("label",null,"Extract Brush",-1)),Re(d("input",{type:"range","onUpdate:modelValue":n[9]||(n[9]=o=>v(e).extractMode.brush=o),min:"5",max:"150",step:"1",class:"param-slider"},null,512),[[Je,v(e).extractMode.brush,void 0,{number:!0}]]),d("span",Ot,U(v(e).extractMode.brush)+"px",1)])],64)):we("",!0)],64)):(z(),R("span",Bt,"è¯·é€‰æ‹©ä¸€ä¸ªå›¾å±‚è¿›è¡Œç¼–è¾‘"))]),d("div",Nt,[d("div",Gt,[d("div",Ht,[d("span",null,"Layers ("+U(v(e).layers.length)+")",1),d("div",qt,[d("button",{class:"layer-btn",onClick:h,disabled:!v(e).currentLayer,title:"ä¸Šç§»"},"â–²",8,Vt),d("button",{class:"layer-btn",onClick:b,disabled:!v(e).currentLayer,title:"ä¸‹ç§»"},"â–¼",8,Zt)])]),d("div",{class:"layers-list",onScroll:ze},[(z(!0),R(le,null,Te(v(e).layers,(o,l)=>(z(),R("div",{key:o.id,class:ae(["layer-item",{active:l===v(e).currentLayerIndex}]),onClick:m=>v(e).selectLayer(l)},[d("input",{type:"checkbox",class:"layer-check",checked:l===v(e).currentLayerIndex,onClick:n[10]||(n[10]=J(()=>{},["stop"])),onChange:m=>v(e).selectLayer(l),"aria-label":`Select ${ge(o,l)}`},null,40,Qt),d("span",{class:"layer-vis",onClick:J(m=>Ce(o),["stop"])},"ðŸ‘",8,en),d("span",{class:ae(["layer-badge",o.type])},U(o.type==="background"?"BG":"FG"),3),d("span",{class:"layer-name",title:o.name||ge(o,l)},U(ge(o,l)),9,tn),d("button",{class:"layer-del",onClick:J(m=>v(e).removeLayer(l),["stop"])},"ðŸ—‘",8,nn)],10,Jt))),128))],32)]),d("div",{class:"timeline-area",ref_key:"timelineRef",ref:A},[d("div",{class:"timeline-content",style:ke({width:ue.value+"px","--tick-size":Y.value+"px"})},[d("div",{class:"timeline-ruler",onMousedown:P,onMousemove:E,onMouseup:w,onMouseleave:w},[(z(!0),R(le,null,Te(Math.ceil(te.value)+1,o=>(z(),R("div",{key:o,class:"tick",style:ke({left:(o-1)*Y.value+"px"})},[d("span",an,U(o-1)+"s",1)],4))),128)),d("div",{class:"playhead-top",style:ke({left:v(e).currentTime*Y.value+"px"})},null,4)],32),d("div",{class:"timeline-tracks",onDblclick:k,onScroll:Ae},[(z(!0),R(le,null,Te(v(e).layers,(o,l)=>(z(),R(le,{key:o.id},[d("div",{class:ae(["track-header",{active:l===v(e).currentLayerIndex,expanded:Z.value.has(l)}]),onClick:m=>v(e).selectLayer(l)},[d("button",{class:"track-expand",onClick:J(m=>_e(l),["stop"])},U(Z.value.has(l)?"â–¼":"â–¶"),9,sn),d("span",{class:"track-bar",style:ke({width:te.value*Y.value+"px"})},null,4)],10,on),Z.value.has(l)?(z(),R(le,{key:0},Te($,m=>d("div",{key:m.key,class:ae(["track-prop",{active:l===v(e).currentLayerIndex}]),onClick:p=>v(e).selectLayer(l)},[d("div",{class:"prop-track",onDblclick:J(p=>x(p,l,m.key),["stop"])},[(z(!0),R(le,null,Te(xe(o,m.key),p=>(z(),R("div",{key:p.time,class:ae(["keyframe",{selected:ye(l,m.key,p.time)}]),style:ke({left:p.time*Y.value+"px"}),title:`${m.label}: ${Me(p.value,m.key)} @ ${p.time.toFixed(2)}s`,onMousedown:J(g=>Le(g,l,m.key,p),["stop"]),onClick:J(g=>me(l,m.key,p.time),["stop"]),onContextmenu:J(g=>de(l,m.key,p.time),["prevent"])},null,46,cn))),128))],40,ln)],10,rn)),64)):we("",!0)],64))),128))],32),d("div",{class:"playhead-line",style:ke({left:v(e).currentTime*Y.value+"px"})},null,4)],4)],512)]),d("input",{ref_key:"fileInput",ref:B,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:c},null,544),d("input",{ref_key:"projectInput",ref:F,type:"file",accept:".json",style:{display:"none"},onChange:Ye},null,544)]))}});function dn(I,M){const e=ut(un,{node:M.node}),S=dt();return e.use(S),e.mount(I),e}window.createTimelineApp=dn;
