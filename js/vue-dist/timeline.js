import{d as Fe,r as L,c as xe,b as Ue,k as Oe,a as We,w as Ae,f as M,h as _,C as je,j as d,D as Ye,l as O,u as g,z as pe,E as Be,t as T,_ as Ge,p as Ne,q as G,F as J,G as Ke,s as we,i as ye,A as qe,B as Ve}from"./assets/_plugin-vue_export-helper.js";const $e=Fe("timeline",()=>{const X=L({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0}),k=L([]),n=L(-1),b=L(0),z=L(0),A=L(!1),Y=L({enabled:!1,drawing:!1,erase:!1,brush:20}),ee=L({enabled:!1,data:null}),te=L({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),N=xe(()=>n.value>=0&&n.value<k.value.length?k.value[n.value]:null),ne=xe(()=>k.value.filter(u=>u.type==="foreground")),I=xe(()=>k.value.find(u=>u.type==="background"));function K(u){Object.assign(X.value,u),u.fps&&u.duration&&(X.value.total_frames=Math.floor(u.fps*u.duration))}function P(u){k.value.push(u),n.value=k.value.length-1}function ae(u){u>=0&&u<k.value.length&&(k.value.splice(u,1),n.value>=k.value.length&&(n.value=k.value.length-1))}function $(){k.value=[],n.value=-1}function q(u){u>=0&&u<k.value.length&&(n.value=u)}function V(u,v){u>=0&&u<k.value.length&&Object.assign(k.value[u],v)}function w(u){b.value=Math.max(0,Math.min(u,X.value.duration)),z.value=Math.floor(b.value*X.value.fps)}function he(u){z.value=Math.max(0,Math.min(u,X.value.total_frames-1)),b.value=z.value/X.value.fps}let F=null,S=0;function ge(){A.value=!A.value,A.value?E():se()}function E(){S=performance.now(),de()}function de(){if(!A.value)return;const u=performance.now(),v=(u-S)/1e3;S=u;let y=b.value+v;y>=X.value.duration&&(y=0),w(y),F=requestAnimationFrame(de)}function se(){F!==null&&(cancelAnimationFrame(F),F=null)}function fe(){A.value=!1,se(),w(0)}function ve(u){if(!u)return;const v=u.project||{};K({width:v.width||1280,height:v.height||720,fps:v.fps||30,duration:v.duration||5,total_frames:v.total_frames||150,mask_expansion:v.mask_expansion||0,mask_feather:v.mask_feather||0}),k.value=(u.layers||[]).map(y=>({id:y.id,name:y.name,type:y.type,image_data:y.image_data,x:y.x||0,y:y.y||0,scale:y.scale||1,rotation:y.rotation||0,opacity:y.opacity!==void 0?y.opacity:1,rotationX:y.rotationX||0,rotationY:y.rotationY||0,rotationZ:y.rotationZ||0,anchorX:y.anchorX||0,anchorY:y.anchorY||0,perspective:y.perspective||1e3,mask_size:y.mask_size||0,customMask:y.customMask,bezierPath:y.bezierPath,usePathAnimation:y.usePathAnimation||!1,keyframes:y.keyframes||{},bg_mode:y.bg_mode||"fit"}))}function be(){const u=N.value;if(!u)return;const v=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];u.keyframes||(u.keyframes={});for(const y of v){let R=u[y];R===void 0&&(y==="scale"||y==="opacity"?R=1:y==="perspective"?R=1e3:R=0),u.keyframes[y]||(u.keyframes[y]=[]),u.keyframes[y]=u.keyframes[y].filter(W=>W.time!==b.value),u.keyframes[y].push({time:b.value,value:R}),u.keyframes[y].sort((W,le)=>W.time-le.time)}}function re(){const u=N.value;if(!u||!u.keyframes)return;const v=["x","y","scale","rotation","opacity","mask_size"];for(const y of v)u.keyframes[y]&&(u.keyframes[y]=u.keyframes[y].filter(R=>R.time!==b.value))}function me(){const u=N.value;u&&(u.keyframes={})}function ie(){return{project:{...X.value},layers:k.value.map(u=>({id:u.id,name:u.name,type:u.type,image_data:u.image_data,x:u.x,y:u.y,scale:u.scale,rotation:u.rotation,opacity:u.opacity,rotationX:u.rotationX,rotationY:u.rotationY,rotationZ:u.rotationZ,anchorX:u.anchorX,anchorY:u.anchorY,perspective:u.perspective,mask_size:u.mask_size,customMask:u.customMask,bezierPath:u.bezierPath,usePathAnimation:u.usePathAnimation,keyframes:u.keyframes,bg_mode:u.bg_mode}))}}return{project:X,layers:k,currentLayerIndex:n,currentTime:b,currentFrame:z,isPlaying:A,maskMode:Y,pathMode:ee,extractMode:te,currentLayer:N,foregroundLayers:ne,backgroundLayer:I,setProject:K,addLayer:P,removeLayer:ae,clearLayers:$,selectLayer:q,updateLayer:V,setCurrentTime:w,setCurrentFrame:he,togglePlayback:ge,stopPlayback:fe,addKeyframe:be,deleteKeyframe:re,clearAllKeyframes:me,loadAnimation:ve,exportAnimation:ie}}),Ze=["width","height"],He=["width","height"],Je={class:"canvas-info"},Qe={key:0},et={key:0,class:"gpu-badge"},tt={key:1},nt=Ue({__name:"CanvasPreview",setup(X,{expose:k}){const n=$e(),b=L(),z=L(),A=L();let Y=!1,ee=0,te=0,N=0,ne=0;const I=L(!1);let K=!1,P=null;const ae=new Map,$=new Map;Oe(async()=>{b.value&&(P=b.value.getContext("2d",{alpha:!1,desynchronized:!0})),await q(),w()}),We(()=>{ae.clear(),V()});async function q(){console.log("[Timeline GPU] GPU rendering disabled, using Canvas 2D for stability"),I.value=!1}function V(){for(const e of $.values())e.destroy();$.clear()}function w(){K||(K=!0,requestAnimationFrame(()=>{K=!1,de()}))}Ae(()=>[n.layers,n.currentLayer,n.currentTime],()=>{w()},{deep:!0}),Ae(()=>n.extractMode.enabled,()=>{R=!1,w()});function he(){{se();return}}function F(e){if(e.img)return e.img;if(!e.image_data)return null;const t=e.id;if(ae.has(t)){const o=ae.get(t);return o.complete?(e.img=o,o):null}const a=new Image;return a.onload=()=>{e.img=a,w()},a.src=e.image_data,ae.set(t,a),null}function S(e,t,a){if(!e||e.length===0)return a;const o=[...e].sort((c,r)=>c.time-r.time);if(t<=o[0].time)return o[0].value;if(t>=o[o.length-1].time)return o[o.length-1].value;for(let c=0;c<o.length-1;c++)if(t>=o[c].time&&t<=o[c+1].time){const r=(t-o[c].time)/(o[c+1].time-o[c].time);return o[c].value+(o[c+1].value-o[c].value)*r}return a}function ge(e,t,a){if(!e||e.length<2)return null;const o=t/a,r=e.length-1,m=Math.min(Math.floor(o*r),r-1),h=o*r-m,f=e[m],p=e[m+1];if(!f||!p)return null;const C=f.cp2x??f.x+(p.x-f.x)/3,x=f.cp2y??f.y+(p.y-f.y)/3,j=p.cp1x??f.x+(p.x-f.x)*2/3,H=p.cp1y??f.y+(p.y-f.y)*2/3,B=1-h,U=B*B,ce=U*B,oe=h*h,ue=oe*h;return{x:ce*f.x+3*U*h*C+3*B*oe*j+ue*p.x,y:ce*f.y+3*U*h*x+3*B*oe*H+ue*p.y}}function E(e){const t=n.currentTime,a=e.keyframes||{};let o=S(a.x,t,e.x||0),c=S(a.y,t,e.y||0);if(e.usePathAnimation&&e.bezierPath&&e.bezierPath.length>=2){const r=ge(e.bezierPath,t,n.project.duration);r&&(o=r.x,c=r.y)}return{x:o,y:c,scale:S(a.scale,t,e.scale||1),rotation:S(a.rotation,t,e.rotation||0),opacity:S(a.opacity,t,e.opacity??1),mask_size:S(a.mask_size,t,e.mask_size||0),rotationX:S(a.rotationX,t,e.rotationX||0),rotationY:S(a.rotationY,t,e.rotationY||0),rotationZ:S(a.rotationZ,t,e.rotationZ||0),anchorX:S(a.anchorX,t,e.anchorX||0),anchorY:S(a.anchorY,t,e.anchorY||0),perspective:S(a.perspective,t,e.perspective||1e3)}}function de(){if(I.value){he();return}se()}function se(){var t;if(!b.value||!P)return;P.fillStyle="#000",P.fillRect(0,0,n.project.width,n.project.height);const e=n.layers.find(a=>a.type==="background");e&&ve(P,e),n.layers.filter(a=>a.type!=="background").forEach(a=>{be(P,a)}),n.pathMode.enabled&&((t=n.currentLayer)!=null&&t.bezierPath)&&fe(P,n.currentLayer.bezierPath),n.extractMode.enabled&&Ie(P)}function fe(e,t){if(!t||t.length===0)return;const a=n.project.width/2,o=n.project.height/2;e.save(),e.strokeStyle="#ff6b6b",e.lineWidth=2,e.setLineDash([5,5]),e.beginPath(),e.moveTo(a+t[0].x,o+t[0].y);for(let c=1;c<t.length;c++){const r=t[c-1],m=t[c],h=r.cp2x??r.x+(m.x-r.x)/3,f=r.cp2y??r.y+(m.y-r.y)/3,p=m.cp1x??r.x+(m.x-r.x)*2/3,C=m.cp1y??r.y+(m.y-r.y)*2/3;e.bezierCurveTo(a+h,o+f,a+p,o+C,a+m.x,o+m.y)}if(e.stroke(),e.setLineDash([]),t.forEach((c,r)=>{e.beginPath(),e.arc(a+c.x,o+c.y,6,0,Math.PI*2),e.fillStyle=r===0?"#4ecdc4":r===t.length-1?"#ff6b6b":"#ffe66d",e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke()}),t.length>=2){const c=t.length-1,r=t[c-1],m=t[c],h=r.cp2x??r.x+(m.x-r.x)/3,f=r.cp2y??r.y+(m.y-r.y)/3,p=m.cp1x??r.x+(m.x-r.x)*2/3,C=m.cp1y??r.y+(m.y-r.y)*2/3,x=.99,j=1-x,H=3*j*j*(h-r.x)+6*j*x*(p-h)+3*x*x*(m.x-p),B=3*j*j*(f-r.y)+6*j*x*(C-f)+3*x*x*(m.y-C),U=Math.atan2(B,H),ce=a+m.x,oe=o+m.y,ue=18;e.beginPath(),e.moveTo(ce,oe),e.lineTo(ce-ue*Math.cos(U-Math.PI/6),oe-ue*Math.sin(U-Math.PI/6)),e.moveTo(ce,oe),e.lineTo(ce-ue*Math.cos(U+Math.PI/6),oe-ue*Math.sin(U+Math.PI/6)),e.strokeStyle="#ff6b6b",e.lineWidth=2,e.stroke()}e.restore()}function ve(e,t){const a=F(t);if(!a||a.width===0||a.height===0)return;const o=E(t);e.save(),e.globalAlpha=o.opacity;const c=t.bg_mode||"fit",r=n.project.width,m=n.project.height,h=a.width,f=a.height;let p=1;h>0&&f>0&&(c==="fit"?p=Math.min(r/h,m/f):c==="fill"?p=Math.max(r/h,m/f):c==="stretch"&&(p=Math.min(r/h,m/f))),(!Number.isFinite(p)||p<=0)&&(p=1),e.translate(r/2+o.x,m/2+o.y),e.rotate(o.rotation*Math.PI/180),e.scale(o.scale*p,o.scale*p),e.drawImage(a,-h/2,-f/2,h,f),t===n.currentLayer&&(e.strokeStyle="#3a7bc8",e.lineWidth=2/(o.scale*p),e.strokeRect(-h/2-2,-f/2-2,h+4,f+4)),e.restore()}function be(e,t){const a=F(t);if(!a||a.width===0||a.height===0)return;const o=E(t),c=a.width,r=a.height;if(e.save(),e.translate(n.project.width/2+o.x,n.project.height/2+o.y),o.rotationX!==0||o.rotationY!==0){const f=o.perspective||1e3,p=o.rotationX*Math.PI/180,C=o.rotationY*Math.PI/180,x=Math.cos(p),j=Math.sin(p),H=Math.cos(C),B=Math.sin(C),U=1/(1+(B*c/2+j*r/2)/f);e.transform(H*U,j*B*U,0,x*U,0,0)}e.rotate(o.rotation*Math.PI/180),e.scale(o.scale,o.scale),e.globalAlpha=o.opacity;const m=(o.anchorX||0)*c,h=(o.anchorY||0)*r;if(t.maskCanvas){const f=document.createElement("canvas");f.width=c,f.height=r;const p=f.getContext("2d");p?(p.clearRect(0,0,c,r),p.drawImage(a,0,0,c,r),p.globalCompositeOperation="destination-in",p.drawImage(t.maskCanvas,0,0,c,r),e.drawImage(f,-c/2-m,-r/2-h,c,r)):e.drawImage(a,-c/2-m,-r/2-h,c,r)}else e.drawImage(a,-c/2-m,-r/2-h,c,r);if(t===n.currentLayer&&t.img){e.strokeStyle="#3a7bc8",e.lineWidth=2/o.scale;const f=t.img.width,p=t.img.height;e.strokeRect(-f/2-2,-p/2-2,f+4,p+4),e.fillStyle="#3a7bc8",[[-f/2,-p/2],[f/2,-p/2],[f/2,p/2],[-f/2,p/2]].forEach(([x,j])=>{e.fillRect(x-4/o.scale,j-4/o.scale,8/o.scale,8/o.scale)})}if(o.mask_size>0){e.strokeStyle="#3ac88e",e.lineWidth=2/o.scale,e.setLineDash([5/o.scale,5/o.scale]);const f=t.img?t.img.width:512,p=t.img?t.img.height:512,C=f*o.mask_size,x=p*o.mask_size;e.strokeRect(-C/2,-x/2,C,x),e.setLineDash([])}e.restore()}function re(){return I.value?z.value||null:b.value||null}function me(e){const t=re();if(!t)return{x:0,y:0};const a=t.getBoundingClientRect(),o=n.project.width/a.width,c=n.project.height/a.height;return{x:(e.clientX-a.left)*o,y:(e.clientY-a.top)*c}}let ie=!1,u=null,v=null,y=null,R=!1,W=null,le=!1,Z=-1;function Me(e){var o;if((o=re())==null||o.focus(),e.shiftKey,e.altKey,!n.currentLayer)return;const t=me(e);if(n.extractMode.enabled){if(!ke()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}R=!0,Pe(t.x,t.y,e.button===2||e.altKey);return}if(n.maskMode.enabled){ie=!0,Ce(),Le(t.x,t.y);return}if(n.pathMode.enabled){Re(t);return}Y=!0,ee=t.x,te=t.y;const a=E(n.currentLayer);N=a.x,ne=a.y}function _e(e){const t=me(e);if(n.extractMode.enabled&&R){Pe(t.x,t.y,(e.buttons&2)===2||e.altKey);return}if(ie&&n.maskMode.enabled){Le(t.x,t.y);return}if(le&&Z>=0){Se(t);return}if(!Y||!n.currentLayer)return;let a=t.x-ee,o=t.y-te;e.shiftKey&&(Math.abs(a)>Math.abs(o)?o=0:a=0);const c=N+a,r=ne+o;D(n.currentLayer,"x",c),D(n.currentLayer,"y",r),w()}function D(e,t,a){const o=n.currentTime;if(e.keyframes&&e.keyframes[t]&&e.keyframes[t].length>0){const c=e.keyframes[t].findIndex(r=>Math.abs(r.time-o)<.05);c>=0?e.keyframes[t][c]={time:e.keyframes[t][c].time,value:a}:(e.keyframes[t].push({time:o,value:a}),e.keyframes[t].sort((r,m)=>r.time-m.time))}n.updateLayer(n.currentLayerIndex,{[t]:a})}function Ce(){const e=n.currentLayer;if(!(!e||!e.img)){if(e.maskCanvas)u=e.maskCanvas.getContext("2d");else if(e.maskCanvas=document.createElement("canvas"),e.maskCanvas.width=e.img.width,e.maskCanvas.height=e.img.height,u=e.maskCanvas.getContext("2d"),u)if(e.customMask){const t=new Image;t.onload=()=>{u==null||u.drawImage(t,0,0),w()},t.src=e.customMask}else u.globalCompositeOperation="source-over",u.fillStyle="white",u.fillRect(0,0,e.maskCanvas.width,e.maskCanvas.height)}}function Le(e,t){const a=n.currentLayer;if(!a||((!u||!a.maskCanvas)&&Ce(),!a.img||!u||!a.maskCanvas))return;const o=E(a),c=n.project.width/2+o.x,r=n.project.height/2+o.y,m=(e-c)/o.scale+a.img.width/2,h=(t-r)/o.scale+a.img.height/2,f=n.maskMode.brush||20;u.save(),u.beginPath(),u.arc(m,h,f,0,Math.PI*2),n.maskMode.erase?(u.globalCompositeOperation="source-over",u.fillStyle="white"):(u.globalCompositeOperation="destination-out",u.fillStyle="black"),u.fill(),u.restore(),w()}function ke(){const e=n.layers.find(a=>a.type==="background");if(!e)return null;const t=F(e);return t?((!v||!y||v.width!==t.width||v.height!==t.height||W!==e.id)&&(v=document.createElement("canvas"),v.width=t.width,v.height=t.height,y=v.getContext("2d"),y&&y.clearRect(0,0,t.width,t.height),W=e.id||null),{layer:e,img:t,ctx:y}):null}function Pe(e,t,a=!1){const o=ke();if(!o)return;const{layer:c,img:r,ctx:m}=o,h=E(c),f=n.project.width/2+(h.x??0),p=n.project.height/2+(h.y??0),C=h.scale??1,x=(e-f)/C+r.width/2,j=(t-p)/C+r.height/2,H=Math.max(1,n.extractMode.brush||30);m.beginPath(),m.arc(x,j,H,0,Math.PI*2),m.fillStyle=a?"black":"white",m.fill(),w()}function Ie(e){if(!n.extractMode.enabled||!v||!W)return;const t=n.layers.find(m=>m.id===W);if(!t)return;const a=F(t);if(!a)return;const o=E(t);e.save(),e.translate(n.project.width/2+(o.x??0),n.project.height/2+(o.y??0)),e.rotate((o.rotation??0)*Math.PI/180),e.scale(o.scale??1,o.scale??1);const c=-a.width/2,r=-a.height/2;e.fillStyle="rgba(0, 0, 0, 0.65)",e.fillRect(c,r,a.width,a.height),e.globalCompositeOperation="destination-out",e.drawImage(v,c,r,a.width,a.height),e.restore()}function Te(){y&&v&&(y.clearRect(0,0,v.width,v.height),w())}function Ee(){if(!y||!v)return!1;const e=y.getImageData(0,0,v.width,v.height).data;for(let t=0;t<e.length;t+=4)if(e[t]>10)return!0;return!1}function De(e,t,a){const o=e.canvas,c=document.createElement("canvas");c.width=t,c.height=a;const r=c.getContext("2d");if(!r)return null;r.drawImage(o,0,0);const m=8;r.globalCompositeOperation="destination-over";for(let p=0;p<m;p++)r.drawImage(c,1,0),r.drawImage(c,-1,0),r.drawImage(c,0,1),r.drawImage(c,0,-1),p%2===0&&(r.drawImage(c,1,1),r.drawImage(c,-1,-1),r.drawImage(c,1,-1),r.drawImage(c,-1,1));const h=document.createElement("canvas");h.width=t/8,h.height=a/8;const f=h.getContext("2d");return f&&(f.drawImage(c,0,0,h.width,h.height),f.filter="blur(4px)",f.drawImage(h,0,0),f.drawImage(h,0,0),r.save(),r.globalCompositeOperation="destination-over",r.filter="blur(8px)",r.drawImage(h,0,0,t,a),r.restore()),c.toDataURL("image/png")}function Xe(){const e=ke();if(!e||!v||!y)return{error:"èƒŒæ™¯å›¾å±‚å°šæœªå‡†å¤‡å¥½"};if(!Ee())return null;const{img:t}=e,a=document.createElement("canvas");a.width=t.width,a.height=t.height;const o=a.getContext("2d");if(!o)return{error:"æ— æ³•åˆ›å»ºä¸´æ—¶ç”»å¸ƒ"};o.drawImage(t,0,0),o.globalCompositeOperation="destination-in",o.drawImage(v,0,0);const c=a.toDataURL("image/png"),r=document.createElement("canvas");r.width=t.width,r.height=t.height;const m=r.getContext("2d");if(!m)return{error:"æ— æ³•åˆ›å»ºèƒŒæ™¯ç”»å¸ƒ"};m.drawImage(t,0,0),m.globalCompositeOperation="destination-out",m.drawImage(v,0,0),m.globalCompositeOperation="source-over";const h=De(m,t.width,t.height)||t.src;return{foregroundDataUrl:c,backgroundDataUrl:h}}function Re(e,t){const a=n.currentLayer;if(!a)return;a.bezierPath||(a.bezierPath=[]);const o=ze(e);if(o>=0)Z=o,le=!0;else{const c=n.project.width/2,r=n.project.height/2;a.bezierPath.push({x:e.x-c,y:e.y-r}),a.bezierPath.length>=2&&(a.usePathAnimation=!0),w()}}function ze(e){const t=n.currentLayer;if(!t||!t.bezierPath)return-1;const a=n.project.width/2,o=n.project.height/2,c=10;for(let r=0;r<t.bezierPath.length;r++){const m=t.bezierPath[r],h=m.x+a-e.x,f=m.y+o-e.y;if(Math.sqrt(h*h+f*f)<c)return r}return-1}function Se(e){const t=n.currentLayer;if(!t||!t.bezierPath||Z<0)return;const a=n.project.width/2,o=n.project.height/2;t.bezierPath[Z].x=e.x-a,t.bezierPath[Z].y=e.y-o,w()}function l(){Y=!1,ie=!1,R=!1,le=!1,Z=-1}function s(e){if(!n.currentLayer)return;const t=e.deltaY>0?-.05:.05,a=n.currentLayer;if(e.shiftKey){const c=E(a).rotation+(t>0?5:-5);D(a,"rotation",c)}else if(e.altKey){const o=E(a),c=Math.max(0,Math.min(1,o.opacity+t));D(a,"opacity",c)}else{const o=E(a),c=Math.max(.1,Math.min(5,o.scale+t));D(a,"scale",c)}w()}function i(e){if(!n.currentLayer)return;const t=e.shiftKey?10:1,a=n.currentLayer,o=E(a);switch(e.key){case"ArrowLeft":D(a,"x",o.x-t),w(),e.preventDefault();break;case"ArrowRight":D(a,"x",o.x+t),w(),e.preventDefault();break;case"ArrowUp":D(a,"y",o.y-t),w(),e.preventDefault();break;case"ArrowDown":D(a,"y",o.y+t),w(),e.preventDefault();break;case"r":case"R":D(a,"x",0),D(a,"y",0),D(a,"scale",1),D(a,"rotation",0),D(a,"opacity",1),w(),e.preventDefault();break;case"Delete":case"Backspace":confirm("åˆ é™¤å½“å‰å›¾å±‚?")&&n.removeLayer(n.currentLayerIndex),e.preventDefault();break}}return k({clearExtractSelection:Te,applyExtractSelection:Xe}),(e,t)=>(_(),M("div",{class:"canvas-preview",ref_key:"containerRef",ref:A},[je(d("canvas",{ref_key:"gpuCanvasRef",ref:z,width:g(n).project.width,height:g(n).project.height,onMousedown:Me,onMousemove:_e,onMouseup:l,onMouseleave:l,onWheel:O(s,["prevent"]),onContextmenu:t[0]||(t[0]=O(()=>{},["prevent"])),tabindex:"0",onKeydown:i},null,40,Ze),[[Ye,I.value]]),je(d("canvas",{ref_key:"canvasRef",ref:b,width:g(n).project.width,height:g(n).project.height,onMousedown:Me,onMousemove:_e,onMouseup:l,onMouseleave:l,onWheel:O(s,["prevent"]),onContextmenu:t[1]||(t[1]=O(()=>{},["prevent"])),tabindex:"0",onKeydown:i},null,40,He),[[Ye,!I.value]]),d("div",Je,[g(n).currentLayer?(_(),M("span",Qe,[I.value?(_(),M("span",et,"GPU")):pe("",!0),Be(" Layer "+T(g(n).currentLayerIndex+1)+" | X:"+T(Math.round(g(n).currentLayer.x||0))+" Y:"+T(Math.round(g(n).currentLayer.y||0))+" S:"+T((g(n).currentLayer.scale||1).toFixed(2))+" R:"+T(Math.round(g(n).currentLayer.rotation||0))+"Â° ",1)])):(_(),M("span",tt,"No layer selected"))])],512))}}),at=Ge(nt,[["__scopeId","data-v-0445a8cd"]]),ot={class:"root"},st={class:"canvas-area"},rt={class:"toolbar-area"},it={class:"toolbar-center"},lt={key:1,class:"extract-actions"},ct={class:"tb-time"},ut={class:"params-area"},dt={class:"param-label"},ft={class:"param-group"},mt=["value"],yt={class:"param-group"},pt=["value"],ht={class:"param-group"},gt=["value"],vt={class:"param-group"},bt=["value"],kt={class:"param-group"},wt=["value"],xt={class:"param-value"},Mt={class:"param-group"},_t={class:"param-value"},Ct={class:"param-group"},Lt={class:"param-value"},Pt={key:1,class:"param-empty"},St={class:"bottom-area"},jt={class:"layers-sidebar"},It={class:"layers-header"},Tt={class:"layer-actions"},Et=["disabled"],Dt=["disabled"],Xt=["onClick"],Rt=["onClick"],zt={class:"layer-name"},At=["onClick"],Yt={class:"tick-label"},Kt=["onClick"],Ut=["onClick"],$t=["onClick"],Ft=["onDblclick"],Ot=["title","onMousedown","onClick","onContextmenu"],Q=60,Wt=Ue({__name:"TimelineApp",props:{node:{}},setup(X){const k=X,n=$e(),b=L(null),z=L(),A=L(),Y=L();let ee="foreground",te=!1;const N=xe(()=>{var l;return Math.max(n.project.duration*Q+100,((l=Y.value)==null?void 0:l.clientWidth)||0)});Ae(()=>n.extractMode.enabled,l=>{var s,i;l||(i=(s=b.value)==null?void 0:s.clearExtractSelection)==null||i.call(s)});let ne=!1,I=null;const K=L(new Set([0])),P=L(null),ae=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"scale",label:"Scl"},{key:"rotation",label:"Rot"},{key:"opacity",label:"Op"}],$=xe(()=>{const l=n.currentLayer;if(!l)return{x:0,y:0,scale:1,rotation:0,opacity:1};const s=n.currentTime,i=l.keyframes||{};return{x:q(i.x,s,l.x||0),y:q(i.y,s,l.y||0),scale:q(i.scale,s,l.scale||1),rotation:q(i.rotation,s,l.rotation||0),opacity:q(i.opacity,s,l.opacity??1)}});function q(l,s,i){if(!l||l.length===0)return i;const e=[...l].sort((t,a)=>t.time-a.time);if(s<=e[0].time)return e[0].value;if(s>=e[e.length-1].time)return e[e.length-1].value;for(let t=0;t<e.length-1;t++)if(s>=e[t].time&&s<=e[t+1].time){const a=(s-e[t].time)/(e[t+1].time-e[t].time);return e[t].value+(e[t+1].value-e[t].value)*a}return i}function V(l,s){const i=n.currentLayer;if(!i)return;const e=parseFloat(s.target.value);if(isNaN(e))return;const t=n.currentTime;if(i.keyframes&&i.keyframes[l]&&i.keyframes[l].length>0){const a=i.keyframes[l].findIndex(o=>Math.abs(o.time-t)<.05);a>=0?i.keyframes[l][a]={time:i.keyframes[l][a].time,value:e}:(i.keyframes[l].push({time:t,value:e}),i.keyframes[l].sort((o,c)=>o.time-c.time))}n.updateLayer(n.currentLayerIndex,{[l]:e})}function w(l){const s=Math.floor(l/60),i=Math.floor(l%60),e=Math.floor(l%1*n.project.fps);return`${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${e.toString().padStart(2,"0")}`}function he(l,s){return!l.keyframes||!l.keyframes[s]?[]:l.keyframes[s].map(i=>({time:i.time,value:i.value}))}function F(l,s){return s==="opacity"?(l*100).toFixed(0)+"%":l.toFixed(1)}function S(l){K.value.has(l)?K.value.delete(l):K.value.add(l)}function ge(l){console.log("Toggle vis",l.id)}function E(l){if(!Y.value)return 0;const s=Y.value.querySelector(".timeline-content");if(!s)return 0;const i=s.getBoundingClientRect();Y.value.scrollLeft;const e=l.clientX-i.left,t=Math.max(0,e/Q);return Math.min(t,n.project.duration)}function de(l){te=!0,n.setCurrentTime(E(l))}function se(l){te&&n.setCurrentTime(E(l))}function fe(){te=!1}function ve(l){if(!n.currentLayer)return;const s=E(l);n.setCurrentTime(s),n.addKeyframe()}function be(l,s,i){const t=l.currentTarget.getBoundingClientRect(),a=l.clientX-t.left,o=Math.max(0,a/Q),c=n.layers[s];if(!c)return;const r=c[i]??(i==="scale"||i==="opacity"?1:0);c.keyframes||(c.keyframes={}),c.keyframes[i]||(c.keyframes[i]=[]),c.keyframes[i].find(h=>Math.abs(h.time-o)<.05)||(c.keyframes[i].push({time:o,value:r}),c.keyframes[i].sort((h,f)=>h.time-f.time))}function re(l,s,i){P.value={layerIdx:l,prop:s,time:i},n.selectLayer(l),n.setCurrentTime(i)}function me(l,s,i){const e=P.value;return e?e.layerIdx===l&&e.prop===s&&Math.abs(e.time-i)<.01:!1}function ie(l,s,i,e){l.preventDefault(),ne=!0,I={layerIdx:s,prop:i,originalTime:e.time},re(s,i,e.time);const t=l.clientX,a=e.time,o=r=>{var C;if(!ne||!I)return;const h=(r.clientX-t)/Q;let f=Math.max(0,a+h);const p=n.layers[I.layerIdx];if((C=p==null?void 0:p.keyframes)!=null&&C[I.prop]){const x=p.keyframes[I.prop],j=x.findIndex(H=>Math.abs(H.time-I.originalTime)<.01);j>=0&&(x[j].time=f,I.originalTime=f,P.value.time=f,n.setCurrentTime(f))}},c=()=>{var m;ne=!1,I=null,document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",c);const r=n.layers[s];(m=r==null?void 0:r.keyframes)!=null&&m[i]&&r.keyframes[i].sort((h,f)=>h.time-f.time)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",c)}function u(l,s,i){var t,a,o,c;const e=n.layers[l];(t=e==null?void 0:e.keyframes)!=null&&t[s]&&(e.keyframes[s]=e.keyframes[s].filter(r=>Math.abs(r.time-i)>.01),((a=P.value)==null?void 0:a.layerIdx)===l&&((o=P.value)==null?void 0:o.prop)===s&&Math.abs(((c=P.value)==null?void 0:c.time)-i)<.01&&(P.value=null))}function v(l){if(Y.value){const s=l.target,i=Y.value.querySelector(".timeline-tracks");i&&(i.scrollTop=s.scrollTop)}}function y(l){const s=l.target,i=document.querySelector(".layers-list");i&&(i.scrollTop=s.scrollTop)}function R(){const l=n.exportAnimation(),s=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),i=URL.createObjectURL(s),e=document.createElement("a");e.href=i,e.download=`ae_project_${Date.now()}.json`,e.click(),URL.revokeObjectURL(i)}function W(){var l;(l=A.value)==null||l.click()}function le(l){var e;const s=(e=l.target.files)==null?void 0:e[0];if(!s)return;const i=new FileReader;i.onload=t=>{var a;try{const o=JSON.parse((a=t.target)==null?void 0:a.result);n.loadAnimation(o),console.log("Project loaded successfully")}catch(o){console.error("Failed to parse project file",o),alert("å·¥ç¨‹æ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯")}},i.readAsText(s),A.value&&(A.value.value="")}function Z(){var c;if(!((c=k.node)!=null&&c.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}const l=r=>k.node.widgets.find(m=>m.name===r);console.log("[AE Timeline] Saving..."),n.layers.forEach(r=>{r.maskCanvas&&(r.customMask=r.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${r.id}: Saved mask (len=${r.customMask.length})`))});const s=n.exportAnimation();s.layers.forEach((r,m)=>{r.bezierPath&&r.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${r.id}: Exporting Path with ${r.bezierPath.length} points`)});const i=l("layers_keyframes");if(i){const r=JSON.stringify(s.layers);i.value=r,console.log(`[AE Timeline] Saved layers_keyframes (len=${r.length})`)}else console.error("[AE Timeline] Widget layers_keyframes not found!");const e=l("width");e&&(e.value=n.project.width);const t=l("height");t&&(t.value=n.project.height);const a=l("fps");a&&(a.value=n.project.fps);const o=l("total_frames");o&&(o.value=n.project.total_frames)}function Me(){Z();const l=document.querySelector(".ae-timeline-dialog");l&&l.close()}function _e(){n.addKeyframe()}function D(){n.deleteKeyframe()}function Ce(){n.setCurrentTime(0)}function Le(){var s,i;const l=!n.maskMode.enabled;n.maskMode.enabled=l,l&&(n.pathMode.enabled=!1,n.extractMode.enabled&&(n.extractMode.enabled=!1,(i=(s=b.value)==null?void 0:s.clearExtractSelection)==null||i.call(s)))}function ke(){var s,i;const l=!n.pathMode.enabled;n.pathMode.enabled=l,l&&(n.maskMode.enabled=!1,n.extractMode.enabled&&(n.extractMode.enabled=!1,(i=(s=b.value)==null?void 0:s.clearExtractSelection)==null||i.call(s)))}function Pe(){var s,i;const l=!n.extractMode.enabled;if(l){if(!n.layers.find(t=>t.type==="background")){alert("è¯·å…ˆæ·»åŠ èƒŒæ™¯å›¾å±‚å†ä½¿ç”¨æå–åŠŸèƒ½");return}n.maskMode.enabled=!1,n.pathMode.enabled=!1}else(i=(s=b.value)==null?void 0:s.clearExtractSelection)==null||i.call(s);n.extractMode.enabled=l}function Ie(){var l,s;(s=(l=b.value)==null?void 0:l.clearExtractSelection)==null||s.call(l)}function Te(){var t,a;const l=b.value;if(!l||typeof l.applyExtractSelection!="function")return;const s=l.applyExtractSelection();if(!s){alert("è¯·å…ˆç»˜åˆ¶æå–é€‰åŒº");return}if("error"in s){alert(s.error);return}const i=new Image;i.onload=()=>{const o=n.layers.filter(c=>{var r;return(r=c.id)==null?void 0:r.startsWith("extracted_")}).length;n.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${o+1}`,type:"foreground",image_data:s.foregroundDataUrl,img:i,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},i.src=s.foregroundDataUrl;const e=n.layers.find(o=>o.type==="background");if(e&&s.backgroundDataUrl){const o=new Image;o.onload=()=>{e.image_data=s.backgroundDataUrl,e.img=o,n.updateLayer(n.layers.indexOf(e),{image_data:s.backgroundDataUrl})},o.src=s.backgroundDataUrl}n.extractMode.enabled=!1,(a=(t=b.value)==null?void 0:t.clearExtractSelection)==null||a.call(t)}function Ee(){var l;ee="foreground",(l=z.value)==null||l.click()}function De(){var l;ee="background",(l=z.value)==null||l.click()}function Xe(l){const s=l.target.files;s&&(Array.from(s).forEach((i,e)=>{const t=new FileReader;t.onload=a=>{var r;const o=(r=a.target)==null?void 0:r.result,c=new Image;c.onload=()=>{n.addLayer({id:"uploaded_"+Date.now()+"_"+e,name:i.name.replace(/\.[^/.]+$/,""),type:ee,image_data:o,img:c,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},c.src=o},t.readAsDataURL(i)}),z.value&&(z.value.value=""))}function Re(){Se(-1)}function ze(){Se(1)}function Se(l){const s=n.currentLayerIndex;if(s<0)return;const i=s+l;if(i>=0&&i<n.layers.length){const e=n.layers[s];n.layers.splice(s,1),n.layers.splice(i,0,e),n.selectLayer(i)}}return(l,s)=>(_(),M("div",ot,[d("div",st,[Ne(at,{ref_key:"canvasPreviewRef",ref:b},null,512)]),d("div",rt,[d("div",{class:"toolbar-left"},[d("button",{class:"tb-btn accent",onClick:R,title:"ä¿å­˜å·¥ç¨‹æ–‡ä»¶ (.json)"},"ðŸ’¾ Save Proj"),d("button",{class:"tb-btn",onClick:W,title:"åŠ è½½å·¥ç¨‹æ–‡ä»¶"},"ðŸ“‚ Load Proj")]),d("div",it,[d("button",{class:"tb-btn",onClick:Ee,title:"æ·»åŠ å‰æ™¯å›¾å±‚"},"+ Layer"),d("button",{class:"tb-btn",onClick:De,title:"æ·»åŠ èƒŒæ™¯å›¾å±‚"},"+ BG"),s[9]||(s[9]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:"tb-btn",onClick:Ce,title:"å›žåˆ°èµ·ç‚¹"},"|â—€"),d("button",{class:G(["tb-btn",{active:g(n).isPlaying}]),onClick:s[0]||(s[0]=(...i)=>g(n).togglePlayback&&g(n).togglePlayback(...i)),title:"æ’­æ”¾/æš‚åœ"},T(g(n).isPlaying?"â– ":"â–¶"),3),s[10]||(s[10]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:"tb-btn accent",onClick:_e,title:"æ·»åŠ å…³é”®å¸§ (K)"},"â—† Key"),d("button",{class:"tb-btn",onClick:D,title:"åˆ é™¤å…³é”®å¸§"},"âœ• Key"),s[11]||(s[11]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:G(["tb-btn",{active:g(n).maskMode.enabled}]),onClick:Le,title:"é®ç½©ç»˜åˆ¶æ¨¡å¼"},"ðŸ–Œ Mask",2),g(n).maskMode.enabled?(_(),M("button",{key:0,class:G(["tb-btn",{active:g(n).maskMode.erase}]),onClick:s[1]||(s[1]=i=>g(n).maskMode.erase=!g(n).maskMode.erase),title:"åˆ‡æ¢æ©¡çš®æ“¦/è¿˜åŽŸ"}," ðŸ§½ Erase ",2)):pe("",!0),d("button",{class:G(["tb-btn",{active:g(n).pathMode.enabled}]),onClick:ke,title:"è·¯å¾„åŠ¨ç”»æ¨¡å¼"},"ðŸ“ Path",2),d("button",{class:G(["tb-btn",{active:g(n).extractMode.enabled}]),onClick:Pe,title:"èƒŒæ™¯æå–æ¨¡å¼"},"âœ‚ Extract",2),g(n).extractMode.enabled?(_(),M("div",lt,[d("button",{class:"tb-btn accent",onClick:Te,title:"åº”ç”¨æå–ç»“æžœå¹¶ç”Ÿæˆå‰æ™¯å›¾å±‚"},"âœ“ Apply"),d("button",{class:"tb-btn",onClick:Ie,title:"æ¸…ç©ºæå–é€‰åŒº"},"âŸ² Clear")])):pe("",!0),s[12]||(s[12]=d("span",{class:"tb-sep"},null,-1)),d("span",ct,T(w(g(n).currentTime)),1),d("button",{class:"tb-btn save",onClick:Z},"ä¿å­˜åˆ°èŠ‚ç‚¹"),d("button",{class:"tb-btn close",onClick:Me},"âœ•")])]),d("div",ut,[g(n).currentLayer?(_(),M(J,{key:0},[d("span",dt,"Layer "+T(g(n).currentLayerIndex+1)+" ("+T(g(n).currentLayer.type==="background"?"BG":"FG")+")",1),d("div",ft,[s[13]||(s[13]=d("label",null,"X",-1)),d("input",{type:"number",value:$.value.x.toFixed(0),onInput:s[2]||(s[2]=i=>V("x",i)),step:"1",class:"param-input"},null,40,mt)]),d("div",yt,[s[14]||(s[14]=d("label",null,"Y",-1)),d("input",{type:"number",value:$.value.y.toFixed(0),onInput:s[3]||(s[3]=i=>V("y",i)),step:"1",class:"param-input"},null,40,pt)]),d("div",ht,[s[15]||(s[15]=d("label",null,"Scale",-1)),d("input",{type:"number",value:$.value.scale.toFixed(2),onInput:s[4]||(s[4]=i=>V("scale",i)),step:"0.01",min:"0.1",max:"5",class:"param-input"},null,40,gt)]),d("div",vt,[s[16]||(s[16]=d("label",null,"Rotate",-1)),d("input",{type:"number",value:$.value.rotation.toFixed(0),onInput:s[5]||(s[5]=i=>V("rotation",i)),step:"1",class:"param-input"},null,40,bt)]),d("div",kt,[s[17]||(s[17]=d("label",null,"Opacity",-1)),d("input",{type:"range",value:$.value.opacity,onInput:s[6]||(s[6]=i=>V("opacity",i)),min:"0",max:"1",step:"0.01",class:"param-slider"},null,40,wt),d("span",xt,T(($.value.opacity*100).toFixed(0))+"%",1)]),g(n).maskMode.enabled?(_(),M(J,{key:0},[s[19]||(s[19]=d("div",{class:"param-sep"},null,-1)),d("div",Mt,[s[18]||(s[18]=d("label",null,"Mask Brush",-1)),je(d("input",{type:"range","onUpdate:modelValue":s[7]||(s[7]=i=>g(n).maskMode.brush=i),min:"1",max:"100",step:"1",class:"param-slider"},null,512),[[Ke,g(n).maskMode.brush,void 0,{number:!0}]]),d("span",_t,T(g(n).maskMode.brush)+"px",1)])],64)):pe("",!0),g(n).extractMode.enabled?(_(),M(J,{key:1},[s[21]||(s[21]=d("div",{class:"param-sep"},null,-1)),d("div",Ct,[s[20]||(s[20]=d("label",null,"Extract Brush",-1)),je(d("input",{type:"range","onUpdate:modelValue":s[8]||(s[8]=i=>g(n).extractMode.brush=i),min:"5",max:"150",step:"1",class:"param-slider"},null,512),[[Ke,g(n).extractMode.brush,void 0,{number:!0}]]),d("span",Lt,T(g(n).extractMode.brush)+"px",1)])],64)):pe("",!0)],64)):(_(),M("span",Pt,"è¯·é€‰æ‹©ä¸€ä¸ªå›¾å±‚è¿›è¡Œç¼–è¾‘"))]),d("div",St,[d("div",jt,[d("div",It,[d("span",null,"Layers ("+T(g(n).layers.length)+")",1),d("div",Tt,[d("button",{class:"layer-btn",onClick:Re,disabled:!g(n).currentLayer,title:"ä¸Šç§»"},"â–²",8,Et),d("button",{class:"layer-btn",onClick:ze,disabled:!g(n).currentLayer,title:"ä¸‹ç§»"},"â–¼",8,Dt)])]),d("div",{class:"layers-list",onScroll:v},[(_(!0),M(J,null,we(g(n).layers,(i,e)=>(_(),M("div",{key:i.id,class:G(["layer-item",{active:e===g(n).currentLayerIndex}]),onClick:t=>g(n).selectLayer(e)},[d("span",{class:"layer-vis",onClick:O(t=>ge(i),["stop"])},"ðŸ‘",8,Rt),d("span",{class:G(["layer-badge",i.type])},T(i.type==="background"?"BG":"FG"),3),d("span",zt,T(i.name||"Layer "+(e+1)),1),d("button",{class:"layer-del",onClick:O(t=>g(n).removeLayer(e),["stop"])},"ðŸ—‘",8,At)],10,Xt))),128))],32)]),d("div",{class:"timeline-area",ref_key:"timelineRef",ref:Y},[d("div",{class:"timeline-content",style:ye({width:N.value+"px"})},[d("div",{class:"timeline-ruler",onMousedown:de,onMousemove:se,onMouseup:fe,onMouseleave:fe},[(_(!0),M(J,null,we(Math.ceil(g(n).project.duration)+1,i=>(_(),M("div",{key:i,class:"tick",style:ye({left:(i-1)*Q+"px"})},[d("span",Yt,T(i-1)+"s",1)],4))),128)),d("div",{class:"playhead-top",style:ye({left:g(n).currentTime*Q+"px"})},null,4)],32),d("div",{class:"timeline-tracks",onDblclick:ve,onScroll:y},[(_(!0),M(J,null,we(g(n).layers,(i,e)=>(_(),M(J,{key:i.id},[d("div",{class:G(["track-header",{active:e===g(n).currentLayerIndex,expanded:K.value.has(e)}]),onClick:t=>g(n).selectLayer(e)},[d("button",{class:"track-expand",onClick:O(t=>S(e),["stop"])},T(K.value.has(e)?"â–¼":"â–¶"),9,Ut),d("span",{class:"track-bar",style:ye({width:g(n).project.duration*Q+"px"})},null,4)],10,Kt),K.value.has(e)?(_(),M(J,{key:0},we(ae,t=>d("div",{key:t.key,class:G(["track-prop",{active:e===g(n).currentLayerIndex}]),onClick:a=>g(n).selectLayer(e)},[d("div",{class:"prop-track",onDblclick:O(a=>be(a,e,t.key),["stop"])},[(_(!0),M(J,null,we(he(i,t.key),a=>(_(),M("div",{key:a.time,class:G(["keyframe",{selected:me(e,t.key,a.time)}]),style:ye({left:a.time*Q+"px"}),title:`${t.label}: ${F(a.value,t.key)} @ ${a.time.toFixed(2)}s`,onMousedown:O(o=>ie(o,e,t.key,a),["stop"]),onClick:O(o=>re(e,t.key,a.time),["stop"]),onContextmenu:O(o=>u(e,t.key,a.time),["prevent"])},null,46,Ot))),128))],40,Ft)],10,$t)),64)):pe("",!0)],64))),128))],32),d("div",{class:"playhead-line",style:ye({left:g(n).currentTime*Q+"px"})},null,4)],4)],512)]),d("input",{ref_key:"fileInput",ref:z,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:Xe},null,544),d("input",{ref_key:"projectInput",ref:A,type:"file",accept:".json",style:{display:"none"},onChange:le},null,544)]))}});function Bt(X,k){const n=qe(Wt,{node:k.node}),b=Ve();return n.use(b),n.mount(X),n}window.createTimelineApp=Bt;
