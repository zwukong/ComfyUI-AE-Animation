import{d as ot,r as D,c as ye,b as tt,k as nt,a as rt,w as Qe,f as A,h as R,j as r,C as Ee,D as et,l as ae,u as p,z as Ie,E as it,t as S,_ as at,y as lt,q,G as He,H as ct,i as he,p as ut,F as be,s as Pe,A as dt,B as ft}from"./assets/_plugin-vue_export-helper.js";function Je(T){const M=Math.max(1,T.fps||1);return T.duration||T.total_frames/M}const st=ot("timeline",()=>{const T=D({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0}),M=D([]),t=D(-1),j=D(0),G=D(0),V=D(!1),z=D({enabled:!1,drawing:!1,erase:!1,brush:20}),le=D({enabled:!1,data:null}),ue=D({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),Q=ye(()=>t.value>=0&&t.value<M.value.length?M.value[t.value]:null),se=ye(()=>M.value.filter(m=>m.type==="foreground")),$=ye(()=>M.value.find(m=>m.type==="background"));function Z(m){const g=Math.max(1,m.fps??T.value.fps),b=typeof m.duration=="number",I=typeof m.total_frames=="number",E={...T.value,...m,fps:g};b&&!I?E.total_frames=Math.max(1,Math.round((E.duration||0)*g)):I&&!b?(E.total_frames=Math.max(1,Math.round(E.total_frames)),E.duration=E.total_frames/g):(E.total_frames=Math.max(1,Math.round(E.total_frames||E.duration*g)),E.duration=E.duration||E.total_frames/g),Object.assign(T.value,E)}function B(m){M.value.push(m),t.value=M.value.length-1}function ee(m){m>=0&&m<M.value.length&&(M.value.splice(m,1),t.value>=M.value.length&&(t.value=M.value.length-1))}function we(){M.value=[],t.value=-1}function xe(m){m>=0&&m<M.value.length&&(t.value=m)}function te(m,g){m>=0&&m<M.value.length&&Object.assign(M.value[m],g)}function L(m){const g=Je(T.value);j.value=Math.max(0,Math.min(m,g)),G.value=Math.floor(j.value*T.value.fps)}function je(m){const g=Math.max(1,Math.round(T.value.total_frames||Je(T.value)*T.value.fps));G.value=Math.max(0,Math.min(m,g-1)),j.value=G.value/T.value.fps}let N=null,X=0;function H(){V.value=!V.value,V.value?Y():de()}function Y(){N===null&&(X=performance.now(),J())}function J(){if(!V.value)return;const m=performance.now(),g=(m-X)/1e3;X=m;let b=j.value+g;const I=Je(T.value);b>=I&&(b=0),L(b),N=requestAnimationFrame(J)}function de(){N!==null&&(cancelAnimationFrame(N),N=null)}function oe(){V.value=!1,de(),L(0)}function ce(m){if(!m)return;const g=m.project||{},b=g.fps||T.value.fps||30,I=g.duration??(g.total_frames?g.total_frames/Math.max(1,b):T.value.duration),E=g.total_frames??Math.max(1,Math.round((I||T.value.duration)*b));Z({width:g.width||1280,height:g.height||720,fps:b,duration:I,total_frames:E,mask_expansion:g.mask_expansion||0,mask_feather:g.mask_feather||0}),M.value=(m.layers||[]).map(P=>({id:P.id,name:P.name,type:P.type,image_data:P.image_data,x:P.x||0,y:P.y||0,scale:P.scale||1,rotation:P.rotation||0,opacity:P.opacity!==void 0?P.opacity:1,rotationX:P.rotationX||0,rotationY:P.rotationY||0,rotationZ:P.rotationZ||0,anchorX:P.anchorX||0,anchorY:P.anchorY||0,perspective:P.perspective||1e3,mask_size:P.mask_size||0,customMask:P.customMask,bezierPath:P.bezierPath,usePathAnimation:P.usePathAnimation||!1,keyframes:P.keyframes||{},bg_mode:P.bg_mode||"fit"}))}function fe(){const m=Q.value;if(!m)return;const g=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];m.keyframes||(m.keyframes={});for(const b of g){let I=m[b];I===void 0&&(b==="scale"||b==="opacity"?I=1:b==="perspective"?I=1e3:I=0),m.keyframes[b]||(m.keyframes[b]=[]),m.keyframes[b]=m.keyframes[b].filter(E=>E.time!==j.value),m.keyframes[b].push({time:j.value,value:I}),m.keyframes[b].sort((E,P)=>E.time-P.time)}}function Se(){const m=Q.value;if(!m||!m.keyframes)return;const g=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];for(const b of g)m.keyframes[b]&&(m.keyframes[b]=m.keyframes[b].filter(I=>I.time!==j.value))}function me(){const m=Q.value;m&&(m.keyframes={})}function _e(){return{project:{...T.value},layers:M.value.map(m=>({id:m.id,name:m.name,type:m.type,image_data:m.image_data,x:m.x,y:m.y,scale:m.scale,rotation:m.rotation,opacity:m.opacity,rotationX:m.rotationX,rotationY:m.rotationY,rotationZ:m.rotationZ,anchorX:m.anchorX,anchorY:m.anchorY,perspective:m.perspective,mask_size:m.mask_size,customMask:m.customMask,bezierPath:m.bezierPath,usePathAnimation:m.usePathAnimation,keyframes:m.keyframes,bg_mode:m.bg_mode}))}}return{project:T,layers:M,currentLayerIndex:t,currentTime:j,currentFrame:G,isPlaying:V,maskMode:z,pathMode:le,extractMode:ue,currentLayer:Q,foregroundLayers:se,backgroundLayer:$,setProject:Z,addLayer:B,removeLayer:ee,clearLayers:we,selectLayer:xe,updateLayer:te,setCurrentTime:L,setCurrentFrame:je,togglePlayback:H,stopPlayback:oe,addKeyframe:fe,deleteKeyframe:Se,clearAllKeyframes:me,loadAnimation:ce,exportAnimation:_e}}),mt={class:"canvas-wrapper"},pt=["width","height"],ht=["width","height"],yt={class:"canvas-info"},vt={key:0},gt={key:0,class:"gpu-badge"},kt={key:1},bt=tt({__name:"CanvasPreview",setup(T,{expose:M}){const t=st(),j=D(),G=D(),V=D();let z=!1,le=0,ue=0,Q=0,se=0;const $=D(!1);let Z=!1,B=null;const ee=new Map,we=new Map;nt(async()=>{j.value&&(B=j.value.getContext("2d",{alpha:!1,desynchronized:!0})),await xe(),L()}),rt(()=>{ee.clear(),te()});async function xe(){console.log("[Timeline GPU] GPU rendering disabled, using Canvas 2D for stability"),$.value=!1}function te(){for(const n of we.values())n.destroy();we.clear()}function L(){Z||(Z=!0,requestAnimationFrame(()=>{Z=!1,J()}))}Qe(()=>[t.layers,t.currentLayer,t.currentTime],()=>{L()},{deep:!0}),Qe(()=>t.extractMode.enabled,()=>{E=!1,L()});function je(){{de();return}}function N(n){if(n.img)return n.img;if(!n.image_data)return null;const o=n.id;if(ee.has(o)){const c=ee.get(o);return c.complete?(n.img=c,c):null}const l=new Image;return l.onload=()=>{n.img=l,L()},l.src=n.image_data,ee.set(o,l),null}function X(n,o,l){if(!n||n.length===0)return l;const c=[...n].sort((d,u)=>d.time-u.time);if(o<=c[0].time)return c[0].value;if(o>=c[c.length-1].time)return c[c.length-1].value;for(let d=0;d<c.length-1;d++)if(o>=c[d].time&&o<=c[d+1].time){const u=(o-c[d].time)/(c[d+1].time-c[d].time);return c[d].value+(c[d+1].value-c[d].value)*u}return l}function H(n,o,l){if(!n||n.length<2)return null;const c=o/l,u=n.length-1,h=Math.min(Math.floor(c*u),u-1),x=c*u-h,y=n[h],w=n[h+1];if(!y||!w)return null;const U=y.cp2x??y.x+(w.x-y.x)/3,F=y.cp2y??y.y+(w.y-y.y)/3,W=w.cp1x??y.x+(w.x-y.x)*2/3,re=w.cp1y??y.y+(w.y-y.y)*2/3,s=1-x,e=s*s,a=e*s,i=x*x,f=i*x;return{x:a*y.x+3*e*x*U+3*s*i*W+f*w.x,y:a*y.y+3*e*x*F+3*s*i*re+f*w.y}}function Y(n){const o=t.currentTime,l=n.keyframes||{};let c=X(l.x,o,n.x||0),d=X(l.y,o,n.y||0);if(n.usePathAnimation&&n.bezierPath&&n.bezierPath.length>=2){const u=H(n.bezierPath,o,t.project.duration);u&&(c=u.x,d=u.y)}return{x:c,y:d,scale:X(l.scale,o,n.scale||1),rotation:X(l.rotation,o,n.rotation||0),opacity:X(l.opacity,o,n.opacity??1),mask_size:X(l.mask_size,o,n.mask_size||0),rotationX:X(l.rotationX,o,n.rotationX||0),rotationY:X(l.rotationY,o,n.rotationY||0),rotationZ:X(l.rotationZ,o,n.rotationZ||0),anchorX:X(l.anchorX,o,n.anchorX||0),anchorY:X(l.anchorY,o,n.anchorY||0),perspective:X(l.perspective,o,n.perspective||1e3)}}function J(){if($.value){je();return}de()}function de(){var o;if(!j.value||!B)return;B.fillStyle="#000",B.fillRect(0,0,t.project.width,t.project.height);const n=t.layers.find(l=>l.type==="background");n&&fe(B,n),t.layers.filter(l=>l.type!=="background").forEach(l=>{Se(B,l)}),t.pathMode.enabled&&((o=t.currentLayer)!=null&&o.bezierPath)&&oe(B,t.currentLayer.bezierPath),t.extractMode.enabled&&Oe(B)}function oe(n,o){if(!o||o.length===0)return;const l=t.project.width/2,c=t.project.height/2;n.save(),n.strokeStyle="#ff6b6b",n.lineWidth=2,n.setLineDash([5,5]),n.beginPath(),n.moveTo(l+o[0].x,c+o[0].y);for(let d=1;d<o.length;d++){const u=o[d-1],h=o[d],x=u.cp2x??u.x+(h.x-u.x)/3,y=u.cp2y??u.y+(h.y-u.y)/3,w=h.cp1x??u.x+(h.x-u.x)*2/3,U=h.cp1y??u.y+(h.y-u.y)*2/3;n.bezierCurveTo(l+x,c+y,l+w,c+U,l+h.x,c+h.y)}if(n.stroke(),n.setLineDash([]),o.forEach((d,u)=>{n.beginPath(),n.arc(l+d.x,c+d.y,6,0,Math.PI*2),n.fillStyle=u===0?"#4ecdc4":u===o.length-1?"#ff6b6b":"#ffe66d",n.fill(),n.strokeStyle="#fff",n.lineWidth=2,n.stroke()}),o.length>=2){const d=o.length-1,u=o[d-1],h=o[d],x=u.cp2x??u.x+(h.x-u.x)/3,y=u.cp2y??u.y+(h.y-u.y)/3,w=h.cp1x??u.x+(h.x-u.x)*2/3,U=h.cp1y??u.y+(h.y-u.y)*2/3,F=.99,W=1-F,re=3*W*W*(x-u.x)+6*W*F*(w-x)+3*F*F*(h.x-w),s=3*W*W*(y-u.y)+6*W*F*(U-y)+3*F*F*(h.y-U),e=Math.atan2(s,re),a=l+h.x,i=c+h.y,f=18;n.beginPath(),n.moveTo(a,i),n.lineTo(a-f*Math.cos(e-Math.PI/6),i-f*Math.sin(e-Math.PI/6)),n.moveTo(a,i),n.lineTo(a-f*Math.cos(e+Math.PI/6),i-f*Math.sin(e+Math.PI/6)),n.strokeStyle="#ff6b6b",n.lineWidth=2,n.stroke()}n.restore()}function ce(n,o,l){if(n.maskCanvas||!n.customMask)return;const c=new Image;c.onload=()=>{const d=document.createElement("canvas");d.width=c.width||o,d.height=c.height||l;const u=d.getContext("2d");u&&(u.drawImage(c,0,0,d.width,d.height),n.maskCanvas=d,L())},c.src=n.customMask}function fe(n,o){const l=N(o);if(!l||l.width===0||l.height===0)return;const c=Y(o);n.save(),n.globalAlpha=c.opacity;const d=o.bg_mode||"fit",u=t.project.width,h=t.project.height,x=l.width,y=l.height;let w=1;x>0&&y>0&&(d==="fit"?w=Math.min(u/x,h/y):d==="fill"?w=Math.max(u/x,h/y):d==="stretch"&&(w=Math.min(u/x,h/y))),(!Number.isFinite(w)||w<=0)&&(w=1),n.translate(u/2+c.x,h/2+c.y),n.rotate(c.rotation*Math.PI/180),n.scale(c.scale*w,c.scale*w),n.drawImage(l,-x/2,-y/2,x,y),o===t.currentLayer&&(n.strokeStyle="#3a7bc8",n.lineWidth=2/(c.scale*w),n.strokeRect(-x/2-2,-y/2-2,x+4,y+4)),n.restore()}function Se(n,o){const l=N(o);if(!l||l.width===0||l.height===0)return;const c=Y(o),d=l.width,u=l.height;if(ce(o,d,u),n.save(),n.translate(t.project.width/2+c.x,t.project.height/2+c.y),c.rotationX!==0||c.rotationY!==0){const y=c.perspective||1e3,w=c.rotationX*Math.PI/180,U=c.rotationY*Math.PI/180,F=Math.cos(w),W=Math.sin(w),re=Math.cos(U),s=Math.sin(U),e=1/(1+(s*d/2+W*u/2)/y);n.transform(re*e,W*s*e,0,F*e,0,0)}n.rotate(c.rotation*Math.PI/180),n.scale(c.scale,c.scale),n.globalAlpha=c.opacity;const h=(c.anchorX||0)*d,x=(c.anchorY||0)*u;if(o.maskCanvas){const y=document.createElement("canvas");y.width=d,y.height=u;const w=y.getContext("2d");w?(w.clearRect(0,0,d,u),w.drawImage(l,0,0,d,u),w.globalCompositeOperation="destination-in",w.drawImage(o.maskCanvas,0,0,d,u),n.drawImage(y,-d/2-h,-u/2-x,d,u)):n.drawImage(l,-d/2-h,-u/2-x,d,u)}else n.drawImage(l,-d/2-h,-u/2-x,d,u);if(o===t.currentLayer&&o.img){n.strokeStyle="#3a7bc8",n.lineWidth=2/c.scale;const y=o.img.width,w=o.img.height;n.strokeRect(-y/2-2,-w/2-2,y+4,w+4),n.fillStyle="#3a7bc8",[[-y/2,-w/2],[y/2,-w/2],[y/2,w/2],[-y/2,w/2]].forEach(([F,W])=>{n.fillRect(F-4/c.scale,W-4/c.scale,8/c.scale,8/c.scale)})}if(c.mask_size>0){n.strokeStyle="#3ac88e",n.lineWidth=2/c.scale,n.setLineDash([5/c.scale,5/c.scale]);const y=o.img?o.img.width:512,w=o.img?o.img.height:512,U=y*c.mask_size,F=w*c.mask_size;n.strokeRect(-U/2,-F/2,U,F),n.setLineDash([])}n.restore()}function me(){return $.value?G.value||null:j.value||null}function _e(n){const o=me();if(!o)return{x:0,y:0};const l=o.getBoundingClientRect(),c=t.project.width/l.width,d=t.project.height/l.height;return{x:(n.clientX-l.left)*c,y:(n.clientY-l.top)*d}}let m=!1,g=null,b=null,I=null,E=!1,P=null,Te=!1,pe=-1;function De(n){var c;if((c=me())==null||c.focus(),n.shiftKey,n.altKey,!t.currentLayer)return;const o=_e(n);if(t.extractMode.enabled){if(!Ae()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}E=!0,Ke(o.x,o.y,n.button===2||n.altKey);return}if(t.maskMode.enabled){m=!0,We(),$e(o.x,o.y);return}if(t.pathMode.enabled){Me(o);return}z=!0,le=o.x,ue=o.y;const l=Y(t.currentLayer);Q=l.x,se=l.y}function Ue(n){const o=_e(n);if(t.extractMode.enabled&&E){Ke(o.x,o.y,(n.buttons&2)===2||n.altKey);return}if(m&&t.maskMode.enabled){$e(o.x,o.y);return}if(Te&&pe>=0){qe(o);return}if(!z||!t.currentLayer)return;let l=o.x-le,c=o.y-ue;n.shiftKey&&(Math.abs(l)>Math.abs(c)?c=0:l=0);const d=Q+l,u=se+c;K(t.currentLayer,"x",d),K(t.currentLayer,"y",u),L()}function K(n,o,l){const c=t.currentTime;if(n.keyframes&&n.keyframes[o]&&n.keyframes[o].length>0){const d=n.keyframes[o].findIndex(u=>Math.abs(u.time-c)<.05);d>=0?n.keyframes[o][d]={time:n.keyframes[o][d].time,value:l}:(n.keyframes[o].push({time:c,value:l}),n.keyframes[o].sort((u,h)=>u.time-h.time))}t.updateLayer(t.currentLayerIndex,{[o]:l})}function We(){const n=t.currentLayer;if(!(!n||!n.img)){if(n.maskCanvas)g=n.maskCanvas.getContext("2d");else if(n.maskCanvas=document.createElement("canvas"),n.maskCanvas.width=n.img.width,n.maskCanvas.height=n.img.height,g=n.maskCanvas.getContext("2d"),g)if(n.customMask){const o=new Image;o.onload=()=>{g==null||g.drawImage(o,0,0),L()},o.src=n.customMask}else g.globalCompositeOperation="source-over",g.fillStyle="white",g.fillRect(0,0,n.maskCanvas.width,n.maskCanvas.height)}}function $e(n,o){const l=t.currentLayer;if(!l||((!g||!l.maskCanvas)&&We(),!l.img||!g||!l.maskCanvas))return;const c=Y(l),d=t.project.width/2+c.x,u=t.project.height/2+c.y,h=(n-d)/c.scale+l.img.width/2,x=(o-u)/c.scale+l.img.height/2,y=t.maskMode.brush||20;g.save(),g.beginPath(),g.arc(h,x,y,0,Math.PI*2),t.maskMode.erase?(g.globalCompositeOperation="source-over",g.fillStyle="white"):(g.globalCompositeOperation="destination-out",g.fillStyle="black"),g.fill(),g.restore(),L()}function Ae(){const n=t.layers.find(l=>l.type==="background");if(!n)return null;const o=N(n);return o?((!b||!I||b.width!==o.width||b.height!==o.height||P!==n.id)&&(b=document.createElement("canvas"),b.width=o.width,b.height=o.height,I=b.getContext("2d"),I&&I.clearRect(0,0,o.width,o.height),P=n.id||null),{layer:n,img:o,ctx:I}):null}function Ke(n,o,l=!1){const c=Ae();if(!c)return;const{layer:d,img:u,ctx:h}=c,x=Y(d),y=t.project.width/2+(x.x??0),w=t.project.height/2+(x.y??0),U=x.scale??1,F=(n-y)/U+u.width/2,W=(o-w)/U+u.height/2,re=Math.max(1,t.extractMode.brush||30);h.beginPath(),h.arc(F,W,re,0,Math.PI*2),h.fillStyle=l?"black":"white",h.fill(),L()}function Oe(n){if(!t.extractMode.enabled||!b||!P)return;const o=t.layers.find(h=>h.id===P);if(!o)return;const l=N(o);if(!l)return;const c=Y(o);n.save(),n.translate(t.project.width/2+(c.x??0),t.project.height/2+(c.y??0)),n.rotate((c.rotation??0)*Math.PI/180),n.scale(c.scale??1,c.scale??1);const d=-l.width/2,u=-l.height/2;n.fillStyle="rgba(0, 0, 0, 0.65)",n.fillRect(d,u,l.width,l.height),n.globalCompositeOperation="destination-out",n.drawImage(b,d,u,l.width,l.height),n.restore()}function Ge(){I&&b&&(I.clearRect(0,0,b.width,b.height),L())}function Ve(){if(!I||!b)return!1;const n=I.getImageData(0,0,b.width,b.height).data;for(let o=0;o<n.length;o+=4)if(n[o]>10)return!0;return!1}function Ze(n,o,l){const c=n.canvas,d=document.createElement("canvas");d.width=o,d.height=l;const u=d.getContext("2d");if(!u)return null;u.drawImage(c,0,0);const h=20;u.globalCompositeOperation="destination-over";for(let x=0;x<h;x++)u.drawImage(d,1,0),u.drawImage(d,-1,0),u.drawImage(d,0,1),u.drawImage(d,0,-1),x%2===0&&(u.drawImage(d,1,1),u.drawImage(d,-1,-1),u.drawImage(d,1,-1),u.drawImage(d,-1,1));for(let x=0;x<10;x++)u.drawImage(d,2,0),u.drawImage(d,-2,0),u.drawImage(d,0,2),u.drawImage(d,0,-2),u.drawImage(d,2,2),u.drawImage(d,-2,-2),u.drawImage(d,2,-2),u.drawImage(d,-2,2);return d.toDataURL("image/png")}function ve(){const n=Ae();if(!n||!b||!I)return{error:"背景图层尚未准备好"};if(!Ve())return null;const{img:o}=n,l=document.createElement("canvas");l.width=o.width,l.height=o.height;const c=l.getContext("2d");if(!c)return{error:"无法创建临时画布"};c.drawImage(o,0,0),c.globalCompositeOperation="destination-in",c.drawImage(b,0,0);const d=l.toDataURL("image/png"),u=document.createElement("canvas");u.width=o.width,u.height=o.height;const h=u.getContext("2d");if(!h)return{error:"无法创建背景画布"};h.drawImage(o,0,0),h.globalCompositeOperation="destination-out",h.drawImage(b,0,0),h.globalCompositeOperation="source-over";const x=Ze(h,o.width,o.height)||o.src,y=b.toDataURL("image/png");return{foregroundDataUrl:d,backgroundDataUrl:x,extractMaskDataUrl:y}}function Me(n,o){const l=t.currentLayer;if(!l)return;l.bezierPath||(l.bezierPath=[]);const c=Re(n);if(c>=0)pe=c,Te=!0;else{const d=t.project.width/2,u=t.project.height/2;l.bezierPath.push({x:n.x-d,y:n.y-u}),l.bezierPath.length>=2&&(l.usePathAnimation=!0),L()}}function Re(n){const o=t.currentLayer;if(!o||!o.bezierPath)return-1;const l=t.project.width/2,c=t.project.height/2,d=10;for(let u=0;u<o.bezierPath.length;u++){const h=o.bezierPath[u],x=h.x+l-n.x,y=h.y+c-n.y;if(Math.sqrt(x*x+y*y)<d)return u}return-1}function qe(n){const o=t.currentLayer;if(!o||!o.bezierPath||pe<0)return;const l=t.project.width/2,c=t.project.height/2;o.bezierPath[pe].x=n.x-l,o.bezierPath[pe].y=n.y-c,L()}function Le(){z=!1,m=!1,E=!1,Te=!1,pe=-1}function Ne(n){if(!t.currentLayer)return;const o=n.deltaY>0?-.05:.05,l=t.currentLayer;if(n.shiftKey){const d=Y(l).rotation+(o>0?5:-5);K(l,"rotation",d)}else if(n.altKey){const c=Y(l),d=Math.max(0,Math.min(1,c.opacity+o));K(l,"opacity",d)}else{const c=Y(l),d=Math.max(.1,Math.min(5,c.scale+o));K(l,"scale",d)}L()}function Be(n){if(!t.currentLayer)return;const o=n.shiftKey?10:1,l=t.currentLayer,c=Y(l);switch(n.key){case"ArrowLeft":K(l,"x",c.x-o),L(),n.preventDefault();break;case"ArrowRight":K(l,"x",c.x+o),L(),n.preventDefault();break;case"ArrowUp":K(l,"y",c.y-o),L(),n.preventDefault();break;case"ArrowDown":K(l,"y",c.y+o),L(),n.preventDefault();break;case"r":case"R":K(l,"x",0),K(l,"y",0),K(l,"scale",1),K(l,"rotation",0),K(l,"opacity",1),L(),n.preventDefault();break;case"Delete":case"Backspace":confirm("删除当前图层?")&&t.removeLayer(t.currentLayerIndex),n.preventDefault();break}}return M({clearExtractSelection:Ge,applyExtractSelection:ve}),(n,o)=>(R(),A("div",{class:"canvas-preview",ref_key:"containerRef",ref:V},[r("div",mt,[Ee(r("canvas",{ref_key:"gpuCanvasRef",ref:G,width:p(t).project.width,height:p(t).project.height,onMousedown:De,onMousemove:Ue,onMouseup:Le,onMouseleave:Le,onWheel:ae(Ne,["prevent"]),onContextmenu:o[0]||(o[0]=ae(()=>{},["prevent"])),tabindex:"0",onKeydown:Be},null,40,pt),[[et,$.value]]),Ee(r("canvas",{ref_key:"canvasRef",ref:j,width:p(t).project.width,height:p(t).project.height,onMousedown:De,onMousemove:Ue,onMouseup:Le,onMouseleave:Le,onWheel:ae(Ne,["prevent"]),onContextmenu:o[1]||(o[1]=ae(()=>{},["prevent"])),tabindex:"0",onKeydown:Be},null,40,ht),[[et,!$.value]]),r("div",yt,[p(t).currentLayer?(R(),A("span",vt,[$.value?(R(),A("span",gt,"GPU")):Ie("",!0),it(" Layer "+S(p(t).currentLayerIndex+1)+" | X:"+S(Math.round(p(t).currentLayer.x||0))+" Y:"+S(Math.round(p(t).currentLayer.y||0))+" S:"+S((p(t).currentLayer.scale||1).toFixed(2))+" R:"+S(Math.round(p(t).currentLayer.rotation||0))+"° ",1)])):(R(),A("span",kt,"No layer selected"))])])],512))}}),wt=at(bt,[["__scopeId","data-v-22fe3123"]]),xt={class:"ae-timeline-root"},_t={class:"ae-header"},Mt={class:"header-center"},Lt={class:"project-info"},Ct={class:"header-right"},Pt={class:"project-inputs"},It={class:"project-field"},Et=["value"],jt={class:"project-field"},St=["value"],Tt={class:"project-field"},Dt=["value"],At={class:"project-field"},Rt=["value"],zt={class:"ae-main"},Xt={class:"ae-inspector"},Ft={key:0,class:"inspector-card"},Yt={class:"card-header"},Ut={class:"layer-title"},Wt={class:"card-subtitle"},$t={key:1,class:"inspector-card empty"},Kt={key:2,class:"inspector-section"},Ot={class:"property-list"},Nt={class:"property-row"},Bt=["value"],Gt={class:"property-row"},Vt=["value"],Zt={class:"property-row"},qt=["value"],Ht={class:"property-row"},Jt=["value"],Qt={class:"property-row slider-row"},en={class:"slider-header"},tn={class:"prop-value"},nn=["value"],an={class:"inspector-section"},sn={class:"tools-grid"},on=["disabled"],rn={key:0,class:"tool-settings"},ln={class:"slider-header"},cn={class:"prop-value"},un={key:1,class:"tool-settings"},dn={class:"slider-header"},fn={class:"prop-value"},mn={class:"inspector-section"},pn={class:"fit-row"},hn={class:"ae-viewport"},yn={class:"viewport-bar"},vn={class:"duration-text"},gn={class:"viewport-actions"},kn={class:"time-text"},bn={class:"zoom-control"},wn={class:"prop-value"},xn={class:"viewport-canvas"},_n={class:"ae-timeline"},Mn={class:"timeline-controls"},Ln={class:"controls-left"},Cn=["disabled"],Pn=["disabled"],In={class:"controls-center"},En={class:"time-display"},jn={class:"playback-btns"},Sn={class:"timeline-body"},Tn={class:"layers-panel"},Dn={class:"layers-header"},An=["onClick"],Rn=["onClick"],zn={class:"layer-name"},Xn={class:"layer-btns"},Fn=["onClick"],Yn=["onClick"],Un={class:"tick-text"},Wn=["onClick"],$n=["onClick"],Kn=["onDblclick"],On=["title","onMousedown","onClick","onContextmenu"],Ye=80,Nn=tt({__name:"TimelineApp",props:{node:{}},setup(T){const M=T,t=st(),j=D(null),G=D(),V=D(),z=D(),le=D(0);let ue="foreground",Q=!1,se=null;const $=s=>{var e,a;return(a=(e=M.node)==null?void 0:e.widgets)==null?void 0:a.find(i=>i.name===s)};function Z(s,e){const a=typeof s=="number"?s:parseFloat(s);return Number.isFinite(a)?a:e}const B=D("fit"),ee=D(100),we=ye(()=>Math.max(.1,ee.value/100));function xe(s){var e;if(s.code==="Space"){const a=(e=s.target)==null?void 0:e.tagName;if(a==="INPUT"||a==="TEXTAREA"||a==="SELECT")return;s.preventDefault(),s.stopPropagation(),t.togglePlayback()}}const te=ye(()=>{const s=Math.max(1,t.project.fps||1);return t.project.duration||t.project.total_frames/s||0}),L=ye(()=>{var i;const s=Math.max(.001,te.value||0),e=le.value||((i=z.value)==null?void 0:i.clientWidth)||0,a=e?e/s:Ye;return Math.max(Ye,a)}),je=ye(()=>{var f;const a=te.value*L.value+120,i=le.value||((f=z.value)==null?void 0:f.clientWidth)||0;return Math.max(a,i,800)});Qe(()=>t.extractMode.enabled,s=>{var e,a;s||(a=(e=j.value)==null?void 0:e.clearExtractSelection)==null||a.call(e)});function N(){var f;if(!z.value){setTimeout(N,100);return}const s=z.value.getBoundingClientRect(),e=((f=z.value.parentElement)==null?void 0:f.clientWidth)||s.width||0,a=typeof window<"u"?window.innerWidth:e,i=Math.max(e||a,800);i>0&&(le.value=i)}nt(()=>{Ke(),N(),typeof ResizeObserver<"u"&&z.value?(se=new ResizeObserver(s=>{const e=s[0];e!=null&&e.contentRect&&(le.value=e.contentRect.width)}),se.observe(z.value)):window.addEventListener("resize",N),window.addEventListener("keydown",xe,{capture:!0})});let X=!1,H=null;const Y=D(new Set([0])),J=D(null),de=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"scale",label:"Scl"},{key:"rotation",label:"Rot"},{key:"opacity",label:"Op"}],oe=ye(()=>{const s=t.currentLayer;if(!s)return{x:0,y:0,scale:1,rotation:0,opacity:1};const e=t.currentTime,a=s.keyframes||{};return{x:ce(a.x,e,s.x||0),y:ce(a.y,e,s.y||0),scale:ce(a.scale,e,s.scale||1),rotation:ce(a.rotation,e,s.rotation||0),opacity:ce(a.opacity,e,s.opacity??1)}});function ce(s,e,a){if(!s||s.length===0)return a;const i=[...s].sort((f,v)=>f.time-v.time);if(e<=i[0].time)return i[0].value;if(e>=i[i.length-1].time)return i[i.length-1].value;for(let f=0;f<i.length-1;f++)if(e>=i[f].time&&e<=i[f+1].time){const v=(e-i[f].time)/(i[f+1].time-i[f].time);return i[f].value+(i[f+1].value-i[f].value)*v}return a}function fe(s,e){const a=t.currentLayer;if(!a)return;const i=parseFloat(e.target.value);if(isNaN(i))return;const f=t.currentTime;if(a.keyframes&&a.keyframes[s]&&a.keyframes[s].length>0){const v=a.keyframes[s].findIndex(k=>Math.abs(k.time-f)<.05);v>=0?a.keyframes[s][v]={time:a.keyframes[s][v].time,value:i}:(a.keyframes[s].push({time:f,value:i}),a.keyframes[s].sort((k,C)=>k.time-C.time))}t.updateLayer(t.currentLayerIndex,{[s]:i})}function Se(s){const e=t.currentLayer;if(!e)return;const a=parseFloat(s.target.value);if(isNaN(a))return;const i=a/100,f=t.currentTime;if(e.keyframes&&e.keyframes.scale&&e.keyframes.scale.length>0){const v=e.keyframes.scale.findIndex(k=>Math.abs(k.time-f)<.05);v>=0?e.keyframes.scale[v]={time:e.keyframes.scale[v].time,value:i}:(e.keyframes.scale.push({time:f,value:i}),e.keyframes.scale.sort((k,C)=>k.time-C.time))}t.updateLayer(t.currentLayerIndex,{scale:i})}function me(s){const e=Math.floor(s/60),a=Math.floor(s%60),i=Math.floor(s%1*t.project.fps);return`${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}function _e(s,e){return!s.keyframes||!s.keyframes[e]?[]:s.keyframes[e].map(a=>({time:a.time,value:a.value}))}function m(s){const e=[];if(!s.keyframes)return e;for(const a of de){const i=s.keyframes[a.key];i&&i.forEach(f=>e.push({time:f.time,prop:a.key}))}return e}function g(s,e){return e==="opacity"||e==="scale"?(s*100).toFixed(0)+"%":s.toFixed(1)}function b(s){Y.value.has(s)?Y.value.delete(s):Y.value.add(s)}function I(s){var e,a;s.hidden=!s.hidden,(a=(e=j.value)==null?void 0:e.scheduleRender)==null||a.call(e)}function E(s){if(!z.value)return 0;const e=z.value.querySelector(".tracks-content");if(!e)return 0;const a=e.getBoundingClientRect(),i=z.value.scrollLeft,f=s.clientX-a.left+i,v=L.value||Ye;if(f<=10)return 0;const k=f/v;return Math.max(0,Math.min(k,te.value))}function P(s){s.preventDefault(),Q=!0,t.setCurrentTime(E(s));const e=i=>{Q&&t.setCurrentTime(E(i))},a=()=>{Q=!1,document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",e),document.addEventListener("mouseup",a)}function Te(s){if(!t.currentLayer)return;const e=E(s);t.setCurrentTime(e),t.addKeyframe()}function pe(s,e,a){const f=s.currentTarget.getBoundingClientRect(),v=s.clientX-f.left,k=L.value||Ye,C=Math.max(0,v/k),_=t.layers[e];if(!_)return;const O=_[a]??(a==="scale"||a==="opacity"?1:0);_.keyframes||(_.keyframes={}),_.keyframes[a]||(_.keyframes[a]=[]),_.keyframes[a].find(ie=>Math.abs(ie.time-C)<.05)||(_.keyframes[a].push({time:C,value:O}),_.keyframes[a].sort((ie,ne)=>ie.time-ne.time))}function De(s,e,a){J.value={layerIdx:s,prop:e,time:a},t.selectLayer(s),t.setCurrentTime(a)}function Ue(s,e,a){const i=J.value;return i?i.layerIdx===s&&i.prop===e&&Math.abs(i.time-a)<.01:!1}function K(s,e,a,i){s.preventDefault(),X=!0,H={layerIdx:e,prop:a,originalTime:i.time},De(e,a,i.time);const f=s.clientX,v=i.time,k=L.value||Ye,C=O=>{var ze;if(!X||!H)return;const ie=(O.clientX-f)/k;let ne=Math.max(0,v+ie);const ke=t.layers[H.layerIdx];if((ze=ke==null?void 0:ke.keyframes)!=null&&ze[H.prop]){const Xe=ke.keyframes[H.prop],Fe=Xe.findIndex(Ce=>Math.abs(Ce.time-H.originalTime)<.01);Fe>=0&&(Xe[Fe].time=ne,H.originalTime=ne,J.value.time=ne,t.setCurrentTime(ne))}},_=()=>{var ge;X=!1,H=null,document.removeEventListener("mousemove",C),document.removeEventListener("mouseup",_);const O=t.layers[e];(ge=O==null?void 0:O.keyframes)!=null&&ge[a]&&O.keyframes[a].sort((ie,ne)=>ie.time-ne.time)};document.addEventListener("mousemove",C),document.addEventListener("mouseup",_)}function We(s,e,a){var f,v,k,C;const i=t.layers[s];(f=i==null?void 0:i.keyframes)!=null&&f[e]&&(i.keyframes[e]=i.keyframes[e].filter(_=>Math.abs(_.time-a)>.01),((v=J.value)==null?void 0:v.layerIdx)===s&&((k=J.value)==null?void 0:k.prop)===e&&Math.abs(((C=J.value)==null?void 0:C.time)-a)<.01&&(J.value=null))}function $e(s){if(z.value){const e=s.target,a=z.value.querySelector(".tracks-list");a&&(a.scrollTop=e.scrollTop)}}function Ae(s){const e=s.target,a=document.querySelector(".layers-list");a&&(a.scrollTop=e.scrollTop)}function Ke(){var O,ge,ie,ne,ke,ze,Xe,Fe;if(!((O=M.node)!=null&&O.widgets))return;const s=Z((ge=$("width"))==null?void 0:ge.value,t.project.width),e=Z((ie=$("height"))==null?void 0:ie.value,t.project.height),a=Math.max(1,Z((ne=$("fps"))==null?void 0:ne.value,t.project.fps)),i=Math.max(1,Math.round(Z((ke=$("total_frames"))==null?void 0:ke.value,t.project.total_frames))),f=Z((ze=$("mask_expansion"))==null?void 0:ze.value,t.project.mask_expansion),v=Z((Xe=$("mask_feather"))==null?void 0:Xe.value,t.project.mask_feather);let k=[];const C=(Fe=$("layers_keyframes"))==null?void 0:Fe.value;if(typeof C=="string"&&C.trim())try{const Ce=JSON.parse(C);Array.isArray(Ce)&&(k=Ce)}catch(Ce){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",Ce)}else Array.isArray(C)&&(k=C);const _={width:s,height:e,fps:a,total_frames:i,duration:i/a,mask_expansion:f,mask_feather:v};t.loadAnimation({project:_,layers:k}),t.layers.length>0&&t.currentLayerIndex<0&&t.selectLayer(0)}function Oe(s,e){return s.name?s.name:s.type==="background"?"Background":`Layer ${e+1}`}function Ge(){const s=t.exportAnimation(),e=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),a=URL.createObjectURL(e),i=document.createElement("a");i.href=a,i.download=`ae_project_${Date.now()}.json`,i.click(),URL.revokeObjectURL(a)}function Ve(){var s;(s=V.value)==null||s.click()}function Ze(s){var i;const e=(i=s.target.files)==null?void 0:i[0];if(!e)return;const a=new FileReader;a.onload=f=>{var v;try{const k=JSON.parse((v=f.target)==null?void 0:v.result);t.loadAnimation(k),console.log("Project loaded successfully")}catch(k){console.error("Failed to parse project file",k),alert("Project file is corrupted or has invalid format")}},a.readAsText(e),V.value&&(V.value.value="")}function ve(s,e){const i=(f=>{var v,k;return(k=(v=M.node)==null?void 0:v.widgets)==null?void 0:k.find(C=>C.name===f)})(s);i&&(i.value=e,i.inputEl&&(i.inputEl.value=e,i.inputEl.dispatchEvent(new Event("input"))),i.callback&&i.callback(e))}function Me(s,e){const a=parseInt(e.target.value,10);if(Number.isNaN(a))return;let i=a;s==="fps"&&(i=Math.max(1,i)),s==="total_frames"&&(i=Math.max(1,i)),(s==="width"||s==="height")&&(i=Math.max(16,i)),t.setProject({[s]:i}),ve(s,i),t.setCurrentTime(t.currentTime)}function Re(){var i,f,v,k,C;if(!((i=M.node)!=null&&i.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}console.log("[AE Timeline] Saving..."),t.layers.forEach(_=>{_.maskCanvas&&(_.customMask=_.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${_.id}: Saved mask (len=${_.customMask.length})`))});const s=t.exportAnimation();s.layers.forEach(_=>{_.bezierPath&&_.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${_.id}: Exporting Path with ${_.bezierPath.length} points`)});const a=(_=>M.node.widgets.find(O=>O.name===_))("layers_keyframes");if(a){const _=JSON.stringify(s.layers);if(a.value=_,console.log(`[AE Timeline] Saved layers_keyframes (len=${_.length})`),a.inputEl&&(a.inputEl.value=_,a.inputEl.dispatchEvent(new Event("input"))),a.callback&&a.callback(_),M.node.widgets_values){const O=M.node.widgets.indexOf(a);O>=0&&(M.node.widgets_values[O]=_)}(v=(f=M.node).setDirtyCanvas)==null||v.call(f,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");ve("width",t.project.width),ve("height",t.project.height),ve("fps",t.project.fps),ve("total_frames",t.project.total_frames),(C=(k=M.node).setDirtyCanvas)==null||C.call(k,!0,!1)}function qe(){Re();const s=document.querySelector(".ae-timeline-dialog");s&&s.close()}function Le(){t.addKeyframe()}function Ne(){t.deleteKeyframe()}function Be(){t.setCurrentTime(0)}function n(){t.setCurrentTime(te.value)}function o(){if(!t.currentLayer||!confirm("纭畾瑕佹竻闄ゅ綋鍓嶅浘灞傜殑鎵€鏈夊叧閿抚鍚楋紵"))return;const s=t.currentLayer;["x","y","scale","rotation","opacity","mask_size"].forEach(a=>{var i;(i=s.keyframes)!=null&&i[a]&&(s.keyframes[a]=[])})}function l(){t.layers.forEach((s,e)=>{e!==t.currentLayerIndex&&(s._cachedImage&&delete s._cachedImage,console.log(`[AE Timeline] Cleared cache for layer ${s.id}`))})}function c(){var s,e;(e=(s=j.value)==null?void 0:s.scheduleRender)==null||e.call(s),console.log("[AE Timeline] Preview refreshed")}function d(){var s,e;M.node&&M.node.graph&&window.app&&((e=(s=window.app).queuePrompt)==null||e.call(s,0))}function u(s){var f,v;const e={mask:t.maskMode,path:t.pathMode,extract:t.extractMode},a=e[s],i=!a.enabled;if(s==="extract"&&i&&!t.layers.find(C=>C.type==="background")){alert("Add a background layer before using extract");return}Object.entries(e).forEach(([k,C])=>{k!==s&&(C.enabled=!1)}),(!i||s!=="extract")&&((v=(f=j.value)==null?void 0:f.clearExtractSelection)==null||v.call(f)),a.enabled=i}function h(){var s,e;(e=(s=j.value)==null?void 0:s.clearExtractSelection)==null||e.call(s)}function x(){var f,v;const s=j.value;if(!s||typeof s.applyExtractSelection!="function")return;const e=s.applyExtractSelection();if(!e){alert("Draw an extract selection first");return}if("error"in e){alert(e.error);return}const a=new Image;a.onload=()=>{const k=t.layers.filter(C=>{var _;return(_=C.id)==null?void 0:_.startsWith("extracted_")}).length;t.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${k+1}`,type:"foreground",image_data:e.foregroundDataUrl,img:a,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},a.src=e.foregroundDataUrl;const i=t.layers.find(k=>k.type==="background");if(i&&e.backgroundDataUrl){const k=new Image;k.onload=()=>{i.image_data=e.backgroundDataUrl,i.img=k,t.updateLayer(t.layers.indexOf(i),{image_data:e.backgroundDataUrl})},k.src=e.backgroundDataUrl}t.extractMode.enabled=!1,(v=(f=j.value)==null?void 0:f.clearExtractSelection)==null||v.call(f)}function y(){var s;ue="foreground",(s=G.value)==null||s.click()}function w(){var s;ue="background",(s=G.value)==null||s.click()}function U(s){const e=s.target.files;e&&(Array.from(e).forEach((a,i)=>{const f=new FileReader;f.onload=v=>{var _;const k=(_=v.target)==null?void 0:_.result,C=new Image;C.onload=()=>{t.addLayer({id:"uploaded_"+Date.now()+"_"+i,name:a.name.replace(/\.[^/.]+$/,""),type:ue,image_data:k,img:C,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},C.src=k},f.readAsDataURL(a)}),G.value&&(G.value.value=""))}function F(){re(-1)}function W(){re(1)}function re(s){const e=t.currentLayerIndex;if(e<0)return;const a=e+s;if(a>=0&&a<t.layers.length){const i=t.layers[e];t.layers.splice(e,1),t.layers.splice(a,0,i),t.selectLayer(a)}}return lt(()=>{se&&z.value&&(se.disconnect(),se=null),window.removeEventListener("resize",N),window.removeEventListener("keydown",xe,{capture:!0}),Re()}),(s,e)=>(R(),A("div",xt,[r("header",_t,[r("div",{class:"header-left"},[e[18]||(e[18]=r("div",{class:"logo"},[r("div",{class:"logo-icon"},"AE"),r("span",{class:"logo-text"},"AE Animator")],-1)),e[19]||(e[19]=r("div",{class:"header-divider"},null,-1)),r("button",{class:"btn btn-ghost",onClick:Ge,title:"保存工程文件"},"Save"),r("button",{class:"btn btn-ghost",onClick:Ve,title:"加载工程文件"},"Load")]),r("div",Mt,[r("span",Lt,S(p(t).project.width)+"x"+S(p(t).project.height)+" @ "+S(p(t).project.fps)+" FPS",1)]),r("div",Ct,[r("div",Pt,[r("div",It,[e[20]||(e[20]=r("span",{class:"field-label"},"W",-1)),r("input",{type:"number",min:"16",max:"8192",value:p(t).project.width,onInput:e[0]||(e[0]=a=>Me("width",a))},null,40,Et)]),r("div",jt,[e[21]||(e[21]=r("span",{class:"field-label"},"H",-1)),r("input",{type:"number",min:"16",max:"8192",value:p(t).project.height,onInput:e[1]||(e[1]=a=>Me("height",a))},null,40,St)]),r("div",Tt,[e[22]||(e[22]=r("span",{class:"field-label"},"FPS",-1)),r("input",{type:"number",min:"1",max:"240",value:p(t).project.fps,onInput:e[2]||(e[2]=a=>Me("fps",a))},null,40,Dt)]),r("div",At,[e[23]||(e[23]=r("span",{class:"field-label"},"Frames",-1)),r("input",{type:"number",min:"1",value:p(t).project.total_frames,onInput:e[3]||(e[3]=a=>Me("total_frames",a))},null,40,Rt)])]),r("button",{class:"btn btn-primary",onClick:y},"+ FG Layer"),r("button",{class:"btn btn-secondary",onClick:w},"+ BG Layer"),e[24]||(e[24]=r("div",{class:"header-divider"},null,-1)),r("button",{class:"btn btn-accent",onClick:Re,title:"保存到节点"},"Save"),r("button",{class:"btn btn-close",onClick:qe,title:"关闭"},"Close")])]),r("div",zt,[r("aside",Xt,[p(t).currentLayer?(R(),A("div",Ft,[r("div",Yt,[r("span",Ut,S(Oe(p(t).currentLayer,p(t).currentLayerIndex)),1),r("span",{class:q(["layer-badge",p(t).currentLayer.type])},S(p(t).currentLayer.type==="background"?"BG":"FG"),3)]),r("div",Wt," Layer "+S(p(t).currentLayerIndex+1)+" - "+S(p(t).currentLayer.type==="background"?"Background":"Foreground"),1)])):(R(),A("div",$t,[...e[25]||(e[25]=[r("span",null,"请选择一个图层",-1)])])),p(t).currentLayer?(R(),A("div",Kt,[e[33]||(e[33]=r("div",{class:"section-title"},"Transform",-1)),r("div",Ot,[r("div",Nt,[e[26]||(e[26]=r("span",{class:"prop-label"},"Position X",-1)),r("input",{type:"number",class:"prop-input",value:oe.value.x.toFixed(0),onInput:e[4]||(e[4]=a=>fe("x",a)),step:"1"},null,40,Bt)]),r("div",Gt,[e[27]||(e[27]=r("span",{class:"prop-label"},"Position Y",-1)),r("input",{type:"number",class:"prop-input",value:oe.value.y.toFixed(0),onInput:e[5]||(e[5]=a=>fe("y",a)),step:"1"},null,40,Vt)]),r("div",Zt,[e[28]||(e[28]=r("span",{class:"prop-label"},"Scale",-1)),r("input",{type:"number",class:"prop-input",value:(oe.value.scale*100).toFixed(0),onInput:e[6]||(e[6]=a=>Se(a)),step:"1"},null,40,qt),e[29]||(e[29]=r("span",{class:"prop-unit"},"%",-1))]),r("div",Ht,[e[30]||(e[30]=r("span",{class:"prop-label"},"Rotation",-1)),r("input",{type:"number",class:"prop-input",value:oe.value.rotation.toFixed(0),onInput:e[7]||(e[7]=a=>fe("rotation",a)),step:"1"},null,40,Jt),e[31]||(e[31]=r("span",{class:"prop-unit"},"deg",-1))]),r("div",Qt,[r("div",en,[e[32]||(e[32]=r("span",{class:"prop-label"},"Opacity",-1)),r("span",tn,S((oe.value.opacity*100).toFixed(0))+"%",1)]),r("input",{type:"range",class:"prop-slider",value:oe.value.opacity,onInput:e[8]||(e[8]=a=>fe("opacity",a)),min:"0",max:"1",step:"0.01"},null,40,nn)])])])):Ie("",!0),r("div",an,[e[36]||(e[36]=r("div",{class:"section-title"},"Tools",-1)),r("div",sn,[r("button",{class:q(["tool-btn",{active:p(t).maskMode.enabled}]),onClick:e[9]||(e[9]=a=>u("mask"))},"Mask Mode",2),r("button",{class:q(["tool-btn",{active:p(t).maskMode.enabled&&p(t).maskMode.erase}]),onClick:e[10]||(e[10]=a=>p(t).maskMode.erase=!p(t).maskMode.erase),disabled:!p(t).maskMode.enabled},"Eraser",10,on),r("button",{class:q(["tool-btn",{active:p(t).pathMode.enabled}]),onClick:e[11]||(e[11]=a=>u("path"))},"Path Tool",2),r("button",{class:q(["tool-btn",{active:p(t).extractMode.enabled}]),onClick:e[12]||(e[12]=a=>u("extract"))},"AI Extract",2)]),p(t).maskMode.enabled?(R(),A("div",rn,[r("div",ln,[e[34]||(e[34]=r("span",{class:"prop-label"},"Brush Size",-1)),r("span",cn,S(p(t).maskMode.brush)+"px",1)]),Ee(r("input",{type:"range",class:"prop-slider","onUpdate:modelValue":e[13]||(e[13]=a=>p(t).maskMode.brush=a),min:"1",max:"100",step:"1"},null,512),[[He,p(t).maskMode.brush,void 0,{number:!0}]])])):Ie("",!0),p(t).extractMode.enabled?(R(),A("div",un,[r("div",dn,[e[35]||(e[35]=r("span",{class:"prop-label"},"Brush Size",-1)),r("span",fn,S(p(t).extractMode.brush)+"px",1)]),Ee(r("input",{type:"range",class:"prop-slider","onUpdate:modelValue":e[14]||(e[14]=a=>p(t).extractMode.brush=a),min:"5",max:"150",step:"1"},null,512),[[He,p(t).extractMode.brush,void 0,{number:!0}]]),r("div",{class:"extract-actions"},[r("button",{class:"btn btn-small btn-primary",onClick:x},"Apply"),r("button",{class:"btn btn-small btn-ghost",onClick:h},"Clear")])])):Ie("",!0)]),r("div",mn,[e[39]||(e[39]=r("div",{class:"section-title"},"Actions",-1)),r("div",{class:"action-row"},[r("button",{class:"btn btn-small btn-ghost",onClick:l},"Clear Cache"),r("button",{class:"btn btn-small btn-ghost",onClick:c},"Refresh"),r("button",{class:"btn btn-small btn-accent",onClick:d},"Run")]),r("div",pn,[e[38]||(e[38]=r("span",{class:"prop-label"},"Fit Mode",-1)),Ee(r("select",{class:"fit-select","onUpdate:modelValue":e[15]||(e[15]=a=>B.value=a)},[...e[37]||(e[37]=[r("option",{value:"fit"},"Fit",-1),r("option",{value:"fill"},"Fill",-1),r("option",{value:"stretch"},"Stretch",-1)])],512),[[ct,B.value]])])])]),r("main",hn,[r("div",yn,[r("span",vn,"Duration: "+S(me(te.value)),1),r("div",gn,[r("span",kn,S(me(p(t).currentTime)),1),r("div",bn,[e[40]||(e[40]=r("span",{class:"prop-label"},"Zoom",-1)),Ee(r("input",{type:"range",min:"25",max:"200",step:"5","onUpdate:modelValue":e[16]||(e[16]=a=>ee.value=a)},null,512),[[He,ee.value,void 0,{number:!0}]]),r("span",wn,S(ee.value)+"%",1)])])]),r("div",xn,[r("div",{class:"canvas-zoom",style:he({transform:`scale(${we.value})`})},[ut(wt,{ref_key:"canvasPreviewRef",ref:j,fitMode:B.value},null,8,["fitMode"])],4)])])]),r("footer",_n,[r("div",Mn,[r("div",Ln,[r("button",{class:"btn btn-small btn-ghost",onClick:Le},"+ Keyframe"),r("button",{class:"btn btn-small btn-ghost",onClick:Ne},"Del Key"),r("button",{class:"btn btn-small btn-ghost",onClick:o},"Clear All"),e[41]||(e[41]=r("div",{class:"controls-divider"},null,-1)),r("button",{class:"nav-btn",onClick:F,disabled:!p(t).currentLayer},"Up",8,Cn),r("button",{class:"nav-btn",onClick:W,disabled:!p(t).currentLayer},"Down",8,Pn)]),r("div",In,[r("span",En,S(me(p(t).currentTime)),1),r("div",jn,[r("button",{class:"pb-btn",onClick:Be},"|<"),r("button",{class:q(["play-btn",{playing:p(t).isPlaying}]),onClick:e[17]||(e[17]=(...a)=>p(t).togglePlayback&&p(t).togglePlayback(...a))},S(p(t).isPlaying?"Pause":"Play"),3),r("button",{class:"pb-btn",onClick:n},">|")])])]),r("div",Sn,[r("div",Tn,[r("div",Dn,"Layers ("+S(p(t).layers.length)+")",1),r("div",{class:"layers-list",onScroll:$e},[(R(!0),A(be,null,Pe(p(t).layers,(a,i)=>(R(),A("div",{key:a.id,class:q(["layer-item",{active:i===p(t).currentLayerIndex}]),onClick:f=>p(t).selectLayer(i)},[r("span",{class:"expand-icon",onClick:ae(f=>b(i),["stop"])},S(Y.value.has(i)?"v":">"),9,Rn),r("span",{class:q(["layer-type",a.type])},S(a.type==="background"?"B":"F"),3),r("span",zn,S(Oe(a,i)),1),r("span",Xn,[r("span",{class:q(["vis-icon",{off:a.hidden}]),onClick:ae(f=>I(a),["stop"])},"eye",10,Fn),r("span",{class:"del-icon",onClick:ae(f=>p(t).removeLayer(i),["stop"])},"x",8,Yn)])],10,An))),128))],32)]),r("div",{class:"tracks-panel",ref_key:"timelineRef",ref:z},[r("div",{class:"tracks-content",style:he({width:je.value+"px"})},[r("div",{class:"ruler",onMousedown:P},[(R(!0),A(be,null,Pe(Math.ceil(te.value)+1,a=>(R(),A("div",{key:a,class:"ruler-tick",style:he({left:(a-1)*L.value+"px"})},[r("span",Un,S(a-1)+"s",1)],4))),128)),r("div",{class:"playhead-top",style:he({left:p(t).currentTime*L.value+"px"})},null,4)],32),r("div",{class:"tracks-list",onDblclick:Te,onScroll:Ae},[(R(!0),A(be,null,Pe(p(t).layers,(a,i)=>(R(),A(be,{key:a.id},[r("div",{class:q(["track-row",{active:i===p(t).currentLayerIndex}]),onClick:f=>p(t).selectLayer(i)},[r("div",{class:q(["track-bar",a.type]),style:he({width:te.value*L.value+"px"})},[Y.value.has(i)?Ie("",!0):(R(!0),A(be,{key:0},Pe(m(a),f=>(R(),A("div",{key:f.time+f.prop,class:"mini-kf",style:he({left:f.time*L.value+"px"})},null,4))),128))],6)],10,Wn),Y.value.has(i)?(R(),A(be,{key:0},Pe(de,f=>r("div",{key:f.key,class:q(["prop-track-row",{active:i===p(t).currentLayerIndex}]),onClick:v=>p(t).selectLayer(i)},[r("div",{class:"prop-track",onDblclick:ae(v=>pe(v,i,f.key),["stop"])},[(R(!0),A(be,null,Pe(_e(a,f.key),v=>(R(),A("div",{key:v.time,class:q(["keyframe-dot",{selected:Ue(i,f.key,v.time)}]),style:he({left:v.time*L.value+"px"}),title:`${f.label}: ${g(v.value,f.key)} @ ${v.time.toFixed(2)}s`,onMousedown:ae(k=>K(k,i,f.key,v),["stop"]),onClick:ae(k=>De(i,f.key,v.time),["stop"]),onContextmenu:ae(k=>We(i,f.key,v.time),["prevent"])},null,46,On))),128))],40,Kn)],10,$n)),64)):Ie("",!0)],64))),128))],32),r("div",{class:"playhead-line",style:he({left:p(t).currentTime*L.value+"px"})},null,4)],4)],512)])]),r("input",{ref_key:"fileInput",ref:G,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:U},null,544),r("input",{ref_key:"projectInput",ref:V,type:"file",accept:".json",style:{display:"none"},onChange:Ze},null,544)]))}}),Bn=at(Nn,[["__scopeId","data-v-eb87def0"]]);function Gn(T,M){const t=dt(Bn,{node:M.node}),j=ft();return t.use(j),t.mount(T),t}window.createTimelineApp=Gn;
