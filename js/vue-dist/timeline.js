import{d as je,r as T,c as ve,b as Le,k as xe,a as Te,w as ze,f as S,h as X,C as Me,j as d,D as we,l as O,u as v,z as Ce,E as Se,t as x,_ as Xe,y as Ye,p as De,q as N,F as ie,s as pe,i as be,A as Re,B as Ae}from"./assets/_plugin-vue_export-helper.js";const Pe=je("timeline",()=>{const D=T({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0}),i=T([]),s=T(-1),M=T(0),W=T(0),R=T(!1),Z=T({enabled:!1,drawing:!1,erase:!1,brush:20}),q=T({enabled:!1,data:null}),K=T({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),A=ve(()=>s.value>=0&&s.value<i.value.length?i.value[s.value]:null),z=ve(()=>i.value.filter(l=>l.type==="foreground")),Q=ve(()=>i.value.find(l=>l.type==="background"));function C(l){Object.assign(D.value,l),l.fps&&l.duration&&(D.value.total_frames=Math.floor(l.fps*l.duration))}function $(l){i.value.push(l),s.value=i.value.length-1}function U(l){l>=0&&l<i.value.length&&(i.value.splice(l,1),s.value>=i.value.length&&(s.value=i.value.length-1))}function ce(){i.value=[],s.value=-1}function fe(l){l>=0&&l<i.value.length&&(s.value=l)}function P(l,b){l>=0&&l<i.value.length&&Object.assign(i.value[l],b)}function ee(l){M.value=Math.max(0,Math.min(l,D.value.duration)),W.value=Math.floor(M.value*D.value.fps)}function V(l){W.value=Math.max(0,Math.min(l,D.value.total_frames-1)),M.value=W.value/D.value.fps}let w=null,te=0;function I(){R.value=!R.value,R.value?me():ae()}function me(){te=performance.now(),ne()}function ne(){if(!R.value)return;const l=performance.now(),b=(l-te)/1e3;te=l;let p=M.value+b;p>=D.value.duration&&(p=0),ee(p),w=requestAnimationFrame(ne)}function ae(){w!==null&&(cancelAnimationFrame(w),w=null)}function de(){R.value=!1,ae(),ee(0)}function ye(l){if(!l)return;const b=l.project||{};C({width:b.width||1280,height:b.height||720,fps:b.fps||30,duration:b.duration||5,total_frames:b.total_frames||150,mask_expansion:b.mask_expansion||0,mask_feather:b.mask_feather||0}),i.value=(l.layers||[]).map(p=>({id:p.id,name:p.name,type:p.type,image_data:p.image_data,x:p.x||0,y:p.y||0,scale:p.scale||1,rotation:p.rotation||0,opacity:p.opacity!==void 0?p.opacity:1,rotationX:p.rotationX||0,rotationY:p.rotationY||0,rotationZ:p.rotationZ||0,anchorX:p.anchorX||0,anchorY:p.anchorY||0,perspective:p.perspective||1e3,mask_size:p.mask_size||0,customMask:p.customMask,bezierPath:p.bezierPath,usePathAnimation:p.usePathAnimation||!1,keyframes:p.keyframes||{},bg_mode:p.bg_mode||"fit"}))}function le(){const l=A.value;if(!l)return;const b=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];l.keyframes||(l.keyframes={});for(const p of b){let B=l[p];B===void 0&&(p==="scale"||p==="opacity"?B=1:p==="perspective"?B=1e3:B=0),l.keyframes[p]||(l.keyframes[p]=[]),l.keyframes[p]=l.keyframes[p].filter(_=>_.time!==M.value),l.keyframes[p].push({time:M.value,value:B}),l.keyframes[p].sort((_,ue)=>_.time-ue.time)}}function H(){const l=A.value;if(!l||!l.keyframes)return;const b=["x","y","scale","rotation","opacity","mask_size"];for(const p of b)l.keyframes[p]&&(l.keyframes[p]=l.keyframes[p].filter(B=>B.time!==M.value))}function se(){const l=A.value;l&&(l.keyframes={})}function Y(){return{project:{...D.value},layers:i.value.map(l=>({id:l.id,name:l.name,type:l.type,image_data:l.image_data,x:l.x,y:l.y,scale:l.scale,rotation:l.rotation,opacity:l.opacity,rotationX:l.rotationX,rotationY:l.rotationY,rotationZ:l.rotationZ,anchorX:l.anchorX,anchorY:l.anchorY,perspective:l.perspective,mask_size:l.mask_size,customMask:l.customMask,bezierPath:l.bezierPath,usePathAnimation:l.usePathAnimation,keyframes:l.keyframes,bg_mode:l.bg_mode}))}}return{project:D,layers:i,currentLayerIndex:s,currentTime:M,currentFrame:W,isPlaying:R,maskMode:Z,pathMode:q,extractMode:K,currentLayer:A,foregroundLayers:z,backgroundLayer:Q,setProject:C,addLayer:$,removeLayer:U,clearLayers:ce,selectLayer:fe,updateLayer:P,setCurrentTime:ee,setCurrentFrame:V,togglePlayback:I,stopPlayback:de,addKeyframe:le,deleteKeyframe:H,clearAllKeyframes:se,loadAnimation:ye,exportAnimation:Y}}),Ke=["width","height"],Ie=["width","height"],Fe={class:"canvas-info"},$e={key:0},Be={key:0,class:"gpu-badge"},Ee={key:1},We=Le({__name:"CanvasPreview",setup(D){const i=Pe(),s=T(),M=T(),W=T();let R=!1,Z=0,q=0,K=0,A=0;const z=T(!1);let Q=!1,C=null;const $=new Map,U=new Map;xe(async()=>{s.value&&(C=s.value.getContext("2d",{alpha:!1,desynchronized:!0})),await ce(),P()}),Te(()=>{$.clear(),fe()});async function ce(){console.log("[Timeline GPU] GPU rendering disabled, using Canvas 2D for stability"),z.value=!1}function fe(){for(const e of U.values())e.destroy();U.clear()}function P(){Q||(Q=!0,requestAnimationFrame(()=>{Q=!1,me()}))}ze(()=>[i.layers,i.currentLayer,i.currentTime],()=>{P()},{deep:!0});function ee(){{ne();return}}function V(e){if(e.img)return e.img;if(!e.image_data)return null;const t=e.id;if($.has(t)){const a=$.get(t);return a.complete?(e.img=a,a):null}const n=new Image;return n.onload=()=>{e.img=n,P()},n.src=e.image_data,$.set(t,n),null}function w(e,t,n){if(!e||e.length===0)return n;const a=[...e].sort((f,m)=>f.time-m.time);if(t<=a[0].time)return a[0].value;if(t>=a[a.length-1].time)return a[a.length-1].value;for(let f=0;f<a.length-1;f++)if(t>=a[f].time&&t<=a[f+1].time){const m=(t-a[f].time)/(a[f+1].time-a[f].time);return a[f].value+(a[f+1].value-a[f].value)*m}return n}function te(e,t,n){if(!e||e.length<2)return null;const a=t/n,m=e.length-1,h=Math.min(Math.floor(a*m),m-1),k=a*m-h,y=e[h],g=e[h+1];if(!y||!g)return null;const j=y.cp2x??y.x+(g.x-y.x)/3,L=y.cp2y??y.y+(g.y-y.y)/3,F=g.cp1x??y.x+(g.x-y.x)*2/3,he=g.cp1y??y.y+(g.y-y.y)*2/3,G=1-k,E=G*G,oe=E*G,J=k*k,re=J*k;return{x:oe*y.x+3*E*k*j+3*G*J*F+re*g.x,y:oe*y.y+3*E*k*L+3*G*J*he+re*g.y}}function I(e){const t=i.currentTime,n=e.keyframes||{};let a=w(n.x,t,e.x||0),f=w(n.y,t,e.y||0);if(e.usePathAnimation&&e.bezierPath&&e.bezierPath.length>=2){const m=te(e.bezierPath,t,i.project.duration);m&&(a=m.x,f=m.y)}return{x:a,y:f,scale:w(n.scale,t,e.scale||1),rotation:w(n.rotation,t,e.rotation||0),opacity:w(n.opacity,t,e.opacity??1),mask_size:w(n.mask_size,t,e.mask_size||0),rotationX:w(n.rotationX,t,e.rotationX||0),rotationY:w(n.rotationY,t,e.rotationY||0),rotationZ:w(n.rotationZ,t,e.rotationZ||0),anchorX:w(n.anchorX,t,e.anchorX||0),anchorY:w(n.anchorY,t,e.anchorY||0),perspective:w(n.perspective,t,e.perspective||1e3)}}function me(){if(z.value){ee();return}ne()}function ne(){var t;if(!s.value||!C)return;C.fillStyle="#000",C.fillRect(0,0,i.project.width,i.project.height);const e=i.layers.find(n=>n.type==="background");e&&de(C,e),i.layers.filter(n=>n.type!=="background").forEach(n=>{ye(C,n)}),i.pathMode.enabled&&((t=i.currentLayer)!=null&&t.bezierPath)&&ae(C,i.currentLayer.bezierPath)}function ae(e,t){if(!t||t.length===0)return;const n=i.project.width/2,a=i.project.height/2;e.save(),e.strokeStyle="#ff6b6b",e.lineWidth=2,e.setLineDash([5,5]),e.beginPath(),e.moveTo(n+t[0].x,a+t[0].y);for(let f=1;f<t.length;f++){const m=t[f-1],h=t[f],k=m.cp2x??m.x+(h.x-m.x)/3,y=m.cp2y??m.y+(h.y-m.y)/3,g=h.cp1x??m.x+(h.x-m.x)*2/3,j=h.cp1y??m.y+(h.y-m.y)*2/3;e.bezierCurveTo(n+k,a+y,n+g,a+j,n+h.x,a+h.y)}if(e.stroke(),e.setLineDash([]),t.forEach((f,m)=>{e.beginPath(),e.arc(n+f.x,a+f.y,6,0,Math.PI*2),e.fillStyle=m===0?"#4ecdc4":m===t.length-1?"#ff6b6b":"#ffe66d",e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke()}),t.length>=2){const f=t.length-1,m=t[f-1],h=t[f],k=m.cp2x??m.x+(h.x-m.x)/3,y=m.cp2y??m.y+(h.y-m.y)/3,g=h.cp1x??m.x+(h.x-m.x)*2/3,j=h.cp1y??m.y+(h.y-m.y)*2/3,L=.99,F=1-L,he=3*F*F*(k-m.x)+6*F*L*(g-k)+3*L*L*(h.x-g),G=3*F*F*(y-m.y)+6*F*L*(j-y)+3*L*L*(h.y-j),E=Math.atan2(G,he),oe=n+h.x,J=a+h.y,re=18;e.beginPath(),e.moveTo(oe,J),e.lineTo(oe-re*Math.cos(E-Math.PI/6),J-re*Math.sin(E-Math.PI/6)),e.moveTo(oe,J),e.lineTo(oe-re*Math.cos(E+Math.PI/6),J-re*Math.sin(E+Math.PI/6)),e.strokeStyle="#ff6b6b",e.lineWidth=2,e.stroke()}e.restore()}function de(e,t){const n=V(t);if(!n)return;const a=I(t);e.save(),e.globalAlpha=a.opacity;const f=t.bg_mode||"fit",m=i.project.width,h=i.project.height,k=n.width,y=n.height;let g=1;f==="fit"?g=Math.min(m/k,h/y):f==="fill"?g=Math.max(m/k,h/y):f==="stretch"&&(g=Math.min(m/k,h/y)),e.translate(m/2+a.x,h/2+a.y),e.rotate(a.rotation*Math.PI/180),e.scale(a.scale*g,a.scale*g),e.drawImage(n,-k/2,-y/2,k,y),t===i.currentLayer&&(e.strokeStyle="#3a7bc8",e.lineWidth=2/(a.scale*g),e.strokeRect(-k/2-2,-y/2-2,k+4,y+4)),e.restore()}function ye(e,t){const n=V(t);if(!n)return;const a=I(t),f=n.width,m=n.height;if(e.save(),e.translate(i.project.width/2+a.x,i.project.height/2+a.y),a.rotationX!==0||a.rotationY!==0){const y=a.perspective||1e3,g=a.rotationX*Math.PI/180,j=a.rotationY*Math.PI/180,L=Math.cos(g),F=Math.sin(g),he=Math.cos(j),G=Math.sin(j),E=1/(1+(G*f/2+F*m/2)/y);e.transform(he*E,F*G*E,0,L*E,0,0)}e.rotate(a.rotation*Math.PI/180),e.scale(a.scale,a.scale),e.globalAlpha=a.opacity;const h=(a.anchorX||0)*f,k=(a.anchorY||0)*m;if(t.maskCanvas){const y=document.createElement("canvas");y.width=f,y.height=m;const g=y.getContext("2d");g?(g.clearRect(0,0,f,m),g.drawImage(n,0,0,f,m),g.globalCompositeOperation="destination-in",g.drawImage(t.maskCanvas,0,0,f,m),e.drawImage(y,-f/2-h,-m/2-k,f,m)):e.drawImage(n,-f/2-h,-m/2-k,f,m)}else e.drawImage(n,-f/2-h,-m/2-k,f,m);if(t===i.currentLayer&&t.img){e.strokeStyle="#3a7bc8",e.lineWidth=2/a.scale;const y=t.img.width,g=t.img.height;e.strokeRect(-y/2-2,-g/2-2,y+4,g+4),e.fillStyle="#3a7bc8",[[-y/2,-g/2],[y/2,-g/2],[y/2,g/2],[-y/2,g/2]].forEach(([L,F])=>{e.fillRect(L-4/a.scale,F-4/a.scale,8/a.scale,8/a.scale)})}if(a.mask_size>0){e.strokeStyle="#3ac88e",e.lineWidth=2/a.scale,e.setLineDash([5/a.scale,5/a.scale]);const y=t.img?t.img.width:512,g=t.img?t.img.height:512,j=y*a.mask_size,L=g*a.mask_size;e.strokeRect(-j/2,-L/2,j,L),e.setLineDash([])}e.restore()}function le(){return z.value?M.value||null:s.value||null}function H(e){const t=le();if(!t)return{x:0,y:0};const n=t.getBoundingClientRect(),a=i.project.width/n.width,f=i.project.height/n.height;return{x:(e.clientX-n.left)*a,y:(e.clientY-n.top)*f}}let se=!1,Y=null,l=!1,b=-1;function p(e){var a;if((a=le())==null||a.focus(),e.shiftKey,e.altKey,!i.currentLayer)return;const t=H(e);if(i.maskMode.enabled){se=!0,ue(),ge(t.x,t.y);return}if(i.pathMode.enabled){_e(t);return}R=!0,Z=t.x,q=t.y;const n=I(i.currentLayer);K=n.x,A=n.y}function B(e){const t=H(e);if(se&&i.maskMode.enabled){ge(t.x,t.y);return}if(l&&b>=0){c(t);return}if(!R||!i.currentLayer)return;let n=t.x-Z,a=t.y-q;e.shiftKey&&(Math.abs(n)>Math.abs(a)?a=0:n=0);const f=K+n,m=A+a;_(i.currentLayer,"x",f),_(i.currentLayer,"y",m),P()}function _(e,t,n){const a=i.currentTime;if(e.keyframes&&e.keyframes[t]&&e.keyframes[t].length>0){const f=e.keyframes[t].findIndex(m=>Math.abs(m.time-a)<.05);f>=0?e.keyframes[t][f]={time:e.keyframes[t][f].time,value:n}:(e.keyframes[t].push({time:a,value:n}),e.keyframes[t].sort((m,h)=>m.time-h.time))}i.updateLayer(i.currentLayerIndex,{[t]:n})}function ue(){const e=i.currentLayer;!e||!e.img||(e.maskCanvas?Y=e.maskCanvas.getContext("2d"):(e.maskCanvas=document.createElement("canvas"),e.maskCanvas.width=e.img.width,e.maskCanvas.height=e.img.height,Y=e.maskCanvas.getContext("2d"),Y&&(Y.fillStyle="white",Y.fillRect(0,0,e.maskCanvas.width,e.maskCanvas.height))))}function ge(e,t){const n=i.currentLayer;if(!n||((!Y||!n.maskCanvas)&&ue(),!n.img||!Y||!n.maskCanvas))return;const a=I(n),f=i.project.width/2+a.x,m=i.project.height/2+a.y,h=(e-f)/a.scale+n.img.width/2,k=(t-m)/a.scale+n.img.height/2,y=i.maskMode.brush||20;Y.beginPath(),Y.arc(h,k,y,0,Math.PI*2),Y.fillStyle=i.maskMode.erase?"black":"white",Y.fill(),P()}function _e(e,t){const n=i.currentLayer;if(!n)return;n.bezierPath||(n.bezierPath=[]);const a=ke(e);if(a>=0)b=a,l=!0;else{const f=i.project.width/2,m=i.project.height/2;n.bezierPath.push({x:e.x-f,y:e.y-m}),n.bezierPath.length>=2&&(n.usePathAnimation=!0),P()}}function ke(e){const t=i.currentLayer;if(!t||!t.bezierPath)return-1;const n=i.project.width/2,a=i.project.height/2,f=10;for(let m=0;m<t.bezierPath.length;m++){const h=t.bezierPath[m],k=h.x+n-e.x,y=h.y+a-e.y;if(Math.sqrt(k*k+y*y)<f)return m}return-1}function c(e){const t=i.currentLayer;if(!t||!t.bezierPath||b<0)return;const n=i.project.width/2,a=i.project.height/2;t.bezierPath[b].x=e.x-n,t.bezierPath[b].y=e.y-a,P()}function o(){R=!1,se=!1,l=!1,b=-1}function r(e){if(!i.currentLayer)return;const t=e.deltaY>0?-.05:.05,n=i.currentLayer;if(e.shiftKey){const f=I(n).rotation+(t>0?5:-5);_(n,"rotation",f)}else if(e.altKey){const a=I(n),f=Math.max(0,Math.min(1,a.opacity+t));_(n,"opacity",f)}else{const a=I(n),f=Math.max(.1,Math.min(5,a.scale+t));_(n,"scale",f)}P()}function u(e){if(!i.currentLayer)return;const t=e.shiftKey?10:1,n=i.currentLayer,a=I(n);switch(e.key){case"ArrowLeft":_(n,"x",a.x-t),P(),e.preventDefault();break;case"ArrowRight":_(n,"x",a.x+t),P(),e.preventDefault();break;case"ArrowUp":_(n,"y",a.y-t),P(),e.preventDefault();break;case"ArrowDown":_(n,"y",a.y+t),P(),e.preventDefault();break;case"r":case"R":_(n,"x",0),_(n,"y",0),_(n,"scale",1),_(n,"rotation",0),_(n,"opacity",1),P(),e.preventDefault();break;case"Delete":case"Backspace":confirm("åˆ é™¤å½“å‰å›¾å±‚?")&&i.removeLayer(i.currentLayerIndex),e.preventDefault();break}}return(e,t)=>(X(),S("div",{class:"canvas-preview",ref_key:"containerRef",ref:W},[Me(d("canvas",{ref_key:"gpuCanvasRef",ref:M,width:v(i).project.width,height:v(i).project.height,onMousedown:p,onMousemove:B,onMouseup:o,onMouseleave:o,onWheel:O(r,["prevent"]),onContextmenu:t[0]||(t[0]=O(()=>{},["prevent"])),tabindex:"0",onKeydown:u},null,40,Ke),[[we,z.value]]),Me(d("canvas",{ref_key:"canvasRef",ref:s,width:v(i).project.width,height:v(i).project.height,onMousedown:p,onMousemove:B,onMouseup:o,onMouseleave:o,onWheel:O(r,["prevent"]),onContextmenu:t[1]||(t[1]=O(()=>{},["prevent"])),tabindex:"0",onKeydown:u},null,40,Ie),[[we,!z.value]]),d("div",Fe,[v(i).currentLayer?(X(),S("span",$e,[z.value?(X(),S("span",Be,"GPU")):Ce("",!0),Se(" Layer "+x(v(i).currentLayerIndex+1)+" | X:"+x(Math.round(v(i).currentLayer.x||0))+" Y:"+x(Math.round(v(i).currentLayer.y||0))+" S:"+x((v(i).currentLayer.scale||1).toFixed(2))+" R:"+x(Math.round(v(i).currentLayer.rotation||0))+"Â° ",1)])):(X(),S("span",Ee,"No layer selected"))])],512))}}),Ue=Xe(We,[["__scopeId","data-v-4705de43"]]),Ge={class:"root"},Oe={class:"canvas-area"},Ne={class:"toolbar-area"},Ze={class:"toolbar-center"},qe={class:"tb-time"},Ve={class:"params-area"},He={class:"param-label"},Je={class:"param-group"},Qe=["value"],et={class:"param-group"},tt=["value"],nt={class:"param-group"},at=["value"],st={class:"param-group"},ot=["value"],rt={class:"param-group"},it=["value"],ct={class:"param-value"},lt={key:1,class:"param-empty"},ut={class:"bottom-area"},ft={class:"layers-sidebar"},mt={class:"layers-header"},dt={class:"layer-actions"},yt=["disabled"],ht=["disabled"],pt={class:"layers-list"},vt=["onClick"],gt={class:"layer-name"},kt=["onClick"],bt=["onClick"],_t=["onClick"],Mt={class:"track-name"},wt=["onClick"],Lt={class:"prop-name"},xt=["onDblclick"],Ct=["title","onMousedown","onClick","onContextmenu"],Pt=Le({__name:"TimelineApp",props:{node:{}},setup(D){const i=D,s=Pe(),M=T(),W=T();let R="foreground",Z=!1,q=!1,K=null;const A=T(new Set([0])),z=T(null),Q=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"scale",label:"Scale"},{key:"rotation",label:"Rotate"},{key:"opacity",label:"Opacity"}];ve(()=>Math.ceil(s.project.duration)+1);const C=ve(()=>{const c=s.currentLayer;if(!c)return{x:0,y:0,scale:1,rotation:0,opacity:1};const o=s.currentTime,r=c.keyframes||{};return{x:$(r.x,o,c.x||0),y:$(r.y,o,c.y||0),scale:$(r.scale,o,c.scale||1),rotation:$(r.rotation,o,c.rotation||0),opacity:$(r.opacity,o,c.opacity??1)}});function $(c,o,r){if(!c||c.length===0)return r;const u=[...c].sort((e,t)=>e.time-t.time);if(o<=u[0].time)return u[0].value;if(o>=u[u.length-1].time)return u[u.length-1].value;for(let e=0;e<u.length-1;e++)if(o>=u[e].time&&o<=u[e+1].time){const t=(o-u[e].time)/(u[e+1].time-u[e].time);return u[e].value+(u[e+1].value-u[e].value)*t}return r}function U(c,o){const r=s.currentLayer;if(!r)return;const u=parseFloat(o.target.value);if(isNaN(u))return;const e=s.currentTime;if(r.keyframes&&r.keyframes[c]&&r.keyframes[c].length>0){const t=r.keyframes[c].findIndex(n=>Math.abs(n.time-e)<.05);t>=0?r.keyframes[c][t]={time:r.keyframes[c][t].time,value:u}:(r.keyframes[c].push({time:e,value:u}),r.keyframes[c].sort((n,a)=>n.time-a.time))}s.updateLayer(s.currentLayerIndex,{[c]:u})}function ce(c){const o=Math.floor(c/60),r=Math.floor(c%60),u=Math.floor(c%1*s.project.fps);return`${o.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}.${u.toString().padStart(2,"0")}`}function fe(c,o){return!c.keyframes||!c.keyframes[o]?[]:c.keyframes[o].map(r=>({time:r.time,value:r.value}))}function P(c,o){return o==="opacity"?(c*100).toFixed(0)+"%":o==="scale"?c.toFixed(2):o==="rotation"?c.toFixed(0)+"Â°":c.toFixed(0)}function ee(c){A.value.has(c)?A.value.delete(c):A.value.add(c)}function V(c){if(!W.value)return 0;const o=W.value.querySelector(".timeline-ruler");if(!o)return 0;const r=o.getBoundingClientRect();return Math.max(0,Math.min(1,(c.clientX-r.left)/r.width))*s.project.duration}function w(c){Z=!0,s.setCurrentTime(V(c))}function te(c){Z&&s.setCurrentTime(V(c))}function I(){Z=!1}function me(c){if(!s.currentLayer)return;const o=V(c);s.setCurrentTime(o),s.addKeyframe()}function ne(c,o,r){const u=s.layers[o];if(!u)return;const t=c.currentTarget.getBoundingClientRect(),a=Math.max(0,Math.min(1,(c.clientX-t.left)/t.width))*s.project.duration,f=u[r]??(r==="scale"||r==="opacity"?1:0);u.keyframes||(u.keyframes={}),u.keyframes[r]||(u.keyframes[r]=[]),u.keyframes[r].find(h=>Math.abs(h.time-a)<.05)||(u.keyframes[r].push({time:a,value:f}),u.keyframes[r].sort((h,k)=>h.time-k.time))}function ae(c,o,r){z.value={layerIdx:c,prop:o,time:r},s.selectLayer(c),s.setCurrentTime(r)}function de(c,o,r){const u=z.value;return u?u.layerIdx===c&&u.prop===o&&Math.abs(u.time-r)<.01:!1}function ye(c,o,r,u){c.preventDefault(),q=!0,K={layerIdx:o,prop:r,originalTime:u.time},ae(o,r,u.time);const e=c.target.parentElement;if(!e)return;const t=a=>{var y;if(!q||!K||!e)return;const f=e.getBoundingClientRect(),h=Math.max(0,Math.min(1,(a.clientX-f.left)/f.width))*s.project.duration,k=s.layers[K.layerIdx];if((y=k==null?void 0:k.keyframes)!=null&&y[K.prop]){const g=k.keyframes[K.prop],j=g.findIndex(L=>Math.abs(L.time-K.originalTime)<.01);j>=0&&(g[j]={time:h,value:g[j].value},K.originalTime=h,z.value={layerIdx:o,prop:r,time:h},s.setCurrentTime(h))}},n=()=>{q=!1,K=null,document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",n)}function le(c,o,r){var e,t,n,a;const u=s.layers[c];(e=u==null?void 0:u.keyframes)!=null&&e[o]&&(u.keyframes[o]=u.keyframes[o].filter(f=>Math.abs(f.time-r)>.01),((t=z.value)==null?void 0:t.layerIdx)===c&&((n=z.value)==null?void 0:n.prop)===o&&Math.abs(((a=z.value)==null?void 0:a.time)-r)<.01&&(z.value=null))}function H(){var a;if(!((a=i.node)!=null&&a.widgets))return;const c=f=>i.node.widgets.find(m=>m.name===f),o=s.exportAnimation(),r=c("layers_keyframes");r&&(r.value=JSON.stringify(o.layers));const u=c("width");u&&(u.value=s.project.width);const e=c("height");e&&(e.value=s.project.height);const t=c("fps");t&&(t.value=s.project.fps);const n=c("total_frames");n&&(n.value=s.project.total_frames)}function se(){H();const c=document.querySelector(".ae-timeline-dialog");c&&c.close()}function Y(){s.addKeyframe()}function l(){s.deleteKeyframe()}function b(){s.maskMode.enabled=!s.maskMode.enabled}function p(){s.pathMode.enabled=!s.pathMode.enabled}function B(){var c;R="foreground",(c=M.value)==null||c.click()}function _(){var c;R="background",(c=M.value)==null||c.click()}function ue(c){const o=c.target.files;o&&(Array.from(o).forEach((r,u)=>{const e=new FileReader;e.onload=t=>{var f;const n=(f=t.target)==null?void 0:f.result,a=new Image;a.onload=()=>{s.addLayer({id:"uploaded_"+Date.now()+"_"+u,name:r.name.replace(/\.[^/.]+$/,""),type:R,image_data:n,img:a,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},a.src=n},e.readAsDataURL(r)}),M.value&&(M.value.value=""))}function ge(){ke(-1)}function _e(){ke(1)}function ke(c){const o=s.currentLayerIndex;if(o<0)return;const r=o+c;if(r>=0&&r<s.layers.length){const u=s.layers[o];s.layers.splice(o,1),s.layers.splice(r,0,u),s.selectLayer(r)}}return xe(()=>{var r,u,e,t;if(!i.node)return;s.clearLayers();const c=n=>{var a;return(a=i.node.widgets)==null?void 0:a.find(f=>f.name===n)},o=c("layers_keyframes");if(o!=null&&o.value)try{const n=JSON.parse(o.value);Array.isArray(n)&&n.length>0&&s.loadAnimation({layers:n})}catch(n){console.error("[Timeline] Failed to load layers:",n)}s.setProject({width:((r=c("width"))==null?void 0:r.value)||1280,height:((u=c("height"))==null?void 0:u.value)||720,fps:((e=c("fps"))==null?void 0:e.value)||30,total_frames:((t=c("total_frames"))==null?void 0:t.value)||150})}),Ye(()=>{H()}),(c,o)=>(X(),S("div",Ge,[d("div",Oe,[De(Ue)]),d("div",Ne,[d("div",Ze,[d("button",{class:"tb-btn",onClick:B,title:"æ·»åŠ å‰æ™¯å›¾å±‚"},"+ Layer"),d("button",{class:"tb-btn",onClick:_,title:"æ·»åŠ èƒŒæ™¯å›¾å±‚"},"+ BG"),o[8]||(o[8]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:"tb-btn",onClick:o[0]||(o[0]=r=>v(s).setCurrentTime(0)),title:"å›žåˆ°èµ·ç‚¹"},"|â—€"),d("button",{class:N(["tb-btn",{active:v(s).isPlaying}]),onClick:o[1]||(o[1]=(...r)=>v(s).togglePlayback&&v(s).togglePlayback(...r)),title:"æ’­æ”¾/æš‚åœ"},x(v(s).isPlaying?"â– ":"â–¶"),3),o[9]||(o[9]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:"tb-btn accent",onClick:Y,title:"æ·»åŠ å…³é”®å¸§ (K)"},"â—† Key"),d("button",{class:"tb-btn",onClick:l,title:"åˆ é™¤å…³é”®å¸§"},"âœ• Key"),o[10]||(o[10]=d("span",{class:"tb-sep"},null,-1)),d("button",{class:N(["tb-btn",{active:v(s).maskMode.enabled}]),onClick:b,title:"é®ç½©ç»˜åˆ¶æ¨¡å¼"},"ðŸ–Œ Mask",2),d("button",{class:N(["tb-btn",{active:v(s).pathMode.enabled}]),onClick:p,title:"è·¯å¾„åŠ¨ç”»æ¨¡å¼"},"ðŸ“ Path",2),d("button",{class:N(["tb-btn",{active:v(s).extractMode.enabled}]),onClick:o[2]||(o[2]=r=>v(s).extractMode.enabled=!v(s).extractMode.enabled),title:"èƒŒæ™¯æå–æ¨¡å¼"},"âœ‚ Extract",2),o[11]||(o[11]=d("span",{class:"tb-sep"},null,-1)),d("span",qe,x(ce(v(s).currentTime))+" / "+x(ce(v(s).project.duration)),1),d("button",{class:"tb-btn save",onClick:H},"ä¿å­˜"),d("button",{class:"tb-btn close",onClick:se},"âœ•")])]),d("div",Ve,[v(s).currentLayer?(X(),S(ie,{key:0},[d("span",He,"Layer "+x(v(s).currentLayerIndex+1)+" ("+x(v(s).currentLayer.type==="background"?"BG":"FG")+")",1),d("div",Je,[o[12]||(o[12]=d("label",null,"X",-1)),d("input",{type:"number",value:C.value.x.toFixed(0),onInput:o[3]||(o[3]=r=>U("x",r)),step:"1",class:"param-input"},null,40,Qe)]),d("div",et,[o[13]||(o[13]=d("label",null,"Y",-1)),d("input",{type:"number",value:C.value.y.toFixed(0),onInput:o[4]||(o[4]=r=>U("y",r)),step:"1",class:"param-input"},null,40,tt)]),d("div",nt,[o[14]||(o[14]=d("label",null,"Scale",-1)),d("input",{type:"number",value:C.value.scale.toFixed(2),onInput:o[5]||(o[5]=r=>U("scale",r)),step:"0.01",min:"0.1",max:"5",class:"param-input"},null,40,at)]),d("div",st,[o[15]||(o[15]=d("label",null,"Rotate",-1)),d("input",{type:"number",value:C.value.rotation.toFixed(0),onInput:o[6]||(o[6]=r=>U("rotation",r)),step:"1",class:"param-input"},null,40,ot)]),d("div",rt,[o[16]||(o[16]=d("label",null,"Opacity",-1)),d("input",{type:"range",value:C.value.opacity,onInput:o[7]||(o[7]=r=>U("opacity",r)),min:"0",max:"1",step:"0.01",class:"param-slider"},null,40,it),d("span",ct,x((C.value.opacity*100).toFixed(0))+"%",1)])],64)):(X(),S("span",lt,"è¯·é€‰æ‹©ä¸€ä¸ªå›¾å±‚"))]),d("div",ut,[d("div",ft,[d("div",mt,[d("span",null,"Layers ("+x(v(s).layers.length)+")",1),d("div",dt,[d("button",{class:"layer-btn",onClick:ge,disabled:!v(s).currentLayer,title:"ä¸Šç§»"},"â–²",8,yt),d("button",{class:"layer-btn",onClick:_e,disabled:!v(s).currentLayer,title:"ä¸‹ç§»"},"â–¼",8,ht)])]),d("div",pt,[(X(!0),S(ie,null,pe(v(s).layers,(r,u)=>(X(),S("div",{key:r.id,class:N(["layer-item",{active:u===v(s).currentLayerIndex}]),onClick:e=>v(s).selectLayer(u)},[d("span",{class:N(["layer-badge",r.type])},x(r.type==="background"?"BG":"FG"),3),d("span",gt,"Layer "+x(u+1),1),d("button",{class:"layer-del",onClick:O(e=>v(s).removeLayer(u),["stop"])},"Ã—",8,kt)],10,vt))),128))])]),d("div",{class:"timeline-area",ref_key:"timelineRef",ref:W},[d("div",{class:"timeline-ruler",onMousedown:w,onMousemove:te,onMouseup:I,onMouseleave:I},[(X(!0),S(ie,null,pe(Math.ceil(v(s).project.duration)+1,r=>(X(),S("div",{key:r,class:"tick",style:be({left:(r-1)/v(s).project.duration*100+"%"})},x(r-1)+"s ",5))),128)),d("div",{class:"playhead-top",style:be({left:v(s).currentTime/v(s).project.duration*100+"%"})},null,4)],32),d("div",{class:"timeline-tracks",onDblclick:me},[(X(!0),S(ie,null,pe(v(s).layers,(r,u)=>(X(),S(ie,{key:r.id},[d("div",{class:N(["track-header",{active:u===v(s).currentLayerIndex,expanded:A.value.has(u)}]),onClick:e=>v(s).selectLayer(u)},[d("button",{class:"track-expand",onClick:O(e=>ee(u),["stop"])},x(A.value.has(u)?"â–¼":"â–¶"),9,_t),d("span",Mt,x(r.type==="background"?"BG":"Layer "+(u+1)),1)],10,bt),A.value.has(u)?(X(),S(ie,{key:0},pe(Q,e=>d("div",{key:e.key,class:N(["track-prop",{active:u===v(s).currentLayerIndex}]),onClick:t=>v(s).selectLayer(u)},[d("span",Lt,x(e.label),1),d("div",{class:"prop-track",onDblclick:O(t=>ne(t,u,e.key),["stop"])},[(X(!0),S(ie,null,pe(fe(r,e.key),t=>(X(),S("div",{key:t.time,class:N(["keyframe",{selected:de(u,e.key,t.time)}]),style:be({left:t.time/v(s).project.duration*100+"%"}),title:e.label+": "+P(t.value,e.key)+" @ "+t.time.toFixed(2)+"s",onMousedown:O(n=>ye(n,u,e.key,t),["stop"]),onClick:O(n=>ae(u,e.key,t.time),["stop"]),onContextmenu:O(n=>le(u,e.key,t.time),["prevent"])},null,46,Ct))),128))],40,xt)],10,wt)),64)):Ce("",!0)],64))),128))],32),d("div",{class:"playhead",style:be({left:v(s).currentTime/v(s).project.duration*100+"%"})},null,4)],512)]),d("input",{ref_key:"fileInput",ref:M,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:ue},null,544)]))}});function jt(D,i){const s=Re(Pt,{node:i.node}),M=Ae();return s.use(M),s.mount(D),s}window.createTimelineApp=jt;
