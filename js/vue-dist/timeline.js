var na=Object.defineProperty;var oa=(t,n,e)=>n in t?na(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var N=(t,n,e)=>oa(t,typeof n!="symbol"?n+"":n,e);import{d as ra,r as be,c as ve,q as Pt,W as Zt,an as aa,al as lt,a1 as Pe,ag as ia,b2 as sa,bl as Ct,bq as Tt,bi as ca,w as ft,bm as ae,bn as ne,bp as r,bA as Ne,bo as Ke,bv as Oe,bw as qe,bE as la,bu as Ve,u as k,br as Ge,bs as ce,bB as St,bF as Wt,bz as ua,bG as bt,bH as Nt,bI as Mt,bt as qt,bJ as ma,bC as pa,bD as da}from"./assets/_plugin-vue_export-helper.js";function jt(t){const n=Math.max(1,t.fps||1);return t.duration||t.total_frames/n}const Lt=ra("timeline",()=>{const t=be({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0,hdr_enable:!1,hdr_exposure:0,pano_enable:!1,cam_enable:!1,cam_yaw:0,cam_pitch:0,cam_roll:0,cam_fov:90,cam_offset_x:0,cam_offset_y:0,cam_pos_x:0,cam_pos_y:0,cam_pos_z:1e3,preview_mode:"2d"}),n=be({}),e=be([]),m=be(-1),v=be(0),_=be(0),P=be(!1),F=be({enabled:!1,drawing:!1,erase:!1,brush:20}),O=be({enabled:!1,data:null}),z=be({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),V=ve(()=>m.value>=0&&m.value<e.value.length?e.value[m.value]:null),S=ve(()=>e.value.filter(c=>c.type==="foreground")),T=ve(()=>e.value.find(c=>c.type==="background"));function R(c){const u=Math.max(1,c.fps??t.value.fps),d=typeof c.duration=="number",g=typeof c.total_frames=="number",x={...t.value,...c,fps:u};d&&!g?x.total_frames=Math.max(1,Math.round((x.duration||0)*u)):g&&!d?(x.total_frames=Math.max(1,Math.round(x.total_frames)),x.duration=x.total_frames/u):(x.total_frames=Math.max(1,Math.round(x.total_frames||x.duration*u)),x.duration=x.duration||x.total_frames/u),Object.assign(t.value,x)}function J(c,u,d){n.value[c]||(n.value[c]=[]);const g=n.value[c],x=g.find(y=>Math.abs(y.time-u)<.001);x?x.value=d:g.push({time:u,value:d}),g.sort((y,L)=>y.time-L.time)}function G(c,u){const d=n.value[c];d&&(n.value[c]=d.filter(g=>Math.abs(g.time-u)>.001))}function ee(c,u,d){const g=n.value[c];if(!g||g.length===0)return d;const x=[...g].sort((y,L)=>y.time-L.time);if(u<=x[0].time)return x[0].value;if(u>=x[x.length-1].time)return x[x.length-1].value;for(let y=0;y<x.length-1;y++){const L=x[y],Z=x[y+1];if(u>=L.time&&u<=Z.time){const K=(u-L.time)/Math.max(1e-6,Z.time-L.time);return L.value+(Z.value-L.value)*K}}return d}function Y(c){e.value.push({z:0,is3D:!1,rotationX:0,rotationY:0,rotationZ:0,scaleX:1,scaleY:1,scaleZ:1,anchorX:0,anchorY:0,perspective:1e3,...c}),m.value=e.value.length-1}function j(c){c>=0&&c<e.value.length&&(e.value.splice(c,1),m.value>=e.value.length&&(m.value=e.value.length-1))}function Se(){e.value=[],m.value=-1}function Fe(c){c>=0&&c<e.value.length&&(m.value=c)}function Ie(c,u){c>=0&&c<e.value.length&&Object.assign(e.value[c],u)}function Le(c){const u=jt(t.value);v.value=Math.max(0,Math.min(c,u)),_.value=Math.floor(v.value*t.value.fps)}function Ee(c){const u=Math.max(1,Math.round(t.value.total_frames||jt(t.value)*t.value.fps));_.value=Math.max(0,Math.min(c,u-1)),v.value=_.value/t.value.fps}let xe=null,ze=0;function ke(){P.value=!P.value,P.value?ie():De()}function ie(){xe===null&&(ze=performance.now(),Ze())}function Ze(){if(!P.value)return;const c=performance.now(),u=(c-ze)/1e3;ze=c;let d=v.value+u;const g=jt(t.value);d>=g&&(d=0),Le(d),xe=requestAnimationFrame(Ze)}function De(){xe!==null&&(cancelAnimationFrame(xe),xe=null)}function Ce(){P.value=!1,De(),Le(0)}function W(c){if(!c)return;const u=c.project||{},d=u.fps||t.value.fps||30,g=u.duration??(u.total_frames?u.total_frames/Math.max(1,d):t.value.duration),x=u.total_frames??Math.max(1,Math.round((g||t.value.duration)*d));R({width:u.width||1280,height:u.height||720,fps:d,duration:g,total_frames:x,mask_expansion:u.mask_expansion||0,mask_feather:u.mask_feather||0,hdr_enable:!!u.hdr_enable,hdr_exposure:u.hdr_exposure||0,pano_enable:!!u.pano_enable,cam_enable:u.cam_enable!==void 0?!!u.cam_enable:!!u.pano_enable,cam_yaw:u.cam_yaw||0,cam_pitch:u.cam_pitch||0,cam_roll:u.cam_roll||0,cam_fov:u.cam_fov||90,cam_offset_x:u.cam_offset_x||0,cam_offset_y:u.cam_offset_y||0,cam_pos_x:u.cam_pos_x||0,cam_pos_y:u.cam_pos_y||0,cam_pos_z:u.cam_pos_z!==void 0?u.cam_pos_z:1e3,preview_mode:u.preview_mode||"2d"}),n.value=u.project_keyframes||{},e.value=(c.layers||[]).map(y=>({id:y.id,name:y.name,type:y.type,image_data:y.image_data,x:y.x||0,y:y.y||0,z:y.z||0,scale:y.scale||1,rotation:y.rotation||0,opacity:y.opacity!==void 0?y.opacity:1,is3D:y.is3D||!1,rotationX:y.rotationX||0,rotationY:y.rotationY||0,rotationZ:y.rotationZ||0,scaleX:y.scaleX!==void 0?y.scaleX:y.scale||1,scaleY:y.scaleY!==void 0?y.scaleY:y.scale||1,scaleZ:y.scaleZ!==void 0?y.scaleZ:1,anchorX:y.anchorX||0,anchorY:y.anchorY||0,perspective:y.perspective||1e3,mask_size:y.mask_size||0,customMask:y.customMask,bezierPath:y.bezierPath,usePathAnimation:y.usePathAnimation||!1,keyframes:y.keyframes||{},bg_mode:y.bg_mode||"fit"}))}function C(){const c=V.value;if(!c)return;const u=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];c.keyframes||(c.keyframes={});for(const d of u){let g=c[d];g===void 0&&(d==="scale"||d==="opacity"?g=1:d==="perspective"?g=1e3:g=0),c.keyframes[d]||(c.keyframes[d]=[]),c.keyframes[d]=c.keyframes[d].filter(x=>x.time!==v.value),c.keyframes[d].push({time:v.value,value:g}),c.keyframes[d].sort((x,y)=>x.time-y.time)}}function i(){const c=V.value;if(!c||!c.keyframes)return;const u=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];for(const d of u)c.keyframes[d]&&(c.keyframes[d]=c.keyframes[d].filter(g=>g.time!==v.value))}function l(){const c=V.value;c&&(c.keyframes={})}function b(){return{project:{...t.value,project_keyframes:n.value},layers:e.value.map(c=>({id:c.id,name:c.name,type:c.type,image_data:c.image_data,x:c.x,y:c.y,z:c.z||0,scale:c.scale,rotation:c.rotation,opacity:c.opacity,is3D:c.is3D||!1,rotationX:c.rotationX,rotationY:c.rotationY,rotationZ:c.rotationZ,scaleX:c.scaleX,scaleY:c.scaleY,scaleZ:c.scaleZ,anchorX:c.anchorX,anchorY:c.anchorY,perspective:c.perspective,mask_size:c.mask_size,customMask:c.customMask,bezierPath:c.bezierPath,usePathAnimation:c.usePathAnimation,keyframes:c.keyframes,bg_mode:c.bg_mode}))}}return{project:t,layers:e,currentLayerIndex:m,currentTime:v,currentFrame:_,isPlaying:P,maskMode:F,pathMode:O,extractMode:z,projectKeyframes:n,currentLayer:V,foregroundLayers:S,backgroundLayer:T,setProject:R,addLayer:Y,removeLayer:j,clearLayers:Se,selectLayer:Fe,updateLayer:Ie,setCurrentTime:Le,setCurrentFrame:Ee,togglePlayback:ke,stopPlayback:Ce,addKeyframe:C,deleteKeyframe:i,clearAllKeyframes:l,setProjectKeyframe:J,deleteProjectKeyframe:G,interpolateProjectValue:ee,loadAnimation:W,exportAnimation:b}});class fa{constructor(n,e=100){N(this,"cache",new Map);N(this,"device");N(this,"maxCacheSize");this.device=n,this.maxCacheSize=e}loadImage(n,e){if(this.cache.has(n)){const _=this.cache.get(n);return _.lastUsed=Date.now(),_.refCount++,_.texture}this.evictLRU();const m=this.createTextureFromImage(e),v=m.createView();return this.cache.set(n,{texture:m,view:v,lastUsed:Date.now(),refCount:1,width:e.width,height:e.height}),m}getView(n){const e=this.cache.get(n);return e?(e.lastUsed=Date.now(),e.view):null}createTextureFromImage(n){const e=this.device.createTexture({size:[n.width,n.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return this.device.queue.copyExternalImageToTexture({source:n},{texture:e},[n.width,n.height]),e}release(n){const e=this.cache.get(n);e&&(e.refCount--,e.refCount<=0&&(e.texture.destroy(),this.cache.delete(n)))}evictLRU(){if(this.cache.size<this.maxCacheSize)return;let n=null,e=1/0;for(const[m,v]of this.cache)v.refCount===0&&v.lastUsed<e&&(e=v.lastUsed,n=m);n?(this.cache.get(n).texture.destroy(),this.cache.delete(n),console.log(`[TextureCache] Evicted texture: ${n}`)):console.warn("[TextureCache] Cache full but no textures can be evicted")}has(n){return this.cache.has(n)}getStats(){let n=0,e=0;for(const m of this.cache.values())n+=m.refCount,m.refCount>0&&e++;return{size:this.cache.size,maxSize:this.maxCacheSize,activeTextures:e,totalRefCount:n}}cleanup(){for(const[n,e]of this.cache)e.texture.destroy();this.cache.clear(),console.log("[TextureCache] Cleaned up all textures")}evict(n){const e=this.cache.get(n);return e&&e.refCount===0?(e.texture.destroy(),this.cache.delete(n),!0):!1}setMaxCacheSize(n){for(this.maxCacheSize=n;this.cache.size>this.maxCacheSize;)this.evictLRU()}}class ha{constructor(n=60){N(this,"frameTimes",[]);N(this,"lastFrameTime",0);N(this,"frameCount",0);N(this,"droppedFrames",0);N(this,"startTime",0);N(this,"maxSamples",60);this.maxSamples=n,this.startTime=performance.now()}startFrame(){this.lastFrameTime=performance.now()}endFrame(){const e=performance.now()-this.lastFrameTime;this.frameTimes.push(e),this.frameTimes.length>this.maxSamples&&this.frameTimes.shift(),this.frameCount++,e>16.67&&this.droppedFrames++}getStats(){if(this.frameTimes.length===0)return{fps:0,frameTime:0,avgFrameTime:0,minFrameTime:0,maxFrameTime:0,totalFrames:0,droppedFrames:0};const n=this.frameTimes.reduce((_,P)=>_+P,0)/this.frameTimes.length,e=Math.min(...this.frameTimes),m=Math.max(...this.frameTimes),v=1e3/n;return{fps:Math.round(v*10)/10,frameTime:Math.round(this.frameTimes[this.frameTimes.length-1]*100)/100,avgFrameTime:Math.round(n*100)/100,minFrameTime:Math.round(e*100)/100,maxFrameTime:Math.round(m*100)/100,totalFrames:this.frameCount,droppedFrames:this.droppedFrames}}reset(){this.frameTimes=[],this.frameCount=0,this.droppedFrames=0,this.startTime=performance.now()}getFormattedStats(){const n=this.getStats();return`FPS: ${n.fps} | Frame: ${n.frameTime}ms | Avg: ${n.avgFrameTime}ms | Dropped: ${n.droppedFrames}`}isPerformanceGood(){return this.getStats().fps>=55}isPerformanceAcceptable(){return this.getStats().fps>=30}}const Ht=`
struct LayerUniforms {
  opacity: f32,
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: LayerUniforms;

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  var output: VertexOutput;
  output.position = vec4<f32>(pos, 0.0, 1.0);
  output.uv = uv;
  output.opacity = uniforms.opacity;
  return output;
}
`,Jt=`
struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(1) @binding(0) var layerTexture: texture_2d<f32>;
@group(1) @binding(1) var layerSampler: sampler;

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  var color = textureSample(layerTexture, layerSampler, input.uv);
  
  // Apply opacity
  color.a *= input.opacity;
  
  // Return premultiplied alpha
  return vec4<f32>(color.rgb * color.a, color.a);
}
`,va=`
struct PanoramaUniforms {
  yaw: f32,
  pitch: f32,
  roll: f32,
  fov: f32,
  aspectRatio: f32,
  padding: f32,
  screenSize: vec2<f32>,
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: PanoramaUniforms;
@group(1) @binding(0) var panoTexture: texture_2d<f32>;
@group(1) @binding(1) var panoSampler: sampler;

fn screenToRay(screenPos: vec2<f32>) -> vec3<f32> {
  // Convert screen position to normalized coordinates [-1, 1]
  // 与Canvas 2D一致: nx = (xPix + 0.5) / prevW * 2 - 1
  let nx = (screenPos.x / uniforms.screenSize.x) * 2.0 - 1.0;
  // Canvas 2D: ny = (yPix + 0.5) / prevH * 2 - 1
  let ny = (screenPos.y / uniforms.screenSize.y) * 2.0 - 1.0;
  
  // Calculate ray direction based on FOV
  // 与Canvas 2D一致: vx = nx * tanHalfFov * aspect, vy = -ny * tanHalfFov
  // Clamp FOV to valid range [10, 170] degrees (与Canvas 2D一致)
  let fovClamped = clamp(uniforms.fov, 10.0, 170.0);
  let tanHalfFov = tan(fovClamped * 0.5 * 0.01745329); // deg to rad
  let vx = nx * tanHalfFov * uniforms.aspectRatio;
  let vy = -ny * tanHalfFov;
  let vz = 1.0;
  
  // Normalize ray
  let len = sqrt(vx * vx + vy * vy + vz * vz);
  return vec3<f32>(vx / len, vy / len, vz / len);
}

fn applyCameraRotation(ray: vec3<f32>) -> vec3<f32> {
  // Convert degrees to radians
  let yawRad = uniforms.yaw * 0.01745329;
  let pitchRad = uniforms.pitch * 0.01745329;
  let rollRad = uniforms.roll * 0.01745329;
  
  // Build rotation components - 与Canvas 2D完全一致的顺序
  let cy = cos(yawRad);
  let sy = sin(yawRad);
  let cp = cos(pitchRad);
  let sp = sin(pitchRad);
  let cr = cos(rollRad);
  let sr = sin(rollRad);
  
  var vx = ray.x;
  var vy = ray.y;
  var vz = ray.z;
  
  // Apply Yaw (Y轴旋转) - 与Canvas 2D一致
  var tx = cy * vx + sy * vz;
  var tz = -sy * vx + cy * vz;
  vx = tx;
  vz = tz;
  
  // Apply Pitch (X轴旋转) - 与Canvas 2D一致
  var ty = cp * vy - sp * vz;
  tz = sp * vy + cp * vz;
  vy = ty;
  vz = tz;
  
  // Apply Roll (Z轴旋转) - 与Canvas 2D一致
  tx = cr * vx - sr * vy;
  ty = sr * vx + cr * vy;
  vx = tx;
  vy = ty;
  
  return vec3<f32>(vx, vy, vz);
}

fn rayToEquirectangular(ray: vec3<f32>) -> vec2<f32> {
  // Convert ray to spherical coordinates - 与Canvas 2D完全一致
  let lon = atan2(ray.x, ray.z);
  let lat = asin(clamp(ray.y, -1.0, 1.0));
  
  // Map to UV coordinates [0, 1] - 与Canvas 2D的映射一致
  // Canvas 2D: u = ((lon / (Math.PI * 2)) + 0.5) * imgW
  //            v = ((0.5 - (lat / Math.PI))) * imgH
  let u = (lon / (3.14159265 * 2.0)) + 0.5;
  let v = 0.5 - (lat / 3.14159265);  // 与Canvas 2D一致
  
  return vec2<f32>(u, v);
}

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  var output: VertexOutput;
  output.position = vec4<f32>(pos, 0.0, 1.0);
  output.uv = uv;
  output.opacity = 1.0;
  return output;
}

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  // Convert screen position to ray direction
  var ray = screenToRay(input.position.xy);
  
  // Apply camera rotation
  ray = applyCameraRotation(ray);
  
  // Convert ray to equirectangular UV
  let uv = rayToEquirectangular(ray);
  
  // Sample panorama texture
  var color = textureSample(panoTexture, panoSampler, uv);
  
  // Return with full opacity (panorama should be opaque)
  return vec4<f32>(color.rgb, 1.0);
}
`,Qt=`
struct LayerUniforms {
  opacity: f32,
  // Camera rotation matrix (3x3, stored as 3 vec4s for alignment)
  rotationRow0: vec4<f32>,  // [r00, r01, r02, padding]
  rotationRow1: vec4<f32>,  // [r10, r11, r12, padding]
  rotationRow2: vec4<f32>,  // [r20, r21, r22, padding]
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: LayerUniforms;

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  // Apply camera rotation to vertex position
  // Extract rotation matrix
  let r00 = uniforms.rotationRow0.x;
  let r01 = uniforms.rotationRow0.y;
  let r02 = uniforms.rotationRow0.z;
  let r10 = uniforms.rotationRow1.x;
  let r11 = uniforms.rotationRow1.y;
  let r12 = uniforms.rotationRow1.z;
  let r20 = uniforms.rotationRow2.x;
  let r21 = uniforms.rotationRow2.y;
  let r22 = uniforms.rotationRow2.z;
  
  // Apply rotation (pos is already in NDC space)
  let rotatedX = r00 * pos.x + r01 * pos.y;
  let rotatedY = r10 * pos.x + r11 * pos.y;
  
  var output: VertexOutput;
  output.position = vec4<f32>(rotatedX, rotatedY, 0.0, 1.0);
  output.uv = uv;
  output.opacity = uniforms.opacity;
  return output;
}
`,ea=`
struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(1) @binding(0) var layerTexture: texture_2d<f32>;
@group(1) @binding(1) var layerSampler: sampler;

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  var color = textureSample(layerTexture, layerSampler, input.uv);
  
  // Apply opacity
  color.a *= input.opacity;
  
  // Return premultiplied alpha
  return vec4<f32>(color.rgb * color.a, color.a);
}
`;class ya{constructor(n){N(this,"device");N(this,"presentationFormat");N(this,"width");N(this,"height");N(this,"enableCameraRotation",!1);N(this,"backgroundPipeline",null);N(this,"foregroundPipeline",null);N(this,"panoramaPipeline",null);N(this,"overlayPipeline",null);N(this,"advancedBackgroundPipeline",null);N(this,"advancedForegroundPipeline",null);N(this,"useAdvancedTransforms",!1);N(this,"uniformBindGroupLayout",null);N(this,"textureBindGroupLayout",null);N(this,"overlayBindGroupLayout",null);N(this,"uniformBuffer",null);N(this,"panoUniformBuffer",null);N(this,"quadVertexBuffer",null);N(this,"indexBuffer",null);N(this,"textureCache");N(this,"sampler",null);N(this,"performanceMonitor");N(this,"lastUniformData",null);N(this,"uniformsDirty",!0);N(this,"lastCameraState",null);N(this,"lastLayerProps",new Map);N(this,"panoSampler",null);N(this,"tempBuffers",[]);this.device=n.device,this.presentationFormat=n.presentationFormat,this.width=n.width,this.height=n.height,this.useAdvancedTransforms=n.useAdvancedTransforms??!1,this.textureCache=new fa(this.device),this.performanceMonitor=new ha,this.initialize(),console.log("[GPUTimelineRenderer] Advanced transforms:",this.useAdvancedTransforms?"ENABLED":"DISABLED")}initialize(){this.createBindGroupLayouts(),this.createBuffers(),this.createSampler(),this.createPanoSampler(),this.createPipelines()}createBindGroupLayouts(){this.uniformBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.textureBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),this.overlayBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]})}createBuffers(){this.uniformBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.panoUniformBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const n=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,1,0,0]);this.quadVertexBuffer=this.device.createBuffer({size:n.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.quadVertexBuffer.getMappedRange()).set(n),this.quadVertexBuffer.unmap();const e=new Uint16Array([0,1,2,0,2,3]);this.indexBuffer=this.device.createBuffer({size:e.byteLength,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),new Uint16Array(this.indexBuffer.getMappedRange()).set(e),this.indexBuffer.unmap()}createSampler(){this.sampler=this.device.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"})}createPanoSampler(){this.panoSampler=this.device.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",addressModeU:"repeat",addressModeV:"clamp-to-edge"})}createPipelines(){const n=this.device.createPipelineLayout({bindGroupLayouts:[this.uniformBindGroupLayout,this.textureBindGroupLayout]}),e={arrayStride:16,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:8,format:"float32x2"}]},m={color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}};this.backgroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Ht}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:Jt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:m}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.foregroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Ht}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:Jt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:m}]},primitive:{topology:"triangle-list",cullMode:"none"}});const v=this.device.createShaderModule({code:va});this.panoramaPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:v,entryPoint:"vs",buffers:[e]},fragment:{module:v,entryPoint:"fs",targets:[{format:this.presentationFormat,blend:m}]},primitive:{topology:"triangle-list",cullMode:"none"}});const _=`
      @group(0) @binding(0) var<uniform> overlayColor: vec4<f32>;
      
      struct VertexOutput {
        @builtin(position) position: vec4<f32>,
        @location(0) uv: vec2<f32>
      }
      
      @vertex
      fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
        return VertexOutput(vec4<f32>(pos, 0.0, 1.0), uv);
      }
      
      @fragment
      fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
        return overlayColor;
      }
    `,P=this.device.createPipelineLayout({bindGroupLayouts:[this.overlayBindGroupLayout]});this.overlayPipeline=this.device.createRenderPipeline({layout:P,vertex:{module:this.device.createShaderModule({code:_}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:_}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:m}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.useAdvancedTransforms&&(this.advancedBackgroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Qt}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:ea}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:m}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.advancedForegroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Qt}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:ea}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:m}]},primitive:{topology:"triangle-list",cullMode:"none"}}),console.log("[GPUTimelineRenderer] Advanced pipelines created")),console.log("[GPUTimelineRenderer] Pipelines created successfully")}renderFrame(n,e,m,v){if(this.performanceMonitor.startFrame(),!this.backgroundPipeline||!this.foregroundPipeline){console.warn("[GPUTimelineRenderer] Pipelines not initialized");return}this.tempBuffers=[];const _=this.device.createCommandEncoder();_.beginRenderPass({colorAttachments:[{view:v,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:1},storeOp:"store"}]}).end();const F=n.find(T=>T.type==="background");if(F&&F.img){const T=this.getLayerProps(F,e);if(m.panorama&&F.img.width>0&&F.img.height>0)this.renderPanoramaLayer(_,F,m,v);else{const J=this.useAdvancedTransforms&&this.advancedBackgroundPipeline?this.advancedBackgroundPipeline:this.backgroundPipeline;this.renderLayerInternal(_,F,T,m,v,J)}}const O=n.filter(T=>T.type!=="background"),z=this.cullLayers(O,e,m),V=[],S=[];for(const T of z)T.maskCanvas?S.push(T):V.push(T);for(const T of V)if(T.img){const R=this.getLayerProps(T,e),J=this.useAdvancedTransforms&&this.advancedForegroundPipeline?this.advancedForegroundPipeline:this.foregroundPipeline;this.renderLayerInternal(_,T,R,m,v,J)}for(const T of S)if(T.img){const R=this.getLayerProps(T,e);this.renderLayerWithMask(_,T,R,m,v)}this.device.queue.submit([_.finish()]);for(const T of this.tempBuffers)T.destroy();this.tempBuffers=[],this.performanceMonitor.endFrame()}cullLayers(n,e,m){const v=[];for(const _ of n){if(!_.img)continue;const P=this.getLayerProps(_,e);if(P.opacity<=.001||Math.abs(P.scale)<.001)continue;const F=m.enabled?Math.max(.2,Math.min(4,1/(1+m.position.z*.001))):1,O=1/Math.max(.1,1+P.z*.001),z=P.scale*F*O,V=(_.img.width||0)*z,S=(_.img.height||0)*z,T=Math.max(V,S)*1.5,R=P.x+(m.enabled?m.offset.x:0),J=P.y+(m.enabled?m.offset.y:0);R+T<0||R-T>this.width||J+T<0||J-T>this.height||v.push(_)}return v}getPerformanceStats(){return this.performanceMonitor.getStats()}resetPerformanceStats(){this.performanceMonitor.reset()}getLayerProps(n,e){const m=`${n.id}_${e}`,v=this.lastLayerProps.get(m);if(v&&!n.keyframes&&!n.usePathAnimation)return v;const _=n.keyframes||{};let P=this.interpolateValue(_.x,e,n.x),F=this.interpolateValue(_.y,e,n.y);if(n.usePathAnimation&&n.bezierPath&&n.bezierPath.length>=2){const z=this.interpolateBezierPath(n.bezierPath,e,2);z&&(P=z.x,F=z.y)}const O={x:P,y:F,z:this.interpolateValue(_.z,e,n.z),scale:this.interpolateValue(_.scale,e,n.scale),rotation:this.interpolateValue(_.rotation,e,n.rotation),rotationX:this.interpolateValue(_.rotationX,e,n.rotationX),rotationY:this.interpolateValue(_.rotationY,e,n.rotationY),rotationZ:this.interpolateValue(_.rotationZ,e,n.rotationZ),opacity:this.interpolateValue(_.opacity,e,n.opacity??1),anchorX:this.interpolateValue(_.anchorX,e,n.anchorX),anchorY:this.interpolateValue(_.anchorY,e,n.anchorY),perspective:this.interpolateValue(_.perspective,e,n.perspective),mask_size:this.interpolateValue(_.mask_size,e,n.mask_size)};if(this.lastLayerProps.set(m,O),this.lastLayerProps.size>100){const z=this.lastLayerProps.keys().next().value;z&&this.lastLayerProps.delete(z)}return O}interpolateValue(n,e,m){if(!n||n.length===0)return m;const v=[...n].sort((_,P)=>_.time-P.time);if(e<=v[0].time)return v[0].value;if(e>=v[v.length-1].time)return v[v.length-1].value;for(let _=0;_<v.length-1;_++)if(e>=v[_].time&&e<=v[_+1].time){const P=(e-v[_].time)/(v[_+1].time-v[_].time);return v[_].value+(v[_+1].value-v[_].value)*P}return m}interpolateBezierPath(n,e,m){if(!n||n.length<2)return null;const v=e/m,P=n.length-1,F=Math.min(Math.floor(v*P),P-1),O=v*P-F,z=n[F],V=n[F+1];if(!z||!V)return null;const S=z.cp2x??z.x+(V.x-z.x)/3,T=z.cp2y??z.y+(V.y-z.y)/3,R=V.cp1x??z.x+(V.x-z.x)*2/3,J=V.cp1y??z.y+(V.y-z.y)*2/3,G=1-O,ee=G*G,Y=ee*G,j=O*O,Se=j*O;return{x:Y*z.x+3*ee*O*S+3*G*j*R+Se*V.x,y:Y*z.y+3*ee*O*T+3*G*j*J+Se*V.y}}calculateBackgroundScale(n,e,m){if(!n.img||n.type!=="background")return 1;const v=n.img.width,_=n.img.height;if(v===0||_===0)return 1;switch(n.bg_mode||"fit"){case"fit":return Math.min(e/v,m/_);case"fill":return Math.max(e/v,m/_);case"stretch":return Math.min(e/v,m/_);default:return 1}}renderPanoramaLayer(n,e,m,v){if(!e.img||!this.panoramaPipeline)return;const _=e.id;let P;try{P=this.textureCache.loadImage(_,e.img)}catch(Y){console.error("[GPUTimelineRenderer] Failed to load panorama texture:",Y);return}const F=Math.max(1,this.width),O=Math.max(1,this.height),z=F/O,V=Math.min(170,Math.max(10,m.fov||90)),S=new ArrayBuffer(256),T=new Float32Array(S);let R=0;T[R++]=m.rotation.yaw||0,T[R++]=m.rotation.pitch||0,T[R++]=m.rotation.roll||0,T[R++]=V,T[R++]=z,T[R++]=0,T[R++]=F,T[R++]=O,this.device.queue.writeBuffer(this.panoUniformBuffer,0,S);const J=this.device.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.panoUniformBuffer}}]}),G=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:P.createView()},{binding:1,resource:this.panoSampler}]}),ee=n.beginRenderPass({colorAttachments:[{view:v,loadOp:"load",storeOp:"store"}]});ee.setPipeline(this.panoramaPipeline),ee.setBindGroup(0,J),ee.setBindGroup(1,G),ee.setVertexBuffer(0,this.quadVertexBuffer),ee.setIndexBuffer(this.indexBuffer,"uint16"),ee.drawIndexed(6),ee.end()}renderLayerInternal(n,e,m,v,_,P){if(!e.img)return;const F=e.id;let O;try{O=this.textureCache.loadImage(F,e.img)}catch(d){console.error(`[GPUTimelineRenderer] Failed to load texture for layer ${e.id}:`,d);return}const z=v.offset.x,V=v.offset.y,S=v.panorama,T=v.enabled,R=1/Math.max(.1,1+m.z*.001);let J=1;e.type==="background"&&(J=this.calculateBackgroundScale(e,this.width,this.height));const G=m.scale*J*R,ee=e.img.width,Y=e.img.height,j=this.width/2,Se=this.height/2;let Fe=m.x,Ie=m.y;if(e.type!=="background"&&(T||S)){const d=v.rotation.yaw,g=v.rotation.pitch,x=Math.max(10,Math.min(170,v.fov||90));if(d!==0||g!==0){const y=d*Math.PI/180,L=g*Math.PI/180,Z=Math.tan(x*Math.PI/180/2),K=this.width/(2*Z);Fe-=Math.tan(y)*K,Ie-=Math.tan(L)*K}}const Le=j+Fe+z,Ee=Se+Ie+V,xe=ee*G,ze=Y*G,ke=(Le-xe/2)/this.width*2-1,ie=(Le+xe/2)/this.width*2-1,Ze=1-(Ee-ze/2)/this.height*2,De=1-(Ee+ze/2)/this.height*2,Ce=new Float32Array([ke,De,0,1,ie,De,1,1,ie,Ze,1,0,ke,Ze,0,0]),W=this.device.createBuffer({size:Ce.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});this.device.queue.writeBuffer(W,0,Ce),this.tempBuffers.push(W);const C=new ArrayBuffer(256),i=new Float32Array(C);let l=0;if(i[l++]=m.opacity,this.useAdvancedTransforms&&v.enabled){const d=v.rotation.yaw*Math.PI/180,g=v.rotation.pitch*Math.PI/180,x=v.rotation.roll*Math.PI/180,y=Math.cos(d),L=Math.sin(d),Z=Math.cos(g),K=Math.sin(g),X=Math.cos(x),q=Math.sin(x),oe=X*y+q*K*L,se=q*Z,pe=X*-L+q*K*y,de=-q*y+X*K*L,ye=X*Z,le=-q*-L+X*K*y,Ue=Z*L,We=-K,Ye=Z*y;i[l++]=oe,i[l++]=se,i[l++]=pe,i[l++]=0,i[l++]=de,i[l++]=ye,i[l++]=le,i[l++]=0,i[l++]=Ue,i[l++]=We,i[l++]=Ye,i[l++]=0}else i[l++]=1,i[l++]=0,i[l++]=0,i[l++]=0,i[l++]=0,i[l++]=1,i[l++]=0,i[l++]=0,i[l++]=0,i[l++]=0,i[l++]=1,i[l++]=0;this.device.queue.writeBuffer(this.uniformBuffer,0,C);const b=this.device.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]}),c=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:O.createView()},{binding:1,resource:this.sampler}]}),u=n.beginRenderPass({colorAttachments:[{view:_,loadOp:"load",storeOp:"store"}]});u.setPipeline(P),u.setBindGroup(0,b),u.setBindGroup(1,c),u.setVertexBuffer(0,W),u.setIndexBuffer(this.indexBuffer,"uint16"),u.drawIndexed(6),u.end()}renderLayer(n,e,m){const v=this.device.createCommandEncoder(),_=n.type==="background"?this.backgroundPipeline:this.foregroundPipeline,P={enabled:!1,position:{x:0,y:0,z:0},offset:{x:0,y:0},rotation:{yaw:0,pitch:0,roll:0},fov:90,panorama:!1};this.renderLayerInternal(v,n,e,P,m,_),this.device.queue.submit([v.finish()])}renderLayerWithMask(n,e,m,v,_){if(!e.maskCanvas||!e.img){this.renderLayerInternal(n,e,m,v,_,this.foregroundPipeline);return}try{const P=`${e.id}_mask`,F=e.maskCanvas,O=this.textureCache.loadImage(P,F),z={...m};z.opacity*=.8,this.renderLayerInternal(n,e,z,v,_,this.foregroundPipeline)}catch(P){console.warn(`[GPUTimelineRenderer] Failed to apply mask for layer ${e.id}:`,P),this.renderLayerInternal(n,e,m,v,_,this.foregroundPipeline)}}renderOverlay(n,e,m){if(n==="none"||!this.overlayPipeline)return;const v=this.device.createCommandEncoder();let _=[1,0,0,.3];switch(n){case"mask":_=[1,0,0,.5];break;case"extract":_=[0,0,0,.6];break;case"path":_=[0,.5,1,.8];break}m!=null&&m.color&&(_=m.color);const P=this.device.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),F=new Float32Array(_);this.device.queue.writeBuffer(P,0,F);const O=this.device.createBindGroup({layout:this.overlayBindGroupLayout,entries:[{binding:0,resource:{buffer:P}}]}),z=v.beginRenderPass({colorAttachments:[{view:e,loadOp:"load",storeOp:"store"}]});z.setPipeline(this.overlayPipeline),z.setBindGroup(0,O),z.setVertexBuffer(0,this.quadVertexBuffer),z.setIndexBuffer(this.indexBuffer,"uint16"),z.drawIndexed(6),z.end(),this.device.queue.submit([v.finish()]),P.destroy()}renderPathOverlay(n,e,m){!n||n.length<2||this.renderOverlay("path",e,{color:[0,.5,1,.8]})}renderMaskOverlay(n,e,m){n.maskCanvas&&this.renderOverlay("mask",e,{color:[1,0,0,.5],layer:n})}renderExtractOverlay(n,e,m){this.renderOverlay("extract",e,{color:[0,0,0,.6],layer:n})}updateUniforms(n){if(this.lastUniformData){const e=new Uint8Array(this.lastUniformData),m=new Uint8Array(n);let v=!1;for(let _=0;_<Math.min(e.length,m.length);_++)if(e[_]!==m[_]){v=!0;break}if(!v)return}this.device.queue.writeBuffer(this.uniformBuffer,0,n),this.lastUniformData=n.slice(0)}cameraStateChanged(n){if(!this.lastCameraState)return this.lastCameraState={...n},!0;const e=this.lastCameraState.enabled!==n.enabled||this.lastCameraState.position.x!==n.position.x||this.lastCameraState.position.y!==n.position.y||this.lastCameraState.position.z!==n.position.z||this.lastCameraState.offset.x!==n.offset.x||this.lastCameraState.offset.y!==n.offset.y||this.lastCameraState.rotation.yaw!==n.rotation.yaw||this.lastCameraState.rotation.pitch!==n.rotation.pitch||this.lastCameraState.rotation.roll!==n.rotation.roll||this.lastCameraState.fov!==n.fov||this.lastCameraState.panorama!==n.panorama;return e&&(this.lastCameraState={...n}),e}resizeRenderTargets(n,e){this.width=n,this.height=e}cleanup(){var n,e,m,v;for(const _ of this.tempBuffers)_.destroy();this.tempBuffers=[],(n=this.uniformBuffer)==null||n.destroy(),(e=this.panoUniformBuffer)==null||e.destroy(),(m=this.quadVertexBuffer)==null||m.destroy(),(v=this.indexBuffer)==null||v.destroy(),this.textureCache.cleanup(),console.log("[GPUTimelineRenderer] Cleaned up all resources")}getCacheStats(){return this.textureCache.getStats()}}class ga{constructor(n,e){N(this,"device");N(this,"adapter",null);this.device=n,this.adapter=e||null}async getDeviceInfo(){var v,_,P;const n={},e=[];if(this.device.limits)for(const[F,O]of Object.entries(this.device.limits))typeof O=="number"&&(n[F]=O);this.device.features&&this.device.features.forEach(F=>{e.push(F)});let m="Unknown";if(this.adapter)try{const F=await((_=(v=this.adapter).requestAdapterInfo)==null?void 0:_.call(v));m=(F==null?void 0:F.description)||(F==null?void 0:F.vendor)||"WebGPU Adapter"}catch{m="WebGPU Adapter"}return{adapter:m,device:"WebGPU Device",limits:n,features:e,canvasFormat:((P=navigator.gpu)==null?void 0:P.getPreferredCanvasFormat())||"unknown"}}async logDeviceInfo(){const n=await this.getDeviceInfo();console.group("[GPUDebugger] Device Information"),console.log("Adapter:",n.adapter),console.log("Device:",n.device),console.log("Canvas Format:",n.canvasFormat),console.log("Features:",n.features),console.log("Limits:",n.limits),console.groupEnd()}checkRequiredFeatures(){const n=[],e=[];for(const m of n)this.device.features.has(m)||e.push(m);return{supported:e.length===0,missing:e}}getMemoryEstimate(n,e){const _=n*e*4/(1024*1024);return`~${Math.round(_)}MB`}validatePipeline(n){return n?!0:(console.error("[GPUDebugger] Pipeline is null"),!1)}logCacheStats(n){console.group("[GPUDebugger] Texture Cache Stats"),console.log("Total Textures:",n.totalTextures),console.log("Cache Hits:",n.cacheHits),console.log("Cache Misses:",n.cacheMisses),console.log("Hit Rate:",`${n.hitRate}%`),console.log("Memory Usage:",n.memoryUsage),console.groupEnd()}logPerformanceStats(n){console.group("[GPUDebugger] Performance Stats"),console.log("FPS:",n.fps),console.log("Frame Time:",`${n.frameTime}ms`),console.log("Avg Frame Time:",`${n.avgFrameTime}ms`),console.log("Min Frame Time:",`${n.minFrameTime}ms`),console.log("Max Frame Time:",`${n.maxFrameTime}ms`),console.log("Total Frames:",n.totalFrames),console.log("Dropped Frames:",n.droppedFrames),console.groupEnd()}createDebugOverlay(n){const e=document.createElement("div");return e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.padding="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="#00ff00",e.style.fontFamily="monospace",e.style.fontSize="12px",e.style.zIndex="10000",e.style.pointerEvents="none",n.appendChild(e),e}updateDebugOverlay(n,e,m){n.innerHTML=`
      <div><strong>GPU Timeline Renderer</strong></div>
      <div>FPS: ${e.fps}</div>
      <div>Frame: ${e.frameTime}ms</div>
      <div>Avg: ${e.avgFrameTime}ms</div>
      <div>Dropped: ${e.droppedFrames}</div>
      <div>---</div>
      <div>Textures: ${m.totalTextures}</div>
      <div>Hit Rate: ${m.hitRate}%</div>
    `}}(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(Pt({position:lt,scale:lt,rotation:Pe,opacity:Pe,screenSize:lt,rotationX:Pe,rotationY:Pe,rotationZ:Pe,perspective:Pe,cameraOffset:lt,cameraScale:Pe,cameraYaw:Pe,cameraPitch:Pe,cameraRoll:Pe,cameraFOV:Pe,zDepth:Pe,anchorOffset:lt,backgroundMode:aa}),"LayerUniforms");(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(Pt({position:ia,offset:lt,yaw:Pe,pitch:Pe,roll:Pe,fov:Pe,scale:Pe,enabled:aa}),"CameraUniforms");(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(Pt({yaw:Pe,pitch:Pe,roll:Pe,fov:Pe,aspectRatio:Pe,screenSize:lt}),"PanoramaUniforms");(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(Pt({position:sa.position,uv:Zt(0,lt),opacity:Zt(1,Pe)}),"VertexOutput");function _a(t,n,e){let m=null,v=null,_=!1,P=null,F=null,O=null,z=!1;const V=new Map,S={};async function T(){const i=localStorage.getItem("timeline_disable_gpu")==="true";if(localStorage.getItem("timeline_gpu_camera_rotation"),!i&&"gpu"in navigator&&n.value)try{console.log("[Timeline] Attempting WebGPU initialization...");const l=await navigator.gpu.requestAdapter();if(console.log("[Timeline] GPU adapter:",l),l){const b=await l.requestDevice();console.log("[Timeline] GPU device:",b);const c=n.value.getContext("webgpu");if(console.log("[Timeline] WebGPU context:",c),c){const u=navigator.gpu.getPreferredCanvasFormat();console.log("[Timeline] Presentation format:",u),c.configure({device:b,format:u,alphaMode:"premultiplied"});const d=localStorage.getItem("timeline_gpu_advanced")==="true";P=new ya({device:b,presentationFormat:u,width:t.project.width,height:t.project.height,useAdvancedTransforms:d}),O=new ga(b,l),F=c,z=!0,console.log("[Timeline] ✅ WebGPU initialized successfully"),console.log("[Timeline] Canvas size:",t.project.width,"x",t.project.height),e.value&&(v=e.value.getContext("2d",{alpha:!0}));return}}}catch(l){console.warn("[Timeline] ❌ WebGPU initialization failed, falling back to Canvas 2D:",l)}else i?console.log("[Timeline] GPU rendering disabled by user preference"):"gpu"in navigator||console.log("[Timeline] WebGPU not supported in this browser");console.log("[Timeline] Using Canvas 2D renderer"),z=!1,n.value&&(m=n.value.getContext("2d",{alpha:!1,desynchronized:!0})),e.value&&(v=e.value.getContext("2d",{alpha:!0}))}function R(){_||(_=!0,requestAnimationFrame(()=>{_=!1,j()}))}function J(i){if(i.img)return i.img;if(!i.image_data)return null;const l=i.id;if(V.has(l)){const c=V.get(l);return c.complete?(i.img=c,c):null}const b=new Image;return b.onload=()=>{i.img=b,R()},b.src=i.image_data,V.set(l,b),null}function G(i,l,b){if(!i||i.length===0)return b;const c=[...i].sort((u,d)=>u.time-d.time);if(l<=c[0].time)return c[0].value;if(l>=c[c.length-1].time)return c[c.length-1].value;for(let u=0;u<c.length-1;u++)if(l>=c[u].time&&l<=c[u+1].time){const d=(l-c[u].time)/(c[u+1].time-c[u].time);return c[u].value+(c[u+1].value-c[u].value)*d}return b}function ee(i,l,b){if(!i||i.length<2)return null;const c=l/b,d=i.length-1,g=Math.min(Math.floor(c*d),d-1),x=c*d-g,y=i[g],L=i[g+1];if(!y||!L)return null;const Z=y.cp2x??y.x+(L.x-y.x)/3,K=y.cp2y??y.y+(L.y-y.y)/3,X=L.cp1x??y.x+(L.x-y.x)*2/3,q=L.cp1y??y.y+(L.y-y.y)*2/3,oe=1-x,se=oe*oe,pe=se*oe,de=x*x,ye=de*x;return{x:pe*y.x+3*se*x*Z+3*oe*de*X+ye*L.x,y:pe*y.y+3*se*x*K+3*oe*de*q+ye*L.y}}function Y(i){const l=t.currentTime,b=i.keyframes||{};let c=G(b.x,l,i.x||0),u=G(b.y,l,i.y||0);if(i.usePathAnimation&&i.bezierPath&&i.bezierPath.length>=2){const d=ee(i.bezierPath,l,t.project.duration);d&&(c=d.x,u=d.y)}return{x:c,y:u,z:G(b.z,l,i.z||0),scale:G(b.scale,l,i.scale||1),rotation:G(b.rotation,l,i.rotation||0),opacity:G(b.opacity,l,i.opacity??1),mask_size:G(b.mask_size,l,i.mask_size||0),rotationX:G(b.rotationX,l,i.rotationX||0),rotationY:G(b.rotationY,l,i.rotationY||0),rotationZ:G(b.rotationZ,l,i.rotationZ||0),anchorX:G(b.anchorX,l,i.anchorX||0),anchorY:G(b.anchorY,l,i.anchorY||0),perspective:G(b.perspective,l,i.perspective||1e3)}}function j(){z&&P&&F?Se():Fe(),Ee()}function Se(){var c,u,d,g,x,y,L,Z,K;if(!P||!F)return;let i=!0;for(const X of t.layers)X.image_data&&!X.img&&(J(X)||(i=!1));if(!i){Fe();return}const b={enabled:!!t.project.cam_enable&&!t.project.pano_enable,position:{x:((c=t.interpolateProjectValue)==null?void 0:c.call(t,"cam_pos_x",t.currentTime,t.project.cam_pos_x||0))??(t.project.cam_pos_x||0),y:((u=t.interpolateProjectValue)==null?void 0:u.call(t,"cam_pos_y",t.currentTime,t.project.cam_pos_y||0))??(t.project.cam_pos_y||0),z:((d=t.interpolateProjectValue)==null?void 0:d.call(t,"cam_pos_z",t.currentTime,t.project.cam_pos_z||0))??(t.project.cam_pos_z||0)},offset:{x:((g=t.interpolateProjectValue)==null?void 0:g.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x||0))??(t.project.cam_offset_x||0),y:((x=t.interpolateProjectValue)==null?void 0:x.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y||0))??(t.project.cam_offset_y||0)},rotation:{yaw:((y=t.interpolateProjectValue)==null?void 0:y.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw||0))??(t.project.cam_yaw||0),pitch:((L=t.interpolateProjectValue)==null?void 0:L.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch||0))??(t.project.cam_pitch||0),roll:((Z=t.interpolateProjectValue)==null?void 0:Z.call(t,"cam_roll",t.currentTime,t.project.cam_roll||0))??(t.project.cam_roll||0)},fov:((K=t.interpolateProjectValue)==null?void 0:K.call(t,"cam_fov",t.currentTime,t.project.cam_fov||90))??(t.project.cam_fov||90),panorama:!!t.project.pano_enable};try{const X=t.project.width,q=t.project.height;P.resizeRenderTargets(X,q);const oe=F.getCurrentTexture().createView();P.renderFrame(t.layers,t.currentTime,b,oe)}catch(X){console.error("[Timeline] GPU rendering error:",X),z=!1,Fe()}}function Fe(){var u,d,g;if(!n.value||!m)return;m.fillStyle="#000",m.fillRect(0,0,t.project.width,t.project.height);const i=((u=t.interpolateProjectValue)==null?void 0:u.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x??0))??t.project.cam_offset_x??0,l=((d=t.interpolateProjectValue)==null?void 0:d.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y??0))??t.project.cam_offset_y??0;t.project.pano_enable;const b=!!t.project.cam_enable,c=t.layers.find(x=>x.type==="background");c&&m&&ze(m,c,i,l,1,b),m&&t.layers.filter(x=>x.type!=="background").forEach(x=>{ke(m,x,i,l,b,1)}),t.pathMode.enabled&&((g=t.currentLayer)!=null&&g.bezierPath)&&m&&ie(m,t.currentLayer.bezierPath),t.extractMode.enabled}let Ie=null;function Le(i){Ie=i}function Ee(){var c,u;if(!e.value||!v)return;const i=v,l=t.project.width,b=t.project.height;i.clearRect(0,0,l,b),t.pathMode.enabled&&((c=t.currentLayer)!=null&&c.bezierPath)&&Ze(i,t.currentLayer.bezierPath),t.extractMode.enabled&&Ie&&Ie(i),t.maskMode.enabled&&((u=t.currentLayer)!=null&&u.maskCanvas)&&De(i),t.currentLayer&&t.currentLayer.img&&Ce(i)}function xe(i,l,b){if(i.maskCanvas||!i.customMask)return;const c=new Image;c.onload=()=>{const u=document.createElement("canvas");u.width=c.width||l,u.height=c.height||b;const d=u.getContext("2d");d&&(d.drawImage(c,0,0,u.width,u.height),i.maskCanvas=u,R())},c.src=i.customMask}function ze(i,l,b=0,c=0,u=1,d=!1){var pe,de,ye,le;const g=J(l);if(!g||g.width===0||g.height===0)return;const x=Y(l),y=!!t.project.pano_enable;i.save(),i.globalAlpha=x.opacity;const L=l.bg_mode||"fit",Z=t.project.width,K=t.project.height,X=g.width,q=g.height;let oe=1;if(y&&X>0&&q>0){const Ue=((pe=t.interpolateProjectValue)==null?void 0:pe.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw||0))??(t.project.cam_yaw||0),We=((de=t.interpolateProjectValue)==null?void 0:de.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch||0))??(t.project.cam_pitch||0),Ye=((ye=t.interpolateProjectValue)==null?void 0:ye.call(t,"cam_roll",t.currentTime,t.project.cam_roll||0))??(t.project.cam_roll||0),Be=Math.min(170,Math.max(10,((le=t.interpolateProjectValue)==null?void 0:le.call(t,"cam_fov",t.currentTime,t.project.cam_fov||90))??(t.project.cam_fov||90))),ue=Math.PI/180,fe=1024;let f=Z,h=K;const M=Math.max(1,Math.max(Z,K)/fe);M>1.01&&(f=Math.max(1,Math.round(Z/M)),h=Math.max(1,Math.round(K/M)));const B=`${f}x${h}|${X}x${q}|${Ue}|${We}|${Ye}|${Be}`;if(S.key!==B){const re=document.createElement("canvas");re.width=X,re.height=q;const we=re.getContext("2d");we?(we.drawImage(g,0,0,X,q),S.srcData=we.getImageData(0,0,X,q).data):S.srcData=void 0;const Xe=Z/Math.max(1,K),$e=Math.tan(Be*ue/2),je=Ue*ue,Te=We*ue,me=Ye*ue,_e=Math.cos(je),tt=Math.sin(je),ot=Math.cos(Te),ht=Math.sin(Te),vt=Math.cos(me),ut=Math.sin(me),rt=new Float32Array(f*h),mt=new Float32Array(f*h);for(let it=0;it<h;it++){const yt=(it+.5)/h*2-1;for(let st=0;st<f;st++){let He=((st+.5)/f*2-1)*$e*Xe,Je=-yt*$e,Qe=1;const gt=1/Math.hypot(He,Je,Qe);He*=gt,Je*=gt,Qe*=gt;let s=_e*He+tt*Qe,a=-tt*He+_e*Qe;He=s,Qe=a;let o=ot*Je-ht*Qe;a=ht*Je+ot*Qe,Je=o,Qe=a,s=vt*He-ut*Je,o=ut*He+vt*Je,He=s,Je=o;const p=Math.atan2(He,Qe),w=Math.asin(Math.max(-1,Math.min(1,Je))),E=(p/(Math.PI*2)+.5)*X,A=(.5-w/Math.PI)*q;let Q=Math.floor(E)%X;Q<0&&(Q+=X);let $=Math.floor(A);$=Math.max(0,Math.min(q-1,$));const Me=it*f+st;rt[Me]=Q,mt[Me]=$}}S.key=B,S.mapX=rt,S.mapY=mt,S.imgW=X,S.imgH=q,S.outW=f,S.outH=h,S.canvas=document.createElement("canvas"),S.canvas.width=f,S.canvas.height=h,S.ctx=S.canvas.getContext("2d")}const I=S.srcData,H=S.mapX,te=S.mapY,U=S.canvas,he=S.ctx,ge=S.outW||0,Re=S.outH||0;if(I&&H&&te&&U&&he&&ge>0&&Re>0){const re=he.getImageData(0,0,ge,Re),we=re.data,Xe=ge*Re;for(let $e=0;$e<Xe;$e++){const je=H[$e],me=(te[$e]*X+je)*4,_e=$e*4;we[_e]=I[me],we[_e+1]=I[me+1],we[_e+2]=I[me+2],we[_e+3]=255}he.putImageData(re,0,0),i.drawImage(U,0,0,Z,K),i.restore();return}else return i.restore(),ze(i,{...l,panoFallback:!0,type:l.type,bg_mode:l.bg_mode},b,c,1,!1)}else{X>0&&q>0&&(L==="fit"?oe=Math.min(Z/X,K/q):L==="fill"?oe=Math.max(Z/X,K/q):L==="stretch"&&(oe=Math.min(Z/X,K/q))),(!Number.isFinite(oe)||oe<=0)&&(oe=1);let Ue=x.x,We=x.y;const Ye=x.z||0,Be=1/Math.max(.1,1+Ye*.001),ue=Z/2+Ue+b,fe=K/2+We+c,f=(x.scale||1)*oe*Be;if(!Number.isFinite(ue)||!Number.isFinite(fe)||!Number.isFinite(f)||f<=0){i.restore();return}i.translate(ue,fe);const h=x.rotationZ!==void 0&&x.rotationZ!==0?x.rotationZ:x.rotation;i.rotate((h||0)*Math.PI/180),i.scale(f,f),i.drawImage(g,-X/2,-q/2,X,q)}i.restore()}function ke(i,l,b=0,c=0,u=!1,d=1){var We,Ye,Be;const g=J(l);if(!g||g.width===0||g.height===0)return;const x=Y(l),y=g.width,L=g.height;xe(l,y,L),i.save();const Z=!!t.project.pano_enable;let K=x.x,X=x.y;const q=x.z||0;if(u||Z){const ue=((We=t.interpolateProjectValue)==null?void 0:We.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw??0))??t.project.cam_yaw??0,fe=((Ye=t.interpolateProjectValue)==null?void 0:Ye.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch??0))??t.project.cam_pitch??0,f=((Be=t.interpolateProjectValue)==null?void 0:Be.call(t,"cam_fov",t.currentTime,t.project.cam_fov??90))??t.project.cam_fov??90;if(ue!==0||fe!==0){const h=ue*Math.PI/180,M=fe*Math.PI/180,B=Math.tan(f*Math.PI/180/2),D=t.project.width/(2*B);K-=Math.tan(h)*D,X-=Math.tan(M)*D}}const oe=1/Math.max(.1,1+q*.001),se=t.project.width/2+K+b,pe=t.project.height/2+X+c;if(!Number.isFinite(se)||!Number.isFinite(pe)){i.restore();return}if(i.translate(se,pe),x.rotationX!==0||x.rotationY!==0){const ue=x.rotationX*Math.PI/180,fe=x.rotationY*Math.PI/180,f=Math.cos(ue),h=Math.cos(fe);i.scale(h,f)}const de=x.rotationZ!==void 0&&x.rotationZ!==0?x.rotationZ:x.rotation;i.rotate(de*Math.PI/180);const ye=x.scale*oe;i.scale(ye,ye),i.globalAlpha=x.opacity;const le=(x.anchorX||0)*y,Ue=(x.anchorY||0)*L;if(l.maskCanvas){const ue=document.createElement("canvas");ue.width=y,ue.height=L;const fe=ue.getContext("2d");fe?(fe.clearRect(0,0,y,L),fe.drawImage(g,0,0,y,L),fe.globalCompositeOperation="destination-in",fe.drawImage(l.maskCanvas,0,0,y,L),i.drawImage(ue,-y/2-le,-L/2-Ue,y,L)):i.drawImage(g,-y/2-le,-L/2-Ue,y,L)}else i.drawImage(g,-y/2-le,-L/2-Ue,y,L);if(x.mask_size>0){i.strokeStyle="#3ac88e",i.lineWidth=2/x.scale,i.setLineDash([5/x.scale,5/x.scale]);const ue=y*x.mask_size,fe=L*x.mask_size;i.strokeRect(-ue/2,-fe/2,ue,fe),i.setLineDash([])}i.restore()}function ie(i,l){if(!l||l.length===0)return;const b=t.project.width/2,c=t.project.height/2;i.save(),i.strokeStyle="#ff6b6b",i.lineWidth=2,i.setLineDash([5,5]),i.beginPath(),i.moveTo(b+l[0].x,c+l[0].y);for(let u=1;u<l.length;u++){const d=l[u-1],g=l[u],x=d.cp2x??d.x+(g.x-d.x)/3,y=d.cp2y??d.y+(g.y-d.y)/3,L=g.cp1x??d.x+(g.x-d.x)*2/3,Z=g.cp1y??d.y+(g.y-d.y)*2/3;i.bezierCurveTo(b+x,c+y,b+L,c+Z,b+g.x,c+g.y)}if(i.stroke(),i.setLineDash([]),l.forEach((u,d)=>{i.beginPath(),i.arc(b+u.x,c+u.y,6,0,Math.PI*2),i.fillStyle=d===0?"#4ecdc4":d===l.length-1?"#ff6b6b":"#ffe66d",i.fill(),i.strokeStyle="#fff",i.lineWidth=2,i.stroke()}),l.length>=2){const u=l.length-1,d=l[u-1],g=l[u],x=d.cp2x??d.x+(g.x-d.x)/3,y=d.cp2y??d.y+(g.y-d.y)/3,L=g.cp1x??d.x+(g.x-d.x)*2/3,Z=g.cp1y??d.y+(g.y-d.y)*2/3,K=.99,X=1-K,q=3*X*X*(x-d.x)+6*X*K*(L-x)+3*K*K*(g.x-L),oe=3*X*X*(y-d.y)+6*X*K*(Z-y)+3*K*K*(g.y-Z),se=Math.atan2(oe,q),pe=b+g.x,de=c+g.y,ye=18;i.beginPath(),i.moveTo(pe,de),i.lineTo(pe-ye*Math.cos(se-Math.PI/6),de-ye*Math.sin(se-Math.PI/6)),i.moveTo(pe,de),i.lineTo(pe-ye*Math.cos(se+Math.PI/6),de-ye*Math.sin(se+Math.PI/6)),i.strokeStyle="#ff6b6b",i.lineWidth=2,i.stroke()}i.restore()}function Ze(i,l){if(!l||l.length===0)return;const b=t.project.width/2,c=t.project.height/2;i.save(),i.strokeStyle="#ff6b6b",i.lineWidth=2,i.setLineDash([5,5]),i.beginPath(),i.moveTo(b+l[0].x,c+l[0].y);for(let u=1;u<l.length;u++){const d=l[u-1],g=l[u],x=d.cp2x??d.x+(g.x-d.x)/3,y=d.cp2y??d.y+(g.y-d.y)/3,L=g.cp1x??d.x+(g.x-d.x)*2/3,Z=g.cp1y??d.y+(g.y-d.y)*2/3;i.bezierCurveTo(b+x,c+y,b+L,c+Z,b+g.x,c+g.y)}i.stroke(),i.setLineDash([]),l.forEach((u,d)=>{i.beginPath(),i.arc(b+u.x,c+u.y,6,0,Math.PI*2),i.fillStyle=d===0?"#4ecdc4":d===l.length-1?"#ff6b6b":"#ffe66d",i.fill(),i.strokeStyle="#fff",i.lineWidth=2,i.stroke()}),i.restore()}function De(i){var de,ye;const l=t.currentLayer;if(!l||!l.maskCanvas||!l.img)return;const b=Y(l),c=l.img.width,u=l.img.height,d=t.project.width,g=t.project.height,x=d/2,y=g/2,L=((de=t.interpolateProjectValue)==null?void 0:de.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x??0))??t.project.cam_offset_x??0,Z=((ye=t.interpolateProjectValue)==null?void 0:ye.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y??0))??t.project.cam_offset_y??0,K=b.z||0,X=1/Math.max(.1,1+K*.001),q=b.x+L,oe=b.y+Z,se=b.scale*X;i.save(),i.globalAlpha=.5,i.translate(x+q,y+oe);const pe=b.rotationZ!==void 0&&b.rotationZ!==0?b.rotationZ:b.rotation;i.rotate(pe*Math.PI/180),i.scale(se,se),i.fillStyle="rgba(255, 0, 0, 0.3)",i.fillRect(-c/2,-u/2,c,u),i.globalCompositeOperation="destination-out",i.drawImage(l.maskCanvas,-c/2,-u/2,c,u),i.restore()}function Ce(i){var Ye,Be,ue,fe,f;const l=t.currentLayer;if(!l||!l.img)return;const b=Y(l),c=l.img.width,u=l.img.height,d=t.project.width,g=t.project.height,x=d/2,y=g/2,L=!!t.project.cam_enable,Z=!!t.project.pano_enable,K=((Ye=t.interpolateProjectValue)==null?void 0:Ye.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x??0))??t.project.cam_offset_x??0,X=((Be=t.interpolateProjectValue)==null?void 0:Be.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y??0))??t.project.cam_offset_y??0,q=b.z||0,oe=1/Math.max(.1,1+q*.001);let se=b.x,pe=b.y;if((L||Z)&&l.type!=="background"){const h=((ue=t.interpolateProjectValue)==null?void 0:ue.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw??0))??t.project.cam_yaw??0,M=((fe=t.interpolateProjectValue)==null?void 0:fe.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch??0))??t.project.cam_pitch??0,B=((f=t.interpolateProjectValue)==null?void 0:f.call(t,"cam_fov",t.currentTime,t.project.cam_fov??90))??t.project.cam_fov??90;if(h!==0||M!==0){const D=h*Math.PI/180,I=M*Math.PI/180,H=Math.tan(B*Math.PI/180/2),te=d/(2*H);se-=Math.tan(D)*te,pe-=Math.tan(I)*te}}let de=se+K,ye=pe+X,le=b.scale*oe;if(l.type==="background"&&c>0&&u>0){const h=l.bg_mode||"fit";let M=1;h==="fit"?M=Math.min(d/c,g/u):h==="fill"?M=Math.max(d/c,g/u):M=Math.min(d/c,g/u),le=b.scale*M*oe}(!Number.isFinite(le)||le<=0)&&(le=1),i.save(),i.translate(x+de,y+ye);const Ue=b.rotationZ!==void 0&&b.rotationZ!==0?b.rotationZ:b.rotation;i.rotate(Ue*Math.PI/180),i.scale(le,le),i.strokeStyle="#3a7bc8",i.lineWidth=2/le,i.strokeRect(-c/2,-u/2,c,u),i.fillStyle="#3a7bc8",[[-c/2,-u/2],[c/2,-u/2],[c/2,u/2],[-c/2,u/2]].forEach(([h,M])=>{i.fillRect(h-4/le,M-4/le,8/le,8/le)}),i.restore()}function W(){V.clear(),P&&(P.cleanup(),P=null),F=null}function C(i){i?(localStorage.removeItem("timeline_disable_gpu"),console.log("[Timeline] GPU rendering will be enabled on next reload")):(localStorage.setItem("timeline_disable_gpu","true"),console.log("[Timeline] GPU rendering will be disabled on next reload"))}return{initContexts:T,scheduleRender:R,render:j,getCachedImage:J,getLayerProps:Y,setDrawExtractOverlayOnCtx:Le,cleanup:W,panoCache:S,imageCache:V,isUsingGPU:()=>z,toggleGPU:C,getGPUStats:()=>(P==null?void 0:P.getCacheStats())||null,getPerformanceStats:()=>(P==null?void 0:P.getPerformanceStats())||null,resetPerformanceStats:()=>P==null?void 0:P.resetPerformanceStats()}}function ba(t,n,e,m,v,_){let P=!1,F=0,O=0,z=0,V=0,S=!1,T=!1,R=0,J=0,G=0,ee=0,Y=0,j=0,Se=!1,Fe=!1,Ie=!1,Le=!1,Ee=0,xe=0,ze=0,ke=0,ie=0,Ze=0,De=0,Ce=0,W=!1,C=null,i=null,l=null,b=!1,c=null,u=!1,d=-1;function g(f){return!(!(!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled)||!t.project.cam_enable||t.project.pano_enable||f&&"ctrlKey"in f&&f.ctrlKey)}function x(f){const h=e.value||n.value;if(!h)return{x:0,y:0};const M=h.getBoundingClientRect(),B=t.project.width/M.width,D=t.project.height/M.height;return{x:(f.clientX-M.left)*B,y:(f.clientY-M.top)*D}}function y(f,h,M){const B=t.currentTime;if(f.keyframes&&f.keyframes[h]&&f.keyframes[h].length>0){const D=f.keyframes[h].findIndex(I=>Math.abs(I.time-B)<.05);D>=0?f.keyframes[h][D]={time:f.keyframes[h][D].time,value:M}:(f.keyframes[h].push({time:B,value:M}),f.keyframes[h].sort((I,H)=>I.time-H.time))}t.updateLayer(t.currentLayerIndex,{[h]:M})}function L(f){var I;(I=e.value)==null||I.focus(),f.shiftKey,f.altKey;const h=x(f);if(g(f)){if(Ee=h.x,xe=h.y,ze=t.project.cam_pos_x||0,ke=t.project.cam_pos_y||0,ie=t.project.cam_pos_z||0,Ze=t.project.cam_yaw||0,De=t.project.cam_pitch||0,Ce=t.project.cam_roll||0,f.button===0&&f.shiftKey){Le=!0;return}if(f.button===0){Fe=!0;return}if(f.button===1){Se=!0;return}if(f.button===2){Ie=!0;return}}if(t.project.pano_enable&&!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled){if(R=h.x,J=h.y,G=t.project.cam_yaw||0,ee=t.project.cam_pitch||0,Y=t.project.cam_offset_x||0,j=t.project.cam_offset_y||0,f.button===1||f.button===2){S=!0;return}else if(f.button===0&&(!t.currentLayer||f.altKey)){T=!0;return}}if(!t.currentLayer)return;if(t.extractMode.enabled){if(!pe()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}b=!0,de(h.x,h.y,f.button===2||f.altKey);return}if(t.maskMode.enabled){W=!0,oe(),se(h.x,h.y);return}if(t.pathMode.enabled){Be(h);return}P=!0,F=h.x,O=h.y;const D=v(t.currentLayer);z=D.x,V=D.y}function Z(f){var H,te,U,he,ge,Re,re,we,Xe,$e;const h=x(f);if(Fe){const je=h.x-Ee,Te=h.y-xe,me=Ze+je*.25,_e=Math.max(-89,Math.min(89,De+Te*.25));t.setProject({cam_yaw:me,cam_pitch:_e}),(H=t.setProjectKeyframe)==null||H.call(t,"cam_yaw",t.currentTime,me),(te=t.setProjectKeyframe)==null||te.call(t,"cam_pitch",t.currentTime,_e),m();return}if(Se){const je=h.x-Ee,Te=h.y-xe,me=1+Math.max(0,(ie||0)/500),_e=ze+je*me,tt=ke+Te*me;t.setProject({cam_pos_x:_e,cam_pos_y:tt}),(U=t.setProjectKeyframe)==null||U.call(t,"cam_pos_x",t.currentTime,_e),(he=t.setProjectKeyframe)==null||he.call(t,"cam_pos_y",t.currentTime,tt),m();return}if(Ie){const je=h.y-xe,me=ie+je*2;t.setProject({cam_pos_z:me}),(ge=t.setProjectKeyframe)==null||ge.call(t,"cam_pos_z",t.currentTime,me),m();return}if(Le){const je=h.x-Ee,Te=Ce+je*.25;t.setProject({cam_roll:Te}),(Re=t.setProjectKeyframe)==null||Re.call(t,"cam_roll",t.currentTime,Te),m();return}if(S){const je=h.x-R,Te=h.y-J,me=G+je*.2,_e=Math.max(-89,Math.min(89,ee+Te*.2));t.setProject({cam_yaw:me,cam_pitch:_e}),(re=t.setProjectKeyframe)==null||re.call(t,"cam_yaw",t.currentTime,me),(we=t.setProjectKeyframe)==null||we.call(t,"cam_pitch",t.currentTime,_e),m();return}if(T){const je=h.x-R,Te=h.y-J,me=(Y||0)+je,_e=(j||0)+Te;t.setProject({cam_offset_x:me,cam_offset_y:_e}),(Xe=t.setProjectKeyframe)==null||Xe.call(t,"cam_offset_x",t.currentTime,me),($e=t.setProjectKeyframe)==null||$e.call(t,"cam_offset_y",t.currentTime,_e),m();return}if(t.extractMode.enabled&&b){de(h.x,h.y,(f.buttons&2)===2||f.altKey);return}if(W&&t.maskMode.enabled){se(h.x,h.y);return}if(u&&d>=0){fe(h);return}if(!P||!t.currentLayer)return;let M=h.x-F,B=h.y-O;f.shiftKey&&(Math.abs(M)>Math.abs(B)?B=0:M=0);const D=z+M,I=V+B;y(t.currentLayer,"x",D),y(t.currentLayer,"y",I),m()}function K(){P=!1,W=!1,b=!1,u=!1,d=-1,S=!1,T=!1,Se=!1,Fe=!1,Ie=!1,Le=!1}function X(f){var he,ge,Re;const h=f.deltaY>0?-.05:.05;if(g(f)){const re=t.project.cam_pos_z||0,we=8,Xe=re+(h>0?we:-we);t.setProject({cam_pos_z:Xe}),(he=t.setProjectKeyframe)==null||he.call(t,"cam_pos_z",t.currentTime,Xe),m();return}if(t.project.pano_enable&&!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled&&(!t.currentLayer||f.ctrlKey||f.altKey)){const re=Math.min(170,Math.max(10,(t.project.cam_fov||90)+(h>0?2:-2)));t.setProject({cam_fov:re}),(ge=t.setProjectKeyframe)==null||ge.call(t,"cam_fov",t.currentTime,re),m();return}if(!!t.project.cam_enable&&!t.project.pano_enable&&!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled&&!t.currentLayer&&!t.currentLayer){const re=t.project.cam_pos_z||0,we=5,Xe=re+(h>0?we:-we);t.setProject({cam_pos_z:Xe}),(Re=t.setProjectKeyframe)==null||Re.call(t,"cam_pos_z",t.currentTime,Xe),m();return}if(!t.currentLayer)return;const H=t.currentLayer,te=v(H),U=2;if(f.shiftKey&&!f.ctrlKey&&!f.altKey){const re=te.rotationX+(h>0?U:-U);y(H,"rotationX",re)}else if(f.ctrlKey&&!f.shiftKey&&!f.altKey){const re=te.rotationY+(h>0?U:-U);y(H,"rotationY",re)}else if(f.altKey&&!f.shiftKey&&!f.ctrlKey){const re=(te.rotationZ||te.rotation||0)+(h>0?U:-U);y(H,"rotationZ",re)}else{const re=Math.max(.1,Math.min(5,te.scale+h));y(H,"scale",re)}m()}function q(f){if(!t.currentLayer)return;const h=f.shiftKey?10:1,M=t.currentLayer,B=v(M);switch(f.key){case"ArrowLeft":y(M,"x",B.x-h),m(),f.preventDefault();break;case"ArrowRight":y(M,"x",B.x+h),m(),f.preventDefault();break;case"ArrowUp":y(M,"y",B.y-h),m(),f.preventDefault();break;case"ArrowDown":y(M,"y",B.y+h),m(),f.preventDefault();break;case"r":case"R":y(M,"x",0),y(M,"y",0),y(M,"scale",1),y(M,"rotation",0),y(M,"opacity",1),m(),f.preventDefault();break;case"Delete":case"Backspace":confirm("Delete current layer?")&&t.removeLayer(t.currentLayerIndex),f.preventDefault();break}}function oe(){const f=t.currentLayer;if(!(!f||!f.img)){if(f.maskCanvas)C=f.maskCanvas.getContext("2d");else if(f.maskCanvas=document.createElement("canvas"),f.maskCanvas.width=f.img.width,f.maskCanvas.height=f.img.height,C=f.maskCanvas.getContext("2d"),C)if(f.customMask){const h=new Image;h.onload=()=>{C==null||C.drawImage(h,0,0),m()},h.src=f.customMask}else C.globalCompositeOperation="source-over",C.fillStyle="white",C.fillRect(0,0,f.maskCanvas.width,f.maskCanvas.height)}}function se(f,h){const M=t.currentLayer;if(!M||((!C||!M.maskCanvas)&&oe(),!M.img||!C||!M.maskCanvas))return;const B=v(M),D=t.project.width/2+B.x,I=t.project.height/2+B.y,H=(f-D)/B.scale+M.img.width/2,te=(h-I)/B.scale+M.img.height/2,U=t.maskMode.brush||20;C.save(),C.beginPath(),C.arc(H,te,U,0,Math.PI*2),t.maskMode.erase?(C.globalCompositeOperation="source-over",C.fillStyle="white"):(C.globalCompositeOperation="destination-out",C.fillStyle="black"),C.fill(),C.restore(),m()}function pe(){const f=t.layers.find(M=>M.type==="background");if(!f)return null;const h=_(f);return h?((!i||!l||i.width!==h.width||i.height!==h.height||c!==f.id)&&(i=document.createElement("canvas"),i.width=h.width,i.height=h.height,l=i.getContext("2d"),l&&l.clearRect(0,0,h.width,h.height),c=f.id||null),{layer:f,img:h,ctx:l}):null}function de(f,h,M=!1){const B=pe();if(!B)return;const{layer:D,img:I,ctx:H}=B,te=v(D),U=t.project.width/2+(te.x??0),he=t.project.height/2+(te.y??0),ge=te.scale??1,Re=(f-U)/ge+I.width/2,re=(h-he)/ge+I.height/2,we=Math.max(1,t.extractMode.brush||30);H.beginPath(),H.arc(Re,re,we,0,Math.PI*2),H.fillStyle=M?"black":"white",H.fill(),m()}function ye(){l&&i&&(l.clearRect(0,0,i.width,i.height),m())}function le(){if(!l||!i)return!1;const f=l.getImageData(0,0,i.width,i.height).data;for(let h=0;h<f.length;h+=4)if(f[h]>10)return!0;return!1}function Ue(f,h,M){const B=f.canvas,D=document.createElement("canvas");D.width=h,D.height=M;const I=D.getContext("2d");if(!I)return null;I.drawImage(B,0,0);const H=20;I.globalCompositeOperation="destination-over";for(let te=0;te<H;te++)I.drawImage(D,1,0),I.drawImage(D,-1,0),I.drawImage(D,0,1),I.drawImage(D,0,-1),te%2===0&&(I.drawImage(D,1,1),I.drawImage(D,-1,-1),I.drawImage(D,1,-1),I.drawImage(D,-1,1));for(let te=0;te<10;te++)I.drawImage(D,2,0),I.drawImage(D,-2,0),I.drawImage(D,0,2),I.drawImage(D,0,-2),I.drawImage(D,2,2),I.drawImage(D,-2,-2),I.drawImage(D,2,-2),I.drawImage(D,-2,2);return D.toDataURL("image/png")}function We(){const f=pe();if(!f||!i||!l)return{error:"Background layer not ready"};if(!le())return null;const{img:h}=f,M=document.createElement("canvas");M.width=h.width,M.height=h.height;const B=M.getContext("2d");if(!B)return{error:"Cannot create temporary canvas"};B.drawImage(h,0,0),B.globalCompositeOperation="destination-in",B.drawImage(i,0,0);const D=M.toDataURL("image/png"),I=document.createElement("canvas");I.width=h.width,I.height=h.height;const H=I.getContext("2d");if(!H)return{error:"Cannot create background canvas"};H.drawImage(h,0,0),H.globalCompositeOperation="destination-out",H.drawImage(i,0,0),H.globalCompositeOperation="source-over";const te=Ue(H,h.width,h.height)||h.src,U=i.toDataURL("image/png");return{foregroundDataUrl:D,backgroundDataUrl:te,extractMaskDataUrl:U}}function Ye(f){var rt,mt,it,yt,st;if(!t.extractMode.enabled||!i||!c)return;const h=t.layers.find(pt=>pt.id===c);if(!h)return;const M=_(h);if(!M)return;const B=v(h),D=t.project.width,I=t.project.height,H=D/2,te=I/2,U=M.width,he=M.height,ge=!!t.project.cam_enable,Re=ge?((rt=t.interpolateProjectValue)==null?void 0:rt.call(t,"cam_pos_x",t.currentTime,t.project.cam_pos_x||0))??(t.project.cam_pos_x||0):0,re=ge?((mt=t.interpolateProjectValue)==null?void 0:mt.call(t,"cam_pos_y",t.currentTime,t.project.cam_pos_y||0))??(t.project.cam_pos_y||0):0,we=ge?((it=t.interpolateProjectValue)==null?void 0:it.call(t,"cam_pos_z",t.currentTime,t.project.cam_pos_z||0))??(t.project.cam_pos_z||0):0,Xe=((yt=t.interpolateProjectValue)==null?void 0:yt.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x||0))??(t.project.cam_offset_x||0),$e=((st=t.interpolateProjectValue)==null?void 0:st.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y||0))??(t.project.cam_offset_y||0),je=ge?Math.max(.2,Math.min(4,1/(1+we*.001))):1,Te=B.z||0,me=1/Math.max(.1,1+Te*.001),_e=ge?me:1,tt=ge?je:1;let ot=1;if(U>0&&he>0){const pt=h.bg_mode||"fit";pt==="fit"?ot=Math.min(D/U,I/he):pt==="fill"?ot=Math.max(D/U,I/he):ot=Math.min(D/U,I/he)}const ht=((B.x??0)+(Xe+Re)*_e)*tt,vt=((B.y??0)+($e+re)*_e)*tt,ut=(B.scale??1)*ot*tt*me;f.save(),f.translate(H+ht,te+vt),f.rotate((B.rotation??0)*Math.PI/180),f.scale(ut,ut),f.fillStyle="rgba(0, 0, 0, 0.65)",f.fillRect(-U/2,-he/2,U,he),f.globalCompositeOperation="destination-out",f.drawImage(i,-U/2,-he/2,U,he),f.restore()}function Be(f,h){const M=t.currentLayer;if(!M)return;M.bezierPath||(M.bezierPath=[]);const B=ue(f);if(B>=0)d=B,u=!0;else{const D=t.project.width/2,I=t.project.height/2;M.bezierPath.push({x:f.x-D,y:f.y-I}),M.bezierPath.length>=2&&(M.usePathAnimation=!0),m()}}function ue(f){const h=t.currentLayer;if(!h||!h.bezierPath)return-1;const M=t.project.width/2,B=t.project.height/2,D=10;for(let I=0;I<h.bezierPath.length;I++){const H=h.bezierPath[I],te=H.x+M-f.x,U=H.y+B-f.y;if(Math.sqrt(te*te+U*U)<D)return I}return-1}function fe(f){const h=t.currentLayer;if(!h||!h.bezierPath||d<0)return;const M=t.project.width/2,B=t.project.height/2;h.bezierPath[d].x=f.x-M,h.bezierPath[d].y=f.y-B,m()}return{onMouseDown:L,onMouseMove:Z,onMouseUp:K,onWheel:X,onKeyDown:q,getCanvasCoords:x,clearExtractSelection:ye,applyExtractSelection:We,drawExtractOverlayOnCtx:Ye}}function xa(t,n,e){const{x:m,y:v,z:_,rotationX:P,rotationY:F,rotationZ:O,scaleX:z,scaleY:V,scaleZ:S,anchorX:T,anchorY:R}=t,J=T*n,G=R*e,ee=[];return ee.push(`translate3d(${m-J}px, ${v-G}px, ${_}px)`),P!==0&&ee.push(`rotateX(${P}deg)`),F!==0&&ee.push(`rotateY(${F}deg)`),O!==0&&ee.push(`rotateZ(${O}deg)`),(z!==1||V!==1||S!==1)&&ee.push(`scale3d(${z}, ${V}, ${S})`),ee.join(" ")}function wa(t,n){const e=(.5+t)*100,m=(.5+n)*100;return`${e}% ${m}%`}function Pa(t,n){const e=Math.max(1,Math.min(179,t))*Math.PI/180;return n/(2*Math.tan(e/2))}function ta(t,n,e,m){const{cam_pos_x:v,cam_pos_y:_,cam_pos_z:P,cam_yaw:F,cam_pitch:O}=m,z=t-v,V=n-_,S=e-P,T=F*Math.PI/180,R=O*Math.PI/180,J=Math.cos(T),G=Math.sin(T),ee=Math.cos(R),Y=Math.sin(R),j=z*G+S*J;return V*Y+j*ee}function ka(t,n){return[...t].sort((e,m)=>{const v=ta(e.x,e.y,e.z,n);return ta(m.x,m.y,m.z,n)-v})}const Ma={class:"canvas-wrapper"},ja=["src","alt"],Ca=["width","height"],Ta=["width","height"],Sa={class:"canvas-info"},La={key:0},za={key:1},Fa={key:2,style:{color:"#ff9800","margin-left":"10px"}},Ia=Ct({__name:"CanvasPreview",setup(t,{expose:n}){const e=Lt(),m=be(),v=be(),_=be(),P=_a(e,m,v),{initContexts:F,scheduleRender:O,getCachedImage:z,getLayerProps:V,setDrawExtractOverlayOnCtx:S,cleanup:T}=P,R=ve(()=>e.project.preview_mode==="3d-css"),J=ve(()=>({x:Math.max(0,(e.project.width||0)/2),y:Math.max(0,(e.project.height||0)/2)})),G=ve(()=>({cam_pos_x:e.project.cam_pos_x??0,cam_pos_y:e.project.cam_pos_y??0,cam_pos_z:e.project.cam_pos_z??1e3,cam_yaw:e.project.cam_yaw??0,cam_pitch:e.project.cam_pitch??0,cam_roll:e.project.cam_roll??0,cam_fov:e.project.cam_fov??90})),ee=ve(()=>{const W=Math.max(1,e.project.height||1);return Pa(G.value.cam_fov,W)}),Y=ve(()=>({width:`${e.project.width}px`,height:`${e.project.height}px`,perspective:`${Math.round(ee.value)}px`,perspectiveOrigin:"50% 50%",transformStyle:"preserve-3d"})),j=ve(()=>{const W=[],C=G.value,i=e.project.cam_offset_x||0,l=e.project.cam_offset_y||0;W.push(`translate3d(${J.value.x}px, ${J.value.y}px, 0px)`);const b=-(C.cam_pos_x+i),c=-(C.cam_pos_y+l),u=-(C.cam_pos_z||0);if(W.push(`translate3d(${b}px, ${c}px, ${u}px)`),e.project.cam_enable){C.cam_pitch!==0&&W.push(`rotateX(${-C.cam_pitch}deg)`),C.cam_yaw!==0&&W.push(`rotateY(${-C.cam_yaw}deg)`),C.cam_roll!==0&&W.push(`rotateZ(${-C.cam_roll}deg)`);const d=Math.max(.2,Math.min(4,1/(1+(C.cam_pos_z??1e3)*.001)));d!==1&&W.push(`scale(${d})`)}return{transform:W.join(" ")||void 0,transformStyle:"preserve-3d"}}),Se=ve(()=>{if(!R.value)return[];const W=e.layers.map(l=>{const b=z(l);if(!b||!b.complete)return null;const c=Math.max(1,e.project.width||1),u=Math.max(1,e.project.height||1),d=V(l);let g=1;if(l.type==="background"&&b.width&&b.height){const se=l.bg_mode||"fit";se==="fit"?g=Math.min(c/b.width,u/b.height):se==="fill"?g=Math.max(c/b.width,u/b.height):g=Math.min(c/b.width,u/b.height),(!Number.isFinite(g)||g<=0)&&(g=1)}const x=(l.scaleX??d.scale??1)*g,y=(l.scaleY??d.scale??1)*g,L=l.scaleZ??1,Z=d.x,K=d.y,X=d.z||0,q=d.rotationZ!==void 0&&d.rotationZ!==0?d.rotationZ:d.rotation,oe=xa({x:Z,y:K,z:X,rotationX:d.rotationX||0,rotationY:d.rotationY||0,rotationZ:q||0,scaleX:x,scaleY:y,scaleZ:L,anchorX:l.anchorX??0,anchorY:l.anchorY??0,opacity:d.opacity??1},b.width,b.height);return{id:l.id,type:l.type,src:b.src||l.image_data,width:b.width,height:b.height,opacity:d.opacity??1,transform:oe,origin:wa(l.anchorX??0,l.anchorY??0),x:Z,y:K,z:X}}).filter(Boolean),C={cam_pos_x:G.value.cam_pos_x,cam_pos_y:G.value.cam_pos_y,cam_pos_z:G.value.cam_pos_z,cam_yaw:G.value.cam_yaw,cam_pitch:G.value.cam_pitch,cam_roll:G.value.cam_roll,cam_fov:G.value.cam_fov};return ka(W,C)}),Fe=ve(()=>{const W=G.value,C=[];return C.push("translate3d(0, 0, 0)"),W.cam_pitch&&C.push(`rotateX(${-W.cam_pitch}deg)`),W.cam_yaw&&C.push(`rotateY(${-W.cam_yaw}deg)`),W.cam_roll&&C.push(`rotateZ(${-W.cam_roll}deg)`),C.push("scale(0.6)"),{transform:C.join(" ")||void 0}}),Ie=ba(e,m,v,O,V,z),{onMouseDown:Le,onMouseMove:Ee,onMouseUp:xe,onWheel:ze,onKeyDown:ke,clearExtractSelection:ie,applyExtractSelection:Ze,drawExtractOverlayOnCtx:De}=Ie;S(De),Tt(()=>{F(),O()}),ca(()=>{T()});const Ce=()=>{R.value||O()};return ft(()=>[e.layers,e.currentLayer,e.currentTime],()=>{Ce()},{deep:!0}),ft(()=>e.project,()=>{Ce()},{deep:!0}),ft(()=>[e.project.cam_enable,e.project.cam_pos_x,e.project.cam_pos_y,e.project.cam_pos_z,e.project.cam_offset_x,e.project.cam_offset_y,e.project.cam_yaw,e.project.cam_pitch,e.project.cam_roll,e.project.cam_fov,e.project.pano_enable],()=>{Ce()}),ft(()=>e.extractMode.enabled,()=>{Ce()}),ft(()=>[e.maskMode.enabled,e.pathMode.enabled],()=>{Ce()}),ft(R,W=>{W||O()}),n({clearExtractSelection:ie,applyExtractSelection:Ze}),(W,C)=>(ne(),ae("div",{class:"canvas-preview",ref_key:"containerRef",ref:_},[r("div",Ma,[R.value?(ne(),ae("div",{key:0,class:"css-preview",style:Ke(Y.value)},[r("div",{class:"css-camera",style:Ke(j.value)},[(ne(!0),ae(Oe,null,qe(Se.value,(i,l)=>(ne(),ae("div",{key:i.id,class:"css-layer",style:Ke({width:i.width+"px",height:i.height+"px",opacity:i.opacity,transform:i.transform,transformOrigin:i.origin,zIndex:l})},[r("img",{src:i.src,alt:i.id,draggable:"false"},null,8,ja)],4))),128))],4),r("div",{class:"axis-widget",style:Ke(Fe.value)},[...C[7]||(C[7]=[la('<div class="axis axis-x" data-v-49eaa238></div><div class="axis axis-y" data-v-49eaa238></div><div class="axis axis-z" data-v-49eaa238></div><div class="axis-label axis-label-x" data-v-49eaa238>X</div><div class="axis-label axis-label-y" data-v-49eaa238>Y</div><div class="axis-label axis-label-z" data-v-49eaa238>Z</div>',6)])],4)],4)):Ne("",!0),r("canvas",{ref_key:"canvasRef",ref:m,width:k(e).project.width,height:k(e).project.height,class:Ve(["render-canvas",{"css-mode-hidden":R.value}])},null,10,Ca),r("canvas",{ref_key:"interactionCanvasRef",ref:v,width:k(e).project.width,height:k(e).project.height,class:Ve(["interaction-canvas",{"css-mode":R.value}]),onMousedown:C[0]||(C[0]=(...i)=>k(Le)&&k(Le)(...i)),onMousemove:C[1]||(C[1]=(...i)=>k(Ee)&&k(Ee)(...i)),onMouseup:C[2]||(C[2]=(...i)=>k(xe)&&k(xe)(...i)),onMouseleave:C[3]||(C[3]=(...i)=>k(xe)&&k(xe)(...i)),onWheel:C[4]||(C[4]=Ge((...i)=>k(ze)&&k(ze)(...i),["prevent"])),onContextmenu:C[5]||(C[5]=Ge(()=>{},["prevent"])),tabindex:"0",onKeydown:C[6]||(C[6]=(...i)=>k(ke)&&k(ke)(...i))},null,42,Ta),r("div",Sa,[k(e).currentLayer?(ne(),ae("span",La," Layer "+ce(k(e).currentLayerIndex+1)+" | X:"+ce(Math.round(k(e).currentLayer.x||0))+" Y:"+ce(Math.round(k(e).currentLayer.y||0))+" S:"+ce((k(e).currentLayer.scale||1).toFixed(2))+" R:"+ce(Math.round(k(e).currentLayer.rotation||0))+"° ",1)):(ne(),ae("span",za,"No layer selected")),k(e).project.cam_enable?(ne(),ae("span",Fa," 📷 3D Camera (Preview Approximation) ")):Ne("",!0)])])],512))}}),Ea=St(Ia,[["__scopeId","data-v-49eaa238"]]),Da={class:"project-settings"},Ua={class:"setting-row"},Ya=["value"],Xa={class:"setting-row"},Aa=["value"],Ba={class:"setting-row"},Ra=["value"],$a={class:"setting-row"},Oa=["value"],Va={class:"setting-row"},Ga=["checked"],Ka={key:0,class:"setting-note"},Za={class:"setting-row"},Wa=["checked"],Na={class:"setting-row"},qa=["value"],Ha={class:"setting-row"},Ja=["value"],Qa={class:"setting-row"},en=["value"],tn={class:"setting-row"},an=["value"],nn={class:"setting-row"},on=["value"],rn={class:"setting-row"},sn=["value"],cn={class:"setting-row"},ln=["value"],un={class:"setting-row"},mn=["value"],pn=Ct({__name:"ProjectSettings",setup(t){const n=Lt(),e=be(!1);Tt(()=>{e.value=localStorage.getItem("timeline_disable_gpu")==="true"});function m(Y){Y.target.checked?(localStorage.removeItem("timeline_disable_gpu"),e.value=!1):(localStorage.setItem("timeline_disable_gpu","true"),e.value=!0),alert("GPU设置已更改，请刷新页面以应用更改。")}function v(Y){n.setProject({width:parseInt(Y.target.value)||1280})}function _(Y){n.setProject({height:parseInt(Y.target.value)||720})}function P(Y){n.setProject({fps:parseInt(Y.target.value)||30})}function F(Y){n.setProject({total_frames:parseInt(Y.target.value)||150})}function O(Y){n.setProject({cam_enable:Y.target.checked})}function z(Y){n.setProject({cam_pos_x:parseFloat(Y.target.value)||0})}function V(Y){n.setProject({cam_pos_y:parseFloat(Y.target.value)||0})}function S(Y){n.setProject({cam_pos_z:parseFloat(Y.target.value)||0})}function T(Y){n.setProject({cam_yaw:parseFloat(Y.target.value)||0})}function R(Y){n.setProject({cam_pitch:parseFloat(Y.target.value)||0})}function J(Y){n.setProject({cam_roll:parseFloat(Y.target.value)||0})}function G(Y){n.setProject({cam_fov:parseFloat(Y.target.value)||90})}function ee(Y){const j=Y.target.value;n.setProject({preview_mode:j})}return(Y,j)=>(ne(),ae("div",Da,[j[21]||(j[21]=r("div",{class:"section-title"},"📐 项目",-1)),r("div",Ua,[j[0]||(j[0]=r("label",null,"宽度",-1)),r("input",{type:"number",value:k(n).project.width,onInput:v,min:"64",max:"8192"},null,40,Ya)]),r("div",Xa,[j[1]||(j[1]=r("label",null,"高度",-1)),r("input",{type:"number",value:k(n).project.height,onInput:_,min:"64",max:"8192"},null,40,Aa)]),r("div",Ba,[j[2]||(j[2]=r("label",null,"帧率",-1)),r("input",{type:"number",value:k(n).project.fps,onInput:P,min:"1",max:"120"},null,40,Ra)]),r("div",$a,[j[3]||(j[3]=r("label",null,"帧数",-1)),r("input",{type:"number",value:k(n).project.total_frames,onInput:F,min:"1",max:"9999"},null,40,Oa)]),j[22]||(j[22]=r("div",{class:"section-title"},"🖥️ 预览渲染",-1)),r("div",Va,[j[4]||(j[4]=r("label",null,"GPU加速",-1)),r("input",{type:"checkbox",checked:!e.value,onChange:m},null,40,Ga)]),e.value?(ne(),ae("div",Ka,[...j[5]||(j[5]=[r("small",{style:{color:"#f90","font-size":"10px"}}," ⚠️ 已禁用GPU，使用Canvas 2D渲染 ",-1)])])):Ne("",!0),j[23]||(j[23]=r("div",{class:"section-title"},"🎥 3D 摄像机",-1)),r("div",Za,[j[6]||(j[6]=r("label",null,"启用",-1)),r("input",{type:"checkbox",checked:k(n).project.cam_enable,onChange:O},null,40,Wa)]),k(n).project.cam_enable?(ne(),ae(Oe,{key:1},[j[16]||(j[16]=r("div",{class:"subsection-title"},"位置",-1)),r("div",Na,[j[7]||(j[7]=r("label",null,"X",-1)),r("input",{type:"number",value:k(n).project.cam_pos_x,onInput:z,step:"10"},null,40,qa)]),r("div",Ha,[j[8]||(j[8]=r("label",null,"Y",-1)),r("input",{type:"number",value:k(n).project.cam_pos_y,onInput:V,step:"10"},null,40,Ja)]),r("div",Qa,[j[9]||(j[9]=r("label",null,"Z (距离)",-1)),r("input",{type:"number",value:k(n).project.cam_pos_z,onInput:S,step:"50"},null,40,en)]),j[17]||(j[17]=r("div",{class:"subsection-title"},"旋转",-1)),r("div",tn,[j[10]||(j[10]=r("label",null,"Yaw (Y轴)",-1)),r("input",{type:"number",value:k(n).project.cam_yaw,onInput:T,step:"5"},null,40,an)]),r("div",nn,[j[11]||(j[11]=r("label",null,"Pitch (X轴)",-1)),r("input",{type:"number",value:k(n).project.cam_pitch,onInput:R,step:"5"},null,40,on)]),r("div",rn,[j[12]||(j[12]=r("label",null,"Roll (Z轴)",-1)),r("input",{type:"number",value:k(n).project.cam_roll,onInput:J,step:"5"},null,40,sn)]),j[18]||(j[18]=r("div",{class:"subsection-title"},"投影",-1)),r("div",cn,[j[13]||(j[13]=r("label",null,"FOV",-1)),r("input",{type:"number",value:k(n).project.cam_fov,onInput:G,min:"1",max:"179",step:"5"},null,40,ln)]),j[19]||(j[19]=r("div",{class:"subsection-title"},"预览模式",-1)),r("div",un,[j[15]||(j[15]=r("label",null,"模式",-1)),r("select",{value:k(n).project.preview_mode||"2d",onChange:ee,style:{width:"80px",padding:"4px",background:"#1a1a1a",border:"1px solid #444","border-radius":"3px",color:"#fff","font-size":"11px"}},[...j[14]||(j[14]=[r("option",{value:"2d"},"2D 近似",-1),r("option",{value:"3d-css"},"3D CSS (实验性)",-1)])],40,mn)]),j[20]||(j[20]=r("div",{class:"setting-note"},[r("small",{style:{color:"#666","font-size":"10px","line-height":"1.4"}},[Wt(" ⚠️ 预览仅为近似效果"),r("br"),Wt(" 最终渲染使用完整3D透视 ")])],-1))],64)):Ne("",!0)]))}}),dn=St(pn,[["__scopeId","data-v-dd7a8f2f"]]),fn={class:"ae-timeline-root"},hn={class:"ae-header"},vn={class:"header-center"},yn={class:"project-info"},gn={class:"header-right"},_n={class:"project-inputs"},bn={class:"project-field"},xn=["value"],wn={class:"project-field"},Pn=["value"],kn={class:"project-field"},Mn=["value"],jn={class:"project-field"},Cn=["value"],Tn={class:"project-field pano-field"},Sn={class:"hdr-toggle"},Ln={class:"hdr-toggle cam-enable"},zn={class:"cam-row"},Fn=["value"],In=["value"],En=["value"],Dn=["value"],Un={class:"cam-row cam-row-3d"},Yn=["value"],Xn=["value"],An=["value"],Bn={class:"ae-main"},Rn={class:"ae-inspector"},$n={key:0,class:"inspector-card"},On={class:"card-header"},Vn={class:"layer-title"},Gn={class:"card-subtitle"},Kn={key:1,class:"inspector-card empty"},Zn={key:2,class:"inspector-section"},Wn={class:"property-list"},Nn={class:"property-row"},qn=["value"],Hn={class:"property-row"},Jn=["value"],Qn={class:"property-row"},eo=["value"],to={class:"property-row"},ao=["value"],no={class:"property-row"},oo=["value"],ro={class:"property-row"},io=["value"],so={class:"property-row"},co=["value"],lo={class:"property-row slider-row"},uo={class:"slider-header"},mo={class:"prop-value"},po=["value"],fo={class:"inspector-section"},ho={class:"tools-grid"},vo=["disabled"],yo={key:0,class:"tool-settings"},go={class:"slider-header"},_o={class:"prop-value"},bo={key:1,class:"tool-settings"},xo={class:"slider-header"},wo={class:"prop-value"},Po={class:"inspector-section"},ko={class:"inspector-section"},Mo={class:"fit-row"},jo={class:"ae-viewport"},Co={class:"viewport-bar"},To={class:"duration-text"},So={class:"viewport-actions"},Lo={class:"time-text"},zo={class:"zoom-control"},Fo={class:"prop-value"},Io={class:"viewport-canvas"},Eo={class:"ae-timeline"},Do={class:"timeline-controls"},Uo={class:"controls-left"},Yo=["disabled"],Xo=["disabled"],Ao={class:"controls-center"},Bo={class:"time-display"},Ro={class:"playback-btns"},$o={class:"timeline-body"},Oo={class:"layers-panel"},Vo={class:"layers-header"},Go={class:"prop-label-small"},Ko=["onClick"],Zo=["onClick"],Wo={class:"layer-name"},No={class:"layer-btns"},qo=["onClick"],Ho=["onClick"],Jo={class:"prop-label-small"},Qo={class:"tick-text"},er=["title","onMousedown","onContextmenu"],tr=["onDblclick"],ar=["title","onMousedown","onContextmenu"],nr=["onClick"],or=["onClick"],rr=["onDblclick"],ir=["title","onMousedown","onClick","onContextmenu"],wt=80,sr=Ct({__name:"TimelineApp",props:{node:{}},setup(t){const n=t,e=Lt(),m=be(null),v=be(),_=be(),P=be(),F=be(0);let O="foreground",z=!1,V=null;const S=s=>{var a,o;return(o=(a=n.node)==null?void 0:a.widgets)==null?void 0:o.find(p=>p.name===s)};function T(s,a){const o=typeof s=="number"?s:parseFloat(s);return Number.isFinite(o)?o:a}const R=be("fit"),J=be(100),G=ve(()=>Math.max(.1,J.value/100)),ee=ve({get:()=>!!e.project.cam_enable,set:s=>{e.setProject({cam_enable:s}),U("cam_enable",s?1:0)}}),Y=ve({get:()=>e.project.pano_enable,set:s=>{e.setProject({pano_enable:s}),U("pano_enable",s?1:0)}}),j=ve({get:()=>e.project.cam_yaw,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_yaw;e.setProject({cam_yaw:a}),U("cam_yaw",a)}}),Se=ve({get:()=>e.project.cam_pitch,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pitch;e.setProject({cam_pitch:a}),U("cam_pitch",a)}}),Fe=ve({get:()=>e.project.cam_roll,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_roll;e.setProject({cam_roll:a}),U("cam_roll",a)}}),Ie=ve({get:()=>e.project.cam_fov,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_fov,o=Math.min(170,Math.max(10,a));e.setProject({cam_fov:o}),U("cam_fov",o)}}),Le=ve({get:()=>e.project.cam_pos_x||0,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pos_x||0;e.setProject({cam_pos_x:a}),U("cam_pos_x",a)}}),Ee=ve({get:()=>e.project.cam_pos_y||0,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pos_y||0;e.setProject({cam_pos_y:a}),U("cam_pos_y",a)}}),xe=ve({get:()=>e.project.cam_pos_z||0,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pos_z||0;e.setProject({cam_pos_z:a}),U("cam_pos_z",a)}});function ze(s){var a;if(s.code==="Space"){const o=(a=s.target)==null?void 0:a.tagName;if(o==="INPUT"||o==="TEXTAREA"||o==="SELECT")return;s.preventDefault(),s.stopPropagation(),e.togglePlayback()}}const ke=ve(()=>{const s=Math.max(1,e.project.fps||1);return e.project.duration||e.project.total_frames/s||0}),ie=ve(()=>{var p;const s=Math.max(.001,ke.value||0),a=F.value||((p=P.value)==null?void 0:p.clientWidth)||0,o=a?a/s:wt;return Math.max(wt,o)}),Ze=ve(()=>{var w;const o=ke.value*ie.value+120,p=F.value||((w=P.value)==null?void 0:w.clientWidth)||0;return Math.max(o,p,800)});ft(()=>e.extractMode.enabled,s=>{var a,o;s||(o=(a=m.value)==null?void 0:a.clearExtractSelection)==null||o.call(a)});function De(){var w;if(!P.value){setTimeout(De,100);return}const s=P.value.getBoundingClientRect(),a=((w=P.value.parentElement)==null?void 0:w.clientWidth)||s.width||0,o=typeof window<"u"?window.innerWidth:a,p=Math.max(a||o,800);p>0&&(F.value=p)}Tt(()=>{B(),De(),typeof ResizeObserver<"u"&&P.value?(V=new ResizeObserver(s=>{const a=s[0];a!=null&&a.contentRect&&(F.value=a.contentRect.width)}),V.observe(P.value)):window.addEventListener("resize",De),window.addEventListener("keydown",ze,{capture:!0}),window.addEventListener("beforeunload",yt,{capture:!0})});let Ce=!1,W=null;const C=be(new Set([0])),i=be(!1),l=be(null),b=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"z",label:"Z"},{key:"scale",label:"Scl"},{key:"rotation",label:"RotZ"},{key:"rotationX",label:"RotX"},{key:"rotationY",label:"RotY"},{key:"opacity",label:"Op"}],c=[{key:"cam_yaw",label:"Yaw"},{key:"cam_pitch",label:"Pitch"},{key:"cam_roll",label:"Roll"},{key:"cam_fov",label:"FOV"},{key:"cam_offset_x",label:"OffX"},{key:"cam_offset_y",label:"OffY"},{key:"cam_pos_x",label:"PosX"},{key:"cam_pos_y",label:"PosY"},{key:"cam_pos_z",label:"PosZ"}],u=ve(()=>{const s=e.currentLayer;if(!s)return{x:0,y:0,z:0,scale:1,rotation:0,rotationX:0,rotationY:0,rotationZ:0,opacity:1};const a=e.currentTime,o=s.keyframes||{};return{x:d(o.x,a,s.x||0),y:d(o.y,a,s.y||0),z:d(o.z,a,s.z||0),scale:d(o.scale,a,s.scale||1),rotation:d(o.rotation,a,s.rotation||0),rotationX:d(o.rotationX,a,s.rotationX||0),rotationY:d(o.rotationY,a,s.rotationY||0),rotationZ:d(o.rotationZ,a,s.rotationZ||s.rotation||0),opacity:d(o.opacity,a,s.opacity??1)}});function d(s,a,o){if(!s||s.length===0)return o;const p=[...s].sort((w,E)=>w.time-E.time);if(a<=p[0].time)return p[0].value;if(a>=p[p.length-1].time)return p[p.length-1].value;for(let w=0;w<p.length-1;w++)if(a>=p[w].time&&a<=p[w+1].time){const E=(a-p[w].time)/(p[w+1].time-p[w].time);return p[w].value+(p[w+1].value-p[w].value)*E}return o}function g(s,a){const o=e.currentLayer;if(!o)return;const p=parseFloat(a.target.value);if(isNaN(p))return;const w=e.currentTime;if(o.keyframes&&o.keyframes[s]&&o.keyframes[s].length>0){const E=o.keyframes[s].findIndex(A=>Math.abs(A.time-w)<.05);E>=0?o.keyframes[s][E]={time:o.keyframes[s][E].time,value:p}:(o.keyframes[s].push({time:w,value:p}),o.keyframes[s].sort((A,Q)=>A.time-Q.time))}e.updateLayer(e.currentLayerIndex,{[s]:p})}function x(s){const a=e.currentLayer;if(!a)return;const o=parseFloat(s.target.value);if(isNaN(o))return;const p=o/100,w=e.currentTime;if(a.keyframes&&a.keyframes.scale&&a.keyframes.scale.length>0){const E=a.keyframes.scale.findIndex(A=>Math.abs(A.time-w)<.05);E>=0?a.keyframes.scale[E]={time:a.keyframes.scale[E].time,value:p}:(a.keyframes.scale.push({time:w,value:p}),a.keyframes.scale.sort((A,Q)=>A.time-Q.time))}e.updateLayer(e.currentLayerIndex,{scale:p})}function y(s){const a=Math.floor(s/60),o=Math.floor(s%60),p=Math.floor(s%1*e.project.fps);return`${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`}function L(s,a){return!s.keyframes||!s.keyframes[a]?[]:s.keyframes[a].map(o=>({time:o.time,value:o.value}))}function Z(s){const a=[];if(!s.keyframes)return a;for(const o of b){const p=s.keyframes[o.key];p&&p.forEach(w=>a.push({time:w.time,prop:o.key}))}return a}function K(){const s=[],a=e.projectKeyframes;return c.forEach(o=>{const p=a[o.key];Array.isArray(p)&&p.forEach(w=>{typeof(w==null?void 0:w.time)=="number"&&s.push({time:w.time,prop:o.key,value:w.value??0})})}),s}function X(s,a){return a==="opacity"||a==="scale"?(s*100).toFixed(0)+"%":s.toFixed(1)}function q(s){C.value.has(s)?C.value.delete(s):C.value.add(s)}function oe(){i.value=!i.value}function se(s){const o=e.projectKeyframes[s];return Array.isArray(o)?o.map(p=>({time:p.time,value:p.value??0})):[]}function pe(s,a){const o=le(s),p=e.project[a]??0;e.setProjectKeyframe(a,o,p)}function de(s,a,o){if(s.button!==0)return;s.preventDefault();const p=s.clientX,w=o.time,E=o.value,A=$=>{const at=($.clientX-p)/ie.value,Ae=Math.max(0,Math.min(ke.value,w+at));e.deleteProjectKeyframe(a,o.time),e.setProjectKeyframe(a,Ae,E),o.time=Ae,e.setCurrentTime(Ae)},Q=()=>{document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",Q)};document.addEventListener("mousemove",A),document.addEventListener("mouseup",Q)}function ye(s){var a,o;s.hidden=!s.hidden,(o=(a=m.value)==null?void 0:a.scheduleRender)==null||o.call(a)}function le(s){if(!P.value)return 0;const a=P.value.querySelector(".tracks-content");if(!a)return 0;const o=a.getBoundingClientRect(),p=P.value.scrollLeft,w=s.clientX-o.left+p,E=ie.value||wt;if(w<=10)return 0;const A=w/E;return Math.max(0,Math.min(A,ke.value))}function Ue(s){s.preventDefault(),z=!0,e.setCurrentTime(le(s));const a=p=>{z&&e.setCurrentTime(le(p))},o=()=>{z=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",o)}function We(s){if(!e.currentLayer)return;const a=le(s);e.setCurrentTime(a),e.addKeyframe()}function Ye(s,a,o){const w=s.currentTarget.getBoundingClientRect(),E=s.clientX-w.left,A=ie.value||wt,Q=Math.max(0,E/A),$=e.layers[a];if(!$)return;const Me=$[o]??(o==="scale"||o==="opacity"?1:0);$.keyframes||($.keyframes={}),$.keyframes[o]||($.keyframes[o]=[]),$.keyframes[o].find(Ae=>Math.abs(Ae.time-Q)<.05)||($.keyframes[o].push({time:Q,value:Me}),$.keyframes[o].sort((Ae,nt)=>Ae.time-nt.time))}function Be(s,a,o){l.value={layerIdx:s,prop:a,time:o},e.selectLayer(s),e.setCurrentTime(o)}function ue(s,a,o){const p=l.value;return p?p.layerIdx===s&&p.prop===a&&Math.abs(p.time-o)<.01:!1}function fe(s,a,o,p){s.preventDefault(),Ce=!0,W={layerIdx:a,prop:o,originalTime:p.time},Be(a,o,p.time);const w=s.clientX,E=p.time,A=ie.value||wt,Q=Me=>{var dt;if(!Ce||!W)return;const Ae=(Me.clientX-w)/A;let nt=Math.max(0,E+Ae);const _t=e.layers[W.layerIdx];if((dt=_t==null?void 0:_t.keyframes)!=null&&dt[W.prop]){const ct=_t.keyframes[W.prop],xt=ct.findIndex(kt=>Math.abs(kt.time-W.originalTime)<.01);xt>=0&&(ct[xt].time=nt,W.originalTime=nt,l.value.time=nt,e.setCurrentTime(nt))}},$=()=>{var at;Ce=!1,W=null,document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",$);const Me=e.layers[a];(at=Me==null?void 0:Me.keyframes)!=null&&at[o]&&Me.keyframes[o].sort((Ae,nt)=>Ae.time-nt.time)};document.addEventListener("mousemove",Q),document.addEventListener("mouseup",$)}function f(s,a,o){var w,E,A,Q;const p=e.layers[s];(w=p==null?void 0:p.keyframes)!=null&&w[a]&&(p.keyframes[a]=p.keyframes[a].filter($=>Math.abs($.time-o)>.01),((E=l.value)==null?void 0:E.layerIdx)===s&&((A=l.value)==null?void 0:A.prop)===a&&Math.abs(((Q=l.value)==null?void 0:Q.time)-o)<.01&&(l.value=null))}function h(s){if(P.value){const a=s.target,o=P.value.querySelector(".tracks-list");o&&(o.scrollTop=a.scrollTop)}}function M(s){const a=s.target,o=document.querySelector(".layers-list");o&&(o.scrollTop=a.scrollTop)}function B(){var zt,Ft,It,Et,Dt,Ut,Yt,Xt,At,Bt,Rt,$t,Ot,Vt,Gt,Kt;if(!((zt=n.node)!=null&&zt.widgets))return;const s=T((Ft=S("width"))==null?void 0:Ft.value,e.project.width),a=T((It=S("height"))==null?void 0:It.value,e.project.height),o=Math.max(1,T((Et=S("fps"))==null?void 0:Et.value,e.project.fps)),p=Math.max(1,Math.round(T((Dt=S("total_frames"))==null?void 0:Dt.value,e.project.total_frames))),w=T((Ut=S("mask_expansion"))==null?void 0:Ut.value,e.project.mask_expansion),E=T((Yt=S("mask_feather"))==null?void 0:Yt.value,e.project.mask_feather),A=!!T((Xt=S("pano_enable"))==null?void 0:Xt.value,e.project.pano_enable?1:0),Q=T((At=S("cam_yaw"))==null?void 0:At.value,e.project.cam_yaw),$=T((Bt=S("cam_pitch"))==null?void 0:Bt.value,e.project.cam_pitch),Me=T((Rt=S("cam_roll"))==null?void 0:Rt.value,e.project.cam_roll),at=T(($t=S("cam_fov"))==null?void 0:$t.value,e.project.cam_fov),Ae=T((Ot=S("cam_pos_x"))==null?void 0:Ot.value,e.project.cam_pos_x||0),nt=T((Vt=S("cam_pos_y"))==null?void 0:Vt.value,e.project.cam_pos_y||0),_t=T((Gt=S("cam_pos_z"))==null?void 0:Gt.value,e.project.cam_pos_z||0);let dt=[];const ct=(Kt=S("layers_keyframes"))==null?void 0:Kt.value;let xt={};if(typeof ct=="string"&&ct.trim())try{const et=JSON.parse(ct);Array.isArray(et)?dt=et:et&&typeof et=="object"&&(Array.isArray(et.layers)&&(dt=et.layers),et.project_keyframes&&typeof et.project_keyframes=="object"&&(xt=et.project_keyframes))}catch(et){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",et)}else Array.isArray(ct)&&(dt=ct);const kt={width:s,height:a,fps:o,total_frames:p,duration:p/o,mask_expansion:w,mask_feather:E,pano_enable:A,cam_yaw:Q,cam_pitch:$,cam_roll:Me,cam_fov:at,cam_pos_x:Ae,cam_pos_y:nt,cam_pos_z:_t};e.loadAnimation({project:kt,layers:dt}),e.projectKeyframes.value=xt,e.layers.length>0&&e.currentLayerIndex<0&&e.selectLayer(0)}function D(s,a){return s.name?s.name:s.type==="background"?"Background":`Layer ${a+1}`}function I(){const s=e.exportAnimation(),a=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),o=URL.createObjectURL(a),p=document.createElement("a");p.href=o,p.download=`ae_project_${Date.now()}.json`,p.click(),URL.revokeObjectURL(o)}function H(){var s;(s=_.value)==null||s.click()}function te(s){var p;const a=(p=s.target.files)==null?void 0:p[0];if(!a)return;const o=new FileReader;o.onload=w=>{var E;try{const A=JSON.parse((E=w.target)==null?void 0:E.result);e.loadAnimation(A),console.log("Project loaded successfully")}catch(A){console.error("Failed to parse project file",A),alert("Project file is corrupted or has invalid format")}},o.readAsText(a),_.value&&(_.value.value="")}function U(s,a){const p=(w=>{var E,A;return(A=(E=n.node)==null?void 0:E.widgets)==null?void 0:A.find(Q=>Q.name===w)})(s);p&&(p.value=a,p.inputEl&&(p.inputEl.value=a,p.inputEl.dispatchEvent(new Event("input"))),p.callback&&p.callback(a))}function he(s,a){const o=parseInt(a.target.value,10);if(Number.isNaN(o))return;let p=o;s==="fps"&&(p=Math.max(1,p)),s==="total_frames"&&(p=Math.max(1,p)),(s==="width"||s==="height")&&(p=Math.max(16,p)),e.setProject({[s]:p}),U(s,p),e.setCurrentTime(e.currentTime)}function ge(){var p,w,E,A,Q;if(!((p=n.node)!=null&&p.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}console.log("[AE Timeline] Saving..."),e.layers.forEach($=>{$.maskCanvas&&($.customMask=$.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${$.id}: Saved mask (len=${$.customMask.length})`))});const s=e.exportAnimation();s.layers.forEach($=>{$.bezierPath&&$.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${$.id}: Exporting Path with ${$.bezierPath.length} points`)});const o=($=>n.node.widgets.find(Me=>Me.name===$))("layers_keyframes");if(o){const $=JSON.stringify({layers:s.layers,project_keyframes:e.projectKeyframes,project:s.project});if(o.value=$,console.log(`[AE Timeline] Saved layers_keyframes (len=${$.length})`),o.inputEl&&(o.inputEl.value=$,o.inputEl.dispatchEvent(new Event("input"))),o.callback&&o.callback($),n.node.widgets_values){const Me=n.node.widgets.indexOf(o);Me>=0&&(n.node.widgets_values[Me]=$)}(E=(w=n.node).setDirtyCanvas)==null||E.call(w,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");U("width",e.project.width),U("height",e.project.height),U("fps",e.project.fps),U("total_frames",e.project.total_frames),U("pano_enable",e.project.pano_enable?1:0),U("cam_yaw",e.project.cam_yaw),U("cam_pitch",e.project.cam_pitch),U("cam_roll",e.project.cam_roll),U("cam_fov",e.project.cam_fov),U("cam_pos_x",e.project.cam_pos_x||0),U("cam_pos_y",e.project.cam_pos_y||0),U("cam_pos_z",e.project.cam_pos_z||0),U("cam_pos_x",e.project.cam_pos_x||0),U("cam_pos_y",e.project.cam_pos_y||0),U("cam_pos_z",e.project.cam_pos_z||0),(Q=(A=n.node).setDirtyCanvas)==null||Q.call(A,!0,!1)}function Re(){ge();const s=document.querySelector(".ae-timeline-dialog");s&&s.close()}function re(){e.addKeyframe()}function we(){e.deleteKeyframe()}function Xe(){e.setCurrentTime(0)}function $e(){e.setCurrentTime(ke.value)}function je(){const s=e.currentTime,a=e.project,o=e.setProjectKeyframe;o&&c.forEach(p=>{const w=a[p.key]??0;o(p.key,s,w)})}function Te(){const s=e.currentTime,a=e.deleteProjectKeyframe;a&&c.forEach(o=>a(o.key,s))}function me(s,a){var o;(o=e.deleteProjectKeyframe)==null||o.call(e,s,a)}function _e(s,a){const o=s.clientX,p=a.time,w=A=>{var Ae;const $=(A.clientX-o)/ie.value,Me=Math.max(0,p+$),at=a.value??e.project[a.prop]??0;(Ae=e.setProjectKeyframe)==null||Ae.call(e,a.prop,Me,at)},E=()=>{window.removeEventListener("mousemove",w),window.removeEventListener("mouseup",E)};window.addEventListener("mousemove",w),window.addEventListener("mouseup",E)}function tt(){}function ot(){var s;e.currentLayer&&confirm("Clear all keyframes on this layer?")&&((s=e.clearAllKeyframes)==null||s.call(e))}function ht(){e.layers.forEach((s,a)=>{a!==e.currentLayerIndex&&(s._cachedImage&&delete s._cachedImage,console.log(`[AE Timeline] Cleared cache for layer ${s.id}`))})}function vt(){var s,a;(a=(s=m.value)==null?void 0:s.scheduleRender)==null||a.call(s),console.log("[AE Timeline] Preview refreshed")}function ut(){var s,a;n.node&&n.node.graph&&window.app&&((a=(s=window.app).queuePrompt)==null||a.call(s,0))}function rt(s){var w,E;const a={mask:e.maskMode,path:e.pathMode,extract:e.extractMode},o=a[s],p=!o.enabled;if(s==="extract"&&p&&!e.layers.find(Q=>Q.type==="background")){alert("Add a background layer before using extract");return}Object.entries(a).forEach(([A,Q])=>{A!==s&&(Q.enabled=!1)}),(!p||s!=="extract")&&((E=(w=m.value)==null?void 0:w.clearExtractSelection)==null||E.call(w)),o.enabled=p}function mt(){var s,a;(a=(s=m.value)==null?void 0:s.clearExtractSelection)==null||a.call(s)}function it(){var w,E;const s=m.value;if(!s||typeof s.applyExtractSelection!="function")return;const a=s.applyExtractSelection();if(!a){alert("Draw an extract selection first");return}if("error"in a){alert(a.error);return}const o=new Image;o.onload=()=>{const A=e.layers.filter(Q=>{var $;return($=Q.id)==null?void 0:$.startsWith("extracted_")}).length;e.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${A+1}`,type:"foreground",image_data:a.foregroundDataUrl,img:o,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},o.src=a.foregroundDataUrl;const p=e.layers.find(A=>A.type==="background");if(p&&a.backgroundDataUrl){const A=new Image;A.onload=()=>{p.image_data=a.backgroundDataUrl,p.img=A,e.updateLayer(e.layers.indexOf(p),{image_data:a.backgroundDataUrl})},A.src=a.backgroundDataUrl}e.extractMode.enabled=!1,(E=(w=m.value)==null?void 0:w.clearExtractSelection)==null||E.call(w)}function yt(){try{ge()}catch(s){console.warn("[AE Timeline] autosave failed",s)}}function st(){var s;O="foreground",(s=v.value)==null||s.click()}function pt(){var s;O="background",(s=v.value)==null||s.click()}function He(s){const a=s.target.files;a&&(Array.from(a).forEach((o,p)=>{const w=new FileReader;w.onload=E=>{var $;const A=($=E.target)==null?void 0:$.result,Q=new Image;Q.onload=()=>{e.addLayer({id:"uploaded_"+Date.now()+"_"+p,name:o.name.replace(/\.[^/.]+$/,""),type:O,image_data:A,img:Q,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},Q.src=A},w.readAsDataURL(o)}),v.value&&(v.value.value=""))}function Je(){gt(-1)}function Qe(){gt(1)}function gt(s){const a=e.currentLayerIndex;if(a<0)return;const o=a+s;if(o>=0&&o<e.layers.length){const p=e.layers[a];e.layers.splice(a,1),e.layers.splice(o,0,p),e.selectLayer(o)}}return ua(()=>{V&&P.value&&(V.disconnect(),V=null),window.removeEventListener("resize",De),window.removeEventListener("keydown",ze,{capture:!0}),ge()}),(s,a)=>(ne(),ae("div",fn,[r("header",hn,[r("div",{class:"header-left"},[a[34]||(a[34]=r("div",{class:"logo"},[r("div",{class:"logo-icon"},"AE"),r("span",{class:"logo-text"},"AE Animator")],-1)),a[35]||(a[35]=r("div",{class:"header-divider"},null,-1)),r("button",{class:"btn btn-ghost",onClick:I,title:"保存工程文件"},"Save"),r("button",{class:"btn btn-ghost",onClick:H,title:"加载工程文件"},"Load")]),r("div",vn,[r("span",yn,ce(k(e).project.width)+"x"+ce(k(e).project.height)+" @ "+ce(k(e).project.fps)+" FPS",1)]),r("div",gn,[r("div",_n,[r("div",bn,[a[36]||(a[36]=r("span",{class:"field-label"},"W",-1)),r("input",{type:"number",min:"16",max:"8192",value:k(e).project.width,onInput:a[0]||(a[0]=o=>he("width",o))},null,40,xn)]),r("div",wn,[a[37]||(a[37]=r("span",{class:"field-label"},"H",-1)),r("input",{type:"number",min:"16",max:"8192",value:k(e).project.height,onInput:a[1]||(a[1]=o=>he("height",o))},null,40,Pn)]),r("div",kn,[a[38]||(a[38]=r("span",{class:"field-label"},"FPS",-1)),r("input",{type:"number",min:"1",max:"240",value:k(e).project.fps,onInput:a[2]||(a[2]=o=>he("fps",o))},null,40,Mn)]),r("div",jn,[a[39]||(a[39]=r("span",{class:"field-label"},"Frames",-1)),r("input",{type:"number",min:"1",value:k(e).project.total_frames,onInput:a[3]||(a[3]=o=>he("total_frames",o))},null,40,Cn)]),r("div",Tn,[r("label",Sn,[bt(r("input",{type:"checkbox","onUpdate:modelValue":a[4]||(a[4]=o=>Y.value=o)},null,512),[[Nt,Y.value]]),a[40]||(a[40]=r("span",null,"Pano",-1))]),r("label",Ln,[bt(r("input",{type:"checkbox","onUpdate:modelValue":a[5]||(a[5]=o=>ee.value=o)},null,512),[[Nt,ee.value]]),a[41]||(a[41]=r("span",null,"Cam",-1))]),r("div",zn,[r("input",{type:"number",step:"1",value:j.value,onInput:a[6]||(a[6]=o=>j.value=parseFloat(o.target.value)),title:"Yaw"},null,40,Fn),r("input",{type:"number",step:"1",value:Se.value,onInput:a[7]||(a[7]=o=>Se.value=parseFloat(o.target.value)),title:"Pitch"},null,40,In),r("input",{type:"number",step:"1",value:Fe.value,onInput:a[8]||(a[8]=o=>Fe.value=parseFloat(o.target.value)),title:"Roll"},null,40,En),r("input",{type:"number",step:"1",min:"10",max:"170",value:Ie.value,onInput:a[9]||(a[9]=o=>Ie.value=parseFloat(o.target.value)),title:"FOV"},null,40,Dn)]),r("div",Un,[r("input",{type:"number",step:"1",value:Le.value,onInput:a[10]||(a[10]=o=>Le.value=parseFloat(o.target.value)),title:"Pos X"},null,40,Yn),r("input",{type:"number",step:"1",value:Ee.value,onInput:a[11]||(a[11]=o=>Ee.value=parseFloat(o.target.value)),title:"Pos Y"},null,40,Xn),r("input",{type:"number",step:"1",value:xe.value,onInput:a[12]||(a[12]=o=>xe.value=parseFloat(o.target.value)),title:"Pos Z"},null,40,An)])])]),r("button",{class:"btn btn-primary",onClick:st},"+ FG Layer"),r("button",{class:"btn btn-secondary",onClick:pt},"+ BG Layer"),a[42]||(a[42]=r("div",{class:"header-divider"},null,-1)),r("button",{class:"btn btn-accent",onClick:ge,title:"保存到节点"},"Save"),r("button",{class:"btn btn-close",onClick:Re,title:"关闭"},"Close")])]),r("div",Bn,[r("aside",Rn,[k(e).currentLayer?(ne(),ae("div",$n,[r("div",On,[r("span",Vn,ce(D(k(e).currentLayer,k(e).currentLayerIndex)),1),r("span",{class:Ve(["layer-badge",k(e).currentLayer.type])},ce(k(e).currentLayer.type==="background"?"BG":"FG"),3)]),r("div",Gn," Layer "+ce(k(e).currentLayerIndex+1)+" - "+ce(k(e).currentLayer.type==="background"?"Background":"Foreground"),1)])):(ne(),ae("div",Kn,[...a[43]||(a[43]=[r("span",null,"请选择一个图层",-1)])])),k(e).currentLayer?(ne(),ae("div",Zn,[a[56]||(a[56]=r("div",{class:"section-title"},"Transform",-1)),r("div",Wn,[r("div",Nn,[a[44]||(a[44]=r("span",{class:"prop-label"},"Position X",-1)),r("input",{type:"number",class:"prop-input",value:u.value.x.toFixed(0),onInput:a[13]||(a[13]=o=>g("x",o)),step:"1"},null,40,qn)]),r("div",Hn,[a[45]||(a[45]=r("span",{class:"prop-label"},"Position Y",-1)),r("input",{type:"number",class:"prop-input",value:u.value.y.toFixed(0),onInput:a[14]||(a[14]=o=>g("y",o)),step:"1"},null,40,Jn)]),r("div",Qn,[a[46]||(a[46]=r("span",{class:"prop-label"},"Position Z",-1)),r("input",{type:"number",class:"prop-input",value:u.value.z.toFixed(0),onInput:a[15]||(a[15]=o=>g("z",o)),step:"1"},null,40,eo)]),r("div",to,[a[47]||(a[47]=r("span",{class:"prop-label"},"Scale",-1)),r("input",{type:"number",class:"prop-input",value:(u.value.scale*100).toFixed(0),onInput:a[16]||(a[16]=o=>x(o)),step:"1"},null,40,ao),a[48]||(a[48]=r("span",{class:"prop-unit"},"%",-1))]),r("div",no,[a[49]||(a[49]=r("span",{class:"prop-label"},"Rot X",-1)),r("input",{type:"number",class:"prop-input",value:u.value.rotationX.toFixed(0),onInput:a[17]||(a[17]=o=>g("rotationX",o)),step:"1"},null,40,oo),a[50]||(a[50]=r("span",{class:"prop-unit"},"deg",-1))]),r("div",ro,[a[51]||(a[51]=r("span",{class:"prop-label"},"Rot Y",-1)),r("input",{type:"number",class:"prop-input",value:u.value.rotationY.toFixed(0),onInput:a[18]||(a[18]=o=>g("rotationY",o)),step:"1"},null,40,io),a[52]||(a[52]=r("span",{class:"prop-unit"},"deg",-1))]),r("div",so,[a[53]||(a[53]=r("span",{class:"prop-label"},"Rot Z",-1)),r("input",{type:"number",class:"prop-input",value:u.value.rotation.toFixed(0),onInput:a[19]||(a[19]=o=>g("rotation",o)),step:"1"},null,40,co),a[54]||(a[54]=r("span",{class:"prop-unit"},"deg",-1))]),r("div",lo,[r("div",uo,[a[55]||(a[55]=r("span",{class:"prop-label"},"Opacity",-1)),r("span",mo,ce((u.value.opacity*100).toFixed(0))+"%",1)]),r("input",{type:"range",class:"prop-slider",value:u.value.opacity,onInput:a[20]||(a[20]=o=>g("opacity",o)),min:"0",max:"1",step:"0.01"},null,40,po)])])])):Ne("",!0),r("div",fo,[a[59]||(a[59]=r("div",{class:"section-title"},"Tools",-1)),r("div",ho,[r("button",{class:Ve(["tool-btn",{active:k(e).maskMode.enabled}]),onClick:a[21]||(a[21]=o=>rt("mask"))},"Mask Mode",2),r("button",{class:Ve(["tool-btn",{active:k(e).maskMode.enabled&&k(e).maskMode.erase}]),onClick:a[22]||(a[22]=o=>k(e).maskMode.erase=!k(e).maskMode.erase),disabled:!k(e).maskMode.enabled},"Eraser",10,vo),r("button",{class:Ve(["tool-btn",{active:k(e).pathMode.enabled}]),onClick:a[23]||(a[23]=o=>rt("path"))},"Path Tool",2),r("button",{class:Ve(["tool-btn",{active:k(e).extractMode.enabled}]),onClick:a[24]||(a[24]=o=>rt("extract"))},"AI Extract",2)]),k(e).maskMode.enabled?(ne(),ae("div",yo,[r("div",go,[a[57]||(a[57]=r("span",{class:"prop-label"},"Brush Size",-1)),r("span",_o,ce(k(e).maskMode.brush)+"px",1)]),bt(r("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[25]||(a[25]=o=>k(e).maskMode.brush=o),min:"1",max:"100",step:"1"},null,512),[[Mt,k(e).maskMode.brush,void 0,{number:!0}]])])):Ne("",!0),k(e).extractMode.enabled?(ne(),ae("div",bo,[r("div",xo,[a[58]||(a[58]=r("span",{class:"prop-label"},"Brush Size",-1)),r("span",wo,ce(k(e).extractMode.brush)+"px",1)]),bt(r("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[26]||(a[26]=o=>k(e).extractMode.brush=o),min:"5",max:"150",step:"1"},null,512),[[Mt,k(e).extractMode.brush,void 0,{number:!0}]]),r("div",{class:"extract-actions"},[r("button",{class:"btn btn-small btn-primary",onClick:it},"Apply"),r("button",{class:"btn btn-small btn-ghost",onClick:mt},"Clear")])])):Ne("",!0)]),r("div",Po,[qt(dn)]),r("div",ko,[a[62]||(a[62]=r("div",{class:"section-title"},"Actions",-1)),r("div",{class:"action-row"},[r("button",{class:"btn btn-small btn-ghost",onClick:ht},"Clear Cache"),r("button",{class:"btn btn-small btn-ghost",onClick:vt},"Refresh"),r("button",{class:"btn btn-small btn-accent",onClick:ut},"Run")]),r("div",Mo,[a[61]||(a[61]=r("span",{class:"prop-label"},"Fit Mode",-1)),bt(r("select",{class:"fit-select","onUpdate:modelValue":a[27]||(a[27]=o=>R.value=o)},[...a[60]||(a[60]=[r("option",{value:"fit"},"Fit",-1),r("option",{value:"fill"},"Fill",-1),r("option",{value:"stretch"},"Stretch",-1)])],512),[[ma,R.value]])])])]),r("main",jo,[r("div",Co,[r("span",To,"Duration: "+ce(y(ke.value)),1),r("div",So,[r("span",Lo,ce(y(k(e).currentTime)),1),r("div",zo,[a[63]||(a[63]=r("span",{class:"prop-label"},"Zoom",-1)),bt(r("input",{type:"range",min:"25",max:"200",step:"5","onUpdate:modelValue":a[28]||(a[28]=o=>J.value=o)},null,512),[[Mt,J.value,void 0,{number:!0}]]),r("span",Fo,ce(J.value)+"%",1)])])]),r("div",Io,[r("div",{class:"canvas-zoom",style:Ke({transform:`scale(${G.value})`})},[qt(Ea,{ref_key:"canvasPreviewRef",ref:m,fitMode:R.value},null,8,["fitMode"])],4)])])]),r("footer",Eo,[r("div",Do,[r("div",Uo,[r("button",{class:"btn btn-small btn-ghost",onClick:re},"+ Keyframe"),r("button",{class:"btn btn-small btn-ghost",onClick:we},"Del Key"),r("button",{class:"btn btn-small btn-ghost",onClick:ot},"Clear All"),r("button",{class:"btn btn-small btn-ghost",onClick:je},"+ Cam KF"),r("button",{class:"btn btn-small btn-ghost",onClick:Te},"Del Cam KF"),a[64]||(a[64]=r("div",{class:"controls-divider"},null,-1)),r("button",{class:"nav-btn",onClick:Je,disabled:!k(e).currentLayer},"Up",8,Yo),r("button",{class:"nav-btn",onClick:Qe,disabled:!k(e).currentLayer},"Down",8,Xo)]),r("div",Ao,[r("span",Bo,ce(y(k(e).currentTime)),1),r("div",Ro,[r("button",{class:"pb-btn",onClick:Xe},"|<"),r("button",{class:Ve(["play-btn",{playing:k(e).isPlaying}]),onClick:a[29]||(a[29]=(...o)=>k(e).togglePlayback&&k(e).togglePlayback(...o))},ce(k(e).isPlaying?"Pause":"Play"),3),r("button",{class:"pb-btn",onClick:$e},">|")])])]),r("div",$o,[r("div",Oo,[r("div",Vo,"Layers ("+ce(k(e).layers.length)+")",1),r("div",{class:"layers-list",onScroll:h},[r("div",{class:"layer-item camera-layer",onClick:a[31]||(a[31]=o=>void 0)},[r("span",{class:"expand-icon",onClick:a[30]||(a[30]=Ge(o=>oe(),["stop"]))},ce(i.value?"v":">"),1),a[65]||(a[65]=r("span",{class:"layer-type camera"},"C",-1)),a[66]||(a[66]=r("span",{class:"layer-name"},"Camera",-1))]),i.value?(ne(),ae(Oe,{key:0},qe(c,o=>r("div",{key:o.key,class:"layer-item prop-item camera-prop-item"},[a[67]||(a[67]=r("span",{class:"prop-indent"},null,-1)),r("span",Go,ce(o.label),1)])),64)):Ne("",!0),(ne(!0),ae(Oe,null,qe(k(e).layers,(o,p)=>(ne(),ae(Oe,{key:o.id},[r("div",{class:Ve(["layer-item",{active:p===k(e).currentLayerIndex}]),onClick:w=>k(e).selectLayer(p)},[r("span",{class:"expand-icon",onClick:Ge(w=>q(p),["stop"])},ce(C.value.has(p)?"v":">"),9,Zo),r("span",{class:Ve(["layer-type",o.type])},ce(o.type==="background"?"B":"F"),3),r("span",Wo,ce(D(o,p)),1),r("span",No,[r("span",{class:Ve(["vis-icon",{off:o.hidden}]),onClick:Ge(w=>ye(o),["stop"])},"eye",10,qo),r("span",{class:"del-icon",onClick:Ge(w=>k(e).removeLayer(p),["stop"])},"x",8,Ho)])],10,Ko),C.value.has(p)?(ne(),ae(Oe,{key:0},qe(b,w=>r("div",{key:`layer-${p}-${w.key}`,class:"layer-item prop-item"},[a[68]||(a[68]=r("span",{class:"prop-indent"},null,-1)),r("span",Jo,ce(w.label),1)])),64)):Ne("",!0)],64))),128))],32)]),r("div",{class:"tracks-panel",ref_key:"timelineRef",ref:P},[r("div",{class:"tracks-content",style:Ke({width:Ze.value+"px"})},[r("div",{class:"ruler",onMousedown:Ue},[(ne(!0),ae(Oe,null,qe(Math.ceil(ke.value)+1,o=>(ne(),ae("div",{key:o,class:"ruler-tick",style:Ke({left:(o-1)*ie.value+"px"})},[r("span",Qo,ce(o-1)+"s",1)],4))),128)),r("div",{class:"playhead-top",style:Ke({left:k(e).currentTime*ie.value+"px"})},null,4)],32),r("div",{class:"tracks-list",onDblclick:We,onScroll:M},[r("div",{class:"track-row camera-row",onClick:a[32]||(a[32]=o=>void 0)},[r("div",{class:"track-bar camera",style:Ke({width:ke.value*ie.value+"px"})},[i.value?Ne("",!0):(ne(!0),ae(Oe,{key:0},qe(K(),o=>(ne(),ae("div",{key:`cam-${o.prop}-${o.time}`,class:"mini-kf camera",style:Ke({left:o.time*ie.value+"px"}),title:`Camera ${o.prop} @ ${o.time.toFixed(2)}s`,onMousedown:Ge(p=>_e(p,o),["stop"]),onContextmenu:Ge(p=>me(o.prop,o.time),["prevent"])},null,44,er))),128)),a[69]||(a[69]=r("span",{class:"track-label"},"Camera",-1))],4)]),i.value?(ne(),ae(Oe,{key:0},qe(c,o=>r("div",{key:o.key,class:"prop-track-row camera-prop-track",onClick:a[33]||(a[33]=p=>void 0)},[r("div",{class:"prop-track",onDblclick:Ge(p=>pe(p,o.key),["stop"])},[(ne(!0),ae(Oe,null,qe(se(o.key),p=>(ne(),ae("div",{key:p.time,class:"keyframe-dot camera",style:Ke({left:p.time*ie.value+"px"}),title:`${o.label}: ${p.value.toFixed(2)} @ ${p.time.toFixed(2)}s`,onMousedown:Ge(w=>de(w,o.key,p),["stop"]),onContextmenu:Ge(w=>me(o.key,p.time),["prevent"])},null,44,ar))),128))],40,tr)])),64)):Ne("",!0),(ne(!0),ae(Oe,null,qe(k(e).layers,(o,p)=>(ne(),ae(Oe,{key:o.id},[r("div",{class:Ve(["track-row",{active:p===k(e).currentLayerIndex}]),onClick:w=>k(e).selectLayer(p)},[r("div",{class:Ve(["track-bar",o.type]),style:Ke({width:ke.value*ie.value+"px"})},[C.value.has(p)?Ne("",!0):(ne(!0),ae(Oe,{key:0},qe(Z(o),w=>(ne(),ae("div",{key:w.time+w.prop,class:"mini-kf",style:Ke({left:w.time*ie.value+"px"})},null,4))),128))],6)],10,nr),C.value.has(p)?(ne(),ae(Oe,{key:0},qe(b,w=>r("div",{key:w.key,class:Ve(["prop-track-row",{active:p===k(e).currentLayerIndex}]),onClick:E=>k(e).selectLayer(p)},[r("div",{class:"prop-track",onDblclick:Ge(E=>Ye(E,p,w.key),["stop"])},[(ne(!0),ae(Oe,null,qe(L(o,w.key),E=>(ne(),ae("div",{key:E.time,class:Ve(["keyframe-dot",{selected:ue(p,w.key,E.time)}]),style:Ke({left:E.time*ie.value+"px"}),title:`${w.label}: ${X(E.value,w.key)} @ ${E.time.toFixed(2)}s`,onMousedown:Ge(A=>fe(A,p,w.key,E),["stop"]),onClick:Ge(A=>Be(p,w.key,E.time),["stop"]),onContextmenu:Ge(A=>f(p,w.key,E.time),["prevent"])},null,46,ir))),128))],40,rr)],10,or)),64)):Ne("",!0)],64))),128))],32),r("div",{class:"playhead-line",style:Ke({left:k(e).currentTime*ie.value+"px"})},null,4)],4)],512)])]),r("input",{ref_key:"fileInput",ref:v,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:He},null,544),r("input",{ref_key:"projectInput",ref:_,type:"file",accept:".json",style:{display:"none"},onChange:te},null,544)]))}}),cr=St(sr,[["__scopeId","data-v-d657e4b9"]]);function lr(t,n){const e=pa(cr,{node:n.node}),m=da();return e.use(m),e.mount(t),e}window.createTimelineApp=lr;
