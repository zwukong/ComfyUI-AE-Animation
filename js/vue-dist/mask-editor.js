var sp=Object.defineProperty;var Io=e=>{throw TypeError(e)};var ap=(e,t,r)=>t in e?sp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var y=(e,t,r)=>ap(e,typeof t!="symbol"?t+"":t,r),ai=(e,t,r)=>t.has(e)||Io("Cannot "+r);var w=(e,t,r)=>(ai(e,t,"read from private field"),r?r.call(e):t.get(e)),Y=(e,t,r)=>t.has(e)?Io("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),q=(e,t,r,n)=>(ai(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),Br=(e,t,r)=>(ai(e,t,"access private method"),r);var Eo=(e,t,r,n)=>({set _(s){q(e,t,s,r)},get _(){return w(e,t,n)}});import{r as S,c as Ee,d as Na,w as $r,e as ip,g as op,o as lp,u as I,a as up,n as cp,m as ii,b as Tt,f as Xe,h as ze,i as Cr,j as R,k as qi,l as Rn,t as Ce,p as ot,q as Ba,F as Ru,s as Au,v as On,x as hp,y as pp,z as $s,_ as fp,A as dp,B as mp}from"./assets/_plugin-vue_export-helper.js";function yp(e,t,{signal:r,edges:n}={}){let s,a=null;const i=n!=null&&n.includes("leading"),o=n==null||n.includes("trailing"),l=()=>{a!==null&&(e.apply(s,a),s=void 0,a=null)},u=()=>{o&&l(),d()};let c=null;const h=()=>{c!=null&&clearTimeout(c),c=setTimeout(()=>{c=null,u()},t)},f=()=>{c!==null&&(clearTimeout(c),c=null)},d=()=>{f(),s=void 0,a=null},p=()=>{l()},g=function(...z){if(r!=null&&r.aborted)return;s=this,a=z;const M=c==null;h(),i&&M&&l()};return g.schedule=h,g.cancel=d,g.flush=p,r==null||r.addEventListener("abort",d,{once:!0}),g}function gp(){}function Qt(e,t,r){return r==null?Math.min(e,t):Math.min(Math.max(e,t),r)}function Wi(e){return e==null||typeof e!="object"&&typeof e!="function"}function Yi(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function wp(e){if(Wi(e))return e;if(Array.isArray(e)||Yi(e)||e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer)return e.slice(0);const t=Object.getPrototypeOf(e),r=t.constructor;if(e instanceof Date||e instanceof Map||e instanceof Set)return new r(e);if(e instanceof RegExp){const n=new r(e);return n.lastIndex=e.lastIndex,n}if(e instanceof DataView)return new r(e.buffer.slice(0));if(e instanceof Error){const n=new r(e.message);return n.stack=e.stack,n.name=e.name,n.cause=e.cause,n}if(typeof File<"u"&&e instanceof File)return new r([e],e.name,{type:e.type,lastModified:e.lastModified});if(typeof e=="object"){const n=Object.create(t);return Object.assign(n,e)}return e}function Ou(e){return Object.getOwnPropertySymbols(e).filter(t=>Object.prototype.propertyIsEnumerable.call(e,t))}function Fu(e){return e==null?e===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const vp="[object RegExp]",Lu="[object String]",Gu="[object Number]",Du="[object Boolean]",ju="[object Arguments]",xp="[object Symbol]",bp="[object Date]",Tp="[object Map]",$p="[object Set]",_p="[object Array]",zp="[object ArrayBuffer]",Sp="[object Object]",Mp="[object DataView]",kp="[object Uint8Array]",Pp="[object Uint8ClampedArray]",Bp="[object Uint16Array]",Ip="[object Uint32Array]",Ep="[object Int8Array]",Up="[object Int16Array]",Vp="[object Int32Array]",Cp="[object Float32Array]",Rp="[object Float64Array]";function Ap(e,t){return Fn(e,void 0,e,new Map,t)}function Fn(e,t,r,n=new Map,s=void 0){const a=s==null?void 0:s(e,t,r,n);if(a!==void 0)return a;if(Wi(e))return e;if(n.has(e))return n.get(e);if(Array.isArray(e)){const i=new Array(e.length);n.set(e,i);for(let o=0;o<e.length;o++)i[o]=Fn(e[o],o,r,n,s);return Object.hasOwn(e,"index")&&(i.index=e.index),Object.hasOwn(e,"input")&&(i.input=e.input),i}if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp){const i=new RegExp(e.source,e.flags);return i.lastIndex=e.lastIndex,i}if(e instanceof Map){const i=new Map;n.set(e,i);for(const[o,l]of e)i.set(o,Fn(l,o,r,n,s));return i}if(e instanceof Set){const i=new Set;n.set(e,i);for(const o of e)i.add(Fn(o,void 0,r,n,s));return i}if(typeof Buffer<"u"&&Buffer.isBuffer(e))return e.subarray();if(Yi(e)){const i=new(Object.getPrototypeOf(e)).constructor(e.length);n.set(e,i);for(let o=0;o<e.length;o++)i[o]=Fn(e[o],o,r,n,s);return i}if(e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer)return e.slice(0);if(e instanceof DataView){const i=new DataView(e.buffer.slice(0),e.byteOffset,e.byteLength);return n.set(e,i),nr(i,e,r,n,s),i}if(typeof File<"u"&&e instanceof File){const i=new File([e],e.name,{type:e.type});return n.set(e,i),nr(i,e,r,n,s),i}if(typeof Blob<"u"&&e instanceof Blob){const i=new Blob([e],{type:e.type});return n.set(e,i),nr(i,e,r,n,s),i}if(e instanceof Error){const i=new e.constructor;return n.set(e,i),i.message=e.message,i.name=e.name,i.stack=e.stack,i.cause=e.cause,nr(i,e,r,n,s),i}if(e instanceof Boolean){const i=new Boolean(e.valueOf());return n.set(e,i),nr(i,e,r,n,s),i}if(e instanceof Number){const i=new Number(e.valueOf());return n.set(e,i),nr(i,e,r,n,s),i}if(e instanceof String){const i=new String(e.valueOf());return n.set(e,i),nr(i,e,r,n,s),i}if(typeof e=="object"&&Op(e)){const i=Object.create(Object.getPrototypeOf(e));return n.set(e,i),nr(i,e,r,n,s),i}return e}function nr(e,t,r=e,n,s){const a=[...Object.keys(t),...Ou(t)];for(let i=0;i<a.length;i++){const o=a[i],l=Object.getOwnPropertyDescriptor(e,o);(l==null||l.writable)&&(e[o]=Fn(t[o],o,r,n,s))}}function Op(e){switch(Fu(e)){case ju:case _p:case zp:case Mp:case Du:case bp:case Cp:case Rp:case Ep:case Up:case Vp:case Tp:case Gu:case Sp:case vp:case $p:case Lu:case xp:case kp:case Pp:case Bp:case Ip:return!0;default:return!1}}function Fp(e){return e==="__proto__"}function Lp(e){var r;if(typeof e!="object"||e==null)return!1;if(Object.getPrototypeOf(e)===null)return!0;if(Object.prototype.toString.call(e)!=="[object Object]"){const n=e[Symbol.toStringTag];return n==null||!((r=Object.getOwnPropertyDescriptor(e,Symbol.toStringTag))!=null&&r.writable)?!1:e.toString()===`[object ${n}]`}let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}var nt=(e=>(e.Arc="arc",e.Rect="rect",e))(nt||{}),ae=(e=>(e.MaskPen="mask-pen",e.Eraser="eraser",e.PaintPen="paint-pen",e.MaskBucket="mask-bucket",e.MaskColorFill="mask-color-fill",e))(ae||{});const Gp=["mask-pen","eraser","paint-pen","mask-bucket","mask-color-fill"];var Mt=(e=>(e.Black="black",e.White="white",e.Negative="negative",e))(Mt||{}),on=(e=>(e.Simple="simple",e.Lab="lab",e))(on||{}),At=(e=>(e.SourceOver="source-over",e.DestinationOut="destination-out",e))(At||{});function Dp(e=20){const t=Je(),r=S([]),n=S(-1),s=S(!1),a=Ee(()=>r.value.length>1&&n.value>0),i=Ee(()=>r.value.length>1&&n.value<r.value.length-1),o=()=>{const d=t.maskCtx,p=t.rgbCtx,g=t.maskCanvas,z=t.rgbCanvas;if(!d||!p||!g||!z){requestAnimationFrame(o);return}if(!g.width||!z.width){requestAnimationFrame(o);return}r.value=[];const M=d.getImageData(0,0,g.width,g.height),A=p.getImageData(0,0,z.width,z.height);r.value.push({mask:M,rgb:A}),n.value=0,s.value=!0},l=(d,p)=>{const g=t.maskCtx,z=t.rgbCtx,M=t.maskCanvas,A=t.rgbCanvas;if(!g||!z||!M||!A)return;if(!s.value||n.value===-1){o();return}r.value=r.value.slice(0,n.value+1);let ne,X;if(d&&p?(ne=d,X=p):(ne=g.getImageData(0,0,M.width,M.height),X=z.getImageData(0,0,A.width,A.height)),r.value.push({mask:ne,rgb:X}),n.value++,r.value.length>e){const j=r.value.shift();j&&(j.mask instanceof ImageBitmap&&j.mask.close(),j.rgb instanceof ImageBitmap&&j.rgb.close()),n.value--}},u=()=>{if(!a.value){alert("No more undo states available");return}n.value--,h(r.value[n.value])},c=()=>{if(!i.value){alert("No more redo states available");return}n.value++,h(r.value[n.value])},h=d=>{const p=t.maskCtx,g=t.rgbCtx;!p||!g||(d.mask instanceof ImageBitmap?(p.clearRect(0,0,d.mask.width,d.mask.height),p.drawImage(d.mask,0,0)):p.putImageData(d.mask,0,0),d.rgb instanceof ImageBitmap?(g.clearRect(0,0,d.rgb.width,d.rgb.height),g.drawImage(d.rgb,0,0)):g.putImageData(d.rgb,0,0))};return{canUndo:a,canRedo:i,currentStateIndex:n,saveInitialState:o,saveState:l,undo:u,redo:c,clearStates:()=>{r.value.forEach(d=>{d.mask instanceof ImageBitmap&&d.mask.close(),d.rgb instanceof ImageBitmap&&d.rgb.close()}),r.value=[],n.value=-1,s.value=!1}}}const Je=Na("maskEditor",()=>{const e=S({type:nt.Arc,size:10,opacity:.7,hardness:1,stepSize:10}),t=S(Mt.Black),r=S("mask"),n=S("#FF0000"),s=S(ae.MaskPen),a=S(!1),i=S(5),o=S(100),l=S(20),u=S(!1),c=S(on.Simple),h=S(!1),f=S(!1),d=S(0),p=S(100),g=S(1),z=S(1),M=S({x:0,y:0}),A=S({x:0,y:0}),ne=S(0),X=S(0),j=S(null),V=S(null),G=S(null),N=S(null),Q=S(null),ue=S(null),pe=S(null),Oe=S(null),ke=S(null),qe=S(null),mt=S(.8),$t=S(!0),_t=S(!1),ps=S(!1),Nt=Dp(20),fs=S(null);$r(j,b=>{b&&(V.value=b.getContext("2d",{willReadFrequently:!0}))}),$r(G,b=>{b&&(N.value=b.getContext("2d",{willReadFrequently:!0}))}),$r(Q,b=>{b&&(ue.value=b.getContext("2d",{willReadFrequently:!0}))});const ds=Ee(()=>Nt.canUndo.value),C=Ee(()=>Nt.canRedo.value),J=Ee(()=>{switch(t.value){case Mt.Black:return{r:0,g:0,b:0};case Mt.White:return{r:255,g:255,b:255};case Mt.Negative:return{r:255,g:255,b:255};default:return{r:0,g:0,b:0}}});function ce(b){e.value.size=Qt(b,1,500)}function Le(b){e.value.opacity=Qt(b,0,1)}function We(b){e.value.hardness=Qt(b,0,1)}function Ge(b){e.value.stepSize=Qt(b,1,100)}function rt(){e.value.type=nt.Arc,e.value.size=10,e.value.opacity=.7,e.value.hardness=1,e.value.stepSize=10}function at(b){i.value=Qt(b,0,255)}function lt(b){o.value=Qt(b,0,100)}function Et(b){l.value=Qt(b,0,255)}function yt(b){d.value=Qt(b,0,255)}function it(b){p.value=Qt(b,0,100)}function gt(b){g.value=Math.max(.1,Math.min(10,b))}function Ut(b){M.value={...b}}function ms(b){A.value={...b}}function vn(){ne.value++}function kr(){X.value++}function xn(b){mt.value=Qt(b,0,1)}function T(){e.value={type:nt.Arc,size:10,opacity:.7,hardness:1,stepSize:5},t.value=Mt.Black,r.value="mask",n.value="#FF0000",s.value=ae.MaskPen,a.value=!1,i.value=5,o.value=100,l.value=20,u.value=!1,c.value=on.Simple,h.value=!1,f.value=!1,d.value=0,p.value=100,g.value=1,M.value={x:0,y:0},A.value={x:0,y:0},mt.value=.8}return{brushSettings:e,maskBlendMode:t,activeLayer:r,rgbColor:n,currentTool:s,isAdjustingBrush:a,paintBucketTolerance:i,fillOpacity:o,colorSelectTolerance:l,colorSelectLivePreview:u,colorComparisonMethod:c,applyWholeImage:h,maskBoundary:f,maskTolerance:d,selectionOpacity:p,zoomRatio:g,displayZoomRatio:z,panOffset:M,cursorPoint:A,resetZoomTrigger:ne,maskCanvas:j,maskCtx:V,rgbCanvas:G,rgbCtx:N,imgCanvas:Q,imgCtx:ue,canvasContainer:pe,canvasBackground:Oe,pointerZone:ke,image:qe,maskOpacity:mt,canUndo:ds,canRedo:C,maskColor:J,brushVisible:$t,isPanning:_t,brushPreviewGradientVisible:ps,canvasHistory:Nt,tgpuRoot:fs,setBrushSize:ce,setBrushOpacity:Le,setBrushHardness:We,setBrushStepSize:Ge,resetBrushToDefault:rt,setPaintBucketTolerance:at,setFillOpacity:lt,setColorSelectTolerance:Et,setMaskTolerance:yt,setSelectionOpacity:it,setZoomRatio:gt,setPanOffset:Ut,setCursorPoint:ms,resetZoom:vn,triggerClear:kr,clearTrigger:X,setMaskOpacity:xn,resetState:T}}),Zi=Na("maskEditorData",()=>{const e=S(null),t=S(null),r=S(null),n=S(!1),s=S(null),a=Ee(()=>e.value!==null),i=Ee(()=>t.value!==null),o=Ee(()=>a.value&&!n.value);return{inputData:e,outputData:t,sourceNode:r,isLoading:n,loadError:s,hasValidInput:a,hasValidOutput:i,isReady:o,reset:()=>{e.value=null,t.value=null,r.value=null,n.value=!1,s.value=null},setLoading:(c,h)=>{n.value=c,h&&(s.value=h)}}});function jp(e){return op()?(lp(e),!0):!1}function Nu(e){let t=0,r,n;const s=()=>{t-=1,n&&t<=0&&(n.stop(),r=void 0,n=void 0)};return(...a)=>(t+=1,n||(n=ip(!0),r=n.run(()=>e(...a))),jp(s),r)}typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;function qu(){const e=Je(),t=async(a,i,o)=>{const l=e.maskColor;o.drawImage(a,0,0,i.width,i.height);const u=o.getImageData(0,0,i.width,i.height);for(let c=0;c<u.data.length;c+=4){const h=u.data[c+3];u.data[c]=l.r,u.data[c+1]=l.g,u.data[c+2]=l.b,u.data[c+3]=255-h}o.globalCompositeOperation="source-over",o.putImageData(u,0,0)},r=async(a,i,o)=>{const{imgCanvas:l,maskCanvas:u,rgbCanvas:c,imgCtx:h,maskCtx:f,rgbCtx:d}=e;if(!l||!u||!c||!h||!f||!d)throw new Error("Canvas elements or contexts not available");l.width=a.width,l.height=a.height,u.width=a.width,u.height=a.height,c.width=a.width,c.height=a.height,h.drawImage(a,0,0,a.width,a.height),o&&d.drawImage(o,0,0,o.width,o.height),await t(i,u,f)},n=()=>{const a=e.canvasBackground;a&&(e.maskBlendMode===Mt.Black?a.style.backgroundColor="rgba(0,0,0,1)":(e.maskBlendMode===Mt.White||e.maskBlendMode===Mt.Negative)&&(a.style.backgroundColor="rgba(255,255,255,1)"))};return{invalidateCanvas:r,updateMaskColor:async()=>{const{maskCanvas:a,maskCtx:i,maskColor:o,maskBlendMode:l,maskOpacity:u}=e;if(!a||!i)return;l===Mt.Negative?(a.style.mixBlendMode="difference",a.style.opacity="1"):(a.style.mixBlendMode="initial",a.style.opacity=String(u)),i.fillStyle=`rgb(${o.r}, ${o.g}, ${o.b})`,n();const c=i.getImageData(0,0,a.width,a.height);for(let h=0;h<c.data.length;h+=4)c.data[h]=o.r,c.data[h+1]=o.g,c.data[h+2]=o.b;i.putImageData(c,0,0)}}}function Np(){const e=Je(),t=Zi(),r=qu();return{loadImages:async()=>{var d;const s=t.inputData;if(!s)throw new Error("No input data available in dataStore");const{imgCanvas:a,maskCanvas:i,rgbCanvas:o,imgCtx:l,maskCtx:u}=e;if(!a||!i||!o||!l||!u)throw new Error("Canvas elements or contexts not available");l.clearRect(0,0,a.width,a.height),u.clearRect(0,0,i.width,i.height);const c=s.baseLayer.image,h=s.maskLayer.image,f=(d=s.paintLayer)==null?void 0:d.image;return i.width=c.width,i.height=c.height,o.width=c.width,o.height=c.height,e.image=c,await r.invalidateCanvas(c,h,f||null),await r.updateMaskColor(),c}}}const qp=Nu(Np);function Wp(){const e=Je(),t=S([]),r=l=>t.value.includes(l),n=()=>{t.value=[]},s=l=>{if(t.value.includes(l.key)||t.value.push(l.key),l.key===" "){l.preventDefault();const u=document.activeElement;u&&u.blur&&u.blur()}if((l.ctrlKey||l.metaKey)&&!l.altKey){const u=l.key.toUpperCase();u==="Y"&&!l.shiftKey||u==="Z"&&l.shiftKey?e.canvasHistory.redo():u==="Z"&&!l.shiftKey&&e.canvasHistory.undo()}},a=l=>{t.value=t.value.filter(u=>u!==l.key)};return{isKeyDown:r,addListeners:()=>{document.addEventListener("keydown",s),document.addEventListener("keyup",a),window.addEventListener("blur",n)},removeListeners:()=>{document.removeEventListener("keydown",s),document.removeEventListener("keyup",a),window.removeEventListener("blur",n)}}}class Yp{apiURL(t){return`${window.location.origin}${t}`}async fetchApi(t,r){return fetch(this.apiURL(t),r)}}const Ia=new Yp;class Zp{constructor(){y(this,"graph",{setDirtyCanvas:()=>{}});y(this,"nodeOutputs",{});y(this,"nodePreviewImages",{})}getPreviewFormatParam(){return"&preview=true"}getRandParam(){return`&rand=${Math.random()}`}}const ln=new Zp,Xp=Na("nodeOutput",()=>{function e(s){return ln.nodeOutputs[String(s.id)]}function t(s){return ln.nodePreviewImages[String(s.id)]}function r(s){var l;const a=t(s);if(a!=null&&a.length)return a;const i=e(s);if(!((l=i==null?void 0:i.images)!=null&&l.length))return;const o=ln.getRandParam();return i.images.map(u=>{const c=new URLSearchParams(u);return Ia.apiURL(`/view?${c}${o}`)})}function n(s){}return{getNodeOutputs:e,getNodePreviews:t,getNodeImageUrls:r,updateNodeImages:n}}),Hp=!1,oi="clipspace-painted-masked-";function Kp(e){if(!e.startsWith(oi))return;const r=e.slice(oi.length),n=parseInt(r.split(".")[0],10);return{maskedImage:`clipspace-mask-${n}.png`,paint:`clipspace-paint-${n}.png`,paintedImage:`clipspace-painted-${n}.png`,paintedMaskedImage:`${oi}${n}.png`}}function li(e){return{filename:e,subfolder:"clipspace",type:"input"}}function ca(e){const t=new URLSearchParams;t.set("filename",e.ref.filename),e.ref.subfolder&&t.set("subfolder",e.ref.subfolder),e.ref.type&&t.set("type",e.ref.type);const r=Ia.apiURL("/view?"+t.toString()+ln.getPreviewFormatParam()+ln.getRandParam()),n=new Image;return n.crossOrigin="anonymous",n.src=r,n.src}function Qp(){const e=Zi(),t=Xp(),r=async u=>{e.setLoading(!0);try{n(u);let c=s(u),h=a(c),f;if(u.widgets){const V=u.widgets.find(G=>G.name==="image");V&&(typeof V.value=="string"?f=V.value:typeof V.value=="object"&&V.value&&"filename"in V.value&&typeof V.value.filename=="string"&&(f=V.value.filename))}if(f)try{let V=f,G,N="input";const Q=V.match(/ \[([^\]]+)\]$/);Q&&(N=Q[1],V=V.substring(0,V.length-Q[0].length));const ue=V.lastIndexOf("/");ue!==-1&&(G=V.substring(0,ue),V=V.substring(ue+1)),h={filename:V,type:N,subfolder:G},c=ca({ref:h})}catch(V){console.warn("Failed to parse widget filename as ref",V)}const d=f||h.filename;let p,g=Kp(h.filename);if(p){const V=p.painted_masked||p.painted;V&&(g={maskedImage:V,paint:p.paint||"",paintedImage:p.painted||"",paintedMaskedImage:p.painted_masked||V})}const z=g!=null&&g.maskedImage?ca({ref:li(g.maskedImage)}):c,M=g!=null&&g.maskedImage?a(z):h;let A=null;p!=null&&p.paint?A=ca({ref:li(p.paint)}):g!=null&&g.paint&&(A=ca({ref:li(g.paint)}));const[ne,X,j]=await Promise.all([i(z,"rgb"),i(z,"a"),A?l(A):Promise.resolve(void 0)]);e.inputData={baseLayer:ne,maskLayer:X,paintLayer:j,sourceRef:M,nodeId:u.id},e.sourceNode=u,e.setLoading(!1)}catch(c){const h=c instanceof Error?c.message:"Failed to load from node";throw console.error("[MaskEditorLoader]",h,c),e.setLoading(!1,h),c}};function n(u){var h;if(!u)throw new Error("Node is null or undefined");if(!(((h=u.imgs)==null?void 0:h.length)||u.previewMediaType==="image"))throw new Error("Node has no images")}function s(u){var h,f,d;if((h=u.images)!=null&&h[0]){const p=u.images[0],g=new URLSearchParams({filename:p.filename,type:p.type||"output",subfolder:p.subfolder||""});return Ia.apiURL(`/view?${g.toString()}`)}const c=t.getNodeOutputs(u);if((f=c==null?void 0:c.images)!=null&&f[0]){const p=c.images[0];if(!p.filename)throw new Error("nodeOutputStore image missing filename");const g=new URLSearchParams;return g.set("filename",p.filename),g.set("type",p.type||"output"),g.set("subfolder",p.subfolder||""),Ia.apiURL(`/view?${g.toString()}`)}if((d=u.imgs)!=null&&d.length){const p=u.imageIndex??0,g=u.imgs[p].src;if(g&&!g.startsWith("data:"))return g}throw new Error("Unable to get image URL from node")}function a(u){try{const c=new URL(u),h=c.searchParams.get("filename");if(!h)throw new Error("Image URL missing filename parameter");return{filename:h,subfolder:c.searchParams.get("subfolder")||void 0,type:c.searchParams.get("type")||void 0}}catch{try{const h=new URL(u,window.location.origin),f=h.searchParams.get("filename");if(!f)throw new Error("Image URL missing filename parameter");return{filename:f,subfolder:h.searchParams.get("subfolder")||void 0,type:h.searchParams.get("type")||void 0}}catch{throw new Error(`Invalid image URL: ${u}`)}}}async function i(u,c){let h;try{h=new URL(u)}catch{h=new URL(u,window.location.origin)}c&&(h.searchParams.delete("channel"),h.searchParams.set("channel",c));const f=h.toString();return{image:await o(f),url:f}}function o(u){return new Promise((c,h)=>{const f=new Image;f.crossOrigin="anonymous",f.onload=()=>c(f),f.onerror=()=>h(new Error(`Failed to load image: ${u}`)),f.src=u})}async function l(u){let c;try{c=new URL(u)}catch{c=new URL(u,window.location.origin)}const h=c.toString();return{image:await o(h),url:h}}return{loadFromNode:r}}function Jp(){const e=Je(),t=300,r=S(0),n=S(!1),s=S(0),a=S({x:0,y:0}),i=S({x:0,y:0}),o=S(1),l=S(1),u=S({x:0,y:0}),c=S(null),h=S({x:0,y:0}),f=S(null),d=S(null),p=S(null),g=S(null),z=S(null),M=S(null),A=S(null),ne=S(0),X=S(0),j=S({x:0,y:0}),V=S([]),G=C=>{const J=C[0].clientX-C[1].clientX,ce=C[0].clientY-C[1].clientY;return Math.sqrt(J*J+ce*ce)},N=C=>({x:(C[0].clientX+C[1].clientX)/2,y:(C[0].clientY+C[1].clientY)/2}),Q=C=>{const J=C.x-u.value.x,ce=C.y-u.value.y;j.value={x:J,y:ce},e.setCursorPoint({x:J,y:ce})},ue=()=>{e.canvasHistory.undo()},pe=async()=>{var ce,Le;if(!((ce=A.value)!=null&&ce.width)||!((Le=A.value)!=null&&Le.height)||!u.value||!o.value){console.warn("Missing required properties for pan/zoom");return}const C=A.value.width*o.value,J=A.value.height*o.value;f.value||(f.value=e.canvasContainer),f.value&&(Object.assign(f.value.style,{width:`${C}px`,height:`${J}px`,left:`${u.value.x}px`,top:`${u.value.y}px`}),p.value||(p.value=e.rgbCanvas),p.value&&((p.value.width!==A.value.width||p.value.height!==A.value.height)&&(p.value.width=A.value.width,p.value.height=A.value.height),p.value.style.width=`${C}px`,p.value.style.height=`${J}px`),e.setPanOffset(u.value),e.setZoomRatio(o.value))},Oe=C=>{c.value={x:C.clientX,y:C.clientY},e.isPanning=!0,h.value={...u.value}},ke=async C=>{if(c.value===null)throw new Error("mouseDownPoint is null");const J=c.value.x-C.clientX,ce=c.value.y-C.clientY,Le=h.value.x-J,We=h.value.y-ce;u.value={x:Le,y:We},await pe()},qe=async C=>{if(i.value===null){i.value={x:C.clientX,y:C.clientY};return}const J=C.clientX-i.value.x,ce=C.clientY-i.value.y;u.value.x+=J,u.value.y+=ce,await pe(),i.value={x:C.clientX,y:C.clientY}},mt=C=>{if(C.preventDefault(),!(V.value.length>0))if(e.brushVisible=!1,C.touches.length===2){const J=new Date().getTime();J-r.value<t?(ue(),r.value=0):(r.value=J,n.value=!0,s.value=G(C.touches),a.value=N(C.touches))}else C.touches.length===1&&(i.value={x:C.touches[0].clientX,y:C.touches[0].clientY})},$t=async C=>{if(C.preventDefault(),!(V.value.length>0))if(r.value=0,n.value&&C.touches.length===2){const J=G(C.touches),ce=J/s.value,Le=o.value;o.value=Math.max(.2,Math.min(10,o.value*ce));const We=o.value,Ge=N(C.touches);if(a.value){const yt=Ge.x-a.value.x,it=Ge.y-a.value.y;u.value.x+=yt,u.value.y+=it}if(d.value===null&&(d.value=e.maskCanvas),!d.value)return;const rt=d.value.getBoundingClientRect(),at=Ge.x-rt.left,lt=Ge.y-rt.top,Et=We/Le;u.value.x+=at-at*Et,u.value.y+=lt-lt*Et,await pe(),s.value=J,a.value=Ge}else C.touches.length===1&&await qe(C.touches[0])},_t=C=>{C.preventDefault();const J=C.touches[0];J?i.value={x:J.clientX,y:J.clientY}:(n.value=!1,a.value={x:0,y:0})},ps=async C=>{const J={x:C.clientX,y:C.clientY},ce=o.value,Le=C.deltaY<0?1.1:.9;o.value=Math.max(.2,Math.min(10,o.value*Le));const We=o.value;if(d.value||(d.value=e.maskCanvas),!d.value)return;const Ge=d.value.getBoundingClientRect(),rt=J.x-Ge.left,at=J.y-Ge.top,lt=We/ce;u.value.x+=rt-rt*lt,u.value.y+=at-at*lt,await pe();const yt=d.value.clientWidth/ne.value;l.value=yt,e.displayZoomRatio=yt,Q(J)},Nt=()=>{var ce,Le;const C=((ce=z.value)==null?void 0:ce.getBoundingClientRect().width)||64;return{sidePanelWidth:((Le=M.value)==null?void 0:Le.getBoundingClientRect().width)||220,toolPanelWidth:C}},fs=async(C=500)=>{if(!A.value||!g.value)return;const J=o.value,ce={...u.value},{sidePanelWidth:Le,toolPanelWidth:We}=Nt(),Ge=g.value.clientWidth-Le-We,rt=g.value.clientHeight,at=Ge/A.value.width,lt=rt/A.value.height,Et=Math.min(at,lt),yt=A.value.width/A.value.height;let it,gt;const Ut={x:We,y:0};lt>at?(it=Ge,gt=it/yt,Ut.y=(rt-gt)/2):(gt=rt,it=gt*yt,Ut.x=(Ge-it)/2+We);const ms=performance.now(),vn=async kr=>{const xn=kr-ms,T=Math.min(xn/C,1),b=1-Math.pow(1-T,3);o.value=J+(Et-J)*b,u.value.x=ce.x+(Ut.x-ce.x)*b,u.value.y=ce.y+(Ut.y-ce.y)*b,await pe();const P=J+(1-J)*b;e.displayZoomRatio=P,T<1&&requestAnimationFrame(vn)};requestAnimationFrame(vn),l.value=1},ds=async(C,J,ce,Le)=>{g.value=J,z.value=ce||null,M.value=Le||null;const{sidePanelWidth:We,toolPanelWidth:Ge}=Nt(),rt=J.clientWidth-We-Ge,at=J.clientHeight,lt=rt/C.width,Et=at/C.height,yt=C.width/C.height;let it,gt;const Ut={x:Ge,y:0};Et>lt?(it=rt,gt=it/yt,Ut.y=(at-gt)/2):(gt=at,it=gt*yt,Ut.x=(rt-it)/2+Ge),A.value===null&&(A.value=C),ne.value=it,X.value=gt,o.value=Math.min(lt,Et),u.value=Ut,V.value=[],await pe()};return $r(()=>e.resetZoomTrigger,async()=>{l.value!==1&&await fs()}),{initializeCanvasPanZoom:ds,handlePanStart:Oe,handlePanMove:ke,handleTouchStart:mt,handleTouchMove:$t,handleTouchEnd:_t,updateCursorPosition:Q,zoom:ps,invalidatePanZoom:pe}}function ef(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}class tf{constructor(t={}){if(!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof t.maxAge=="number"&&t.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=t.maxSize,this.maxAge=t.maxAge||1/0,this.onEviction=t.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(t){if(typeof this.onEviction=="function")for(const[r,n]of t)this.onEviction(r,n.value)}_deleteIfExpired(t,r){return typeof r.expiry=="number"&&r.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(t,r.value),this.delete(t)):!1}_getOrDeleteIfExpired(t,r){if(this._deleteIfExpired(t,r)===!1)return r.value}_getItemValue(t,r){return r.expiry?this._getOrDeleteIfExpired(t,r):r.value}_peek(t,r){const n=r.get(t);return this._getItemValue(t,n)}_set(t,r){this.cache.set(t,r),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(t,r){this.oldCache.delete(t),this._set(t,r)}*_entriesAscending(){for(const t of this.oldCache){const[r,n]=t;this.cache.has(r)||this._deleteIfExpired(r,n)===!1&&(yield t)}for(const t of this.cache){const[r,n]=t;this._deleteIfExpired(r,n)===!1&&(yield t)}}get(t){if(this.cache.has(t)){const r=this.cache.get(t);return this._getItemValue(t,r)}if(this.oldCache.has(t)){const r=this.oldCache.get(t);if(this._deleteIfExpired(t,r)===!1)return this._moveToRecent(t,r),r.value}}set(t,r,{maxAge:n=this.maxAge===1/0?void 0:Date.now()+this.maxAge}={}){this.cache.has(t)?this.cache.set(t,{value:r,maxAge:n}):this._set(t,{value:r,expiry:n})}has(t){return this.cache.has(t)?!this._deleteIfExpired(t,this.cache.get(t)):this.oldCache.has(t)?!this._deleteIfExpired(t,this.oldCache.get(t)):!1}peek(t){if(this.cache.has(t))return this._peek(t,this.cache);if(this.oldCache.has(t))return this._peek(t,this.oldCache)}delete(t){const r=this.cache.delete(t);return r&&this._size--,this.oldCache.delete(t)||r}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");const r=[...this._entriesAscending()],n=r.length-t;n<0?(this.cache=new Map(r),this.oldCache=new Map,this._size=r.length):(n>0&&this._emitEvictions(r.slice(0,n)),this.oldCache=new Map(r.slice(n)),this.cache=new Map,this._size=0),this.maxSize=t}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}*[Symbol.iterator](){for(const t of this.cache){const[r,n]=t;this._deleteIfExpired(r,n)===!1&&(yield[r,n.value])}for(const t of this.oldCache){const[r,n]=t;this.cache.has(r)||this._deleteIfExpired(r,n)===!1&&(yield[r,n.value])}}*entriesDescending(){let t=[...this.cache];for(let r=t.length-1;r>=0;--r){const n=t[r],[s,a]=n;this._deleteIfExpired(s,a)===!1&&(yield[s,a.value])}t=[...this.oldCache];for(let r=t.length-1;r>=0;--r){const n=t[r],[s,a]=n;this.cache.has(s)||this._deleteIfExpired(s,a)===!1&&(yield[s,a.value])}}*entriesAscending(){for(const[t,r]of this._entriesAscending())yield[t,r.value]}get size(){if(!this._size)return this.oldCache.size;let t=0;for(const r of this.oldCache.keys())this.cache.has(r)||t++;return Math.min(this._size+t,this.maxSize)}}var rf=tf;const nf=ef(rf);function sf(e,t){return Ap(e,(r,n,s,a)=>{if(typeof e=="object")switch(Object.prototype.toString.call(e)){case Gu:case Lu:case Du:{const i=new e.constructor(e==null?void 0:e.valueOf());return nr(i,e),i}case ju:{const i={};return nr(i,e),i.length=e.length,i[Symbol.iterator]=e[Symbol.iterator],i}default:return}})}function Uo(e){return sf(e)}function Vo(e){return e!==null&&typeof e=="object"&&Fu(e)==="[object Arguments]"}function Co(e){return typeof e=="object"&&e!==null}function af(e,t=0,r={}){typeof r!="object"&&(r={});const{leading:n=!1,trailing:s=!0,maxWait:a}=r,i=Array(2);n&&(i[0]="leading"),s&&(i[1]="trailing");let o,l=null;const u=yp(function(...f){o=e.apply(this,f),l=null},t,{edges:i}),c=function(...f){return a!=null&&(l===null&&(l=Date.now()),Date.now()-l>=a)?(o=e.apply(this,f),l=Date.now(),u.cancel(),u.schedule(),o):(u.apply(this,f),o)},h=()=>(u.flush(),o);return c.cancel=u.cancel,c.flush=h,c}function Xi(e,t){if(typeof e!="function"||t!=null&&typeof t!="function")throw new TypeError("Expected a function");const r=function(...s){const a=t?t.apply(this,s):s[0],i=r.cache;if(i.has(a))return i.get(a);const o=e.apply(this,s);return r.cache=i.set(a,o)||i,o},n=Xi.Cache||Map;return r.cache=new n,r}Xi.Cache=Map;function of(e){return Yi(e)}function lf(e,...t){const r=t.slice(0,-1),n=t[t.length-1];let s=e;for(let a=0;a<r.length;a++){const i=r[a];s=Ta(s,i,n,new Map)}return s}function Ta(e,t,r,n){if(Wi(e)&&(e=Object(e)),t==null||typeof t!="object")return e;if(n.has(t))return wp(n.get(t));if(n.set(t,e),Array.isArray(t)){t=t.slice();for(let a=0;a<t.length;a++)t[a]=t[a]??void 0}const s=[...Object.keys(t),...Ou(t)];for(let a=0;a<s.length;a++){const i=s[a];if(Fp(i))continue;let o=t[i],l=e[i];if(Vo(o)&&(o={...o}),Vo(l)&&(l={...l}),typeof Buffer<"u"&&Buffer.isBuffer(o)&&(o=Uo(o)),Array.isArray(o))if(typeof l=="object"&&l!=null){const c=[],h=Reflect.ownKeys(l);for(let f=0;f<h.length;f++){const d=h[f];c[d]=l[d]}l=c}else l=[];const u=r(l,o,i,e,t,n);u!==void 0?e[i]=u:Array.isArray(o)||Co(l)&&Co(o)?e[i]=Ta(l,o,r,n):l==null&&Lp(o)?e[i]=Ta({},o,r,n):l==null&&of(o)?e[i]=Uo(o):(l===void 0||o!==void 0)&&(e[i]=o)}return e}function uf(e,...t){return lf(e,...t,gp)}function Ro({r:e,g:t,b:r}){e/=255,t/=255,r/=255;const n=Math.max(e,t,r),s=Math.min(e,t,r);let a=0,i=0;const o=(n+s)/2;if(n!==s){const l=n-s;switch(i=o>.5?l/(2-n-s):l/(n+s),n){case e:a=(t-r)/l+(t<r?6:0);break;case t:a=(r-e)/l+2;break;case r:a=(e-t)/l+4;break}a/=6}return{h:a,s:i,l:o}}function Wu(e){let t=0,r=0,n=0;return e.length==4?(t=parseInt(e[1]+e[1],16),r=parseInt(e[2]+e[2],16),n=parseInt(e[3]+e[3],16)):e.length==7&&(t=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16)),{r:t,g:r,b:n}}function ha(e){const t=Yu(e);if(!t)return{r:0,g:0,b:0};const r=Xu(e,t);if(!Zu(r))return{r:0,g:0,b:0};const n=r.h/360,s=r.s/100,a=r.l/100,i=(1-Math.abs(2*a-1))*s,o=i*(1-Math.abs(n*6%2-1)),l=a-i/2;let u=0,c=0,h=0;return n<1/6?(u=i,c=o,h=0):n<2/6?(u=o,c=i,h=0):n<3/6?(u=0,c=i,h=o):n<4/6?(u=0,c=o,h=i):n<5/6?(u=o,c=0,h=i):(u=i,c=0,h=o),{r:Math.round((u+l)*255),g:Math.round((c+l)*255),b:Math.round((h+l)*255)}}const Yu=e=>e?e.startsWith("#")&&(e.length===4||e.length===7)?"hex":/rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*/.test(e)?e.includes("rgba")?"rgba":"rgb":/hsla?\(\s*\d+(\.\d+)?\s*,\s*\d+(\.\d+)?%\s*,\s*\d+(\.\d+)?%/.test(e)?e.includes("hsla")?"hsla":"hsl":null:null,Zu=e=>typeof e!="object"||e===null?!1:["h","s","l","a"].every(t=>typeof e[t]=="number"&&!isNaN(e[t]));function Xu(e,t){let r;switch(t){case"hex":{const n=Ro(Wu(e));return{h:Math.round(n.h*360),s:+(n.s*100).toFixed(1),l:+(n.l*100).toFixed(1),a:1}}case"rgb":case"rgba":{if(r=e.match(/\d+(\.\d+)?/g),!r||r.length<3)return null;const[n,s,a]=r.map(Number),i=Ro({r:n,g:s,b:a}),o=t==="rgba"&&r[3]?parseFloat(r[3]):1;return{h:Math.round(i.h*360),s:+(i.s*100).toFixed(1),l:+(i.l*100).toFixed(1),a:o}}case"hsl":case"hsla":{if(r=e.match(/\d+(\.\d+)?/g),!r||r.length<3)return null;const[n,s,a]=r.map(Number),i=t==="hsla"&&r[3]?parseFloat(r[3]):1;return{h:n,s,l:a,a:i}}default:return null}}const cf=(e,t)=>{if(!Object.keys(t).length)return e;const r=Yu(e);if(!r)return console.warn(`Unsupported color format in color palette: ${e}`),e;const n=Xu(e,r);return Zu(n)?(t.lightness&&(n.l=Math.max(0,Math.min(100,n.l+t.lightness*100))),t.opacity&&(n.a=Math.max(0,Math.min(1,t.opacity))),`hsla(${n.h}, ${n.s}%, ${n.l}%, ${n.a})`):(console.warn(`Invalid color values in color palette: ${e}`),e)};Xi(cf,(e,t)=>`${e}-${JSON.stringify(t)}`);function hf(e,t){try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch{return t}}function pf(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Failed to save to localStorage:",r)}}function ff(){const e=Je();return{screenToCanvas:n=>{const s=I(e.pointerZone),a=I(e.canvasContainer),i=I(e.maskCanvas);if(!s||!a||!i)return console.warn("screenToCanvas called before elements are available"),{x:0,y:0};const o=s.getBoundingClientRect(),l=a.getBoundingClientRect(),u=i.getBoundingClientRect(),c=o.left+n.x,h=o.top+n.y,f=c-l.left,d=h-l.top,p=i.width/u.width,g=i.height/u.height,z=f*p,M=d*g;return{x:z,y:M}},canvasToScreen:n=>{const s=I(e.pointerZone),a=I(e.canvasContainer),i=I(e.maskCanvas);if(!s||!a||!i)return console.warn("canvasToScreen called before elements are available"),{x:0,y:0};const o=s.getBoundingClientRect(),l=a.getBoundingClientRect(),u=i.getBoundingClientRect(),c=u.width/i.width,h=u.height/i.height,f=n.x*c,d=n.y*h,p=l.left+f,g=l.top+d,z=p-o.left,M=g-o.top;return{x:z,y:M}}}}const Hu=Nu(ff);function df(e,t,r,n,s){const i=(ne,X,j)=>{const V=Math.hypot(j.x-X.x,j.y-X.y);return ne+Math.pow(V,.5)},l=i(0,e,t),u=i(l,t,r),c=i(u,r,n),h=l+(u-l)*s,f=(ne,X,j,V,G)=>{if(Math.abs(V-j)<1e-4)return ne;const N=(G-j)/(V-j);return mf(Ao(ne,1-N),Ao(X,N))},d=f(e,t,0,l,h),p=f(t,r,l,u,h),g=f(r,n,u,c,h),z=f(d,p,0,u,h),M=f(p,g,l,c,h);return f(z,M,l,u,h)}function mf(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Ao(e,t){return{x:e.x*t,y:e.y*t}}function Ku(e,t,r){if(e.length===0)return{points:[],remainder:r};const n=[];let s=0,a=r;for(let o=0;o<e.length-1;o++){const l=e[o],u=e[o+1],c=u.x-l.x,h=u.y-l.y,f=Math.hypot(c,h);if(f<1e-4){for(;a<=s;)n.push(l),a+=t;continue}for(;a<=s+f;){const d=(a-s)/f,p=l.x+d*c,g=l.y+d*h;n.push({x:p,y:g}),a+=t}s+=f}const i=a-s;return{points:n,remainder:i}}var cn="0.8.2",m=Symbol(`typegpu:${cn}:$internal`),ge=Symbol(`typegpu:${cn}:$gpuValueOf`),Ae=Symbol(`typegpu:${cn}:$getNameForward`),Hr=Symbol(`typegpu:${cn}:$providing`),bt=Symbol(`typegpu:${cn}:$ownSnippet`),H=Symbol(`typegpu:${cn}:$resolve`),os=Symbol(`typegpu:${cn}:$repr`);function ye(e){return!!(e!=null&&e[m])}var xt={[m]:!0,type:"void",toString(){return"void"}},yf=["bool","f32","f16","i32","u32","u16","vec2f","vec2h","vec2i","vec2u","vec2<bool>","vec3f","vec3h","vec3i","vec3u","vec3<bool>","vec4f","vec4h","vec4i","vec4u","vec4<bool>","mat2x2f","mat3x3f","mat4x4f","struct","array","ptr","atomic","decorated","abstractInt","abstractFloat","void","texture_1d","texture_storage_1d","texture_2d","texture_storage_2d","texture_multisampled_2d","texture_depth_2d","texture_depth_multisampled_2d","texture_2d_array","texture_storage_2d_array","texture_depth_2d_array","texture_cube","texture_depth_cube","texture_cube_array","texture_depth_cube_array","texture_3d","texture_storage_3d","texture_external","sampler","sampler_comparison"];function Me(e){let t=e;return ye(t)&&typeof t.kind=="string"&&t.kind.startsWith("vec")}function wi(e){let t=e;return ye(t)&&typeof t.type=="string"&&t.type.startsWith("vec2")}function vi(e){let t=e;return ye(t)&&typeof t.type=="string"&&t.type.startsWith("vec3")}function Qu(e){let t=e;return ye(t)&&typeof t.type=="string"&&t.type.startsWith("vec4")}function zr(e){return wi(e)||vi(e)||Qu(e)}function or(e){var r;let t=e;return ye(t)&&typeof((r=t.kind)==null?void 0:r.startsWith)=="function"&&t.kind.startsWith("mat")}function Ju(e){return ye(e)&&(e==null?void 0:e.type)==="mat2x2f"}function ec(e){return ye(e)&&(e==null?void 0:e.type)==="mat3x3f"}function gf(e){return ye(e)&&(e==null?void 0:e.type)==="mat4x4f"}function As(e){return Ju(e)||ec(e)||gf(e)}function Oo(e){return Me(e)&&["vec2f","vec3f","vec4f"].includes(e.kind)}function hn(e){return ye(e)&&yf.includes(e==null?void 0:e.type)}function Xt(e){return ye(e)&&(e==null?void 0:e.type)==="array"}function pt(e){return ye(e)&&(e==null?void 0:e.type)==="struct"}function Fo(e){return ye(e)&&(e==null?void 0:e.type)==="ptr"}function wf(e){return ye(e)&&(e==null?void 0:e.type)==="atomic"}function tc(e){return ye(e)&&(e==null?void 0:e.type)==="@align"}function rc(e){return ye(e)&&(e==null?void 0:e.type)==="@size"}function vf(e){return ye(e)&&(e==null?void 0:e.type)==="@location"}function xf(e){return ye(e)&&(e==null?void 0:e.type)==="@builtin"}function pn(e){return ye(e)&&(e==null?void 0:e.type)==="decorated"}function nc(e){return ye(e)&&e.type==="void"}function Sr(e){let t=e==null?void 0:e.type;return ye(e)&&(t==="abstractInt"||t==="abstractFloat"||t==="f32"||t==="f16"||t==="i32"||t==="u32")}function Hi(e){let t=e==null?void 0:e.type;return ye(e)&&(t==="f16"||t==="vec2h"||t==="vec3h"||t==="vec4h")}Object.assign(globalThis,{__TYPEGPU_AUTONAME__:(e,t)=>(qa(e)&&ye(e)&&!U(e)&&e.$name(t),e)});var _s=globalThis;function sc(e){return!!(e!=null&&e[Ae])}function U(e){var t;return sc(e)?U(e[Ae]):(t=Wa(e))==null?void 0:t.name}function ve(e,t){sc(e)&&ve(e[Ae],t),bf(e,{name:t})}function qa(e){return!!(e!=null&&e.$name)}function ks(e){var t;return!!((t=Wa(e))!=null&&t.ast)}function Wa(e){return _s.__TYPEGPU_META__.get(e)}function bf(e,t){_s.__TYPEGPU_META__??(_s.__TYPEGPU_META__=new WeakMap);let r=_s.__TYPEGPU_META__;r.set(e,{...r.get(e),...t})}var ac=["uint8","uint8x2","uint8x4","sint8","sint8x2","sint8x4","unorm8","unorm8x2","unorm8x4","snorm8","snorm8x2","snorm8x4","uint16","uint16x2","uint16x4","sint16","sint16x2","sint16x4","unorm16","unorm16x2","unorm16x4","snorm16","snorm16x2","snorm16x4","float16","float16x2","float16x4","float32","float32x2","float32x3","float32x4","uint32","uint32x2","uint32x3","uint32x4","sint32","sint32x2","sint32x3","sint32x4","unorm10-10-10-2","unorm8x4-bgra"],Tf={f32:"float32",vec2f:"float32x2",vec3f:"float32x3",vec4f:"float32x4",f16:"float16",vec2h:"float16x2",vec4h:"float16x4",u32:"uint32",vec2u:"uint32x2",vec3u:"uint32x3",vec4u:"uint32x4",i32:"sint32",vec2i:"sint32x2",vec3i:"sint32x3",vec4i:"sint32x4"};function Or(e){return e.type==="decorated"||e.type==="loose-decorated"?e.inner:e}var $f=["unstruct","disarray","loose-decorated",...ac];function Ks(e){return ye(e)&&$f.includes(e==null?void 0:e.type)}function ls(e){return ye(e)&&(e==null?void 0:e.type)==="disarray"}function Gr(e){return ye(e)&&(e==null?void 0:e.type)==="unstruct"}function fn(e){return ye(e)&&(e==null?void 0:e.type)==="loose-decorated"}function Ps(e){var t,r;return(r=(t=e.attribs)==null?void 0:t.find(tc))==null?void 0:r.params[0]}function _f(e){var t,r;return(r=(t=e.attribs)==null?void 0:t.find(rc))==null?void 0:r.params[0]}function Fr(e){var t,r;return(r=(t=e.attribs)==null?void 0:t.find(vf))==null?void 0:r.params[0]}function us(e){return hn(e)||Ks(e)}var ht={type:"unknown",toString(){return"unknown"}},Lo=class{constructor(t,r,n){this.name=t,this.lhs=r,this.operator=n}},Go=class{constructor(t){this.matrix=t}},Pl,Do=(Pl=m,class{constructor(t){y(this,Pl,!0);this.op=t,ve(this,"consoleLog")}}),zf="Invariant failed";function Tr(e,t){if(!e)throw new Error(zf)}var zs=class xi extends Error{constructor(t,r){let n=r.map(s=>`- ${ks(s)?`fn*:${U(s)}`:s}`);n.length>20&&(n=[...n.slice(0,11),"...",...n.slice(-10)]),super(`Resolution of the following tree failed:
${n.join(`
`)}: ${t&&typeof t=="object"&&"message"in t?t.message:t}`),this.cause=t,this.trace=r,Object.setPrototypeOf(this,xi.prototype)}appendToTrace(t){let r=[t,...this.trace];return new xi(this.cause,r)}},jo=class bi extends Error{constructor(t,r){let n=r.map(s=>`- ${s}`);n.length>20&&(n=[...n.slice(0,11),"...",...n.slice(-10)]),super(`Execution of the following tree failed:
${n.join(`
`)}: ${t&&typeof t=="object"&&"message"in t?t.message:t}`),this.cause=t,this.trace=r,Object.setPrototypeOf(this,bi.prototype)}appendToTrace(t){let r=[t,...this.trace];return new bi(this.cause,r)}},Sf=class ic extends Error{constructor(t){super(`Missing value for '${t}'`),this.slot=t,Object.setPrototypeOf(this,ic.prototype)}},Mf=class oc extends Error{constructor(t){super(`Buffer '${U(t)??"<unnamed>"}' is not bindable as a uniform. Use .$usage('uniform') to allow it.`),Object.setPrototypeOf(this,oc.prototype)}},kf=class lc extends Error{constructor(t,r){super(`The function '${t??"<unnamed>"}' is missing links to the following external values: ${r}.`),Object.setPrototypeOf(this,lc.prototype)}},Ki=class uc extends Error{constructor(t){super(`Missing bind groups for layouts: '${[...t].map(r=>U(r)??"<unnamed>").join(", ")}'. Please provide it using pipeline.with(bindGroup).(...)`),Object.setPrototypeOf(this,uc.prototype)}},cc=class hc extends Error{constructor(t){super(`Missing vertex buffers for layouts: '${[...t].map(r=>U(r)??"<unnamed>").join(", ")}'. Please provide it using pipeline.with(layout, buffer).(...)`),Object.setPrototypeOf(this,hc.prototype)}},No=class pc extends Error{constructor(t){super(t),Object.setPrototypeOf(this,pc.prototype)}},qo=class fc extends Error{constructor(t){super(t),Object.setPrototypeOf(this,fc.prototype)}},Lt=class dc extends Error{constructor(t){super(t),Object.setPrototypeOf(this,dc.prototype)}};function Ti(e){return(e==null?void 0:e.resourceType)==="slot"}function $i(e){return(e==null?void 0:e.resourceType)==="derived"}function _i(e){return(e==null?void 0:e[Hr])!==void 0}function Ya(e){return(e==null?void 0:e.resourceType)==="accessor"}var mc=class{constructor(t,r){this.value=t,this.dataType=r}};function Qi(e){return e instanceof mc}function pa(e){return Sr(e.dataType)}function _(e,t){return new mc(e,Or(t))}var yc=class{constructor(){y(this,"type","normal")}},Pf=class{constructor(){y(this,"type","codegen")}},Bf=class{constructor(e,t){y(this,"type","simulate");this.buffers=e,this.vars=t}};function gc(e){return!!(e!=null&&e[H])}function Ji(e){return e==null?void 0:e[bt]}function If(e){return typeof e=="number"||typeof e=="boolean"||typeof e=="string"||gc(e)||hn(e)||Ti(e)||$i(e)||_i(e)}function zi(e){return!!e&&typeof e=="object"&&"getMappedRange"in e&&"mapAsync"in e}var $a=!1;function Ef(e){if($a)return e();try{return $a=!0,e()}finally{$a=!1}}function Ea(){return $a}var Gt;function wc(e,t){if(Tr(Gt===void 0||Gt===e),Gt===e)return t();Gt=e;try{return t()}finally{Gt=void 0}}function un(){return Gt}var vc=new yc;function Ua(){return(Gt==null?void 0:Gt.mode)??vc}function yr(){return(Gt==null?void 0:Gt.mode.type)==="codegen"}function x(e,...t){let r=un();function n(a){return Qi(a)?r.resolve(a.value,a.dataType).value:a}let s="";for(let a=0;a<e.length;++a){s+=e[a];let i=t[a];Array.isArray(i)?s+=i.filter(o=>o!==void 0).map(n).join(", "):i&&(s+=n(i))}return s}function is(e,t){throw new Error(`Failed to handle ${e} at ${t}`)}var eo={rank:Number.POSITIVE_INFINITY,action:"none"};function Va(e,t){let r=Or(e),n=Or(t);if(r.type===n.type)return{rank:0,action:"none"};if(r.type==="abstractFloat"){if(n.type==="f32")return{rank:1,action:"none"};if(n.type==="f16")return{rank:2,action:"none"}}if(r.type==="abstractInt"){if(n.type==="i32")return{rank:3,action:"none"};if(n.type==="u32")return{rank:4,action:"none"};if(n.type==="abstractFloat")return{rank:5,action:"none"};if(n.type==="f32")return{rank:6,action:"none"};if(n.type==="f16")return{rank:7,action:"none"}}return zr(r)&&zr(n)?Va(r.primitive,n.primitive):As(r)&&As(n)?{rank:0,action:"none"}:eo}function Uf(e,t){let r=Or(e),n=Or(t);if(r.type==="ptr"&&Va(r.inner,n).rank<Number.POSITIVE_INFINITY)return{rank:0,action:"deref"};if(n.type==="ptr"&&Va(r,n.inner).rank<Number.POSITIVE_INFINITY)return{rank:1,action:"ref"};let s={f32:0,f16:1,i32:2,u32:3,bool:4};if(r.type in s&&n.type in s){let a=r.type,i=n.type;if(a!==i){let o=s[a];return{rank:s[i]<o?10:20,action:"cast",targetType:n}}}if(r.type==="abstractFloat"){if(n.type==="u32")return{rank:2,action:"cast",targetType:n};if(n.type==="i32")return{rank:1,action:"cast",targetType:n}}return eo}function Vf(e,t,r){let n=Va(e,t);return n.rank<Number.POSITIVE_INFINITY?n:r?Uf(e,t):eo}function Wo(e,t,r){let n;for(let a of t){let i=[],o=0;for(let l of e){let u=Vf(l,a,r);if(o+=u.rank,u.rank===Number.POSITIVE_INFINITY)break;i.push(u)}o<((n==null?void 0:n.sum)??Number.POSITIVE_INFINITY)&&(n={type:a,details:i,sum:o})}if(!n)return;let s=n.details.map((a,i)=>({sourceIndex:i,action:a.action,...a.action==="cast"&&{targetType:a.targetType}}));return{targetType:n.type,actions:s,hasImplicitConversions:s.some(a=>a.action==="cast")}}function to(e,t){if(e.length===0)return;let r=[...new Set((t||e).map(Or))],n=Wo(e,r,!1);if(n)return n;let s=Wo(e,r,!0);if(s)return s}function Cf(e,t,r){if(t.action==="none")return _(e.value,r);switch(t.action){case"ref":return _(x`&${e}`,r);case"deref":return _(x`*${e}`,r);case"cast":return r(e);default:is(t.action,"applyActionToSnippet")}}function ft(e,t){if(e.some(n=>n.type==="unknown"))return;let r=to(e,t);if(r)return e.map(()=>r.targetType)}function Bs(e,t,r=!0){let n=e.map(a=>a.dataType);if(n.some(a=>a.type==="unknown"))return;let s=to(n,t);if(s)return e.map((a,i)=>{let o=s.actions[i];return Tr(o),Cf(a,o,s.targetType)})}function Si(e,t,r=!0){if(t===e.dataType)return _(e.value,t);if(e.dataType.type==="unknown")return _(x`${_(e.value,t)}`,t);let n=Bs([e],[t],r);if(!n)throw new Lt(`Cannot convert value of type '${e.dataType.type}' to type '${t.type}'`);return n[0]}function Rf(e,t){return Object.keys(e.propTypes).map(r=>{var a;let n=t[r];if(!n)throw new Error(`Missing property ${r}`);let s=e.propTypes[r];return((a=Bs([n],[s]))==null?void 0:a[0])??n})}function Af(e){return typeof e!="string"&&Ji(e)===void 0}function et(e,t,r,n="keep"){let s=(...a)=>yr()?t(...a):e(...a);return ve(s,r),s.toString=()=>r,Object.defineProperty(s,m,{value:{jsImpl:e,gpuImpl:t,argConversionHint:n}}),s}var Bt=class extends Error{constructor(t){super(t),this.name=this.constructor.name}};function k(e){let t=(...n)=>{let{argTypes:s,returnType:a}=typeof e.signature=="function"?e.signature(...n.map(o=>o.dataType)):e.signature,i=n.map((o,l)=>Si(o,s[l],!e.ignoreImplicitCastWarning));if(i.every(o=>Af(o.value))&&typeof e.normalImpl=="function")try{return _(e.normalImpl(...i.map(o=>o.value)),a)}catch(o){if(!(o instanceof Bt))throw o}return _(e.codegenImpl(...i),a)},r=(...n)=>{if(yr())return t(...n);if(typeof e.normalImpl=="string")throw new Bt(e.normalImpl);return e.normalImpl(...n)};return ve(r,e.name),r.toString=()=>e.name,Object.defineProperty(r,m,{value:{jsImpl:e.normalImpl,gpuImpl:t,argConversionHint:"keep"}}),r}var Za={[m]:!0,type:"abstractInt",toString(){return"abstractInt"}},Ht={[m]:!0,type:"abstractFloat",toString(){return"abstractFloat"}},Of=k({name:"bool",signature:e=>({argTypes:e?[e]:[],returnType:Ue}),normalImpl(e){return e===void 0?!1:typeof e=="boolean"?e:!!e},codegenImpl:e=>e.dataType.type==="bool"?x`${e}`:x`bool(${e})`}),Ue=Object.assign(Of,{type:"bool"}),Ff=k({name:"u32",signature:e=>({argTypes:e?[e]:[],returnType:O}),normalImpl(e){return e===void 0?0:typeof e=="boolean"?e?1:0:(e&4294967295)>>>0},codegenImpl:e=>e.dataType.type==="u32"?x`${e}`:x`u32(${e})`}),O=Object.assign(Ff,{type:"u32"}),Lf=k({name:"i32",signature:e=>({argTypes:e?[e]:[],returnType:we}),normalImpl(e){return e===void 0?0:typeof e=="boolean"?e?1:0:e|0},codegenImpl:e=>e.dataType.type==="i32"?x`${e}`:x`i32(${e})`}),we=Object.assign(Lf,{type:"i32"}),Gf=k({name:"f32",signature:e=>({argTypes:e?[e]:[],returnType:v}),normalImpl(e){return e===void 0?0:typeof e=="boolean"?e?1:0:Math.fround(e)},codegenImpl:e=>e.dataType.type==="f32"?x`${e}`:x`f32(${e})`}),v=Object.assign(Gf,{type:"f32"}),xc=new ArrayBuffer(4),Df=new Float32Array(xc),jf=new Uint32Array(xc);function Nf(e){Df[0]=e;let t=jf[0],r=t>>>31&1,n=t>>>23&255,s=t&8388607;return n===255?r<<15|31744|(s?512:0):(n=n-127+15,n<=0?n<-10?r<<15:(s=(s|8388608)>>1-n,s=s+4096>>13,r<<15|s):n>=31||(s=s+4096,s&8388608&&(s=0,++n,n>=31))?r<<15|31744:r<<15|n<<10|s>>13)}function qf(e){let t=e&32768?-1:1,r=e>>10&31,n=e&1023;return r===0?n?t*n*2**-24:t*0:r===31?n?Number.NaN:t===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:t*(1+n/1024)*2**(r-15)}function Wf(e){return qf(Nf(e))}var Yf=k({name:"f16",signature:e=>({argTypes:e?[e]:[],returnType:je}),normalImpl(e){return e===void 0?0:typeof e=="boolean"?e?1:0:Wf(e)},codegenImpl:e=>e.dataType.type==="f16"?x`${e}`:x`f16(${e})`}),je=Object.assign(Yf,{type:"f16"}),ro=class extends Array{castElement(){return this[m].elementSchema[m].jsImpl}[H](){let t=this[m].elementSchema;return this.every(r=>!r)?_(`${this.kind}()`,t):this.every(r=>this[0]===r)?_(`${this.kind}(${this[0]})`,t):_(`${this.kind}(${this.join(", ")})`,t)}toString(){return this[H]().value}get xx(){return new this._Vec2(this[0],this[0])}get xy(){return new this._Vec2(this[0],this[1])}get xz(){return new this._Vec2(this[0],this[2])}get xw(){return new this._Vec2(this[0],this[3])}get yx(){return new this._Vec2(this[1],this[0])}get yy(){return new this._Vec2(this[1],this[1])}get yz(){return new this._Vec2(this[1],this[2])}get yw(){return new this._Vec2(this[1],this[3])}get zx(){return new this._Vec2(this[2],this[0])}get zy(){return new this._Vec2(this[2],this[1])}get zz(){return new this._Vec2(this[2],this[2])}get zw(){return new this._Vec2(this[2],this[3])}get wx(){return new this._Vec2(this[3],this[0])}get wy(){return new this._Vec2(this[3],this[1])}get wz(){return new this._Vec2(this[3],this[2])}get ww(){return new this._Vec2(this[3],this[3])}get xxx(){return new this._Vec3(this[0],this[0],this[0])}get xxy(){return new this._Vec3(this[0],this[0],this[1])}get xxz(){return new this._Vec3(this[0],this[0],this[2])}get xxw(){return new this._Vec3(this[0],this[0],this[3])}get xyx(){return new this._Vec3(this[0],this[1],this[0])}get xyy(){return new this._Vec3(this[0],this[1],this[1])}get xyz(){return new this._Vec3(this[0],this[1],this[2])}get xyw(){return new this._Vec3(this[0],this[1],this[3])}get xzx(){return new this._Vec3(this[0],this[2],this[0])}get xzy(){return new this._Vec3(this[0],this[2],this[1])}get xzz(){return new this._Vec3(this[0],this[2],this[2])}get xzw(){return new this._Vec3(this[0],this[2],this[3])}get xwx(){return new this._Vec3(this[0],this[3],this[0])}get xwy(){return new this._Vec3(this[0],this[3],this[1])}get xwz(){return new this._Vec3(this[0],this[3],this[2])}get xww(){return new this._Vec3(this[0],this[3],this[3])}get yxx(){return new this._Vec3(this[1],this[0],this[0])}get yxy(){return new this._Vec3(this[1],this[0],this[1])}get yxz(){return new this._Vec3(this[1],this[0],this[2])}get yxw(){return new this._Vec3(this[1],this[0],this[3])}get yyx(){return new this._Vec3(this[1],this[1],this[0])}get yyy(){return new this._Vec3(this[1],this[1],this[1])}get yyz(){return new this._Vec3(this[1],this[1],this[2])}get yyw(){return new this._Vec3(this[1],this[1],this[3])}get yzx(){return new this._Vec3(this[1],this[2],this[0])}get yzy(){return new this._Vec3(this[1],this[2],this[1])}get yzz(){return new this._Vec3(this[1],this[2],this[2])}get yzw(){return new this._Vec3(this[1],this[2],this[3])}get ywx(){return new this._Vec3(this[1],this[3],this[0])}get ywy(){return new this._Vec3(this[1],this[3],this[1])}get ywz(){return new this._Vec3(this[1],this[3],this[2])}get yww(){return new this._Vec3(this[1],this[3],this[3])}get zxx(){return new this._Vec3(this[2],this[0],this[0])}get zxy(){return new this._Vec3(this[2],this[0],this[1])}get zxz(){return new this._Vec3(this[2],this[0],this[2])}get zxw(){return new this._Vec3(this[2],this[0],this[3])}get zyx(){return new this._Vec3(this[2],this[1],this[0])}get zyy(){return new this._Vec3(this[2],this[1],this[1])}get zyz(){return new this._Vec3(this[2],this[1],this[2])}get zyw(){return new this._Vec3(this[2],this[1],this[3])}get zzx(){return new this._Vec3(this[2],this[2],this[0])}get zzy(){return new this._Vec3(this[2],this[2],this[1])}get zzz(){return new this._Vec3(this[2],this[2],this[2])}get zzw(){return new this._Vec3(this[2],this[2],this[3])}get zwx(){return new this._Vec3(this[2],this[3],this[0])}get zwy(){return new this._Vec3(this[2],this[3],this[1])}get zwz(){return new this._Vec3(this[2],this[3],this[2])}get zww(){return new this._Vec3(this[2],this[3],this[3])}get wxx(){return new this._Vec3(this[3],this[0],this[0])}get wxy(){return new this._Vec3(this[3],this[0],this[1])}get wxz(){return new this._Vec3(this[3],this[0],this[2])}get wxw(){return new this._Vec3(this[3],this[0],this[3])}get wyx(){return new this._Vec3(this[3],this[1],this[0])}get wyy(){return new this._Vec3(this[3],this[1],this[1])}get wyz(){return new this._Vec3(this[3],this[1],this[2])}get wyw(){return new this._Vec3(this[3],this[1],this[3])}get wzx(){return new this._Vec3(this[3],this[2],this[0])}get wzy(){return new this._Vec3(this[3],this[2],this[1])}get wzz(){return new this._Vec3(this[3],this[2],this[2])}get wzw(){return new this._Vec3(this[3],this[2],this[3])}get wwx(){return new this._Vec3(this[3],this[3],this[0])}get wwy(){return new this._Vec3(this[3],this[3],this[1])}get wwz(){return new this._Vec3(this[3],this[3],this[2])}get www(){return new this._Vec3(this[3],this[3],this[3])}get xxxx(){return new this._Vec4(this[0],this[0],this[0],this[0])}get xxxy(){return new this._Vec4(this[0],this[0],this[0],this[1])}get xxxz(){return new this._Vec4(this[0],this[0],this[0],this[2])}get xxxw(){return new this._Vec4(this[0],this[0],this[0],this[3])}get xxyx(){return new this._Vec4(this[0],this[0],this[1],this[0])}get xxyy(){return new this._Vec4(this[0],this[0],this[1],this[1])}get xxyz(){return new this._Vec4(this[0],this[0],this[1],this[2])}get xxyw(){return new this._Vec4(this[0],this[0],this[1],this[3])}get xxzx(){return new this._Vec4(this[0],this[0],this[2],this[0])}get xxzy(){return new this._Vec4(this[0],this[0],this[2],this[1])}get xxzz(){return new this._Vec4(this[0],this[0],this[2],this[2])}get xxzw(){return new this._Vec4(this[0],this[0],this[2],this[3])}get xxwx(){return new this._Vec4(this[0],this[0],this[3],this[0])}get xxwy(){return new this._Vec4(this[0],this[0],this[3],this[1])}get xxwz(){return new this._Vec4(this[0],this[0],this[3],this[2])}get xxww(){return new this._Vec4(this[0],this[0],this[3],this[3])}get xyxx(){return new this._Vec4(this[0],this[1],this[0],this[0])}get xyxy(){return new this._Vec4(this[0],this[1],this[0],this[1])}get xyxz(){return new this._Vec4(this[0],this[1],this[0],this[2])}get xyxw(){return new this._Vec4(this[0],this[1],this[0],this[3])}get xyyx(){return new this._Vec4(this[0],this[1],this[1],this[0])}get xyyy(){return new this._Vec4(this[0],this[1],this[1],this[1])}get xyyz(){return new this._Vec4(this[0],this[1],this[1],this[2])}get xyyw(){return new this._Vec4(this[0],this[1],this[1],this[3])}get xyzx(){return new this._Vec4(this[0],this[1],this[2],this[0])}get xyzy(){return new this._Vec4(this[0],this[1],this[2],this[1])}get xyzz(){return new this._Vec4(this[0],this[1],this[2],this[2])}get xyzw(){return new this._Vec4(this[0],this[1],this[2],this[3])}get xywx(){return new this._Vec4(this[0],this[1],this[3],this[0])}get xywy(){return new this._Vec4(this[0],this[1],this[3],this[1])}get xywz(){return new this._Vec4(this[0],this[1],this[3],this[2])}get xyww(){return new this._Vec4(this[0],this[1],this[3],this[3])}get xzxx(){return new this._Vec4(this[0],this[2],this[0],this[0])}get xzxy(){return new this._Vec4(this[0],this[2],this[0],this[1])}get xzxz(){return new this._Vec4(this[0],this[2],this[0],this[2])}get xzxw(){return new this._Vec4(this[0],this[2],this[0],this[3])}get xzyx(){return new this._Vec4(this[0],this[2],this[1],this[0])}get xzyy(){return new this._Vec4(this[0],this[2],this[1],this[1])}get xzyz(){return new this._Vec4(this[0],this[2],this[1],this[2])}get xzyw(){return new this._Vec4(this[0],this[2],this[1],this[3])}get xzzx(){return new this._Vec4(this[0],this[2],this[2],this[0])}get xzzy(){return new this._Vec4(this[0],this[2],this[2],this[1])}get xzzz(){return new this._Vec4(this[0],this[2],this[2],this[2])}get xzzw(){return new this._Vec4(this[0],this[2],this[2],this[3])}get xzwx(){return new this._Vec4(this[0],this[2],this[3],this[0])}get xzwy(){return new this._Vec4(this[0],this[2],this[3],this[1])}get xzwz(){return new this._Vec4(this[0],this[2],this[3],this[2])}get xzww(){return new this._Vec4(this[0],this[2],this[3],this[3])}get xwxx(){return new this._Vec4(this[0],this[3],this[0],this[0])}get xwxy(){return new this._Vec4(this[0],this[3],this[0],this[1])}get xwxz(){return new this._Vec4(this[0],this[3],this[0],this[2])}get xwxw(){return new this._Vec4(this[0],this[3],this[0],this[3])}get xwyx(){return new this._Vec4(this[0],this[3],this[1],this[0])}get xwyy(){return new this._Vec4(this[0],this[3],this[1],this[1])}get xwyz(){return new this._Vec4(this[0],this[3],this[1],this[2])}get xwyw(){return new this._Vec4(this[0],this[3],this[1],this[3])}get xwzx(){return new this._Vec4(this[0],this[3],this[2],this[0])}get xwzy(){return new this._Vec4(this[0],this[3],this[2],this[1])}get xwzz(){return new this._Vec4(this[0],this[3],this[2],this[2])}get xwzw(){return new this._Vec4(this[0],this[3],this[2],this[3])}get xwwx(){return new this._Vec4(this[0],this[3],this[3],this[0])}get xwwy(){return new this._Vec4(this[0],this[3],this[3],this[1])}get xwwz(){return new this._Vec4(this[0],this[3],this[3],this[2])}get xwww(){return new this._Vec4(this[0],this[3],this[3],this[3])}get yxxx(){return new this._Vec4(this[1],this[0],this[0],this[0])}get yxxy(){return new this._Vec4(this[1],this[0],this[0],this[1])}get yxxz(){return new this._Vec4(this[1],this[0],this[0],this[2])}get yxxw(){return new this._Vec4(this[1],this[0],this[0],this[3])}get yxyx(){return new this._Vec4(this[1],this[0],this[1],this[0])}get yxyy(){return new this._Vec4(this[1],this[0],this[1],this[1])}get yxyz(){return new this._Vec4(this[1],this[0],this[1],this[2])}get yxyw(){return new this._Vec4(this[1],this[0],this[1],this[3])}get yxzx(){return new this._Vec4(this[1],this[0],this[2],this[0])}get yxzy(){return new this._Vec4(this[1],this[0],this[2],this[1])}get yxzz(){return new this._Vec4(this[1],this[0],this[2],this[2])}get yxzw(){return new this._Vec4(this[1],this[0],this[2],this[3])}get yxwx(){return new this._Vec4(this[1],this[0],this[3],this[0])}get yxwy(){return new this._Vec4(this[1],this[0],this[3],this[1])}get yxwz(){return new this._Vec4(this[1],this[0],this[3],this[2])}get yxww(){return new this._Vec4(this[1],this[0],this[3],this[3])}get yyxx(){return new this._Vec4(this[1],this[1],this[0],this[0])}get yyxy(){return new this._Vec4(this[1],this[1],this[0],this[1])}get yyxz(){return new this._Vec4(this[1],this[1],this[0],this[2])}get yyxw(){return new this._Vec4(this[1],this[1],this[0],this[3])}get yyyx(){return new this._Vec4(this[1],this[1],this[1],this[0])}get yyyy(){return new this._Vec4(this[1],this[1],this[1],this[1])}get yyyz(){return new this._Vec4(this[1],this[1],this[1],this[2])}get yyyw(){return new this._Vec4(this[1],this[1],this[1],this[3])}get yyzx(){return new this._Vec4(this[1],this[1],this[2],this[0])}get yyzy(){return new this._Vec4(this[1],this[1],this[2],this[1])}get yyzz(){return new this._Vec4(this[1],this[1],this[2],this[2])}get yyzw(){return new this._Vec4(this[1],this[1],this[2],this[3])}get yywx(){return new this._Vec4(this[1],this[1],this[3],this[0])}get yywy(){return new this._Vec4(this[1],this[1],this[3],this[1])}get yywz(){return new this._Vec4(this[1],this[1],this[3],this[2])}get yyww(){return new this._Vec4(this[1],this[1],this[3],this[3])}get yzxx(){return new this._Vec4(this[1],this[2],this[0],this[0])}get yzxy(){return new this._Vec4(this[1],this[2],this[0],this[1])}get yzxz(){return new this._Vec4(this[1],this[2],this[0],this[2])}get yzxw(){return new this._Vec4(this[1],this[2],this[0],this[3])}get yzyx(){return new this._Vec4(this[1],this[2],this[1],this[0])}get yzyy(){return new this._Vec4(this[1],this[2],this[1],this[1])}get yzyz(){return new this._Vec4(this[1],this[2],this[1],this[2])}get yzyw(){return new this._Vec4(this[1],this[2],this[1],this[3])}get yzzx(){return new this._Vec4(this[1],this[2],this[2],this[0])}get yzzy(){return new this._Vec4(this[1],this[2],this[2],this[1])}get yzzz(){return new this._Vec4(this[1],this[2],this[2],this[2])}get yzzw(){return new this._Vec4(this[1],this[2],this[2],this[3])}get yzwx(){return new this._Vec4(this[1],this[2],this[3],this[0])}get yzwy(){return new this._Vec4(this[1],this[2],this[3],this[1])}get yzwz(){return new this._Vec4(this[1],this[2],this[3],this[2])}get yzww(){return new this._Vec4(this[1],this[2],this[3],this[3])}get ywxx(){return new this._Vec4(this[1],this[3],this[0],this[0])}get ywxy(){return new this._Vec4(this[1],this[3],this[0],this[1])}get ywxz(){return new this._Vec4(this[1],this[3],this[0],this[2])}get ywxw(){return new this._Vec4(this[1],this[3],this[0],this[3])}get ywyx(){return new this._Vec4(this[1],this[3],this[1],this[0])}get ywyy(){return new this._Vec4(this[1],this[3],this[1],this[1])}get ywyz(){return new this._Vec4(this[1],this[3],this[1],this[2])}get ywyw(){return new this._Vec4(this[1],this[3],this[1],this[3])}get ywzx(){return new this._Vec4(this[1],this[3],this[2],this[0])}get ywzy(){return new this._Vec4(this[1],this[3],this[2],this[1])}get ywzz(){return new this._Vec4(this[1],this[3],this[2],this[2])}get ywzw(){return new this._Vec4(this[1],this[3],this[2],this[3])}get ywwx(){return new this._Vec4(this[1],this[3],this[3],this[0])}get ywwy(){return new this._Vec4(this[1],this[3],this[3],this[1])}get ywwz(){return new this._Vec4(this[1],this[3],this[3],this[2])}get ywww(){return new this._Vec4(this[1],this[3],this[3],this[3])}get zxxx(){return new this._Vec4(this[2],this[0],this[0],this[0])}get zxxy(){return new this._Vec4(this[2],this[0],this[0],this[1])}get zxxz(){return new this._Vec4(this[2],this[0],this[0],this[2])}get zxxw(){return new this._Vec4(this[2],this[0],this[0],this[3])}get zxyx(){return new this._Vec4(this[2],this[0],this[1],this[0])}get zxyy(){return new this._Vec4(this[2],this[0],this[1],this[1])}get zxyz(){return new this._Vec4(this[2],this[0],this[1],this[2])}get zxyw(){return new this._Vec4(this[2],this[0],this[1],this[3])}get zxzx(){return new this._Vec4(this[2],this[0],this[2],this[0])}get zxzy(){return new this._Vec4(this[2],this[0],this[2],this[1])}get zxzz(){return new this._Vec4(this[2],this[0],this[2],this[2])}get zxzw(){return new this._Vec4(this[2],this[0],this[2],this[3])}get zxwx(){return new this._Vec4(this[2],this[0],this[3],this[0])}get zxwy(){return new this._Vec4(this[2],this[0],this[3],this[1])}get zxwz(){return new this._Vec4(this[2],this[0],this[3],this[2])}get zxww(){return new this._Vec4(this[2],this[0],this[3],this[3])}get zyxx(){return new this._Vec4(this[2],this[1],this[0],this[0])}get zyxy(){return new this._Vec4(this[2],this[1],this[0],this[1])}get zyxz(){return new this._Vec4(this[2],this[1],this[0],this[2])}get zyxw(){return new this._Vec4(this[2],this[1],this[0],this[3])}get zyyx(){return new this._Vec4(this[2],this[1],this[1],this[0])}get zyyy(){return new this._Vec4(this[2],this[1],this[1],this[1])}get zyyz(){return new this._Vec4(this[2],this[1],this[1],this[2])}get zyyw(){return new this._Vec4(this[2],this[1],this[1],this[3])}get zyzx(){return new this._Vec4(this[2],this[1],this[2],this[0])}get zyzy(){return new this._Vec4(this[2],this[1],this[2],this[1])}get zyzz(){return new this._Vec4(this[2],this[1],this[2],this[2])}get zyzw(){return new this._Vec4(this[2],this[1],this[2],this[3])}get zywx(){return new this._Vec4(this[2],this[1],this[3],this[0])}get zywy(){return new this._Vec4(this[2],this[1],this[3],this[1])}get zywz(){return new this._Vec4(this[2],this[1],this[3],this[2])}get zyww(){return new this._Vec4(this[2],this[1],this[3],this[3])}get zzxx(){return new this._Vec4(this[2],this[2],this[0],this[0])}get zzxy(){return new this._Vec4(this[2],this[2],this[0],this[1])}get zzxz(){return new this._Vec4(this[2],this[2],this[0],this[2])}get zzxw(){return new this._Vec4(this[2],this[2],this[0],this[3])}get zzyx(){return new this._Vec4(this[2],this[2],this[1],this[0])}get zzyy(){return new this._Vec4(this[2],this[2],this[1],this[1])}get zzyz(){return new this._Vec4(this[2],this[2],this[1],this[2])}get zzyw(){return new this._Vec4(this[2],this[2],this[1],this[3])}get zzzx(){return new this._Vec4(this[2],this[2],this[2],this[0])}get zzzy(){return new this._Vec4(this[2],this[2],this[2],this[1])}get zzzz(){return new this._Vec4(this[2],this[2],this[2],this[2])}get zzzw(){return new this._Vec4(this[2],this[2],this[2],this[3])}get zzwx(){return new this._Vec4(this[2],this[2],this[3],this[0])}get zzwy(){return new this._Vec4(this[2],this[2],this[3],this[1])}get zzwz(){return new this._Vec4(this[2],this[2],this[3],this[2])}get zzww(){return new this._Vec4(this[2],this[2],this[3],this[3])}get zwxx(){return new this._Vec4(this[2],this[3],this[0],this[0])}get zwxy(){return new this._Vec4(this[2],this[3],this[0],this[1])}get zwxz(){return new this._Vec4(this[2],this[3],this[0],this[2])}get zwxw(){return new this._Vec4(this[2],this[3],this[0],this[3])}get zwyx(){return new this._Vec4(this[2],this[3],this[1],this[0])}get zwyy(){return new this._Vec4(this[2],this[3],this[1],this[1])}get zwyz(){return new this._Vec4(this[2],this[3],this[1],this[2])}get zwyw(){return new this._Vec4(this[2],this[3],this[1],this[3])}get zwzx(){return new this._Vec4(this[2],this[3],this[2],this[0])}get zwzy(){return new this._Vec4(this[2],this[3],this[2],this[1])}get zwzz(){return new this._Vec4(this[2],this[3],this[2],this[2])}get zwzw(){return new this._Vec4(this[2],this[3],this[2],this[3])}get zwwx(){return new this._Vec4(this[2],this[3],this[3],this[0])}get zwwy(){return new this._Vec4(this[2],this[3],this[3],this[1])}get zwwz(){return new this._Vec4(this[2],this[3],this[3],this[2])}get zwww(){return new this._Vec4(this[2],this[3],this[3],this[3])}get wxxx(){return new this._Vec4(this[3],this[0],this[0],this[0])}get wxxy(){return new this._Vec4(this[3],this[0],this[0],this[1])}get wxxz(){return new this._Vec4(this[3],this[0],this[0],this[2])}get wxxw(){return new this._Vec4(this[3],this[0],this[0],this[3])}get wxyx(){return new this._Vec4(this[3],this[0],this[1],this[0])}get wxyy(){return new this._Vec4(this[3],this[0],this[1],this[1])}get wxyz(){return new this._Vec4(this[3],this[0],this[1],this[2])}get wxyw(){return new this._Vec4(this[3],this[0],this[1],this[3])}get wxzx(){return new this._Vec4(this[3],this[0],this[2],this[0])}get wxzy(){return new this._Vec4(this[3],this[0],this[2],this[1])}get wxzz(){return new this._Vec4(this[3],this[0],this[2],this[2])}get wxzw(){return new this._Vec4(this[3],this[0],this[2],this[3])}get wxwx(){return new this._Vec4(this[3],this[0],this[3],this[0])}get wxwy(){return new this._Vec4(this[3],this[0],this[3],this[1])}get wxwz(){return new this._Vec4(this[3],this[0],this[3],this[2])}get wxww(){return new this._Vec4(this[3],this[0],this[3],this[3])}get wyxx(){return new this._Vec4(this[3],this[1],this[0],this[0])}get wyxy(){return new this._Vec4(this[3],this[1],this[0],this[1])}get wyxz(){return new this._Vec4(this[3],this[1],this[0],this[2])}get wyxw(){return new this._Vec4(this[3],this[1],this[0],this[3])}get wyyx(){return new this._Vec4(this[3],this[1],this[1],this[0])}get wyyy(){return new this._Vec4(this[3],this[1],this[1],this[1])}get wyyz(){return new this._Vec4(this[3],this[1],this[1],this[2])}get wyyw(){return new this._Vec4(this[3],this[1],this[1],this[3])}get wyzx(){return new this._Vec4(this[3],this[1],this[2],this[0])}get wyzy(){return new this._Vec4(this[3],this[1],this[2],this[1])}get wyzz(){return new this._Vec4(this[3],this[1],this[2],this[2])}get wyzw(){return new this._Vec4(this[3],this[1],this[2],this[3])}get wywx(){return new this._Vec4(this[3],this[1],this[3],this[0])}get wywy(){return new this._Vec4(this[3],this[1],this[3],this[1])}get wywz(){return new this._Vec4(this[3],this[1],this[3],this[2])}get wyww(){return new this._Vec4(this[3],this[1],this[3],this[3])}get wzxx(){return new this._Vec4(this[3],this[2],this[0],this[0])}get wzxy(){return new this._Vec4(this[3],this[2],this[0],this[1])}get wzxz(){return new this._Vec4(this[3],this[2],this[0],this[2])}get wzxw(){return new this._Vec4(this[3],this[2],this[0],this[3])}get wzyx(){return new this._Vec4(this[3],this[2],this[1],this[0])}get wzyy(){return new this._Vec4(this[3],this[2],this[1],this[1])}get wzyz(){return new this._Vec4(this[3],this[2],this[1],this[2])}get wzyw(){return new this._Vec4(this[3],this[2],this[1],this[3])}get wzzx(){return new this._Vec4(this[3],this[2],this[2],this[0])}get wzzy(){return new this._Vec4(this[3],this[2],this[2],this[1])}get wzzz(){return new this._Vec4(this[3],this[2],this[2],this[2])}get wzzw(){return new this._Vec4(this[3],this[2],this[2],this[3])}get wzwx(){return new this._Vec4(this[3],this[2],this[3],this[0])}get wzwy(){return new this._Vec4(this[3],this[2],this[3],this[1])}get wzwz(){return new this._Vec4(this[3],this[2],this[3],this[2])}get wzww(){return new this._Vec4(this[3],this[2],this[3],this[3])}get wwxx(){return new this._Vec4(this[3],this[3],this[0],this[0])}get wwxy(){return new this._Vec4(this[3],this[3],this[0],this[1])}get wwxz(){return new this._Vec4(this[3],this[3],this[0],this[2])}get wwxw(){return new this._Vec4(this[3],this[3],this[0],this[3])}get wwyx(){return new this._Vec4(this[3],this[3],this[1],this[0])}get wwyy(){return new this._Vec4(this[3],this[3],this[1],this[1])}get wwyz(){return new this._Vec4(this[3],this[3],this[1],this[2])}get wwyw(){return new this._Vec4(this[3],this[3],this[1],this[3])}get wwzx(){return new this._Vec4(this[3],this[3],this[2],this[0])}get wwzy(){return new this._Vec4(this[3],this[3],this[2],this[1])}get wwzz(){return new this._Vec4(this[3],this[3],this[2],this[2])}get wwzw(){return new this._Vec4(this[3],this[3],this[2],this[3])}get wwwx(){return new this._Vec4(this[3],this[3],this[3],this[0])}get wwwy(){return new this._Vec4(this[3],this[3],this[3],this[1])}get wwwz(){return new this._Vec4(this[3],this[3],this[3],this[2])}get wwww(){return new this._Vec4(this[3],this[3],this[3],this[3])}},Qs=class extends ro{constructor(r,n){super(2);y(this,"e0");y(this,"e1");this.e0=this.castElement()(r),this.e1=this.castElement()(n??r)}get 0(){return this.e0}get 1(){return this.e1}set 0(r){this.e0=this.castElement()(r)}set 1(r){this.e1=this.castElement()(r)}get x(){return this[0]}get y(){return this[1]}set x(r){this[0]=this.castElement()(r)}set y(r){this[1]=this.castElement()(r)}},Js=class extends ro{constructor(r,n,s){super(3);y(this,"e0");y(this,"e1");y(this,"e2");this.e0=this.castElement()(r),this.e1=this.castElement()(n??r),this.e2=this.castElement()(s??r)}get 0(){return this.e0}get 1(){return this.e1}get 2(){return this.e2}set 0(r){this.e0=this.castElement()(r)}set 1(r){this.e1=this.castElement()(r)}set 2(r){this.e2=this.castElement()(r)}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(r){this[0]=this.castElement()(r)}set y(r){this[1]=this.castElement()(r)}set z(r){this[2]=this.castElement()(r)}},ea=class extends ro{constructor(r,n,s,a){super(4);y(this,"e0");y(this,"e1");y(this,"e2");y(this,"e3");this.e0=this.castElement()(r),this.e1=this.castElement()(n??r),this.e2=this.castElement()(s??r),this.e3=this.castElement()(a??r)}get 0(){return this.e0}get 1(){return this.e1}get 2(){return this.e2}get 3(){return this.e3}set 0(r){this.e0=this.castElement()(r)}set 1(r){this.e1=this.castElement()(r)}set 2(r){this.e2=this.castElement()(r)}set 3(r){this.e3=this.castElement()(r)}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}get w(){return this[3]}set x(r){this[0]=r}set y(r){this[1]=r}set z(r){this[2]=r}set w(r){this[3]=r}},no=class bc extends Qs{get[m](){return{elementSchema:v}}get kind(){return"vec2f"}get _Vec2(){return bc}get _Vec3(){return lo}get _Vec4(){return fo}},so=class Tc extends Qs{get[m](){return{elementSchema:je}}get kind(){return"vec2h"}get _Vec2(){return Tc}get _Vec3(){return uo}get _Vec4(){return mo}},ao=class $c extends Qs{get[m](){return{elementSchema:we}}get kind(){return"vec2i"}get _Vec2(){return $c}get _Vec3(){return co}get _Vec4(){return yo}},io=class _c extends Qs{get[m](){return{elementSchema:O}}get kind(){return"vec2u"}get _Vec2(){return _c}get _Vec3(){return ho}get _Vec4(){return go}},oo=class zc extends Qs{get[m](){return{elementSchema:Ue}}get kind(){return"vec2<bool>"}get _Vec2(){return zc}get _Vec3(){return po}get _Vec4(){return wo}},lo=class Sc extends Js{get[m](){return{elementSchema:v}}get kind(){return"vec3f"}get _Vec2(){return no}get _Vec3(){return Sc}get _Vec4(){return fo}},uo=class Mc extends Js{get[m](){return{elementSchema:je}}get kind(){return"vec3h"}get _Vec2(){return so}get _Vec3(){return Mc}get _Vec4(){return mo}},co=class kc extends Js{get[m](){return{elementSchema:we}}get kind(){return"vec3i"}get _Vec2(){return ao}get _Vec3(){return kc}get _Vec4(){return yo}},ho=class Pc extends Js{get[m](){return{elementSchema:O}}get kind(){return"vec3u"}get _Vec2(){return io}get _Vec3(){return Pc}get _Vec4(){return go}},po=class Bc extends Js{get[m](){return{elementSchema:Ue}}get kind(){return"vec3<bool>"}get _Vec2(){return oo}get _Vec3(){return Bc}get _Vec4(){return wo}},fo=class Ic extends ea{get[m](){return{elementSchema:v}}get kind(){return"vec4f"}get _Vec2(){return no}get _Vec3(){return lo}get _Vec4(){return Ic}},mo=class Ec extends ea{get[m](){return{elementSchema:je}}get kind(){return"vec4h"}get _Vec2(){return so}get _Vec3(){return uo}get _Vec4(){return Ec}},yo=class Uc extends ea{get[m](){return{elementSchema:we}}get kind(){return"vec4i"}get _Vec2(){return ao}get _Vec3(){return co}get _Vec4(){return Uc}},go=class Vc extends ea{get[m](){return{elementSchema:O}}get kind(){return"vec4u"}get _Vec2(){return io}get _Vec3(){return ho}get _Vec4(){return Vc}},wo=class Cc extends ea{get[m](){return{elementSchema:Ue}}get kind(){return"vec4<bool>"}get _Vec2(){return oo}get _Vec3(){return po}get _Vec4(){return Cc}},me=dt(no,v),cr=dt(so,je),st=dt(ao,we),kt=dt(io,O),dn=dt(oo,Ue),He=dt(lo,v),hr=dt(uo,je),It=dt(co,we),De=dt(ho,O),mn=dt(po,Ue),$=dt(fo,v),pr=dt(mo,je),$e=dt(yo,we),Se=dt(go,O),yn=dt(wo,Ue),Ca={vec2f:me,vec2h:cr,vec2i:st,vec2u:kt,"vec2<bool>":dn,vec3f:He,vec3h:hr,vec3i:It,vec3u:De,"vec3<bool>":mn,vec4f:$,vec4h:pr,vec4i:$e,vec4u:Se,"vec4<bool>":yn};function dt(e,t){let{kind:r,length:n}=new e,s=k({name:r,signature:(...i)=>({argTypes:i.map(o=>{let l=Or(o);return zr(l)?l:t}),returnType:a}),normalImpl:(...i)=>{let o=new Array(i.length),l=0;for(let u of i)if(typeof u=="number"||typeof u=="boolean")o[l++]=u;else for(let c=0;c<u.length;++c)o[l++]=u[c];if(o.length<=1||o.length===n)return new e(...o);throw new Error(`'${r}' constructor called with invalid number of arguments.`)},ignoreImplicitCastWarning:!0,codegenImpl:(...i)=>x`${r}(${i})`}),a=Object.assign(s,{type:r,primitive:t,[os]:void 0});return a}var Lr={uint8:O,uint8x2:kt,uint8x4:Se,sint8:we,sint8x2:st,sint8x4:$e,unorm8:v,unorm8x2:me,unorm8x4:$,snorm8:v,snorm8x2:me,snorm8x4:$,uint16:O,uint16x2:kt,uint16x4:Se,sint16:we,sint16x2:st,sint16x4:$e,unorm16:v,unorm16x2:me,unorm16x4:$,snorm16:v,snorm16x2:me,snorm16x4:$,float16:v,float16x2:me,float16x4:$,float32:v,float32x2:me,float32x3:He,float32x4:$,uint32:O,uint32x2:kt,uint32x3:De,uint32x4:Se,sint32:we,sint32x2:st,sint32x3:It,sint32x4:$e,"unorm10-10-10-2":$,"unorm8x4-bgra":$},Rc=new Set(Object.keys(Lr));function Zf(e){return ye(e)&&Rc.has(e==null?void 0:e.type)}function Os(e){let t=String(e);if(t!=="[object Object]")return t;try{return JSON.stringify(e)}catch(r){return console.error("Error parsing JSON:",r),"<invalid json>"}}function Mi(e){return Me(e)||or(e)?e.toString():Array.isArray(e)?`[${e.map(Mi).join(", ")}]`:e&&typeof e=="object"?`{ ${Object.entries(e).map(([t,r])=>`${t}: ${Mi(r)}`).join(", ")} }`:String(e)}var Xf={f32:4,f16:2,i32:4,u32:4,bool:4,u16:2,vec2f:8,vec2h:4,vec2i:8,vec2u:8,vec2b:8,vec3f:16,vec3h:8,vec3i:16,vec3u:16,vec3b:16,vec4f:16,vec4h:8,vec4i:16,vec4u:16,vec4b:16,mat2x2f:8,mat3x3f:16,mat4x4f:16,atomic:4};function Hf(e){let t=e==null?void 0:e.type,r=Xf[t];if(r!==void 0)return r;if(pt(e))return Object.values(e.propTypes).map(Re).reduce((n,s)=>n>s?n:s);if(Xt(e))return Re(e.elementType);if(Gr(e)){let n=Object.values(e.propTypes)[0];return n?Ps(n)??1:1}if(ls(e))return Ps(e.elementType)??1;if(pn(e)||fn(e))return Ps(e)??Re(e.inner);if(Rc.has(t))return 1;throw new Error(`Cannot determine alignment of data: ${Os(e)}`)}function Kf(e){if(Gr(e)){let t=Object.values(e.propTypes)[0];return t?Dt(t):1}return ls(e)?Dt(e.elementType):fn(e)?Ps(e)??Dt(e.inner):Ps(e)??1}var Yo=new WeakMap,Zo=new WeakMap;function Re(e){let t=Yo.get(e);return t===void 0&&(t=Hf(e),Yo.set(e,t)),t}function Dt(e){let t=Zo.get(e);return t===void 0&&(t=Kf(e),Zo.set(e,t)),t}var Pt=(e,t)=>{let r=t-1,n=~r;return e&r?(e&n)+t:e},Qf={bool:4,f32:4,f16:2,i32:4,u32:4,u16:2,vec2f:8,vec2h:4,vec2i:8,vec2u:8,"vec2<bool>":8,vec3f:12,vec3h:6,vec3i:12,vec3u:12,"vec3<bool>":12,vec4f:16,vec4h:8,vec4i:16,vec4u:16,"vec4<bool>":16,mat2x2f:16,mat3x3f:48,mat4x4f:64,uint8:1,uint8x2:2,uint8x4:4,sint8:1,sint8x2:2,sint8x4:4,unorm8:1,unorm8x2:2,unorm8x4:4,snorm8:1,snorm8x2:2,snorm8x4:4,uint16:2,uint16x2:4,uint16x4:8,sint16:2,sint16x2:4,sint16x4:8,unorm16:2,unorm16x2:4,unorm16x4:8,snorm16:2,snorm16x2:4,snorm16x4:8,float16:2,float16x2:4,float16x4:8,float32:4,float32x2:8,float32x3:12,float32x4:16,uint32:4,uint32x2:8,uint32x3:12,uint32x4:16,sint32:4,sint32x2:8,sint32x3:12,sint32x4:16,"unorm10-10-10-2":4,"unorm8x4-bgra":4,atomic:4};function Jf(e){let t=0,r=e.propTypes;for(let n of Object.values(r)){if(Number.isNaN(t))throw new Error("Only the last property of a struct can be unbounded");if(t=Pt(t,Re(n)),t+=le(n),Number.isNaN(t)&&n.type!=="array")throw new Error("Cannot nest unbounded struct within another struct")}return Pt(t,Re(e))}function ed(e){let t=0,r=e.propTypes;for(let n of Object.values(r)){let s=Dt(n);t=Pt(t,s),t+=le(n)}return t}function td(e){let t=Qf[e==null?void 0:e.type];if(t!==void 0)return t;if(pt(e))return Jf(e);if(Gr(e))return ed(e);if(Xt(e)){if(e.elementCount===0)return Number.NaN;let r=Re(e.elementType);return Pt(le(e.elementType),r)*e.elementCount}if(ls(e)){let r=Dt(e.elementType);return Pt(le(e.elementType),r)*e.elementCount}if(pn(e)||fn(e))return _f(e)??le(e.inner);throw new Error(`Cannot determine size of data: ${e}`)}var Xo=new WeakMap;function le(e){let t=Xo.get(e);return t===void 0&&(t=td(e),Xo.set(e,t)),t}function rd(e){return le(e)}function Ac(e,t){return pn(e)?new Ho(e.inner,[t,...e.attribs]):fn(e)?new Ko(e.inner,[t,...e.attribs]):Ks(e)?new Ko(e,[t]):new Ho(e,[t])}function lr(e,t){return Ac(t,{[m]:!0,type:"@location",params:[e]})}function ta(e){return(pn(e)||fn(e))&&e.attribs.find(xf)!==void 0}function vo(e){return!pn(e)&&!fn(e)?"":e.attribs.map(t=>t.params.length===0?`${t.type} `:`${t.type}(${t.params.join(", ")}) `).join("")}var Bl,Oc=(Bl=m,class{constructor(t,r){y(this,Bl,!0);var a,i;this.inner=t,this.attribs=r;let n=(a=r.find(tc))==null?void 0:a.params[0],s=(i=r.find(rc))==null?void 0:i.params[0];if(n!==void 0){if(n<=0)throw new Error(`Custom data alignment must be a positive number, got: ${n}.`);if(Math.log2(n)%1!==0)throw new Error(`Alignment has to be a power of 2, got: ${n}.`);if(hn(this.inner)&&n%Re(this.inner)!==0)throw new Error(`Custom alignment has to be a multiple of the standard data alignment. Got: ${n}, expected multiple of: ${Re(this.inner)}.`)}if(s!==void 0){if(s<le(this.inner))throw new Error(`Custom data size cannot be smaller then the standard data size. Got: ${s}, expected at least: ${le(this.inner)}.`);if(s<=0)throw new Error(`Custom data size must be a positive number. Got: ${s}.`)}}}),Il,El,Ho=class extends(El=Oc,Il=m,El){constructor(){super(...arguments);y(this,Il,!0);y(this,"type","decorated")}},Ul,Vl,Ko=class extends(Vl=Oc,Ul=m,Vl){constructor(){super(...arguments);y(this,Ul,!0);y(this,"type","loose-decorated")}};function Fs(e,t){let r=e==null?void 0:e.type,n=r in Lr?Lr[r]:e;return typeof n!="function"?t:t===void 0?n():n(t)}function ra(e){return Fc(e,!1)}function Qe(e){return Fc(e,!0)}function Fc(e,t){let r=n=>Object.fromEntries(Object.entries(e).map(([s,a])=>[s,Fs(a,n==null?void 0:n[s])]));return Object.setPrototypeOf(r,nd),r.propTypes=e,Object.defineProperty(r,m,{value:{isAbstruct:t}}),r}var nd={type:"struct",$name(e){return ve(this,e),this},toString(){return`struct:${U(this)??"<unnamed>"}`}},Ls=et((e,t)=>t===void 0?r=>ui(e,r):ui(e,t),(e,t)=>{if((t==null?void 0:t.value)===void 0){let r=n=>Ls[m].gpuImpl(e,n);return r[m]=!0,_(r,ht)}if(typeof t.value!="number")throw new Error(`Cannot create array schema with count unknown at compile-time: '${t.value}'`);return _(ui(e.value,t.value),e.value)},"arrayOf");function ui(e,t){let r=n=>{if(n&&n.length!==t)throw new Error(`Array schema of ${t} elements of type ${e.type} called with ${n.length} argument(s).`);return Array.from({length:t},(s,a)=>Fs(e,n==null?void 0:n[a]))};if(Object.setPrototypeOf(r,sd),Number.isNaN(le(e)))throw new Error("Cannot nest runtime sized arrays.");if(r.elementType=e,!Number.isInteger(t)||t<0)throw new Error(`Cannot create array schema with invalid element count: ${t}.`);return r.elementCount=t,r}var sd={[m]:!0,type:"array",toString(){return`arrayOf(${this.elementType}, ${this.elementCount})`}};function ut(e,t){return Ac(e,{[m]:!0,type:"@builtin",params:[t]})}var Lc={vertexIndex:ut(O,"vertex_index"),instanceIndex:ut(O,"instance_index"),position:ut($,"position"),clipDistances:ut(Ls(O,8),"clip_distances"),frontFacing:ut(Ue,"front_facing"),fragDepth:ut(v,"frag_depth"),sampleIndex:ut(O,"sample_index"),sampleMask:ut(O,"sample_mask"),localInvocationId:ut(De,"local_invocation_id"),localInvocationIndex:ut(O,"local_invocation_index"),globalInvocationId:ut(De,"global_invocation_id"),workgroupId:ut(De,"workgroup_id"),numWorkgroups:ut(De,"num_workgroups"),subgroupInvocationId:ut(O,"subgroup_invocation_id"),subgroupSize:ut(O,"subgroup_size")},ad={block:0,binaryExpr:1,assignmentExpr:2,logicalExpr:3,unaryExpr:4,numericLiteral:5,call:6,memberAccess:7,indexAccess:8,return:10,if:11,let:12,const:13,for:14,while:15,continue:16,break:17,arrayExpr:100,preUpdate:101,postUpdate:102,stringLiteral:103,objectExpr:104},ki={identifier:"i",destructuredObject:"d"},id=1;const od=Object.freeze(Object.defineProperty({__proto__:null,FORMAT_VERSION:id,FuncParameterType:ki,NodeTypeCatalog:ad},Symbol.toStringTag,{value:"Module"}));function Is(e,t){for(let[r,n]of Object.entries(t))e[r]=n,n&&(typeof n=="object"||typeof n=="function")&&U(n)===void 0&&ve(n,r)}function ld(e,t,r){let n=[...e.matchAll(/:\s*(?<arg>.*?)\s*[,)]/g)].map(s=>s?s[1]:void 0);r(Object.fromEntries(t.flatMap((s,a)=>{let i=n?n[a]:void 0;return pt(s)&&i!==void 0?[[i,s]]:[]})))}function Gc(e,t,r){var a;let n=e.match(/->\s(?<output>[\w\d_]+)\s{/),s=n?(a=n[1])==null?void 0:a.trim():void 0;pt(t)&&s&&!/\s/g.test(s)&&r({[s]:t})}function ud(e){return new RegExp(`(?<![\\w\\$_.])${e.replaceAll(".","\\.").replaceAll("$","\\$")}(?![\\w\\$_])`,"g")}function Xa(e,t,r){return Object.entries(t).reduce((n,[s,a])=>{let i=ud(s);if(r&&s!=="Out"&&s!=="In"&&!i.test(r)&&console.warn(`The external '${s}' wasn't used in the resolved template.`),If(a)||Ks(a)||ks(a))return n.replaceAll(i,e.resolve(a).value);if(a!==null&&typeof a=="object"){let o=[...r.matchAll(new RegExp(`${s.replaceAll(".","\\.").replaceAll("$","\\$")}\\.(?<prop>.*?)(?![\\w\\$_])`,"g"))].map(l=>l[1]);return[...new Set(o)].reduce((l,u)=>u&&u in a?Xa(e,{[`${s}.${u}`]:a[u]},l):l,n)}return console.warn(`During resolution, the external '${s}' has been omitted. Only primitives, TGPU resources and plain JS objects can be used as externals.`),n},r)}function cd(e){let{strippedCode:t,argRange:r}=hd(e),n=new Dc(t);n.consume("(");let s=[];for(;!n.isAt(")");){let i=[];for(;n.isAt("@");)n.parseUntil(Qo,Jo),n.consume(")"),i.push(n.lastParsed);n.parseUntil(fd);let o=n.lastParsed,l;n.isAt(":")&&(n.consume(":"),n.parseUntil(dd,yd),l=n.lastParsed),s.push({identifier:o,attributes:i,type:l}),n.isAt(",")&&n.consume(",")}n.consume(")");let a;if(n.isAt("->")){n.consume("->");let i=[];for(;n.isAt("@");)n.parseUntil(Qo,Jo),n.consume(")"),i.push(n.lastParsed);a={type:n.str.slice(n.pos),attributes:i}}return{args:s,ret:a,range:{begin:r[0],end:r[1]}}}function hd(e){let t=new Dc(e),r="",n;for(;!t.isFinished();){if(t.isAt(pd)){t.advanceBy(1);continue}if(t.isAt("//")){t.consume("//"),t.parseUntil(jc),t.advanceBy(1);continue}if(t.isAt("/*")){t.parseUntil(md,gd),t.consume("*/");continue}if(t.isAt("{"))return{strippedCode:r,argRange:[n,t.pos]};t.isAt("(")&&n===void 0&&(n=t.pos),n!==void 0&&(r+=t.str[t.pos]),t.advanceBy(1)}throw new Error("Invalid wgsl code!")}var jn,ct,Cl,Dc=(Cl=class{constructor(t){Y(this,jn);Y(this,ct);this.str=t,q(this,ct,0)}get pos(){return w(this,ct)}get lastParsed(){if(w(this,jn)===void 0)throw new Error("Parse was not called yet!");return this.str.slice(w(this,jn),this.pos)}isFinished(){return w(this,ct)>=this.str.length}isAt(t){if(typeof t=="string"){for(let r=0;r<t.length;r++)if(this.str[w(this,ct)+r]!==t[r])return!1;return!0}for(let r of t)if(this.isAt(r))return!0;return!1}parseUntil(t,r){q(this,jn,w(this,ct));let n=0;for(;w(this,ct)<this.str.length;){if(r&&this.isAt(r[0])&&(n+=1),r&&this.isAt(r[1])&&(n-=1),n===0&&this.isAt(t))return w(this,ct);q(this,ct,w(this,ct)+1)}throw new Error("Reached the end of the string without finding a match!")}advanceBy(t){q(this,ct,w(this,ct)+t)}consume(t){if(!this.isAt(t))throw new Error(`Expected '${t}' at position ${w(this,ct)}, but found '${this.str.slice(w(this,ct),w(this,ct)+t.length)}'`);this.advanceBy(t.length)}},jn=new WeakMap,ct=new WeakMap,Cl),jc=new Set([`
`,"\v","\f","\r","","\u2028","\u2029"]),pd=new Set([...jc," ","	","",""]),Qo=new Set([")"]),fd=new Set([":",",",")"]),dd=new Set([",",")"]),md=new Set(["*/"]),Jo=["(",")"],yd=["<",">"],gd=["/*","*/"];function na(e,t=""){let r=[],n={applyExternals(a){r.push(a)},resolve(a,i,o){var ne;let l={};for(let X of r)Is(l,X);let u=a.getUniqueName(this);if(typeof e=="string"){if(!o)throw new Error("Explicit return type is required for string implementation");let X=Xa(a,l,e),j="",V="";if(t!==""){let G=pt(i[0])?`(in: ${a.resolve(i[0]).value})`:"()",N=hn(o)?vo(o):"",Q=o!==xt?pt(o)?`-> ${a.resolve(o).value}`:`-> ${N!==""?N:"@location(0)"} ${a.resolve(o).value}`:"";j=`${G} ${Q} `,V=X}else{let G=cd(X);if(G.args.length!==i.length)throw new Error(`WGSL implementation has ${G.args.length} arguments, while the shell has ${i.length} arguments.`);let N=G.args.map((ue,pe)=>`${ue.identifier}: ${el(a,`parameter ${ue.identifier}`,ue.type,i[pe])}`).join(", "),Q=o===xt?"":`-> ${el(a,"return type",(ne=G.ret)==null?void 0:ne.type,o)}`;j=`(${N}) ${Q}`,V=X.slice(G.range.end)}return a.addDeclaration(`${t}fn ${u}${j}${V}`),_(u,o)}let c=Wa(e);if(c!=null&&c.externals){let X=Object.fromEntries(Object.entries(c.externals).filter(([j])=>!(j in l)));Is(l,X)}let h=c==null?void 0:c.ast;if(!h)throw new Error("Missing metadata for tgpu.fn function body (either missing 'use gpu' directive, or misconfigured `unplugin-typegpu`)");let f=h.externalNames.filter(X=>!(X in l));if(f.length>0)throw new kf(U(this),f);let d=h.params[1];d&&d.type==="i"&&t!==""&&Is(l,{[d.name]:Or(o)});let p=[],g=[];for(let[X,j]of i.entries()){let V=h.params[X];switch(V==null?void 0:V.type){case ki.identifier:{let G=V.name,N=_(a.makeNameValid(G),j);p.push(N),N.value!==G&&g.push([G,N]);break}case ki.destructuredObject:{p.push(_(`_arg_${X}`,j)),g.push(...V.props.map(({name:G,alias:N})=>[N,_(`_arg_${X}.${G}`,i[X].propTypes[G])]));break}case void 0:p.push(_(`_arg_${X}`,j))}}let{head:z,body:M,returnType:A}=a.fnToWgsl({args:p,argAliases:Object.fromEntries(g),returnType:o,body:h.body,externalMap:l});return a.addDeclaration(`${t}fn ${u}${a.resolve(z).value}${a.resolve(M).value}`),_(u,A)}},s=U(e);return s!==void 0&&ve(n,s),n}function el(e,t,r,n){let s=e.resolve(n).value.replace(/\s/g,"");if(!r)return s;let a=r.replace(/\s/g,"");if(a!==s)throw new Error(`Type mismatch between TGPU shell and WGSL code string: ${t}, JS type "${s}", WGSL type "${a}".`);return r}function wd(e,t={}){let r=0,n=new Set;return Object.fromEntries(Object.entries(e??{}).map(([s,a])=>{let i=Fr(a);if(i!==void 0){if(n.has(i))throw new Error("Duplicate custom location attributes found");n.add(i)}return[s,a]}).map(([s,a])=>{if(ta(a))return[s,a];if(Fr(a)!==void 0)return[s,a];if(t[s])return[s,lr(t[s],a)];for(;n.has(r);)r++;return[s,lr(r++,a)]}))}function sa(e,t={}){return us(e)?nc(e)||Fr(e)!==void 0?e:lr(0,e):ra(wd(e,t))}function Ha(e,...t){return vd(e)?xd(e,...t):e}function vd(e){return Array.isArray(e)&&"raw"in e&&Array.isArray(e.raw)&&e.raw.every(t=>typeof t=="string")}function xd(e,...t){return e.slice(1).reduce((r,n,s)=>`${r}${t[s]}${n}`,e[0])}function bd(e){if(Object.keys(e.out).length===0)throw new Error("A vertexFn output cannot be empty since it must include the 'position' builtin.");let t={in:e.in,out:e.out,argTypes:e.in&&Object.keys(e.in).length!==0?[sa(e.in)]:[],isEntry:!0},r=(n,...s)=>Td(t,Ha(n,...s));return Object.assign(Object.assign(r,t),{does:r})}function Td(e,t){let r=na(t,"@vertex "),n=e.argTypes[0];return{shell:e,$uses(s){return r.applyExternals(s),this},[m]:!0,[Ae]:r,$name(s){return ve(r,s),qa(n)&&n.$name(`${s}_Input`),this},[H](s){let a=sa(e.out,s.varyingLocations).$name(`${U(this)??""}_Output`);return typeof t=="string"&&(n&&r.applyExternals({In:n}),r.applyExternals({Out:a})),r.resolve(s,e.argTypes,a)},toString(){return`vertexFn:${U(r)??"<unnamed>"}`}}}var xo=class{};function bo(e){let t=et((...n)=>{let s=[];for(let a of n)if(typeof a=="number")s.push(a);else for(let i=0;i<a.length;++i)s.push(a[i]);if(s.length!==0&&s.length!==e.columns*e.rows)throw new Error(`'${e.type}' constructor called with invalid number of arguments.`);for(let a=s.length;a<e.columns*e.rows;++a)s.push(0);return new e.MatImpl(...s)},(...n)=>_(x`${e.type}(${n})`,r),e.type),r=Object.assign(t,{type:e.type,identity:Ed[e.columns],translation:e.columns===4?Ud:void 0,scaling:e.columns===4?Vd:void 0,rotationX:e.columns===4?Cd:void 0,rotationY:e.columns===4?Rd:void 0,rotationZ:e.columns===4?Ad:void 0});return r}var Rl,$d=class extends xo{constructor(...r){super();y(this,Rl,!0);y(this,"columns");y(this,"length",4);this.columns=[this.makeColumn(r[0],r[1]),this.makeColumn(r[2],r[3])]}get 0(){return this.columns[0].x}get 1(){return this.columns[0].y}get 2(){return this.columns[1].x}get 3(){return this.columns[1].y}set 0(r){this.columns[0].x=r}set 1(r){this.columns[0].y=r}set 2(r){this.columns[1].x=r}set 3(r){this.columns[1].y=r}*[(Rl=m,Symbol.iterator)](){yield this[0],yield this[1],yield this[2],yield this[3]}[H](){return _(`${this.kind}(${Array.from({length:this.length}).map((r,n)=>this[n]).join(", ")})`,fr)}toString(){return this[H]().value}},_d=class extends $d{constructor(){super(...arguments);y(this,"kind","mat2x2f")}makeColumn(r,n){return me(r,n)}},Al,zd=class extends xo{constructor(...t){super();y(this,Al,!0);y(this,"columns");y(this,"length",12);this.columns=[this.makeColumn(t[0],t[1],t[2]),this.makeColumn(t[3],t[4],t[5]),this.makeColumn(t[6],t[7],t[8])]}get 0(){return this.columns[0].x}get 1(){return this.columns[0].y}get 2(){return this.columns[0].z}get 3(){return 0}get 4(){return this.columns[1].x}get 5(){return this.columns[1].y}get 6(){return this.columns[1].z}get 7(){return 0}get 8(){return this.columns[2].x}get 9(){return this.columns[2].y}get 10(){return this.columns[2].z}get 11(){return 0}set 0(t){this.columns[0].x=t}set 1(t){this.columns[0].y=t}set 2(t){this.columns[0].z=t}set 3(t){}set 4(t){this.columns[1].x=t}set 5(t){this.columns[1].y=t}set 6(t){this.columns[1].z=t}set 7(t){}set 8(t){this.columns[2].x=t}set 9(t){this.columns[2].y=t}set 10(t){this.columns[2].z=t}set 11(t){}*[(Al=m,Symbol.iterator)](){for(let t=0;t<12;t++)yield this[t]}[H](){return _(`${this.kind}(${this[0]}, ${this[1]}, ${this[2]}, ${this[4]}, ${this[5]}, ${this[6]}, ${this[8]}, ${this[9]}, ${this[10]})`,dr)}toString(){return this[H]().value}},Sd=class extends zd{constructor(){super(...arguments);y(this,"kind","mat3x3f")}makeColumn(t,r,n){return He(t,r,n)}},Ol,Md=class extends xo{constructor(...t){super();y(this,Ol,!0);y(this,"columns");y(this,"length",16);this.columns=[this.makeColumn(t[0],t[1],t[2],t[3]),this.makeColumn(t[4],t[5],t[6],t[7]),this.makeColumn(t[8],t[9],t[10],t[11]),this.makeColumn(t[12],t[13],t[14],t[15])]}get 0(){return this.columns[0].x}get 1(){return this.columns[0].y}get 2(){return this.columns[0].z}get 3(){return this.columns[0].w}get 4(){return this.columns[1].x}get 5(){return this.columns[1].y}get 6(){return this.columns[1].z}get 7(){return this.columns[1].w}get 8(){return this.columns[2].x}get 9(){return this.columns[2].y}get 10(){return this.columns[2].z}get 11(){return this.columns[2].w}get 12(){return this.columns[3].x}get 13(){return this.columns[3].y}get 14(){return this.columns[3].z}get 15(){return this.columns[3].w}set 0(t){this.columns[0].x=t}set 1(t){this.columns[0].y=t}set 2(t){this.columns[0].z=t}set 3(t){this.columns[0].w=t}set 4(t){this.columns[1].x=t}set 5(t){this.columns[1].y=t}set 6(t){this.columns[1].z=t}set 7(t){this.columns[1].w=t}set 8(t){this.columns[2].x=t}set 9(t){this.columns[2].y=t}set 10(t){this.columns[2].z=t}set 11(t){this.columns[2].w=t}set 12(t){this.columns[3].x=t}set 13(t){this.columns[3].y=t}set 14(t){this.columns[3].z=t}set 15(t){this.columns[3].w=t}*[(Ol=m,Symbol.iterator)](){for(let t=0;t<16;t++)yield this[t]}[H](){return _(`${this.kind}(${Array.from({length:this.length}).map((t,r)=>this[r]).join(", ")})`,Ne)}toString(){return this[H]().value}},kd=class extends Md{constructor(){super(...arguments);y(this,"kind","mat4x4f")}makeColumn(r,n,s,a){return $(r,n,s,a)}},Pd=et(()=>fr(1,0,0,1),()=>_("mat2x2f(1, 0, 0, 1)",fr),"identity2"),Bd=et(()=>dr(1,0,0,0,1,0,0,0,1),()=>_("mat3x3f(1, 0, 0, 0, 1, 0, 0, 0, 1)",dr),"identity3"),Id=et(()=>Ne(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),()=>_("mat4x4f(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)",Ne),"identity4"),Ed={2:Pd,3:Bd,4:Id},Ud=et(e=>Ne(1,0,0,0,0,1,0,0,0,0,1,0,e.x,e.y,e.z,1),e=>_(x`mat4x4f(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, ${e}.x, ${e}.y, ${e}.z, 1)`,Ne),"translation4"),Vd=et(e=>Ne(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1),e=>_(x`mat4x4f(${e}.x, 0, 0, 0, 0, ${e}.y, 0, 0, 0, 0, ${e}.z, 0, 0, 0, 0, 1)`,Ne),"scaling4"),Cd=et(e=>Ne(1,0,0,0,0,Math.cos(e),Math.sin(e),0,0,-Math.sin(e),Math.cos(e),0,0,0,0,1),e=>_(x`mat4x4f(1, 0, 0, 0, 0, cos(${e}), sin(${e}), 0, 0, -sin(${e}), cos(${e}), 0, 0, 0, 0, 1)`,Ne),"rotationX4"),Rd=et(e=>Ne(Math.cos(e),0,-Math.sin(e),0,0,1,0,0,Math.sin(e),0,Math.cos(e),0,0,0,0,1),e=>_(x`mat4x4f(cos(${e}), 0, -sin(${e}), 0, 0, 1, 0, 0, sin(${e}), 0, cos(${e}), 0, 0, 0, 0, 1)`,Ne),"rotationY4"),Ad=et(e=>Ne(Math.cos(e),Math.sin(e),0,0,-Math.sin(e),Math.cos(e),0,0,0,0,1,0,0,0,0,1),e=>_(x`mat4x4f(cos(${e}), sin(${e}), 0, 0, -sin(${e}), cos(${e}), 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)`,Ne),"rotationZ4"),fr=bo({type:"mat2x2f",rows:2,columns:2,MatImpl:_d}),dr=bo({type:"mat3x3f",rows:3,columns:3,MatImpl:Sd}),Ne=bo({type:"mat4x4f",rows:4,columns:4,MatImpl:kd});function Od(e){return e==null?void 0:e[ge]}var Fd={f:{1:v,2:me,3:He,4:$},h:{1:je,2:cr,3:hr,4:pr},i:{1:we,2:st,3:It,4:$e},u:{1:O,2:kt,3:De,4:Se},b:{1:Ue,2:dn,3:mn,4:yn}},Ld={vec2f:me,vec2h:cr,vec2i:st,vec2u:kt,"vec2<bool>":dn,vec3f:He,vec3h:hr,vec3i:It,vec3u:De,"vec3<bool>":mn,vec4f:$,vec4h:pr,vec4i:$e,vec4u:Se,"vec4<bool>":yn,mat2x2f:fr,mat3x3f:dr,mat4x4f:Ne};function Pi(e,t){if(pt(e)||Gr(e))return e.propTypes[t]??ht;if(e===Ue||Sr(e))return ht;let r=t.length;if(zr(e)&&r>=1&&r<=4){let n=e.type.includes("bool")?"b":e.type[4],s=Fd[n][r];if(s)return s}return ht}var tl={mat2x2f:me,mat3x3f:He,mat4x4f:$};function ci(e){return Xt(e)||ls(e)?e.elementType:zr(e)?e.primitive:e.type in tl?tl[e.type]:ht}function Ra(e){return e>=2**63||e<-9223372036854776e3?_(e,Ht):Number.isInteger(e)?(Number.isSafeInteger(e)||console.warn(`The integer ${e} exceeds the safe integer range and may have lost precision.`),_(e,Za)):_(e,Ht)}function Gs(e){return e.type==="abstractFloat"?v:e.type==="abstractInt"?we:e}function Gd(e){return e.map(t=>_(t.value,Gs(t.dataType)))}function _a(e){return Qi(e)?e:Ji(e)||(Me(e)||or(e)?_(e,Ld[e.kind]):typeof e=="string"||typeof e=="function"||typeof e=="object"||typeof e=="symbol"||typeof e>"u"||e===null?_(e,ht):typeof e=="number"?Ra(e):typeof e=="boolean"?_(e,Ue):_(e,ht))}var Kt={get(e,t){if(t in e)return Reflect.get(e,t);if(t==="toString"||t===Symbol.toStringTag||t===Symbol.toPrimitive)return()=>e.toString();if(typeof t=="symbol")return;let r=Ji(e).dataType,n=Pi(r,String(t));if(n.type!=="unknown")return new Proxy({[m]:!0,[H]:s=>_(`${s.resolve(e).value}.${String(t)}`,n),get[bt](){return _(this,n)},toString:()=>`${String(e)}.${t}`},Kt)}};function Ka(e){let t=e;for(;;){let r=Od(t);if(!r)break;t=r}return t}function Bi(e,t){return new Dd(e,t)}var Fl,Nn,Ll,Dd=(Ll=class{constructor(e,t){y(this,Fl,{});Y(this,Nn);this.dataType=e,q(this,Nn,t)}$name(e){return ve(this,e),this}[(Fl=m,H)](e){let t=e.getUniqueName(this),r=e.resolve(this.dataType).value,n=e.resolve(w(this,Nn),this.dataType).value;return e.addDeclaration(`const ${t}: ${r} = ${n};`),_(t,this.dataType)}toString(){return`const:${U(this)??"<unnamed>"}`}get[ge](){let e=this.dataType;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`const:${U(this)??"<unnamed>"}.$`},Kt)}get value(){return yr()?this[ge]:w(this,Nn)}get $(){return this.value}},Nn=new WeakMap,Ll);function Nc(){return{[m]:!0,type:"sampler",[os]:void 0}}function qc(){return{[m]:!0,type:"sampler_comparison",[os]:void 0}}function jd(e){return!!e[m]&&e.type==="sampler"}function Nd(e){return!!e[m]&&e.type==="sampler_comparison"}function Ii(e){if("multisampled"in e){if(e.multisampled){if(e.dimension==="2d")return Yd(e.sampleType);throw new Error(`Multisampled textures only support '2d' dimension, got '${e.dimension}'`)}switch(e.dimension){case"1d":return qd(e.sampleType);case"2d":return Wd(e.sampleType);case"2d-array":return Zd(e.sampleType);case"3d":return Kd(e.sampleType);case"cube":return Xd(e.sampleType);case"cube-array":return Hd(e.sampleType);default:throw new Error(`Unsupported texture dimension: '${e.dimension}'`)}}if(!("access"in e))throw new Error("Descriptor is neither a sampled nor a storage texture");switch(e.dimension){case"1d":return Qd(e.format,e.access);case"2d":return Jd(e.format,e.access);case"2d-array":return em(e.format,e.access);case"3d":return tm(e.format,e.access);default:throw new Error(`Unsupported storage texture dimension: '${e.dimension}'`)}}function gn(e,t){let r=e.startsWith("texture_depth")?["depth","float","unfilterable-float"]:t.sampleType.type==="i32"?["sint"]:t.sampleType.type==="u32"?["uint"]:["float","unfilterable-float"];return{[m]:!0,[os]:void 0,type:e,bindingSampleType:r,...t}}function Qa(e,t){return{[m]:!0,[os]:void 0,type:e,...t}}var rl=new Map,aa={"write-only":"write","read-only":"read","read-write":"read_write"};function jt(e,t){let r=rl.get(e);return r||(r=t(),rl.set(e,r)),r}function qd(e){let t=e||v,r=`texture_1d<${t.type}>`;return jt(r,()=>gn("texture_1d",{dimension:"1d",sampleType:t,multisampled:!1}))}function Wd(e){let t=e||v,r=`texture_2d<${t.type}>`;return jt(r,()=>gn("texture_2d",{dimension:"2d",sampleType:t,multisampled:!1}))}function Yd(e){let t=e||v,r=`texture_multisampled_2d<${t.type}>`;return jt(r,()=>gn("texture_multisampled_2d",{dimension:"2d",sampleType:t,multisampled:!0}))}function Zd(e){let t=e||v,r=`texture_2d_array<${t.type}>`;return jt(r,()=>gn("texture_2d_array",{dimension:"2d-array",sampleType:t,multisampled:!1}))}function Xd(e){let t=e||v,r=`texture_cube<${t.type}>`;return jt(r,()=>gn("texture_cube",{dimension:"cube",sampleType:t,multisampled:!1}))}function Hd(e){let t=e||v,r=`texture_cube_array<${t.type}>`;return jt(r,()=>gn("texture_cube_array",{dimension:"cube-array",sampleType:t,multisampled:!1}))}function Kd(e){let t=e||v,r=`texture_3d<${t.type}>`;return jt(r,()=>gn("texture_3d",{dimension:"3d",sampleType:t,multisampled:!1}))}function Qd(e,t){let r=t||"write-only",n=`texture_storage_1d<${e}, ${aa[r]}>`;return jt(n,()=>Qa("texture_storage_1d",{dimension:"1d",format:e,access:r}))}function Jd(e,t){let r=t||"write-only",n=`texture_storage_2d<${e}, ${aa[r]}>`;return jt(n,()=>Qa("texture_storage_2d",{dimension:"2d",format:e,access:r}))}function em(e,t){let r=t||"write-only",n=`texture_storage_2d_array<${e}, ${aa[r]}>`;return jt(n,()=>Qa("texture_storage_2d_array",{dimension:"2d-array",format:e,access:r}))}function tm(e,t){let r=t||"write-only",n=`texture_storage_3d<${e}, ${aa[r]}>`;return jt(n,()=>Qa("texture_storage_3d",{dimension:"3d",format:e,access:r}))}function rm(){return jt("texture_external",()=>({[m]:!0,[os]:void 0,type:"texture_external",dimension:"2d"}))}function nm(e){return!!e[m]&&typeof e.multisampled=="boolean"}function Ei(e){return!!e[m]&&typeof e.format=="string"&&typeof e.access=="string"}function sm(e){return new am(e)}var Gl,am=(Gl=m,class{constructor(e){y(this,Gl,!0);y(this,"type","atomic");this.inner=e}}),Yr=(e,t,r)=>{if(e===t)return 0;let n=se((r-e)/(t-e),0,1);return n*n*(3-2*n)},se=(e,t,r)=>Math.min(Math.max(t,e),r),Tn=(e,t)=>t===0?e:Math.trunc(e/t);function er(e){let t=new DataView(new ArrayBuffer(4));return t.setUint32(0,e,!0),t.getFloat32(0,!0)}function tr(e){let t=new DataView(new ArrayBuffer(4));return t.setUint32(0,e,!0),t.getInt32(0,!0)}var Vt=dn[m].jsImpl,Ot=me[m].jsImpl,wr=cr[m].jsImpl,Ln=st[m].jsImpl,Es=kt[m].jsImpl,Ct=mn[m].jsImpl,zt=He[m].jsImpl,sr=hr[m].jsImpl,Gn=It[m].jsImpl,Us=De[m].jsImpl,Rt=yn[m].jsImpl,Ft=$[m].jsImpl,vr=pr[m].jsImpl,Dn=$e[m].jsImpl,Vs=Se[m].jsImpl,$n=e=>Math.sqrt(e.x**2+e.y**2),_n=e=>Math.sqrt(e.x**2+e.y**2+e.z**2),zn=e=>Math.sqrt(e.x**2+e.y**2+e.z**2+e.w**2),fa=(e,t)=>e.x*t.x+e.y*t.y,da=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,ma=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,_e=e=>t=>Ot(e(t.x),e(t.y)),Pe=e=>t=>wr(e(t.x),e(t.y)),Sn=e=>t=>Ln(e(t.x),e(t.y)),ws=e=>t=>Es(e(t.x),e(t.y)),Te=e=>t=>zt(e(t.x),e(t.y),e(t.z)),Be=e=>t=>sr(e(t.x),e(t.y),e(t.z)),Mn=e=>t=>Gn(e(t.x),e(t.y),e(t.z)),vs=e=>t=>Us(e(t.x),e(t.y),e(t.z)),xe=e=>t=>Ft(e(t.x),e(t.y),e(t.z),e(t.w)),Ie=e=>t=>vr(e(t.x),e(t.y),e(t.z),e(t.w)),kn=e=>t=>Dn(e(t.x),e(t.y),e(t.z),e(t.w)),xs=e=>t=>Vs(e(t.x),e(t.y),e(t.z),e(t.w)),nl=e=>t=>{let r=t.columns;return fr(_e(e)(r[0]),_e(e)(r[1]))},sl=e=>t=>{let r=t.columns;return dr(Te(e)(r[0]),Te(e)(r[1]),Te(e)(r[2]))},al=e=>t=>{let r=t.columns;return Ne(xe(e)(r[0]),xe(e)(r[1]),xe(e)(r[2]),xe(e)(r[3]))},gr=e=>(t,r)=>Ot(e(t.x,r.x),e(t.y,r.y)),Nr=e=>(t,r)=>wr(e(t.x,r.x),e(t.y,r.y)),Pn=e=>(t,r)=>Ln(e(t.x,r.x),e(t.y,r.y)),Bn=e=>(t,r)=>Es(e(t.x,r.x),e(t.y,r.y)),ar=e=>(t,r)=>zt(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),qr=e=>(t,r)=>sr(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),In=e=>(t,r)=>Gn(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),En=e=>(t,r)=>Us(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),Zt=e=>(t,r)=>Ft(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),Wr=e=>(t,r)=>vr(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),Un=e=>(t,r)=>Dn(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),Vn=e=>(t,r)=>Vs(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),im=e=>(t,r)=>{let n=t.columns,s=r.columns;return fr(gr(e)(n[0],s[0]),gr(e)(n[1],s[1]))},om=e=>(t,r)=>{let n=t.columns,s=r.columns;return dr(ar(e)(n[0],s[0]),ar(e)(n[1],s[1]),ar(e)(n[2],s[2]))},lm=e=>(t,r)=>{let n=t.columns,s=r.columns;return Ne(Zt(e)(n[0],s[0]),Zt(e)(n[1],s[1]),Zt(e)(n[2],s[2]),Zt(e)(n[3],s[3]))},um=e=>(t,r,n)=>Ot(e(t.x,r.x,n.x),e(t.y,r.y,n.y)),cm=e=>(t,r,n)=>wr(e(t.x,r.x,n.x),e(t.y,r.y,n.y)),hm=e=>(t,r,n)=>zt(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z)),pm=e=>(t,r,n)=>sr(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z)),fm=e=>(t,r,n)=>Ft(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z),e(t.w,r.w,n.w)),dm=e=>(t,r,n)=>vr(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z),e(t.w,r.w,n.w)),L={eq:{vec2f:(e,t)=>Vt(e.x===t.x,e.y===t.y),vec2h:(e,t)=>Vt(e.x===t.x,e.y===t.y),vec2i:(e,t)=>Vt(e.x===t.x,e.y===t.y),vec2u:(e,t)=>Vt(e.x===t.x,e.y===t.y),"vec2<bool>":(e,t)=>Vt(e.x===t.x,e.y===t.y),vec3f:(e,t)=>Ct(e.x===t.x,e.y===t.y,e.z===t.z),vec3h:(e,t)=>Ct(e.x===t.x,e.y===t.y,e.z===t.z),vec3i:(e,t)=>Ct(e.x===t.x,e.y===t.y,e.z===t.z),vec3u:(e,t)=>Ct(e.x===t.x,e.y===t.y,e.z===t.z),"vec3<bool>":(e,t)=>Ct(e.x===t.x,e.y===t.y,e.z===t.z),vec4f:(e,t)=>Rt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),vec4h:(e,t)=>Rt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),vec4i:(e,t)=>Rt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),vec4u:(e,t)=>Rt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),"vec4<bool>":(e,t)=>Rt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w)},lt:{vec2f:(e,t)=>Vt(e.x<t.x,e.y<t.y),vec2h:(e,t)=>Vt(e.x<t.x,e.y<t.y),vec2i:(e,t)=>Vt(e.x<t.x,e.y<t.y),vec2u:(e,t)=>Vt(e.x<t.x,e.y<t.y),vec3f:(e,t)=>Ct(e.x<t.x,e.y<t.y,e.z<t.z),vec3h:(e,t)=>Ct(e.x<t.x,e.y<t.y,e.z<t.z),vec3i:(e,t)=>Ct(e.x<t.x,e.y<t.y,e.z<t.z),vec3u:(e,t)=>Ct(e.x<t.x,e.y<t.y,e.z<t.z),vec4f:(e,t)=>Rt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w),vec4h:(e,t)=>Rt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w),vec4i:(e,t)=>Rt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w),vec4u:(e,t)=>Rt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w)},or:{"vec2<bool>":(e,t)=>Vt(e.x||t.x,e.y||t.y),"vec3<bool>":(e,t)=>Ct(e.x||t.x,e.y||t.y,e.z||t.z),"vec4<bool>":(e,t)=>Rt(e.x||t.x,e.y||t.y,e.z||t.z,e.w||t.w)},all:{"vec2<bool>":e=>e.x&&e.y,"vec3<bool>":e=>e.x&&e.y&&e.z,"vec4<bool>":e=>e.x&&e.y&&e.z&&e.w},abs:{vec2f:_e(Math.abs),vec2h:Pe(Math.abs),vec2i:Sn(Math.abs),vec2u:ws(Math.abs),vec3f:Te(Math.abs),vec3h:Be(Math.abs),vec3i:Mn(Math.abs),vec3u:vs(Math.abs),vec4f:xe(Math.abs),vec4h:Ie(Math.abs),vec4i:kn(Math.abs),vec4u:xs(Math.abs)},atan2:{vec2f:gr(Math.atan2),vec2h:Nr(Math.atan2),vec3f:ar(Math.atan2),vec3h:qr(Math.atan2),vec4f:Zt(Math.atan2),vec4h:Wr(Math.atan2)},acos:{vec2f:_e(Math.acos),vec2h:Pe(Math.acos),vec2i:Sn(Math.acos),vec2u:ws(Math.acos),vec3f:Te(Math.acos),vec3h:Be(Math.acos),vec3i:Mn(Math.acos),vec3u:vs(Math.acos),vec4f:xe(Math.acos),vec4h:Ie(Math.acos),vec4i:kn(Math.acos),vec4u:xs(Math.acos)},acosh:{vec2f:_e(Math.acosh),vec2h:Pe(Math.acosh),vec3f:Te(Math.acosh),vec3h:Be(Math.acosh),vec4f:xe(Math.acosh),vec4h:Ie(Math.acosh)},asin:{vec2f:_e(Math.asin),vec2h:Pe(Math.asin),vec3f:Te(Math.asin),vec3h:Be(Math.asin),vec4f:xe(Math.asin),vec4h:Ie(Math.asin)},asinh:{vec2f:_e(Math.asinh),vec2h:Pe(Math.asinh),vec3f:Te(Math.asinh),vec3h:Be(Math.asinh),vec4f:xe(Math.asinh),vec4h:Ie(Math.asinh)},atan:{vec2f:_e(Math.atan),vec2h:Pe(Math.atan),vec3f:Te(Math.atan),vec3h:Be(Math.atan),vec4f:xe(Math.atan),vec4h:Ie(Math.atan)},atanh:{vec2f:_e(Math.atanh),vec2h:Pe(Math.atanh),vec3f:Te(Math.atanh),vec3h:Be(Math.atanh),vec4f:xe(Math.atanh),vec4h:Ie(Math.atanh)},ceil:{vec2f:_e(Math.ceil),vec2h:Pe(Math.ceil),vec3f:Te(Math.ceil),vec3h:Be(Math.ceil),vec4f:xe(Math.ceil),vec4h:Ie(Math.ceil)},clamp:{vec2f:(e,t,r)=>Ot(se(e.x,t.x,r.x),se(e.y,t.y,r.y)),vec2h:(e,t,r)=>wr(se(e.x,t.x,r.x),se(e.y,t.y,r.y)),vec2i:(e,t,r)=>Ln(se(e.x,t.x,r.x),se(e.y,t.y,r.y)),vec2u:(e,t,r)=>Es(se(e.x,t.x,r.x),se(e.y,t.y,r.y)),vec3f:(e,t,r)=>zt(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z)),vec3h:(e,t,r)=>sr(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z)),vec3i:(e,t,r)=>Gn(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z)),vec3u:(e,t,r)=>Us(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z)),vec4f:(e,t,r)=>Ft(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z),se(e.w,t.w,r.w)),vec4h:(e,t,r)=>vr(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z),se(e.w,t.w,r.w)),vec4i:(e,t,r)=>Dn(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z),se(e.w,t.w,r.w)),vec4u:(e,t,r)=>Vs(se(e.x,t.x,r.x),se(e.y,t.y,r.y),se(e.z,t.z,r.z),se(e.w,t.w,r.w))},length:{vec2f:$n,vec2h:$n,vec3f:_n,vec3h:_n,vec4f:zn,vec4h:zn},add:{vec2f:gr((e,t)=>e+t),vec2h:Nr((e,t)=>e+t),vec2i:Pn((e,t)=>e+t),vec2u:Bn((e,t)=>e+t),vec3f:ar((e,t)=>e+t),vec3h:qr((e,t)=>e+t),vec3i:In((e,t)=>e+t),vec3u:En((e,t)=>e+t),vec4f:Zt((e,t)=>e+t),vec4h:Wr((e,t)=>e+t),vec4i:Un((e,t)=>e+t),vec4u:Vn((e,t)=>e+t),mat2x2f:im((e,t)=>e+t),mat3x3f:om((e,t)=>e+t),mat4x4f:lm((e,t)=>e+t)},smoothstep:{vec2f:um(Yr),vec2h:cm(Yr),vec3f:hm(Yr),vec3h:pm(Yr),vec4f:fm(Yr),vec4h:dm(Yr)},addMixed:{vec2f:(e,t)=>_e(r=>r+t)(e),vec2h:(e,t)=>Pe(r=>r+t)(e),vec2i:(e,t)=>Sn(r=>r+t)(e),vec2u:(e,t)=>ws(r=>r+t)(e),vec3f:(e,t)=>Te(r=>r+t)(e),vec3h:(e,t)=>Be(r=>r+t)(e),vec3i:(e,t)=>Mn(r=>r+t)(e),vec3u:(e,t)=>vs(r=>r+t)(e),vec4f:(e,t)=>xe(r=>r+t)(e),vec4h:(e,t)=>Ie(r=>r+t)(e),vec4i:(e,t)=>kn(r=>r+t)(e),vec4u:(e,t)=>xs(r=>r+t)(e),mat2x2f:(e,t)=>nl(r=>r+t)(e),mat3x3f:(e,t)=>sl(r=>r+t)(e),mat4x4f:(e,t)=>al(r=>r+t)(e)},mulSxV:{vec2f:(e,t)=>_e(r=>e*r)(t),vec2h:(e,t)=>Pe(r=>e*r)(t),vec2i:(e,t)=>Sn(r=>e*r)(t),vec2u:(e,t)=>ws(r=>e*r)(t),vec3f:(e,t)=>Te(r=>e*r)(t),vec3h:(e,t)=>Be(r=>e*r)(t),vec3i:(e,t)=>Mn(r=>e*r)(t),vec3u:(e,t)=>vs(r=>e*r)(t),vec4f:(e,t)=>xe(r=>e*r)(t),vec4h:(e,t)=>Ie(r=>e*r)(t),vec4i:(e,t)=>kn(r=>e*r)(t),vec4u:(e,t)=>xs(r=>e*r)(t),mat2x2f:(e,t)=>nl(r=>e*r)(t),mat3x3f:(e,t)=>sl(r=>e*r)(t),mat4x4f:(e,t)=>al(r=>e*r)(t)},mulVxV:{vec2f:gr((e,t)=>e*t),vec2h:Nr((e,t)=>e*t),vec2i:Pn((e,t)=>e*t),vec2u:Bn((e,t)=>e*t),vec3f:ar((e,t)=>e*t),vec3h:qr((e,t)=>e*t),vec3i:In((e,t)=>e*t),vec3u:En((e,t)=>e*t),vec4f:Zt((e,t)=>e*t),vec4h:Wr((e,t)=>e*t),vec4i:Un((e,t)=>e*t),vec4u:Vn((e,t)=>e*t),mat2x2f:(e,t)=>{let r=e.columns,n=t.columns;return fr(r[0].x*n[0].x+r[1].x*n[0].y,r[0].y*n[0].x+r[1].y*n[0].y,r[0].x*n[1].x+r[1].x*n[1].y,r[0].y*n[1].x+r[1].y*n[1].y)},mat3x3f:(e,t)=>{let r=e.columns,n=t.columns;return dr(r[0].x*n[0].x+r[1].x*n[0].y+r[2].x*n[0].z,r[0].y*n[0].x+r[1].y*n[0].y+r[2].y*n[0].z,r[0].z*n[0].x+r[1].z*n[0].y+r[2].z*n[0].z,r[0].x*n[1].x+r[1].x*n[1].y+r[2].x*n[1].z,r[0].y*n[1].x+r[1].y*n[1].y+r[2].y*n[1].z,r[0].z*n[1].x+r[1].z*n[1].y+r[2].z*n[1].z,r[0].x*n[2].x+r[1].x*n[2].y+r[2].x*n[2].z,r[0].y*n[2].x+r[1].y*n[2].y+r[2].y*n[2].z,r[0].z*n[2].x+r[1].z*n[2].y+r[2].z*n[2].z)},mat4x4f:(e,t)=>{let r=e.columns,n=t.columns;return Ne(r[0].x*n[0].x+r[1].x*n[0].y+r[2].x*n[0].z+r[3].x*n[0].w,r[0].y*n[0].x+r[1].y*n[0].y+r[2].y*n[0].z+r[3].y*n[0].w,r[0].z*n[0].x+r[1].z*n[0].y+r[2].z*n[0].z+r[3].z*n[0].w,r[0].w*n[0].x+r[1].w*n[0].y+r[2].w*n[0].z+r[3].w*n[0].w,r[0].x*n[1].x+r[1].x*n[1].y+r[2].x*n[1].z+r[3].x*n[1].w,r[0].y*n[1].x+r[1].y*n[1].y+r[2].y*n[1].z+r[3].y*n[1].w,r[0].z*n[1].x+r[1].z*n[1].y+r[2].z*n[1].z+r[3].z*n[1].w,r[0].w*n[1].x+r[1].w*n[1].y+r[2].w*n[1].z+r[3].w*n[1].w,r[0].x*n[2].x+r[1].x*n[2].y+r[2].x*n[2].z+r[3].x*n[2].w,r[0].y*n[2].x+r[1].y*n[2].y+r[2].y*n[2].z+r[3].y*n[2].w,r[0].z*n[2].x+r[1].z*n[2].y+r[2].z*n[2].z+r[3].z*n[2].w,r[0].w*n[2].x+r[1].w*n[2].y+r[2].w*n[2].z+r[3].w*n[2].w,r[0].x*n[3].x+r[1].x*n[3].y+r[2].x*n[3].z+r[3].x*n[3].w,r[0].y*n[3].x+r[1].y*n[3].y+r[2].y*n[3].z+r[3].y*n[3].w,r[0].z*n[3].x+r[1].z*n[3].y+r[2].z*n[3].z+r[3].z*n[3].w,r[0].w*n[3].x+r[1].w*n[3].y+r[2].w*n[3].z+r[3].w*n[3].w)}},mulMxV:{mat2x2f:(e,t)=>{let r=e.columns;return Ot(r[0].x*t.x+r[1].x*t.y,r[0].y*t.x+r[1].y*t.y)},mat3x3f:(e,t)=>{let r=e.columns;return zt(r[0].x*t.x+r[1].x*t.y+r[2].x*t.z,r[0].y*t.x+r[1].y*t.y+r[2].y*t.z,r[0].z*t.x+r[1].z*t.y+r[2].z*t.z)},mat4x4f:(e,t)=>{let r=e.columns;return Ft(r[0].x*t.x+r[1].x*t.y+r[2].x*t.z+r[3].x*t.w,r[0].y*t.x+r[1].y*t.y+r[2].y*t.z+r[3].y*t.w,r[0].z*t.x+r[1].z*t.y+r[2].z*t.z+r[3].z*t.w,r[0].w*t.x+r[1].w*t.y+r[2].w*t.z+r[3].w*t.w)}},mulVxM:{mat2x2f:(e,t)=>{let r=t.columns;return Ot(e.x*r[0].x+e.y*r[0].y,e.x*r[1].x+e.y*r[1].y)},mat3x3f:(e,t)=>{let r=t.columns;return zt(e.x*r[0].x+e.y*r[0].y+e.z*r[0].z,e.x*r[1].x+e.y*r[1].y+e.z*r[1].z,e.x*r[2].x+e.y*r[2].y+e.z*r[2].z)},mat4x4f:(e,t)=>{let r=t.columns;return Ft(e.x*r[0].x+e.y*r[0].y+e.z*r[0].z+e.w*r[0].w,e.x*r[1].x+e.y*r[1].y+e.z*r[1].z+e.w*r[1].w,e.x*r[2].x+e.y*r[2].y+e.z*r[2].z+e.w*r[2].w,e.x*r[3].x+e.y*r[3].y+e.z*r[3].z+e.w*r[3].w)}},div:{vec2f:gr((e,t)=>e/t),vec2h:Nr((e,t)=>e/t),vec2i:Pn(Tn),vec2u:Bn(Tn),vec3f:ar((e,t)=>e/t),vec3h:qr((e,t)=>e/t),vec3i:In(Tn),vec3u:En(Tn),vec4f:Zt((e,t)=>e/t),vec4h:Wr((e,t)=>e/t),vec4i:Un(Tn),vec4u:Vn(Tn)},dot:{vec2f:fa,vec2h:fa,vec2i:fa,vec2u:fa,vec3f:da,vec3h:da,vec3i:da,vec3u:da,vec4f:ma,vec4h:ma,vec4i:ma,vec4u:ma},normalize:{vec2f:e=>{let t=$n(e);return Ot(e.x/t,e.y/t)},vec2h:e=>{let t=$n(e);return wr(e.x/t,e.y/t)},vec2i:e=>{let t=$n(e);return Ln(e.x/t,e.y/t)},vec2u:e=>{let t=$n(e);return Es(e.x/t,e.y/t)},vec3f:e=>{let t=_n(e);return zt(e.x/t,e.y/t,e.z/t)},vec3h:e=>{let t=_n(e);return sr(e.x/t,e.y/t,e.z/t)},vec3i:e=>{let t=_n(e);return Gn(e.x/t,e.y/t,e.z/t)},vec3u:e=>{let t=_n(e);return Us(e.x/t,e.y/t,e.z/t)},vec4f:e=>{let t=zn(e);return Ft(e.x/t,e.y/t,e.z/t,e.w/t)},vec4h:e=>{let t=zn(e);return vr(e.x/t,e.y/t,e.z/t,e.w/t)},vec4i:e=>{let t=zn(e);return Dn(e.x/t,e.y/t,e.z/t,e.w/t)},vec4u:e=>{let t=zn(e);return Vs(e.x/t,e.y/t,e.z/t,e.w/t)}},cross:{vec3f:(e,t)=>zt(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x),vec3h:(e,t)=>sr(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)},mod:{vec2f:gr((e,t)=>e%t),vec2h:Nr((e,t)=>e%t),vec2i:Pn((e,t)=>e%t),vec2u:Bn((e,t)=>e%t),vec3f:ar((e,t)=>e%t),vec3h:qr((e,t)=>e%t),vec3i:In((e,t)=>e%t),vec3u:En((e,t)=>e%t),vec4f:Zt((e,t)=>e%t),vec4h:Wr((e,t)=>e%t),vec4i:Un((e,t)=>e%t),vec4u:Vn((e,t)=>e%t)},floor:{vec2f:_e(Math.floor),vec2h:Pe(Math.floor),vec3f:Te(Math.floor),vec3h:Be(Math.floor),vec4f:xe(Math.floor),vec4h:Ie(Math.floor)},max:{vec2f:gr(Math.max),vec2h:Nr(Math.max),vec2i:Pn(Math.max),vec2u:Bn(Math.max),vec3f:ar(Math.max),vec3h:qr(Math.max),vec3i:In(Math.max),vec3u:En(Math.max),vec4f:Zt(Math.max),vec4h:Wr(Math.max),vec4i:Un(Math.max),vec4u:Vn(Math.max)},min:{vec2f:gr(Math.min),vec2h:Nr(Math.min),vec2i:Pn(Math.min),vec2u:Bn(Math.min),vec3f:ar(Math.min),vec3h:qr(Math.min),vec3i:In(Math.min),vec3u:En(Math.min),vec4f:Zt(Math.min),vec4h:Wr(Math.min),vec4i:Un(Math.min),vec4u:Vn(Math.min)},pow:{vec2f:(e,t)=>Ot(e.x**t.x,e.y**t.y),vec2h:(e,t)=>wr(e.x**t.x,e.y**t.y),vec3f:(e,t)=>zt(e.x**t.x,e.y**t.y,e.z**t.z),vec3h:(e,t)=>sr(e.x**t.x,e.y**t.y,e.z**t.z),vec4f:(e,t)=>Ft(e.x**t.x,e.y**t.y,e.z**t.z,e.w**t.w),vec4h:(e,t)=>vr(e.x**t.x,e.y**t.y,e.z**t.z,e.w**t.w)},sign:{vec2f:_e(Math.sign),vec2h:Pe(Math.sign),vec2i:Sn(Math.sign),vec3f:Te(Math.sign),vec3h:Be(Math.sign),vec3i:Mn(Math.sign),vec4f:xe(Math.sign),vec4h:Ie(Math.sign),vec4i:kn(Math.sign)},sqrt:{vec2f:_e(Math.sqrt),vec2h:Pe(Math.sqrt),vec3f:Te(Math.sqrt),vec3h:Be(Math.sqrt),vec4f:xe(Math.sqrt),vec4h:Ie(Math.sqrt)},mix:{vec2f:(e,t,r)=>typeof r=="number"?Ot(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r):Ot(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y),vec2h:(e,t,r)=>typeof r=="number"?wr(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r):wr(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y),vec3f:(e,t,r)=>typeof r=="number"?zt(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r):zt(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z),vec3h:(e,t,r)=>typeof r=="number"?sr(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r):sr(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z),vec4f:(e,t,r)=>typeof r=="number"?Ft(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r,e.w*(1-r)+t.w*r):Ft(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z,e.w*(1-r.w)+t.w*r.w),vec4h:(e,t,r)=>typeof r=="number"?vr(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r,e.w*(1-r)+t.w*r):vr(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z,e.w*(1-r.w)+t.w*r.w)},sin:{vec2f:_e(Math.sin),vec2h:Pe(Math.sin),vec3f:Te(Math.sin),vec3h:Be(Math.sin),vec4f:xe(Math.sin),vec4h:Ie(Math.sin)},cos:{vec2f:_e(Math.cos),vec2h:Pe(Math.cos),vec3f:Te(Math.cos),vec3h:Be(Math.cos),vec4f:xe(Math.cos),vec4h:Ie(Math.cos)},cosh:{vec2f:_e(Math.cosh),vec2h:Pe(Math.cosh),vec3f:Te(Math.cosh),vec3h:Be(Math.cosh),vec4f:xe(Math.cosh),vec4h:Ie(Math.cosh)},exp:{vec2f:_e(Math.exp),vec2h:Pe(Math.exp),vec3f:Te(Math.exp),vec3h:Be(Math.exp),vec4f:xe(Math.exp),vec4h:Ie(Math.exp)},exp2:{vec2f:_e(e=>2**e),vec2h:Pe(e=>2**e),vec3f:Te(e=>2**e),vec3h:Be(e=>2**e),vec4f:xe(e=>2**e),vec4h:Ie(e=>2**e)},log:{vec2f:_e(Math.log),vec2h:Pe(Math.log),vec3f:Te(Math.log),vec3h:Be(Math.log),vec4f:xe(Math.log),vec4h:Ie(Math.log)},log2:{vec2f:_e(Math.log2),vec2h:Pe(Math.log2),vec3f:Te(Math.log2),vec3h:Be(Math.log2),vec4f:xe(Math.log2),vec4h:Ie(Math.log2)},fract:{vec2f:_e(e=>e-Math.floor(e)),vec2h:Pe(e=>e-Math.floor(e)),vec3f:Te(e=>e-Math.floor(e)),vec3h:Be(e=>e-Math.floor(e)),vec4f:xe(e=>e-Math.floor(e)),vec4h:Ie(e=>e-Math.floor(e))},isCloseToZero:{vec2f:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t,vec2h:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t,vec3f:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t,vec3h:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t,vec4f:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t&&Math.abs(e.w)<=t,vec4h:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t&&Math.abs(e.w)<=t},neg:{vec2f:_e(e=>-e),vec2h:Pe(e=>-e),vec2i:Sn(e=>-e),vec2u:ws(e=>-e),"vec2<bool>":e=>Vt(!e.x,!e.y),vec3f:Te(e=>-e),vec3h:Be(e=>-e),vec3i:Mn(e=>-e),vec3u:vs(e=>-e),"vec3<bool>":e=>Ct(!e.x,!e.y,!e.z),vec4f:xe(e=>-e),vec4h:Ie(e=>-e),vec4i:kn(e=>-e),vec4u:xs(e=>-e),"vec4<bool>":e=>Rt(!e.x,!e.y,!e.z,!e.w)},select:{vec2f:(e,t,r)=>Ot(r.x?t.x:e.x,r.y?t.y:e.y),vec2h:(e,t,r)=>wr(r.x?t.x:e.x,r.y?t.y:e.y),vec2i:(e,t,r)=>Ln(r.x?t.x:e.x,r.y?t.y:e.y),vec2u:(e,t,r)=>Es(r.x?t.x:e.x,r.y?t.y:e.y),"vec2<bool>":(e,t,r)=>Vt(r.x?t.x:e.x,r.y?t.y:e.y),vec3f:(e,t,r)=>zt(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec3h:(e,t,r)=>sr(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec3i:(e,t,r)=>Gn(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec3u:(e,t,r)=>Us(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),"vec3<bool>":(e,t,r)=>Ct(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec4f:(e,t,r)=>Ft(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),vec4h:(e,t,r)=>vr(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),vec4i:(e,t,r)=>Dn(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),vec4u:(e,t,r)=>Vs(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),"vec4<bool>":(e,t,r)=>Rt(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w)},tanh:{vec2f:_e(Math.tanh),vec2h:Pe(Math.tanh),vec3f:Te(Math.tanh),vec3h:Be(Math.tanh),vec4f:xe(Math.tanh),vec4h:Ie(Math.tanh)},bitcastU32toF32:{vec2u:e=>Ot(er(e.x),er(e.y)),vec3u:e=>zt(er(e.x),er(e.y),er(e.z)),vec4u:e=>Ft(er(e.x),er(e.y),er(e.z),er(e.w))},bitcastU32toI32:{vec2u:e=>Ln(tr(e.x),tr(e.y)),vec3u:e=>Gn(tr(e.x),tr(e.y),tr(e.z)),vec4u:e=>Dn(tr(e.x),tr(e.y),tr(e.z),tr(e.w))}};function Wc(e,t){if(typeof e=="number"&&typeof t=="number")return e+t;if(typeof e=="number"&&Me(t))return L.addMixed[t.kind](t,e);if(Me(e)&&typeof t=="number")return L.addMixed[e.kind](e,t);if(Me(e)&&Me(t)||or(e)&&or(t))return L.add[e.kind](e,t);throw new Error("Add/Sub called with invalid arguments.")}var Yc=k({name:"add",signature:(...e)=>{let t=ft(e)??e;return{argTypes:t,returnType:Sr(t[0])?t[1]:t[0]}},normalImpl:Wc,codegenImpl:(e,t)=>x`(${e} + ${t})`});function mm(e,t){return Wc(e,Zc(-1,t))}var ia=k({name:"sub",signature:(...e)=>{let t=ft(e)??e;return{argTypes:t,returnType:Sr(t[0])?t[1]:t[0]}},normalImpl:mm,codegenImpl:(e,t)=>x`(${e} - ${t})`});function Zc(e,t){if(typeof e=="number"&&typeof t=="number")return e*t;if(typeof e=="number"&&(Me(t)||or(t)))return L.mulSxV[t.kind](e,t);if((Me(e)||or(e))&&typeof t=="number")return L.mulSxV[e.kind](t,e);if(Me(e)&&Me(t))return L.mulVxV[e.kind](e,t);if(Oo(e)&&or(t))return L.mulVxM[t.kind](e,t);if(or(e)&&Oo(t))return L.mulMxV[e.kind](e,t);if(or(e)&&or(t))return L.mulVxV[e.kind](e,t);throw new Error("Mul called with invalid arguments.")}var To=k({name:"mul",signature:(...e)=>{let t=ft(e)??e,r=Sr(t[0])?t[1]:Sr(t[1])||t[0].type.startsWith("vec")?t[0]:t[1].type.startsWith("vec")?t[1]:t[0];return{argTypes:t,returnType:r}},normalImpl:Zc,codegenImpl:(e,t)=>x`(${e} * ${t})`});function ym(e,t){if(typeof e=="number"&&typeof t=="number")return e/t;if(typeof e=="number"&&Me(t)){let r=Ca[t.kind][m].jsImpl;return L.div[t.kind](r(e),t)}if(Me(e)&&typeof t=="number"){let r=Ca[e.kind][m].jsImpl;return L.div[e.kind](e,r(t))}if(Me(e)&&Me(t))return L.div[e.kind](e,t);throw new Error("Div called with invalid arguments.")}var Xc=k({name:"div",signature:(...e)=>{let t=ft(e,[v,je,Ht])??e;return{argTypes:t,returnType:Sr(t[0])?t[1]:t[0]}},normalImpl:ym,codegenImpl:(e,t)=>x`(${e} / ${t})`,ignoreImplicitCastWarning:!0});k({name:"mod",signature:(...e)=>{let t=ft(e)??e;return{argTypes:t,returnType:Sr(t[0])?t[1]:t[0]}},normalImpl(e,t){if(typeof e=="number"&&typeof t=="number")return e%t;if(typeof e=="number"&&Me(t)){let r=Ca[t.kind];return L.mod[t.kind](r(e),t)}if(Me(e)&&typeof t=="number"){let r=Ca[e.kind];return L.mod[e.kind](e,r(t))}if(Me(e)&&Me(t))return L.mod[e.kind](e,t);throw new Error("Mod called with invalid arguments, expected types: number or vector.")},codegenImpl:(e,t)=>x`(${e} % ${t})`});function gm(e){return typeof e=="number"?-e:L.neg[e.kind](e)}k({name:"neg",signature:e=>({argTypes:[e],returnType:e}),normalImpl:gm,codegenImpl:e=>x`-(${e})`});function wm(e){return typeof e=="number"?Math.abs(e):L.abs[e.kind](e)}k({name:"abs",signature:e=>({argTypes:[e],returnType:e}),normalImpl:wm,codegenImpl:e=>x`abs(${e})`});function vm(e){return typeof e=="number"?Math.acos(e):L.acos[e.kind](e)}k({name:"acos",signature:e=>({argTypes:[e],returnType:e}),normalImpl:vm,codegenImpl:e=>x`acos(${e})`});function xm(e){return typeof e=="number"?Math.acosh(e):L.acosh[e.kind](e)}k({name:"acosh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:xm,codegenImpl:e=>x`acosh(${e})`});function bm(e){return typeof e=="number"?Math.asin(e):L.asin[e.kind](e)}k({name:"asin",signature:e=>({argTypes:[e],returnType:e}),normalImpl:bm,codegenImpl:e=>x`asin(${e})`});function Tm(e){return typeof e=="number"?Math.asinh(e):L.asinh[e.kind](e)}k({name:"asinh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Tm,codegenImpl:e=>x`asinh(${e})`});function $m(e){return typeof e=="number"?Math.atan(e):L.atan[e.kind](e)}k({name:"atan",signature:e=>({argTypes:[e],returnType:e}),normalImpl:$m,codegenImpl:e=>x`atan(${e})`});function _m(e){return typeof e=="number"?Math.atanh(e):L.atanh[e.kind](e)}k({name:"atanh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:_m,codegenImpl:e=>x`atanh(${e})`});function zm(e,t){return typeof e=="number"&&typeof t=="number"?Math.atan2(e,t):L.atan2[e.kind](e,t)}k({name:"atan2",signature:(...e)=>{let t=ft(e,[v,je,Ht])??e;return{argTypes:t,returnType:t[0]}},normalImpl:zm,codegenImpl:(e,t)=>x`atan2(${e}, ${t})`});function Sm(e){return typeof e=="number"?Math.ceil(e):L.ceil[e.kind](e)}var Mm=k({name:"ceil",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Sm,codegenImpl:e=>x`ceil(${e})`});function km(e,t,r){return typeof e=="number"?Math.min(Math.max(t,e),r):L.clamp[e.kind](e,t,r)}k({name:"clamp",signature:(...e)=>{let t=ft(e)??e;return{argTypes:t,returnType:t[0]}},normalImpl:km,codegenImpl:(e,t,r)=>x`clamp(${e}, ${t}, ${r})`});function Pm(e){return typeof e=="number"?Math.cos(e):L.cos[e.kind](e)}k({name:"cos",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Pm,codegenImpl:e=>x`cos(${e})`});function Bm(e){return typeof e=="number"?Math.cosh(e):L.cosh[e.kind](e)}k({name:"cosh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Bm,codegenImpl:e=>x`cosh(${e})`});k({name:"countLeadingZeros",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for countLeadingZeros not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`countLeadingZeros(${e})`});k({name:"countOneBits",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for countOneBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`countOneBits(${e})`});k({name:"countTrailingZeros",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for countTrailingZeros not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`countTrailingZeros(${e})`});k({name:"cross",signature:(e,t)=>({argTypes:[e,t],returnType:e}),normalImpl:(e,t)=>L.cross[e.kind](e,t),codegenImpl:(e,t)=>x`cross(${e}, ${t})`});function Im(e){if(typeof e=="number")return e*180/Math.PI;throw new Bt("CPU implementation for degrees on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"degrees",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Im,codegenImpl:e=>x`degrees(${e})`});k({name:"determinant",signature:e=>({argTypes:[e],returnType:v}),normalImpl:"CPU implementation for determinant not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`determinant(${e})`});function Em(e,t){return typeof e=="number"&&typeof t=="number"?Math.abs(e-t):Dm(ia(e,t))}k({name:"distance",signature:(e,t)=>({argTypes:[e,t],returnType:Hi(e)?je:v}),normalImpl:Em,codegenImpl:(e,t)=>x`distance(${e}, ${t})`});var Um=k({name:"dot",signature:(e,t)=>({argTypes:[e,t],returnType:e.primitive}),normalImpl:(e,t)=>L.dot[e.kind](e,t),codegenImpl:(e,t)=>x`dot(${e}, ${t})`});k({name:"dot4U8Packed",signature:(e,t)=>({argTypes:[O,O],returnType:O}),normalImpl:"CPU implementation for dot4U8Packed not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t)=>x`dot4U8Packed(${e}, ${t})`});k({name:"dot4I8Packed",signature:(e,t)=>({argTypes:[O,O],returnType:we}),normalImpl:"CPU implementation for dot4I8Packed not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t)=>x`dot4I8Packed(${e}, ${t})`});function Vm(e){return typeof e=="number"?Math.exp(e):L.exp[e.kind](e)}k({name:"exp",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Vm,codegenImpl:e=>x`exp(${e})`});function Cm(e){return typeof e=="number"?2**e:L.exp2[e.kind](e)}k({name:"exp2",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Cm,codegenImpl:e=>x`exp2(${e})`});k({name:"extractBits",signature:(e,t,r)=>({argTypes:[e,O,O],returnType:e}),normalImpl:"CPU implementation for extractBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t,r)=>x`extractBits(${e}, ${t}, ${r})`});k({name:"faceForward",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:e}),normalImpl:"CPU implementation for faceForward not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t,r)=>x`faceForward(${e}, ${t}, ${r})`});k({name:"firstLeadingBit",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for firstLeadingBit not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`firstLeadingBit(${e})`});k({name:"firstTrailingBit",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for firstTrailingBit not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`firstTrailingBit(${e})`});function Rm(e){return typeof e=="number"?Math.floor(e):L.floor[e.kind](e)}k({name:"floor",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:Rm,codegenImpl:e=>x`floor(${e})`});function Am(e,t,r){if(typeof e=="number")return e*t+r;throw new Bt("CPU implementation for fma on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"fma",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:e}),normalImpl:Am,codegenImpl:(e,t,r)=>x`fma(${e}, ${t}, ${r})`});function Om(e){return typeof e=="number"?e-Math.floor(e):L.fract[e.kind](e)}k({name:"fract",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:Om,codegenImpl:e=>x`fract(${e})`});var Fm={f32:Qe({fract:v,exp:we}),f16:Qe({fract:je,exp:we}),abstractFloat:Qe({fract:Ht,exp:Za}),vec2f:Qe({fract:me,exp:st}),vec3f:Qe({fract:He,exp:It}),vec4f:Qe({fract:$,exp:$e}),vec2h:Qe({fract:cr,exp:st}),vec3h:Qe({fract:hr,exp:It}),vec4h:Qe({fract:pr,exp:$e})};et(e=>{throw new Bt("CPU implementation for frexp not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")},e=>{let t=Fm[e.dataType.type];if(!t)throw new Error(`Unsupported data type for frexp: ${e.dataType.type}. Supported types are f32, f16, abstractFloat, vec2f, vec3f, vec4f, vec2h, vec3h, vec4h.`);return _(x`frexp(${e})`,t)},"frexp");k({name:"insertBits",signature:(e,t,r,n)=>({argTypes:[e,t,O,O],returnType:e}),normalImpl:"CPU implementation for insertBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t,r,n)=>x`insertBits(${e}, ${t}, ${r}, ${n})`});function Lm(e){if(typeof e=="number")return 1/Math.sqrt(e);throw new Bt("CPU implementation for inverseSqrt on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"inverseSqrt",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Lm,codegenImpl:e=>x`inverseSqrt(${e})`});k({name:"ldexp",signature:(e,t)=>{switch(e.type){case"abstractFloat":return{argTypes:[Ht,Za],returnType:e};case"f32":case"f16":return{argTypes:[e,we],returnType:e};case"vec2f":case"vec2h":return{argTypes:[e,st],returnType:e};case"vec3f":case"vec3h":return{argTypes:[e,It],returnType:e};case"vec4f":case"vec4h":return{argTypes:[e,$e],returnType:e};default:throw new Error(`Unsupported data type for ldexp: ${e.type}. Supported types are abstractFloat, f32, f16, vec2f, vec2h, vec3f, vec3h, vec4f, vec4h.`)}},normalImpl:"CPU implementation for ldexp not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t)=>x`ldexp(${e}, ${t})`});function Gm(e){return typeof e=="number"?Math.abs(e):L.length[e.kind](e)}var Dm=k({name:"length",signature:e=>({argTypes:[e],returnType:Hi(e)?je:v}),normalImpl:Gm,codegenImpl:e=>x`length(${e})`});function jm(e){return typeof e=="number"?Math.log(e):L.log[e.kind](e)}k({name:"log",signature:e=>({argTypes:[e],returnType:e}),normalImpl:jm,codegenImpl:e=>x`log(${e})`});function Nm(e){return typeof e=="number"?Math.log2(e):L.log2[e.kind](e)}k({name:"log2",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Nm,codegenImpl:e=>x`log2(${e})`});function qm(e,t){return typeof e=="number"?Math.max(e,t):L.max[e.kind](e,t)}k({name:"max",signature:(...e)=>{let t=ft(e)??e;return{argTypes:t,returnType:t[0]}},normalImpl:qm,codegenImpl:(e,t)=>x`max(${e}, ${t})`});function Wm(e,t){return typeof e=="number"?Math.min(e,t):L.min[e.kind](e,t)}k({name:"min",signature:(...e)=>{let t=ft(e)??e;return{argTypes:t,returnType:t[0]}},normalImpl:Wm,codegenImpl:(e,t)=>x`min(${e}, ${t})`});function Ym(e,t,r){if(typeof e=="number"){if(typeof r!="number"||typeof t!="number")throw new Error("When e1 and e2 are numbers, the blend factor must be a number.");return e*(1-r)+t*r}if(typeof e=="number"||typeof t=="number")throw new Error("e1 and e2 need to both be vectors of the same kind.");return L.mix[e.kind](e,t,r)}k({name:"mix",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:e}),normalImpl:Ym,codegenImpl:(e,t,r)=>x`mix(${e}, ${t}, ${r})`});var Zm={f32:Qe({fract:v,whole:v}),f16:Qe({fract:je,whole:je}),abstractFloat:Qe({fract:Ht,whole:Ht}),vec2f:Qe({fract:me,whole:me}),vec3f:Qe({fract:He,whole:He}),vec4f:Qe({fract:$,whole:$}),vec2h:Qe({fract:cr,whole:cr}),vec3h:Qe({fract:hr,whole:hr}),vec4h:Qe({fract:pr,whole:pr})};k({name:"modf",signature:e=>{let t=Zm[e.type];if(!t)throw new Error(`Unsupported data type for modf: ${e.type}. Supported types are f32, f16, abstractFloat, vec2f, vec3f, vec4f, vec2h, vec3h, vec4h.`);return{argTypes:[e],returnType:t}},normalImpl:"CPU implementation for modf not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`modf(${e})`});k({name:"normalize",signature:e=>({argTypes:[e],returnType:e}),normalImpl:e=>L.normalize[e.kind](e),codegenImpl:e=>x`normalize(${e})`});function Xm(e,t){if(typeof e=="number"&&typeof t=="number")return e**t;if(Me(e)&&Me(t))return L.pow[e.kind](e,t);throw new Error("Invalid arguments to pow()")}var Hm=k({name:"pow",signature:(...e)=>{let t=ft(e,[v,je,Ht])??e;return{argTypes:t,returnType:Sr(t[0])?t[1]:t[0]}},normalImpl:Xm,codegenImpl:(e,t)=>x`pow(${e}, ${t})`});k({name:"quantizeToF16",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for quantizeToF16 not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`quantizeToF16(${e})`});function Km(e){if(typeof e=="number")return e*Math.PI/180;throw new Bt("CPU implementation for radians on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"radians",signature:(...e)=>{let t=ft(e,[v,je,Ht])??e;return{argTypes:t,returnType:t[0]}},normalImpl:Km,codegenImpl:e=>x`radians(${e})`});k({name:"reflect",signature:(e,t)=>({argTypes:[e,t],returnType:e}),normalImpl:(e,t)=>ia(e,To(2*Um(t,e),t)),codegenImpl:(e,t)=>x`reflect(${e}, ${t})`});et((e,t,r)=>{throw new Bt("CPU implementation for refract not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")},(e,t,r)=>_(x`refract(${e}, ${t}, ${r})`,e.dataType),"refract",(e,t,r)=>[e.dataType,t.dataType,Hi(e)?je:v]);k({name:"reverseBits",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for reverseBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`reverseBits(${e})`});function Qm(e){if(typeof e=="number")return Math.round(e);throw new Bt("CPU implementation for round on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"round",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Qm,codegenImpl:e=>x`round(${e})`});function Jm(e){if(typeof e=="number")return Math.max(0,Math.min(1,e));throw new Bt("CPU implementation for saturate on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"saturate",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Jm,codegenImpl:e=>x`saturate(${e})`});function ey(e){return typeof e=="number"?Math.sign(e):L.sign[e.kind](e)}k({name:"sign",signature:e=>({argTypes:[e],returnType:e}),normalImpl:ey,codegenImpl:e=>x`sign(${e})`});function ty(e){return typeof e=="number"?Math.sin(e):L.sin[e.kind](e)}k({name:"sin",signature:e=>({argTypes:[e],returnType:e}),normalImpl:ty,codegenImpl:e=>x`sin(${e})`});function ry(e){if(typeof e=="number")return Math.sinh(e);throw new Bt("CPU implementation for sinh on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"sinh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:ry,codegenImpl:e=>x`sinh(${e})`});function ny(e,t,r){return typeof r=="number"?Yr(e,t,r):L.smoothstep[r.kind](e,t,r)}k({name:"smoothstep",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:r}),normalImpl:ny,codegenImpl:(e,t,r)=>x`smoothstep(${e}, ${t}, ${r})`});function sy(e){return typeof e=="number"?Math.sqrt(e):L.sqrt[e.kind](e)}k({name:"sqrt",signature:e=>({argTypes:[e],returnType:e}),normalImpl:sy,codegenImpl:e=>x`sqrt(${e})`});function ay(e,t){if(typeof e=="number")return e<=t?1:0;throw new Bt("CPU implementation for step on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"step",signature:(...e)=>{let t=ft(e,[v,je,Ht])??e;return{argTypes:t,returnType:t[0]}},normalImpl:ay,codegenImpl:(e,t)=>x`step(${e}, ${t})`});function iy(e){if(typeof e=="number")return Math.tan(e);throw new Bt("CPU implementation for tan on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}k({name:"tan",signature:e=>({argTypes:[e],returnType:e}),normalImpl:iy,codegenImpl:e=>x`tan(${e})`});function oy(e){return typeof e=="number"?Math.tanh(e):L.tanh[e.kind](e)}k({name:"tanh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:oy,codegenImpl:e=>x`tanh(${e})`});k({name:"transpose",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for transpose not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`transpose(${e})`});k({name:"trunc",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for trunc not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>x`trunc(${e})`});var{NodeTypeCatalog:be}=od,ly=["==","!=","<","<=",">",">=","<<",">>","+","-","*","/","%","|","^","&","&&","||"],uy=["&&","||","==","!=","<","<=",">",">="],cy=["vec2f","vec3f","vec4f","vec2h","vec3h","vec4h","vec2i","vec3i","vec4i","vec2u","vec3u","vec4u","mat2x2f","mat3x3f","mat4x4f"],il={add:Yc,sub:ia,mul:To,div:Xc};function ol(e,t,r){return r?uy.includes(t)?Ue:t==="="?r:e:t==="!"||t==="~"?Ue:e}var hy={"+":Yc[m].gpuImpl,"-":ia[m].gpuImpl,"*":To[m].gpuImpl,"/":Xc[m].gpuImpl,"**":Hm[m].gpuImpl},qn,Dl,py=(Dl=class{constructor(){Y(this,qn)}initGenerator(e){q(this,qn,e)}get ctx(){if(!w(this,qn))throw new Error("WGSL Generator has not yet been initialized. Please call initialize(ctx) before using the generator.");return w(this,qn)}block([e,t]){this.ctx.pushBlockScope();try{this.ctx.indent();let r=t.map(n=>this.statement(n)).join(`
`);return this.ctx.dedent(),`{
${r}
${this.ctx.pre}}`}finally{this.ctx.popBlockScope()}}blockVariable(e,t){let r=_(this.ctx.makeNameValid(e),t);return this.ctx.defineVariable(e,r),r}identifier(e){if(!e)throw new Error("Cannot resolve an empty identifier");let t=this.ctx.getById(e);if(!t)throw new Error(`Identifier ${e} not found`);return t}typedExpression(e,t){let r=this.ctx.expectedType;this.ctx.expectedType=t;try{let n=this.expression(e);return Si(n,t)}finally{this.ctx.expectedType=r}}expression(e){var t,r;if(typeof e=="string")return this.identifier(e);if(typeof e=="boolean")return _(e,Ue);if(e[0]===be.logicalExpr||e[0]===be.binaryExpr||e[0]===be.assignmentExpr){let[n,s,a,i]=e,o=this.expression(s),l=this.expression(i),u=hy[a];if(u)return u(o,l);let c=e[0]===be.assignmentExpr?o.dataType.type==="ptr"?[o.dataType.inner]:[o.dataType]:void 0,[h,f]=Bs([o,l],c)??[o,l],d=this.ctx.resolve(h.value,h.dataType).value,p=this.ctx.resolve(f.value,f.dataType).value,g=ol(h.dataType,a,f.dataType);return _(ly.includes(a)?`(${d} ${a} ${p})`:`${d} ${a} ${p}`,g)}if(e[0]===be.postUpdate){let[n,s,a]=e,i=this.expression(a),o=this.ctx.resolve(i.value,i.dataType).value;return _(`${o}${s}`,i.dataType)}if(e[0]===be.unaryExpr){let[n,s,a]=e,i=this.expression(a),o=this.ctx.resolve(i.value,i.dataType).value,l=ol(i.dataType,s);return _(`${s}${o}`,l)}if(e[0]===be.memberAccess){let[n,s,a]=e,i=this.expression(s);if(i.value===console)return _(new Do(a),ht);if(cy.includes(i.dataType.type)&&a in il)return{value:new Lo(a,i,il[a][m].gpuImpl),dataType:ht};if(i.dataType.type==="unknown"){let o=i.value[a];return _a(o)}return Fo(i.dataType)?_(`(*${this.ctx.resolve(i.value).value}).${a}`,Pi(i.dataType.inner,a)):Xt(i.dataType)&&a==="length"?i.dataType.elementCount===0?_(`arrayLength(&${this.ctx.resolve(i.value).value})`,O):_(String(i.dataType.elementCount),Za):As(i.dataType)&&a==="columns"?_(new Go(i),ht):zr(i.dataType)&&Me(i.value)?_a(i.value[a]):_(`${this.ctx.resolve(i.value).value}.${a}`,Pi(i.dataType,a))}if(e[0]===be.indexAccess){let[n,s,a]=e,i=this.expression(s),o=this.expression(a),l=this.ctx.resolve(o.value,o.dataType).value;if(i.value instanceof Go)return _(x`${i.value.matrix}[${l}]`,ci(i.value.matrix.dataType));let u=this.ctx.resolve(i.value,i.dataType).value;if(i.dataType.type==="unknown"){if(Array.isArray(a)&&a[0]===be.numericLiteral)return _a(i.value[a[1]]);throw new Error(`Unable to index a value of unknown type with index ${l}. If the value is an array, to address this, consider one of the following approaches: (1) declare the array using 'tgpu.const', (2) store the array in a buffer, or (3) define the array within the GPU function scope.`)}if(As(i.dataType))throw new Error("The only way of accessing matrix elements in TGSL is through the 'columns' property.");return Fo(i.dataType)?_(`(*${u})[${l}]`,ci(i.dataType.inner)):_(`${u}[${l}]`,us(i.dataType)?ci(i.dataType):ht)}if(e[0]===be.numericLiteral){let n=typeof e[1]=="string"?Ra(dy(e[1])):Ra(e[1]);if(!n)throw new Error(`Invalid numeric literal ${e[1]}`);return n}if(e[0]===be.call){let[n,s,a]=e,i=this.expression(s);if(pt(i.value)||Xt(i.value)){if(a.length>1)throw new Lt("Array and struct schemas should always be called with at most 1 argument");if(!a[0])return _(`${this.ctx.resolve(i.value).value}()`,i.value);let l=this.typedExpression(a[0],i.value);return _(this.ctx.resolve(l.value,i.value).value,i.value)}if(i.value===Bi)throw new Error("Constants cannot be defined within TypeGPU function scope. To address this, move the constant definition outside the function scope.");if(i.value instanceof Lo){if(!a[0])throw new Lt(`An infix operator '${i.value.name}' was called without any arguments`);let l=this.expression(a[0]);return i.value.operator(i.value.lhs,l)}if(!ye(i.value)){let l=a.map(c=>this.expression(c)),u=this.ctx.shelllessRepo.get(i.value,l);if(u)return this.ctx.withResetIndentLevel(()=>{let c=this.ctx.resolve(u);return _(x`${c.value}(${l})`,c.dataType)});throw new Error(`Function '${U(i.value)??String(i.value)}' is not marked with the 'use gpu' directive and cannot be used in a shader`)}let o=((t=i.value[m])==null?void 0:t.argConversionHint)??"keep";try{let l;if(Array.isArray(o))l=a.map((c,h)=>{let f=o[h];if(!f)throw new Lt(`Function '${U(i.value)}' was called with too many arguments`);return this.typedExpression(c,f)});else{let c=a.map(h=>this.expression(h));o==="keep"?l=c:o==="unify"?l=Bs(c)??c:l=o(...c).map((h,f)=>[h,c[f]]).map(([h,f])=>Si(f,h))}if(i.value instanceof Do)return this.ctx.generateLog(i.value.op,l);let u=i.value(...l);if(!Qi(u))throw new Error("Functions running in codegen mode must return snippets");return u}catch(l){throw new zs(l,[{toString:()=>U(i.value)}])}}if(e[0]===be.objectExpr){let n=e[1],s=this.ctx.expectedType;if(!s||!pt(s))throw new Lt(`No target type could be inferred for object with keys [${Object.keys(n).join(", ")}], please wrap the object in the corresponding schema.`);let a=Object.fromEntries(Object.entries(s.propTypes).map(([o,l])=>{let u=n[o];if(u===void 0)throw new Lt(`Missing property ${o} in object literal for struct ${s}`);let c=this.typedExpression(u,l);return[o,c]})),i=Rf(s,a);return _(x`${this.ctx.resolve(s).value}(${i})`,s)}if(e[0]===be.arrayExpr){let[n,s]=e,a=this.ctx.expectedType,i,o;if(Xt(a)){if(i=a.elementType,o=s.map(u=>this.typedExpression(u,i)),o.length!==a.elementCount)throw new Lt(`Cannot create value of type '${a}' from an array of length: ${o.length}`)}else{let u=s.map(h=>this.expression(h));if(u.length===0)throw new Lt("Cannot infer the type of an empty array literal.");let c=Bs(u);if(!c)throw new Lt("The given values cannot be automatically converted to a common type. Consider wrapping the array in an appropriate schema");o=c,i=Gs((r=o[0])==null?void 0:r.dataType)}let l=`array<${this.ctx.resolve(i).value}, ${o.length}>`;return _(x`${l}(${o})`,Ls[m].jsImpl(i,o.length))}if(e[0]===be.stringLiteral)return _(e[1],ht);if(e[0]===be.preUpdate)throw new Error("Cannot use pre-updates in TGSL.");fy(e)}functionDefinition(e){return this.block(e)}statement(e){if(typeof e=="string")return`${this.ctx.pre}${this.ctx.resolve(this.identifier(e).value).value};`;if(typeof e=="boolean")return`${this.ctx.pre}${e?"true":"false"};`;if(e[0]===be.return){let t=e[1];if(t!==void 0){let r=this.ctx.topFunctionReturnType,n=r?this.typedExpression(t,r):this.expression(t);return Tr(n.dataType.type!=="unknown"),this.ctx.reportReturnType(n.dataType),x`${this.ctx.pre}return ${n};`}return`${this.ctx.pre}return;`}if(e[0]===be.if){let[t,r,n,s]=e,a=this.typedExpression(r,Ue),i=a.value===!1?void 0:this.block(ya(n)),o=a.value===!0||!s?void 0:this.block(ya(s));return a.value===!0?`${this.ctx.pre}${i}`:a.value===!1?o?`${this.ctx.pre}${o}`:"":o?x`\
${this.ctx.pre}if (${a}) ${i}
${this.ctx.pre}else ${o}`:x`${this.ctx.pre}if (${a}) ${i}`}if(e[0]===be.let||e[0]===be.const){let[t,r,n]=e,s=n!==void 0?this.expression(n):void 0;if(!s)throw new Error(`Cannot create variable '${r}' without an initial value.`);if(Ks(s.dataType))throw new Error(`Cannot create variable '${r}' with loose data type.`);let a=this.blockVariable(r,Gs(s.dataType));return x`${this.ctx.pre}var ${a.value} = ${s};`}if(e[0]===be.block)return this.block(e);if(e[0]===be.for){let[t,r,n,s,a]=e,[i,o,l]=this.ctx.withResetIndentLevel(()=>[r?this.statement(r):void 0,n?this.typedExpression(n,Ue):void 0,s?this.statement(s):void 0]),u=i?i.slice(0,-1):"",c=l?l.slice(0,-1):"",h=this.block(ya(a));return x`${this.ctx.pre}for (${u}; ${o}; ${c}) ${h}`}if(e[0]===be.while){let[t,r,n]=e,s=this.typedExpression(r,Ue),a=this.ctx.resolve(s.value).value,i=this.block(ya(n));return`${this.ctx.pre}while (${a}) ${i}`}return e[0]===be.continue?`${this.ctx.pre}continue;`:e[0]===be.break?`${this.ctx.pre}break;`:`${this.ctx.pre}${this.ctx.resolve(this.expression(e).value).value};`}},qn=new WeakMap,Dl);function fy(e){throw new Error(`'${Os(e)}' was not handled by the WGSL generator.`)}function dy(e){return/^0x[0-9a-f]+$/i.test(e)?Number.parseInt(e):/^0b[01]+$/i.test(e)?Number.parseInt(e.slice(2),2):Number.parseFloat(e)}function ya(e){return typeof e!="object"||e[0]!==be.block?[be.block,[e]]:e}var my=new py,Hc=my,Kc=Object.defineProperty,yy=(e,t,r)=>t in e?Kc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,gy=(e,t)=>{for(var r in t)Kc(e,r,{get:t[r],enumerable:!0})},ie=(e,t,r)=>yy(e,typeof t!="symbol"?t+"":t,r),wy={};gy(wy,{BufferReader:()=>Ar,BufferWriter:()=>wn,MaxValue:()=>Fe,Measurer:()=>Ve,UnresolvedReferenceError:()=>Zr,ValidationError:()=>Ja,arrayOf:()=>$y,bool:()=>zy,byte:()=>Iy,chars:()=>qy,concat:()=>Xy,dynamicArrayOf:()=>Ky,f16:()=>Gy,f32:()=>jy,f32Array:()=>fg,f64Array:()=>dg,generic:()=>Yy,genericEnum:()=>Zy,i16:()=>Uy,i16Array:()=>hg,i32:()=>Ay,i32Array:()=>pg,i8:()=>Py,i8Array:()=>cg,keyed:()=>eg,object:()=>Wy,optional:()=>rg,string:()=>My,tupleOf:()=>ag,u16:()=>Cy,u16Array:()=>lg,u32:()=>Fy,u32Array:()=>ug,u8:()=>rh,u8Array:()=>ig,u8ClampedArray:()=>og});var Zr=class Qc extends Error{constructor(t){super(t),Object.setPrototypeOf(this,Qc.prototype)}},Ja=class Jc extends Error{constructor(t){super(t),Object.setPrototypeOf(this,Jc.prototype)}},vy=class{constructor(){ie(this,"size",Number.NaN),ie(this,"unbounded",this),ie(this,"isUnbounded",!0)}add(){return this}fork(){return this}},xy=new vy,Ve=class eh{constructor(){ie(this,"size",0),ie(this,"unbounded",xy),ie(this,"isUnbounded",!1)}add(t){return this.size+=t,this}fork(){const t=new eh;return t.size=this.size,t}},Fe=Symbol("The biggest (in amount of bytes needed) value a schema can represent"),tt=class{constructor(){ie(this,"__unwrapped")}resolveReferences(e){}seekProperty(e,t){return null}},by=class{constructor(e){this.key=e}},Cs={STRING:"string",ENUM:"enum"},Ty=class extends tt{constructor(e,t){super(),this._unstableElementSchema=e,this.length=t,ie(this,"elementSchema"),this.elementSchema=e}resolveReferences(e){this.elementSchema=e.resolve(this._unstableElementSchema)}write(e,t){if(t.length!==this.length)throw new Ja(`Expected array of length ${this.length}, got ${t.length}`);for(const r of t)this.elementSchema.write(e,r)}read(e){const t=[];for(let r=0;r<this.length;++r)t.push(this.elementSchema.read(e));return t}get maxSize(){return this.elementSchema.measure(Fe).size*this.length}measure(e,t=new Ve){for(let r=0;r<this.length;++r)this.elementSchema.measure(e===Fe?Fe:e[r],t);return t}};function $y(e,t){return new Ty(e,t)}var _y=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",1)}read(e){return e.readBool()}write(e,t){e.writeBool(t)}measure(e,t=new Ve){return t.add(1)}},zy=new _y,th=class Ss extends tt{static get _encoder(){return Ss._cachedEncoder||(Ss._cachedEncoder=new TextEncoder),Ss._cachedEncoder}read(t){return t.readString()}write(t,r){t.writeString(r)}measure(t,r=new Ve){if(t===Fe)return r.unbounded;const n=Ss._encoder.encode(t);return r.add(n.byteLength+1)}};ie(th,"_cachedEncoder");var Sy=th,My=new Sy,ky=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",1)}read(e){return e.readInt8()}write(e,t){e.writeInt8(t)}measure(e,t=new Ve){return t.add(1)}},Py=new ky,By=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",1)}read(e){return e.readUint8()}write(e,t){e.writeUint8(t)}measure(e,t=new Ve){return t.add(1)}},rh=new By,Iy=rh,Ey=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",2)}read(e){return e.readInt16()}write(e,t){e.writeInt16(t)}measure(e,t=new Ve){return t.add(2)}},Uy=new Ey,Vy=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",2)}read(e){return e.readUint16()}write(e,t){e.writeUint16(t)}measure(e,t=new Ve){return t.add(2)}},Cy=new Vy,Ry=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",4)}read(e){return e.readInt32()}write(e,t){e.writeInt32(t)}measure(e,t=new Ve){return t.add(4)}},Ay=new Ry,Oy=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",4)}read(e){return e.readUint32()}write(e,t){e.writeUint32(t)}measure(e,t=new Ve){return t.add(4)}},Fy=new Oy,Ly=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",2)}read(e){return e.readFloat16()}write(e,t){e.writeFloat16(t)}measure(e,t=new Ve){return t.add(2)}},Gy=new Ly,Dy=class extends tt{constructor(){super(...arguments),ie(this,"maxSize",4)}read(e){return e.readFloat32()}write(e,t){e.writeFloat32(t)}measure(e,t=new Ve){return t.add(4)}},jy=new Dy,Ny=class extends tt{constructor(e){super(),this.length=e}write(e,t){if(t.length!==this.length)throw new Ja(`Expected char-string of length ${this.length}, got ${t.length}`);for(let r=0;r<t.length;++r)e.writeUint8(t.charCodeAt(r))}read(e){let t="";for(let r=0;r<this.length;++r)t+=String.fromCharCode(e.readByte());return t}measure(e,t=new Ve){return t.add(this.length)}};function qy(e){return new Ny(e)}function Rr(e){return Object.entries(e)}function nh(e,t){const r={};for(const[n,s]of Rr(t))r[n]=e.resolve(s);return r}var $o=class extends tt{constructor(e){super(),this._properties=e,ie(this,"properties"),this.properties=e}resolveReferences(e){this.properties=nh(e,this._properties)}write(e,t){for(const[r,n]of Rr(this.properties))n.write(e,t[r])}read(e){const t={};for(const[r,n]of Rr(this.properties))t[r]=n.read(e);return t}get maxSize(){const e=new Ve;for(const t of Object.values(this.properties))t.measure(Fe,e);return e.size}measure(e,t=new Ve){for(const[r,n]of Rr(this.properties))n.measure(e===Fe?Fe:e[r],t);return t}seekProperty(e,t){let r=0;for(const[n,s]of Rr(this.properties)){if(n===t)return{bufferOffset:r,schema:s};r+=s.measure(e).size}return null}};function Wy(e){return new $o(e)}var sh=class extends tt{constructor(e,t,r){super(),this.keyedBy=e,this._subTypeMap=r,ie(this,"_baseObject"),ie(this,"subTypeMap"),this._baseObject=new $o(t),this.subTypeMap=r}resolveReferences(e){this._baseObject.resolveReferences(e),this.subTypeMap=nh(e,this._subTypeMap)}write(e,t){const r=t.type,n=this.subTypeMap[r]||null;if(n===null)throw new Error(`Unknown sub-type '${r.toString()}' in among '${JSON.stringify(Object.keys(this.subTypeMap))}'`);this.keyedBy===Cs.ENUM?e.writeUint8(t.type):e.writeString(t.type),this._baseObject.write(e,t);for(const[s,a]of Rr(n.properties))a.write(e,t[s])}read(e){const t=this.keyedBy===Cs.ENUM?e.readByte():e.readString(),r=this.subTypeMap[t]||null;if(r===null)throw new Error(`Unknown sub-type '${t}' in among '${JSON.stringify(Object.keys(this.subTypeMap))}'`);const n=this._baseObject.read(e);if(n.type=t,r!==null)for(const[s,a]of Rr(r.properties))n[s]=a.read(e);return n}measure(e,t=new Ve){if(this._baseObject.measure(e,t),this.keyedBy===Cs.ENUM)t.add(1);else if(e!==Fe)t.add(e.type.length+1);else return t.unbounded;if(e===Fe){const r=Object.values(this.subTypeMap).map(n=>{const s=t.fork();for(const a of Object.values(n.properties))a.measure(Fe,s);return[n,s.size]}).reduce((n,s)=>n[1]>s[1]?n:s)[0];for(const n of Object.values(r.properties))n.measure(Fe,t)}else{const r=e.type,n=this.subTypeMap[r]||null;if(n===null)throw new Error(`Unknown sub-type '${r.toString()}', expected one of '${JSON.stringify(Object.keys(this.subTypeMap))}'`);for(const[s,a]of Rr(n.properties))a.measure(e[s],t)}return t}};function Yy(e,t){return new sh(Cs.STRING,e,t)}function Zy(e,t){return new sh(Cs.ENUM,e,t)}function Xy(e){return new $o(Object.fromEntries(e.flatMap(({properties:t})=>Object.entries(t))))}var Hy=class extends tt{constructor(e){super(),this._unstableElementType=e,ie(this,"elementType"),this.elementType=e}resolveReferences(e){this.elementType=e.resolve(this._unstableElementType)}write(e,t){e.writeUint32(t.length);for(const r of t)this.elementType.write(e,r)}read(e){const t=[],r=e.readUint32();for(let n=0;n<r;++n)t.push(this.elementType.read(e));return t}get maxSize(){return this.measure(Fe).size}measure(e,t=new Ve){if(e===Fe)return t.unbounded;t.add(4);for(const r of e)this.elementType.measure(r,t);return t}seekProperty(e,t){if(typeof t=="symbol")return null;const r=Number.parseInt(String(t),10);if(Number.isNaN(r))return null;if(e===Fe)return{bufferOffset:this.elementType.measure(Fe).size*r,schema:this.elementType};if(r>=e.length)return null;const n=new Ve;for(let s=0;s<r;++s)this.elementType.measure(e[s],n);return{bufferOffset:n.size,schema:this.elementType}}};function Ky(e){return new Hy(e)}var ah=class{constructor(e){ie(this,"__unwrapped"),ie(this,"ref"),this.ref=new by(e)}resolveReferences(){throw new Zr("Tried to resolve a reference directly. Do it through a RefResolver instead.")}read(){throw new Zr("Tried to read a reference directly. Resolve it instead.")}write(){throw new Zr("Tried to write a reference directly. Resolve it instead.")}measure(){throw new Zr("Tried to measure size of a reference directly. Resolve it instead.")}seekProperty(){throw new Zr("Tried to seek property of a reference directly. Resolve it instead.")}},Qy=class{constructor(){ie(this,"registry",{})}hasKey(e){return this.registry[e]!==void 0}register(e,t){this.registry[e]=t}resolve(e){if(e instanceof ah){const r=e.ref.key;if(this.registry[r]!==void 0)return this.registry[r];throw new Zr(`Couldn't resolve reference to ${r}. Unknown key.`)}return e.resolveReferences(this),e}},Jy=class{constructor(e,t){this.key=e,ie(this,"__unwrapped"),ie(this,"__keyDefinition"),ie(this,"innerType"),this.innerType=t(new ah(e)),this.resolveReferences(new Qy)}resolveReferences(e){e.hasKey(this.key)||(e.register(this.key,this.innerType),this.innerType.resolveReferences(e))}read(e){return this.innerType.read(e)}write(e,t){this.innerType.write(e,t)}get maxSize(){return this.measure(Fe).size}measure(e,t=new Ve){return this.innerType.measure(e,t)}seekProperty(e,t){return this.innerType.seekProperty(e,t)}};function eg(e,t){return new Jy(e,t)}var tg=class extends tt{constructor(e){super(),this._innerUnstableSchema=e,ie(this,"innerSchema"),this.innerSchema=e}resolveReferences(e){this.innerSchema=e.resolve(this._innerUnstableSchema)}write(e,t){t!=null?(e.writeBool(!0),this.innerSchema.write(e,t)):e.writeBool(!1)}read(e){if(e.readBool())return this.innerSchema.read(e)}get maxSize(){return this.measure(Fe).size}measure(e,t=new Ve){return e!==void 0&&this.innerSchema.measure(e,t),t.add(1)}};function rg(e){return new tg(e)}function ng(e,t){return t.map(r=>e.resolve(r))}var sg=class extends tt{constructor(e){super(),this._unstableSchemas=e,ie(this,"schemas"),this.schemas=e}resolveReferences(e){this.schemas=ng(e,this._unstableSchemas)}write(e,t){if(t.length!==this.schemas.length)throw new Ja(`Expected tuple of length ${this.schemas.length}, got ${t.length}`);for(let r=0;r<this.schemas.length;++r)this.schemas[r].write(e,t[r])}read(e){const t=[];for(let r=0;r<this.schemas.length;++r)t.push(this.schemas[r].read(e));return t}get maxSize(){return this.measure(Fe).size}measure(e,t=new Ve){for(let r=0;r<this.schemas.length;++r)this.schemas[r].measure(e===Fe?Fe:e[r],t);return t}};function ag(e){return new sg(e)}var Mr=class extends tt{constructor(e,t){super(),this.length=e,this._arrayConstructor=t,ie(this,"byteLength"),this.byteLength=e*t.BYTES_PER_ELEMENT}write(e,t){e.writeSlice(t)}read(e){const t=new ArrayBuffer(this.byteLength),r=new this._arrayConstructor(t,0,this.length);return e.readSlice(r,0,this.byteLength),r}measure(e,t=new Ve){return t.add(this.byteLength)}},ig=e=>new Mr(e,Uint8Array),og=e=>new Mr(e,Uint8ClampedArray),lg=e=>new Mr(e,Uint16Array),ug=e=>new Mr(e,Uint32Array),cg=e=>new Mr(e,Int8Array),hg=e=>new Mr(e,Int16Array),pg=e=>new Mr(e,Int32Array),fg=e=>new Mr(e,Float32Array),dg=e=>new Mr(e,Float64Array);function mg(){const e=new Uint8Array(4),t=new Uint32Array(e.buffer);return t[0]=1,e[0]===0}function ih(){return mg()?"big":"little"}function _o(e){let t=0,r=e;return r&&"buffer"in r&&"byteOffset"in r&&(t+=r.byteOffset,r=r.buffer),{buffer:r,byteOffset:t,byteLength:e.byteLength}}var oh=class{constructor(e,t){ie(this,"dataView"),ie(this,"littleEndian"),ie(this,"byteOffset",0),ie(this,"endianness");const{byteOffset:r=0,endianness:n="system"}=t??{};this.byteOffset=r;const s=ih();this.endianness=n==="system"?s:n,this.littleEndian=this.endianness==="little";const a=_o(e);this.byteOffset+=a.byteOffset,this.dataView=new DataView(a.buffer)}get currentByteOffset(){return this.byteOffset}seekTo(e){this.byteOffset=e}skipBytes(e){this.byteOffset+=e}};function yg(e){if(e===0)return 0;if(Number.isNaN(e))return 32256;if(!Number.isFinite(e))return e>0?31744:64512;const t=e<0?1:0,r=Math.abs(e),n=Math.floor(Math.log2(r)),s=r/2**n-1,a=n+15,i=Math.floor(s*1024);return t<<15|a<<10|i}function gg(e){const t=(e&32768)>>15,r=(e&31744)>>10,n=e&1023;return r===0?t===0?n/1024:-n/1024:r===31?n===0?t===0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:Number.NaN:(t===0?1:-1)*(1+n/1024)*2**(r-15)}var Ar=class extends oh{constructor(){super(...arguments),ie(this,"_cachedTextDecoder")}get _textDecoder(){return this._cachedTextDecoder||(this._cachedTextDecoder=new TextDecoder(void 0,{fatal:!0})),this._cachedTextDecoder}readBool(){return this.dataView.getUint8(this.byteOffset++)!==0}readByte(){return this.dataView.getUint8(this.byteOffset++)}readInt8(){return this.dataView.getInt8(this.byteOffset++)}readUint8(){return this.dataView.getUint8(this.byteOffset++)}readInt16(){const e=this.dataView.getInt16(this.byteOffset,this.littleEndian);return this.byteOffset+=2,e}readUint16(){const e=this.dataView.getUint16(this.byteOffset,this.littleEndian);return this.byteOffset+=2,e}readInt32(){const e=this.dataView.getInt32(this.byteOffset,this.littleEndian);return this.byteOffset+=4,e}readUint32(){const e=this.dataView.getUint32(this.byteOffset,this.littleEndian);return this.byteOffset+=4,e}readFloat16(){const e=this.dataView.getUint16(this.byteOffset,this.littleEndian);return this.byteOffset+=2,gg(e)}readFloat32(){const e=this.dataView.getFloat32(this.byteOffset,this.littleEndian);return this.byteOffset+=4,e}readString(){let e=0;for(;this.byteOffset+e<this.dataView.byteLength&&this.dataView.getUint8(this.byteOffset+e++)!==0;);const t=this._textDecoder.decode(new Uint8Array(this.dataView.buffer,this.byteOffset,e-1));return this.byteOffset+=e,t}readSlice(e,t,r){const n=_o(e),s=new Uint8Array(n.buffer,n.byteOffset+t);for(let a=0;a<r;++a)s[a]=this.dataView.getUint8(this.byteOffset++)}},wn=class extends oh{constructor(){super(...arguments),ie(this,"_cachedTextEncoder")}get _textEncoder(){return this._cachedTextEncoder||(this._cachedTextEncoder=new TextEncoder),this._cachedTextEncoder}writeBool(e){this.dataView.setUint8(this.byteOffset++,e?1:0)}writeByte(e){this.dataView.setUint8(this.byteOffset++,e)}writeInt8(e){this.dataView.setInt8(this.byteOffset++,e)}writeUint8(e){this.dataView.setUint8(this.byteOffset++,e)}writeInt16(e){this.dataView.setInt16(this.byteOffset,e,this.littleEndian),this.byteOffset+=2}writeUint16(e){this.dataView.setUint16(this.byteOffset,e,this.littleEndian),this.byteOffset+=2}writeInt32(e){this.dataView.setInt32(this.byteOffset,e,this.littleEndian),this.byteOffset+=4}writeUint32(e){this.dataView.setUint32(this.byteOffset,e,this.littleEndian),this.byteOffset+=4}writeFloat16(e){this.dataView.setUint16(this.byteOffset,yg(e),this.littleEndian),this.byteOffset+=2}writeFloat32(e){this.dataView.setFloat32(this.byteOffset,e,this.littleEndian),this.byteOffset+=4}writeString(e){const t=this._textEncoder.encodeInto(e,new Uint8Array(this.dataView.buffer,this.byteOffset));this.byteOffset+=t.written,this.dataView.setUint8(this.byteOffset++,0)}writeSlice(e){const t=_o(e),r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(const n of r)this.dataView.setUint8(this.byteOffset++,n)}},wg=k({name:"bitcastU32toF32",normalImpl:e=>typeof e=="number"?er(e):L.bitcastU32toF32[e.kind](e),codegenImpl:e=>x`bitcast<f32>(${e})`,signature:(...e)=>{let t=ft(e,[O])??e;return{argTypes:t,returnType:zr(t[0])?t[0].type==="vec2u"?me:t[0].type==="vec3u"?He:$:v}}}),vg=k({name:"bitcastU32toI32",normalImpl:e=>typeof e=="number"?tr(e):L.bitcastU32toI32[e.kind](e),codegenImpl:e=>x`bitcast<i32>(${e})`,signature:(...e)=>{let t=ft(e,[O])??e;return{argTypes:t,returnType:zr(t[0])?t[0].type==="vec2u"?st:t[0].type==="vec3u"?It:$e:we}}}),xg=et(e=>{let t=new ArrayBuffer(4);new wn(t).writeUint32(e);let r=new Ar(t);return me(r.readFloat16(),r.readFloat16())},e=>_(x`unpack2x16float(${e})`,me),"unpack2x16float");et(e=>{let t=new ArrayBuffer(4),r=new wn(t);r.writeFloat16(e.x),r.writeFloat16(e.y);let n=new Ar(t);return O(n.readUint32())},e=>_(x`pack2x16float(${e})`,O),"pack2x16float");et(e=>{let t=new ArrayBuffer(4);new wn(t).writeUint32(e);let r=new Ar(t);return $(r.readUint8()/255,r.readUint8()/255,r.readUint8()/255,r.readUint8()/255)},e=>_(x`unpack4x8unorm(${e})`,$),"unpack4x8unorm");et(e=>{let t=new ArrayBuffer(4),r=new wn(t);r.writeUint8(e.x*255),r.writeUint8(e.y*255),r.writeUint8(e.z*255),r.writeUint8(e.w*255);let n=new Ar(t);return O(n.readUint32())},e=>_(x`pack4x8unorm(${e})`,O),"pack4x8unorm");function cs(e){return e.type.includes("2")?dn:e.type.includes("3")?mn:yn}var bg=k({name:"allEq",signature:(...e)=>({argTypes:e,returnType:Ue}),normalImpl:(e,t)=>So(oa(e,t)),codegenImpl:(e,t)=>x`all(${e} == ${t})`}),oa=(e,t)=>L.eq[e.kind](e,t);k({name:"eq",signature:(...e)=>({argTypes:e,returnType:cs(e[0])}),normalImpl:oa,codegenImpl:(e,t)=>x`(${e} == ${t})`});k({name:"ne",signature:(...e)=>({argTypes:e,returnType:cs(e[0])}),normalImpl:(e,t)=>_r(oa(e,t)),codegenImpl:(e,t)=>x`(${e} != ${t})`});var ei=(e,t)=>L.lt[e.kind](e,t);k({name:"lt",signature:(...e)=>({argTypes:e,returnType:cs(e[0])}),normalImpl:ei,codegenImpl:(e,t)=>x`(${e} < ${t})`});k({name:"le",signature:(...e)=>({argTypes:e,returnType:cs(e[0])}),normalImpl:(e,t)=>zo(ei(e,t),oa(e,t)),codegenImpl:(e,t)=>x`(${e} <= ${t})`});k({name:"gt",signature:(...e)=>({argTypes:e,returnType:cs(e[0])}),normalImpl:(e,t)=>lh(_r(ei(e,t)),_r(oa(e,t))),codegenImpl:(e,t)=>x`(${e} > ${t})`});k({name:"ge",signature:(...e)=>({argTypes:e,returnType:cs(e[0])}),normalImpl:(e,t)=>_r(ei(e,t)),codegenImpl:(e,t)=>x`(${e} >= ${t})`});var _r=e=>L.neg[e.kind](e);k({name:"not",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:_r,codegenImpl:e=>x`!(${e})`});var zo=(e,t)=>L.or[e.kind](e,t);k({name:"or",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:zo,codegenImpl:(e,t)=>x`(${e} | ${t})`});var lh=(e,t)=>_r(zo(_r(e),_r(t)));k({name:"and",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:lh,codegenImpl:(e,t)=>x`(${e} & ${t})`});var So=e=>L.all[e.kind](e);k({name:"all",signature:(...e)=>({argTypes:e,returnType:Ue}),normalImpl:So,codegenImpl:e=>x`all(${e})`});k({name:"any",signature:(...e)=>({argTypes:e,returnType:Ue}),normalImpl:e=>!So(_r(e)),codegenImpl:e=>x`any(${e})`});k({name:"isCloseTo",signature:(...e)=>({argTypes:e,returnType:Ue}),normalImpl:(e,t,r=.01)=>typeof e=="number"&&typeof t=="number"?Math.abs(e-t)<r:Me(e)&&Me(t)?L.isCloseToZero[e.kind](ia[m].jsImpl(e,t),r):!1,codegenImpl:(e,t,r=_(.01,v))=>pa(e)&&pa(t)?x`(abs(f32(${e}) - f32(${t})) <= ${r})`:!pa(e)&&!pa(t)?x`all(abs(${e} - ${t}) <= (${e} - ${e}) + ${r})`:"false"});function Tg(e,t,r){return typeof r=="boolean"?r?t:e:L.select[e.kind](e,t,r)}k({name:"select",signature:(e,t,r)=>{let[n,s]=ft([e,t])??[e,t];return{argTypes:[n,s,r],returnType:n}},normalImpl:Tg,codegenImpl:(e,t,r)=>x`select(${e}, ${t}, ${r})`});var la={r8unorm:{channelType:v,vectorType:$,texelSize:1,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},r8snorm:{channelType:v,vectorType:$,texelSize:1,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},r8uint:{channelType:O,vectorType:Se,texelSize:1,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r8sint:{channelType:we,vectorType:$e,texelSize:1,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rg8unorm:{channelType:v,vectorType:$,texelSize:2,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rg8snorm:{channelType:v,vectorType:$,texelSize:2,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},rg8uint:{channelType:O,vectorType:Se,texelSize:2,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg8sint:{channelType:we,vectorType:$e,texelSize:2,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba8unorm:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},"rgba8unorm-srgb":{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:null},rgba8snorm:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba8uint:{channelType:O,vectorType:Se,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba8sint:{channelType:we,vectorType:$e,texelSize:4,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},bgra8unorm:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only"]},"bgra8unorm-srgb":{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:null},r16unorm:{channelType:v,vectorType:$,texelSize:2,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},r16snorm:{channelType:v,vectorType:$,texelSize:2,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},r16uint:{channelType:O,vectorType:Se,texelSize:2,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r16sint:{channelType:we,vectorType:$e,texelSize:2,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r16float:{channelType:v,vectorType:$,texelSize:2,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},rg16unorm:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16snorm:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16uint:{channelType:O,vectorType:Se,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16sint:{channelType:we,vectorType:$e,texelSize:4,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16float:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rgba16unorm:{channelType:v,vectorType:$,texelSize:8,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba16snorm:{channelType:v,vectorType:$,texelSize:8,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba16uint:{channelType:O,vectorType:Se,texelSize:8,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba16sint:{channelType:we,vectorType:$e,texelSize:8,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba16float:{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},r32uint:{channelType:O,vectorType:Se,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r32sint:{channelType:we,vectorType:$e,texelSize:4,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r32float:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rg32uint:{channelType:O,vectorType:Se,texelSize:8,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},rg32sint:{channelType:we,vectorType:$e,texelSize:8,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},rg32float:{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba32uint:{channelType:O,vectorType:Se,texelSize:16,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba32sint:{channelType:we,vectorType:$e,texelSize:16,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba32float:{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgb10a2uint:{channelType:O,vectorType:Se,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgb10a2unorm:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rg11b10ufloat:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rgb9e5ufloat:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},stencil8:{channelType:O,vectorType:Se,texelSize:1,sampleTypes:["uint"],aspects:["stencil"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},depth16unorm:{channelType:v,vectorType:$,texelSize:2,sampleTypes:["depth","unfilterable-float"],aspects:["depth"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},depth24plus:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},"depth24plus-stencil8":{channelType:v,vectorType:$,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth","stencil"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},depth32float:{channelType:v,vectorType:$,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},"depth32float-stencil8":{channelType:v,vectorType:$,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth","stencil"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},"bc1-rgba-unorm":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc1-rgba-unorm-srgb":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc2-rgba-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc2-rgba-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc3-rgba-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc3-rgba-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc4-r-unorm":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc4-r-snorm":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc5-rg-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc5-rg-snorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc6h-rgb-ufloat":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc6h-rgb-float":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc7-rgba-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc7-rgba-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8unorm":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8unorm-srgb":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8a1unorm":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8a1unorm-srgb":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgba8unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgba8unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-r11unorm":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-r11snorm":{channelType:v,vectorType:$,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-rg11unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-rg11snorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-4x4-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-4x4-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x4-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x4-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x5-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x5-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x5-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x5-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x6-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x6-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x5-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x5-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x6-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x6-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x8-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x8-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x5-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x5-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x6-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x6-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x8-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x8-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x10-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x10-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x10-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x10-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x12-unorm":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x12-unorm-srgb":{channelType:v,vectorType:$,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null}};function uh(e,t){let r=la[e];if(!r)throw new Error(`Unknown texture format: ${e}`);let n={...r};switch(e){case"r32float":case"rg32float":case"rgba32float":t.features.has("float32-filterable")||(n={...n,sampleTypes:r.sampleTypes.filter(s=>s!=="float")}),t.features.has("float32-blendable")||(n={...n,canBlend:!1});break;case"bgra8unorm":t.features.has("bgra8unorm-storage")||(n={...n,storageBindings:null});break;case"rg11b10ufloat":t.features.has("rg11b10ufloat-renderable")||(n={...n,canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1});break}if(n.storageBindings){let s=t.features.has("texture-formats-tier1"),a=t.features.has("texture-formats-tier2"),i=[...n.storageBindings],o=["r8unorm","r8uint","r8sint","r16uint","r16sint","r16float","rgba8unorm","rgba8uint","rgba8sint","rgba16uint","rgba16sint","rgba16float","r32uint","r32sint","r32float","rgba32uint","rgba32sint","rgba32float"],l=["r8snorm","rg8unorm","rg8snorm","rg8uint","rg8sint","rgba8snorm","r16unorm","r16snorm","rg16unorm","rg16snorm","rg16uint","rg16sint","rg16float","rgba16unorm","rgba16snorm","rgb10a2uint","rgb10a2unorm","rg11b10ufloat"];o.includes(e)&&!a&&(i=i.filter(u=>u!=="read-write")),l.includes(e)&&!s&&(i=i.filter(u=>u!=="write-only"&&u!=="read-only")),n={...n,storageBindings:i.length>0?i:null}}return n}var ch=["f16","clip_distances","dual_source_blending","subgroups","primitive_index"],hh={f16:"shader-f16",clip_distances:"clip-distances",dual_source_blending:"dual-source-blending",subgroups:"subgroups",primitive_index:"primitive-index"};function $g(e){return new _g(e)}var jl,_g=class{constructor(e){y(this,jl,!0);y(this,"externalsToApply",[]);this.declaration=e}$uses(e){return this.externalsToApply.push(e),this}[(jl=m,H)](e){let t={};for(let n of this.externalsToApply)Is(t,n);let r=Xa(e,t,this.declaration);return e.addDeclaration(r),_("",xt)}toString(){return`declare: ${this.declaration}`}};function ph(e){let t={argTypes:e.in&&Object.keys(e.in).length!==0?[sa(e.in)]:[],returnType:xt,workgroupSize:[e.workgroupSize[0]??1,e.workgroupSize[1]??1,e.workgroupSize[2]??1],isEntry:!0},r=(n,...s)=>zg(t,e.workgroupSize,Ha(n,...s));return Object.assign(Object.assign(r,t),{does:r})}function zg(e,t,r){let n=na(r,`@compute @workgroup_size(${t.join(", ")}) `),s=e.argTypes[0];return{shell:e,$uses(a){return n.applyExternals(a),this},[m]:!0,[Ae]:n,$name(a){return ve(n,a),qa(s)&&s.$name(`${a}_Input`),this},[H](a){return n.resolve(a,e.argTypes,e.returnType)},toString(){return`computeFn:${U(n)??"<unnamed>"}`}}}function fe(e,t){let r={[m]:!0,argTypes:e,returnType:t??xt,isEntry:!1};return Object.assign((n,...s)=>Mg(r,Ha(n,...s)),r)}function fh(e){return ye(e)&&(e==null?void 0:e.resourceType)==="function"}function Sg([e,t]){return`${U(e)??"<unnamed>"}=${t}`}function Mg(e,t){let r=na(t,""),n={shell:e,resourceType:"function",$uses(i){return r.applyExternals(i),this},[Ae]:r,$name(i){return ve(r,i),this},with(i,o){return dh(a,[[Ya(i)?i.slot:i,o]])},[H](i){return typeof t=="string"&&(ld(t,e.argTypes,r.applyExternals),Gc(t,e.returnType,r.applyExternals)),r.resolve(i,e.argTypes,e.returnType)}},s=et((...i)=>Ef(()=>{try{if(typeof t=="string")throw new Error("Cannot execute on the CPU functions constructed with raw WGSL");let o=i.map((u,c)=>Fs(e.argTypes[c],u)),l=t(...o);return Fs(e.returnType,l)}catch(o){throw o instanceof jo?o.appendToTrace(a):new jo(o,[a])}}),(...i)=>_(new mh(a,i),e.returnType),"tgpuFnCall",e.argTypes),a=Object.assign(s,n);return a[m].implementation=t,Object.defineProperty(a,"toString",{value(){return`fn:${U(r)??"<unnamed>"}`}}),a}function dh(e,t){let r={resourceType:"function",shell:e.shell,[Hr]:{inner:e,pairs:t},$uses(a){return e.$uses(a),this},[Ae]:e,$name(a){return e.$name(a),this},with(a,i){return dh(s,[...t,[Ya(a)?a.slot:a,i]])}},n=et((...a)=>e(...a),(...a)=>_(new mh(s,a),e.shell.returnType),"tgpuFnCall",e.shell.argTypes),s=Object.assign(n,r);return s[m].implementation=e[m].implementation,Object.defineProperty(s,"toString",{value(){return`fn:${U(e)??"<unnamed>"}[${t.map(Sg).join(", ")}]`}}),s[m].implementation=e[m].implementation,s}var Nl,ql,Wl,Kr,js,Yl,mh=(Yl=class{constructor(e,t){y(this,Wl,!0);y(this,ql);y(this,Nl);Y(this,Kr);Y(this,js);q(this,Kr,e),q(this,js,t),this[Ae]=e,this[bt]=_(this,w(this,Kr).shell.returnType)}[(Wl=m,ql=bt,Nl=Ae,H)](e){return e.withResetIndentLevel(()=>_(x`${e.resolve(w(this,Kr)).value}(${w(this,js)})`,w(this,Kr).shell.returnType))}toString(){return`call:${U(this)??"<unnamed>"}`}},Kr=new WeakMap,js=new WeakMap,Yl);function kg(e){let t={in:e.in,out:e.out,returnType:sa(e.out),isEntry:!0},r=(n,...s)=>Pg(t,Ha(n,...s));return Object.assign(Object.assign(r,t),{does:r})}function Pg(e,t){let r=na(t,"@fragment "),n=e.returnType;return typeof t=="string"&&Gc(t,n,s=>r.applyExternals(s)),{shell:e,outputType:n,$uses(s){return r.applyExternals(s),this},[m]:!0,[Ae]:r,$name(s){return ve(r,s),qa(n)&&n.$name(`${s}_Output`),this},[H](s){let a=e.in?sa(e.in,s.varyingLocations).$name(`${U(this)??""}_Input`):void 0;return a&&r.applyExternals({In:a}),r.applyExternals({Out:n}),r.resolve(s,a?[a]:[],e.returnType)},toString(){return`fragmentFn:${U(r)??"<unnamed>"}`}}}var yh=new Set(["alias","break","case","const","const_assert","continue","continuing","default","diagnostic","discard","else","enable","false","fn","for","if","let","loop","override","requires","return","struct","switch","true","var","while","NULL","Self","abstract","active","alignas","alignof","as","asm","asm_fragment","async","attribute","auto","await","become","cast","catch","class","co_await","co_return","co_yield","coherent","column_major","common","compile","compile_fragment","concept","const_cast","consteval","constexpr","constinit","crate","debugger","decltype","delete","demote","demote_to_helper","do","dynamic_cast","enum","explicit","export","extends","extern","external","fallthrough","filter","final","finally","friend","from","fxgroup","get","goto","groupshared","highp","impl","implements","import","inline","instanceof","interface","layout","lowp","macro","macro_rules","match","mediump","meta","mod","module","move","mut","mutable","namespace","new","nil","noexcept","noinline","nointerpolation","non_coherent","noncoherent","noperspective","null","nullptr","of","operator","package","packoffset","partition","pass","patch","pixelfragment","precise","precision","premerge","priv","protected","pub","public","readonly","ref","regardless","register","reinterpret_cast","require","resource","restrict","self","set","shared","sizeof","smooth","snorm","static","static_assert","static_cast","std","subroutine","super","target","template","this","thread_local","throw","trait","try","type","typedef","typeid","typename","typeof","union","unless","unorm","unsafe","unsized","use","using","varying","virtual","volatile","wgsl","where","with","writeonly","yield"]);function gh(e){if(e==="_"||e.startsWith("__")||/\s/.test(e))throw new Error(`Invalid identifier '${e}'. Choose an identifier without whitespaces or leading underscores.`);let t=e.split("_")[0];return!yh.has(t)}var wh=class{makeValid(e){return gh(e)?e:this.makeUnique(e)}},Bg=class extends wh{constructor(){super(...arguments);y(this,"lastUniqueId",0)}makeUnique(t){let r;return t?(r=t.replaceAll(/\s/g,"_"),r=r.replaceAll(/[^\w\d]/g,"")):r="item",`${r}_${this.lastUniqueId++}`}},Ig=class extends wh{constructor(){super(...arguments);y(this,"_usedNames",new Set(yh))}makeUnique(t){if(t===void 0)throw new Error("Unnamed item found when using a strict name registry");let r=0,n=t;for(;this._usedNames.has(n);)r++,n=`${t}_${r}`;return this._usedNames.add(n),n}};function Eg(e,t){let r=na(t,"");return{[m]:!0,[Ae]:r,resourceType:"shellless-impl",[H](n){return r.resolve(n,e,void 0)},toString(){return`fn*:${U(r)??"<unnamed>"}`}}}var Ug=class{constructor(){y(this,"cache",new Map)}get(e,t){let r=Wa(e);if(!(r!=null&&r.ast))return;if(!t&&r.ast.params.length>0)throw new Error(`Cannot resolve '${U(e)}' directly, because it expects arguments. Either call it from another function, or wrap it in a shell`);let n=(t??[]).map(i=>Gs(i.dataType)),s=this.cache.get(e);if(s){let i=s.find(o=>o.argTypes.every((l,u)=>l===n[u]));if(i)return i.value}else s=[],this.cache.set(e,s);let a=Eg(n,e);return s.push({argTypes:n,value:a}),a}},Zl,Vg=(Zl=m,class{constructor(e){y(this,Zl);this[m]={nameRegistry:e,shelllessRepo:new Ug,memoizedResolves:new WeakMap,memoizedDerived:new WeakMap,listeners:{name:new Set}}}on(e,t){if(e==="name"){let r=this[m].listeners.name;return r.add(t),()=>r.delete(t)}throw new Error(`Unsupported event: ${e}`)}});function Cg(e,t){let r=e.nameRegistry.makeUnique(U(t));for(let n of e.listeners.name)n({target:t,name:r});return r}function ua(e){let{names:t="random"}=e||{};return new Vg(t==="strict"?new Ig:new Bg)}function ti(e){return typeof(e==null?void 0:e.format)=="string"}function Rg(e,t){let r=[];if(us(e)){if(!ti(t))throw new Error("Shader expected a single attribute, not a record of attributes to be passed in.");return r.push(t._layout),{usedVertexLayouts:r,bufferDefinitions:[{arrayStride:t._layout.stride,stepMode:t._layout.stepMode,attributes:[{format:t.format,offset:t.offset,shaderLocation:Fr(e)??0}]}]}}let n=[],s=new WeakMap,a=0;for(let[i,o]of Object.entries(e)){if(ta(o))continue;let l=t[i];if(!l)throw new Error(`An attribute by the name of '${i}' was not provided to the shader.`);let u=l._layout,c=s.get(u);c||(r.push(u),c=[],n.push({arrayStride:u.stride,stepMode:u.stepMode,attributes:c}),s.set(u,c)),a=Fr(o)??a,c.push({format:l.format,offset:l.offset,shaderLocation:a++})}return{usedVertexLayouts:r,bufferDefinitions:n}}var Ag=["bool","f32","f16","i32","u32","vec2f","vec3f","vec4f","vec2h","vec3h","vec4h","vec2i","vec3i","vec4i","vec2u","vec3u","vec4u","vec2<bool>","vec3<bool>","vec4<bool>","mat2x2f","mat3x3f","mat4x4f","texture_external"];function Og(e){return Ag.includes(e.type)}function Ui(e,[t,r]){if(!gh(t))throw new Error(`Property key '${t}' is a reserved WGSL word. Choose a different name.`);return`  ${vo(r)}${t}: ${e.resolve(r).value},
`}function Fg(e,t){if(t[m].isAbstruct)throw new Error("Cannot resolve abstract struct types to WGSL.");let r=e.getUniqueName(t);return e.addDeclaration(`struct ${r} {
${Object.entries(t.propTypes).map(n=>Ui(e,n)).join("")}}`),r}function Lg(e,t){let r=e.getUniqueName(t);return e.addDeclaration(`struct ${r} {
${Object.entries(t.propTypes).map(n=>ti(n[1])?Ui(e,[n[0],Lr[n[1].format]]):Ui(e,n)).join("")}
}`),r}function Gg(e,t){let r=e.resolve(t.elementType).value;return t.elementCount===0?`array<${r}>`:`array<${r}, ${t.elementCount}>`}function Dg(e,t){let r=e.resolve(ti(t.elementType)?Lr[t.elementType.format]:t.elementType).value;return t.elementCount===0?`array<${r}>`:`array<${r}, ${t.elementCount}>`}function vh(e,t){if(Ks(t))return t.type==="unstruct"?Lg(e,t):t.type==="disarray"?Dg(e,t):t.type==="loose-decorated"?e.resolve(ti(t.inner)?Lr[t.inner.format]:t.inner).value:e.resolve(Lr[t.type]).value;if(Og(t))return t.type;if(t.type==="struct")return Fg(e,t);if(t.type==="array")return Gg(e,t);if(t.type==="atomic")return`atomic<${vh(e,t.inner)}>`;if(t.type==="decorated")return e.resolve(t.inner).value;if(t.type==="ptr")return t.addressSpace==="storage"?`ptr<storage, ${e.resolve(t.inner).value}, ${t.access==="read-write"?"read_write":t.access}>`:`ptr<${t.addressSpace}, ${e.resolve(t.inner).value}>`;if(t.type==="abstractInt"||t.type==="abstractFloat"||t.type==="void"||t.type==="u16")throw new Error(`${t.type} has no representation in WGSL`);if(Ei(t))return`${t.type}<${t.format}, ${aa[t.access]}>`;if(nm(t))return t.type.startsWith("texture_depth")?t.type:`${t.type}<${t.sampleType.type}>`;if(Nd(t)||jd(t))return t.type;is(t,"resolveData")}var xh=class Vi{constructor(t){this.bindings=t}with(t,r){return new Vi([...this.bindings,[Ya(t)?t.slot:t,r]])}pipe(t){let r=t(this);return new Vi([...this.bindings,...r.bindings])}};function*jg(e){let t=0;for(;;)e.has(t)||(yield t),t++}function Ng(e,t){let r="size"in e?e.size:e.currentByteOffset,n=t-1,s=r&n;"skipBytes"in e?e.skipBytes(t-s&n):e.add(t-s&n)}var Ze=Ng,ll=new WeakMap;function bh(e){let t=ll.get(e);if(t)return t;let r=new Ve,n={},s;for(let a in e.propTypes){let i=e.propTypes[a];if(i===void 0)throw new Error(`Property ${a} is undefined in struct`);let o=r.size;Ze(r,Gr(e)?Dt(i):Re(i)),s&&(s.padding=r.size-o);let l=le(i);n[a]={offset:r.size,size:l},s=n[a],r.add(l)}return s&&(s.padding=Pt(le(e),Re(e))-r.size),ll.set(e,n),n}var qg=(()=>{try{return new Function("return true"),!0}catch{return!1}})(),hi=new WeakMap,ga={u32:"u32",vec2u:"u32",vec3u:"u32",vec4u:"u32",u16:"u16",i32:"i32",vec2i:"i32",vec3i:"i32",vec4i:"i32",f32:"f32",vec2f:"f32",vec3f:"f32",vec4f:"f32",f16:"f16",vec2h:"f16",vec3h:"f16",vec4h:"f16",mat2x2f:"f32",mat3x3f:"f32",mat4x4f:"f32"},Wg={uint8:"u8",uint8x2:"u8",uint8x4:"u8",sint8:"i8",sint8x2:"i8",sint8x4:"i8",unorm8:"u8",unorm8x2:"u8",unorm8x4:"u8",snorm8:"i8",snorm8x2:"i8",snorm8x4:"i8",uint16:"u16",uint16x2:"u16",uint16x4:"u16",sint16:"i16",sint16x2:"i16",sint16x4:"i16",unorm16:"u16",unorm16x2:"u16",unorm16x4:"u16",snorm16:"i16",snorm16x2:"i16",snorm16x4:"i16",float16:"f16",float16x2:"f16",float16x4:"f16",float32:"f32",float32x2:"f32",float32x3:"f32",float32x4:"f32",uint32:"u32",uint32x2:"u32",uint32x3:"u32",uint32x4:"u32",sint32:"i32",sint32x2:"i32",sint32x3:"i32",sint32x4:"i32"},wa={u32:"setUint32",i32:"setInt32",f32:"setFloat32",u16:"setUint16",i16:"setInt16",f16:"setFloat16",u8:"setUint8",i8:"setInt8"},Yg={unorm8:e=>`Math.round(${e} * 255)`,unorm8x2:e=>`Math.round(${e} * 255)`,unorm8x4:e=>`Math.round(${e} * 255)`,snorm8:e=>`Math.round(${e} * 127)`,snorm8x2:e=>`Math.round(${e} * 127)`,snorm8x4:e=>`Math.round(${e} * 127)`,unorm16:e=>`Math.round(${e} * 65535)`,unorm16x2:e=>`Math.round(${e} * 65535)`,unorm16x4:e=>`Math.round(${e} * 65535)`,snorm16:e=>`Math.round(${e} * 32767)`,snorm16x2:e=>`Math.round(${e} * 32767)`,snorm16x4:e=>`Math.round(${e} * 32767)`},ul={"unorm10-10-10-2":{writeFunction:"setUint32",generator:(e,t)=>`output.setUint32(${e}, ((${t}.x*1023&0x3FF)<<22)|((${t}.y*1023&0x3FF)<<12)|((${t}.z*1023&0x3FF)<<2)|(${t}.w*3&3), littleEndian);
`},"unorm8x4-bgra":{writeFunction:"setUint8",generator:(e,t)=>{let r=["z","y","x","w"],n="";for(let s=0;s<4;s++)n+=`output.setUint8((${e} + ${s}), Math.round(${t}.${r[s]} * 255), littleEndian);
`;return n}}};function za(e,t,r,n=0){let s=["i","j","k"][n]||`i${n}`;if(wf(e)||pn(e))return za(e.inner,t,r,n);if(pt(e)||Gr(e)){let i=bh(e),o="";for(let[l,u]of Object.entries(i)){let c=e.propTypes[l];c&&(o+=za(c,`(${t} + ${u.offset})`,`${r}.${l}`,n))}return o}if(Xt(e)||ls(e)){let i=Pt(le(e.elementType),Re(e)),o="";return o+=`for (let ${s} = 0; ${s} < ${e.elementCount}; ${s}++) {
`,o+=za(e.elementType,`(${t} + ${s} * ${i})`,`${r}[${s}]`,n+1),o+=`}
`,o}if(zr(e)){let i=ga[e.type],o="",l=wa[i],u=["x","y","z","w"],c=wi(e)?2:vi(e)?3:4;for(let h=0;h<c;h++)o+=`output.${l}((${t} + ${h*4}), ${r}.${u[h]}, littleEndian);
`;return o}if(As(e)){let i=ga[e.type],o=wa[i],l=Ju(e)?2:ec(e)?3:4,u=l*l,c=Pt(l*4,8),h="";for(let f=0;f<u;f++){let d=Math.floor(f/l),p=f%l,g=d*c+p*4;h+=`output.${o}((${t} + ${g}), ${r}.columns[${d}].${["x","y","z","w"][p]}, littleEndian);
`}return h}if(Zf(e)){let i=e.type;if(i in ul)return ul[i].generator(t,r);let o=Wg[i],l=wa[o],u=Lr[i],c=Qu(u)?4:vi(u)?3:wi(u)?2:1,h=o==="u8"||o==="i8"?1:o==="u16"||o==="i16"||o==="f16"?2:4,f=["x","y","z","w"],d=Yg[i],p="";for(let g=0;g<c;g++){let z=c===1?r:`${r}.${f[g]}`,M=d?d(z):z;p+=`output.${l}((${t} + ${g*h}), ${M}, littleEndian);
`}return p}if(!Object.hasOwn(ga,e.type))throw new Error(`Primitive ${e.type} is unsupported by compiled writer`);let a=ga[e.type];return`output.${wa[a]}(${t}, ${r}, littleEndian);
`}function cl(e){if(!qg){console.warn("This environment does not allow eval - using default writer as fallback");return}if(hi.has(e))return hi.get(e);try{let t=za(e,"offset","value",0),r=new Function("output","offset","value","littleEndian=true",t);return hi.set(e,r),r}catch(t){console.warn(`Failed to compile writer for schema: ${e}
Reason: ${t instanceof Error?t.message:String(t)}
Falling back to default writer`)}}var wt={bool(){throw new Error("Booleans are not host-shareable")},f32(e,t,r){e.writeFloat32(r)},f16(e,t,r){e.writeFloat16(r)},i32(e,t,r){e.writeInt32(r)},u32(e,t,r){e.writeUint32(r)},u16(e,t,r){e.writeUint16(r)},vec2f(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y)},vec2h(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y)},vec2i(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y)},vec2u(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y)},"vec2<bool>"(){throw new Error("Booleans are not host-shareable")},vec3f(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z)},vec3h(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y),e.writeFloat16(r.z)},vec3i(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z)},vec3u(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z)},"vec3<bool>"(){throw new Error("Booleans are not host-shareable")},vec4f(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z),e.writeFloat32(r.w)},vec4h(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y),e.writeFloat16(r.z),e.writeFloat16(r.w)},vec4i(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z),e.writeInt32(r.w)},vec4u(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z),e.writeUint32(r.w)},"vec4<bool>"(){throw new Error("Booleans are not host-shareable")},mat2x2f(e,t,r){for(let n=0;n<r.length;++n)e.writeFloat32(r[n])},mat3x3f(e,t,r){for(let n=0;n<r.length;++n)e.writeFloat32(r[n])},mat4x4f(e,t,r){for(let n=0;n<r.length;++n)e.writeFloat32(r[n])},struct(e,t,r){let n=Re(t);Ze(e,n);for(let[s,a]of Object.entries(t.propTypes))Ze(e,Re(a)),Aa(e,a,r[s]);Ze(e,n)},array(e,t,r){if(t.elementCount===0)throw new Error("Cannot write using a runtime-sized schema.");let n=Re(t);Ze(e,n);let s=e.currentByteOffset;for(let a=0;a<Math.min(t.elementCount,r.length);a++)Ze(e,n),Aa(e,t.elementType,r[a]);e.seekTo(s+le(t))},ptr(){throw new Error("Pointers are not host-shareable")},atomic(e,t,r){var n;(n=wt[t.inner.type])==null||n.call(wt,e,t,r)},decorated(e,t,r){var a,i;let n=Dt(t);Ze(e,n);let s=e.currentByteOffset;(i=wt[(a=t.inner)==null?void 0:a.type])==null||i.call(wt,e,t.inner,r),e.seekTo(s+le(t))},uint8(e,t,r){e.writeUint8(r)},uint8x2(e,t,r){e.writeUint8(r.x),e.writeUint8(r.y)},uint8x4(e,t,r){e.writeUint8(r.x),e.writeUint8(r.y),e.writeUint8(r.z),e.writeUint8(r.w)},sint8(e,t,r){e.writeInt8(r)},sint8x2(e,t,r){e.writeInt8(r.x),e.writeInt8(r.y)},sint8x4(e,t,r){e.writeInt8(r.x),e.writeInt8(r.y),e.writeInt8(r.z),e.writeInt8(r.w)},unorm8(e,t,r){e.writeUint8(Math.round(r*255))},unorm8x2(e,t,r){e.writeUint8(Math.round(r.x*255)),e.writeUint8(Math.round(r.y*255))},unorm8x4(e,t,r){e.writeUint8(Math.round(r.x*255)),e.writeUint8(Math.round(r.y*255)),e.writeUint8(Math.round(r.z*255)),e.writeUint8(Math.round(r.w*255))},snorm8(e,t,r){e.writeInt8(Math.round(r*127))},snorm8x2(e,t,r){e.writeInt8(Math.round(r.x*127)),e.writeInt8(Math.round(r.y*127))},snorm8x4(e,t,r){e.writeInt8(Math.round(r.x*127)),e.writeInt8(Math.round(r.y*127)),e.writeInt8(Math.round(r.z*127)),e.writeInt8(Math.round(r.w*127))},uint16(e,t,r){e.writeUint16(r)},uint16x2(e,t,r){e.writeUint16(r.x),e.writeUint16(r.y)},uint16x4(e,t,r){e.writeUint16(r.x),e.writeUint16(r.y),e.writeUint16(r.z),e.writeUint16(r.w)},sint16(e,t,r){e.writeInt16(r)},sint16x2(e,t,r){e.writeInt16(r.x),e.writeInt16(r.y)},sint16x4(e,t,r){e.writeInt16(r.x),e.writeInt16(r.y),e.writeInt16(r.z),e.writeInt16(r.w)},unorm16(e,t,r){e.writeUint16(r*65535)},unorm16x2(e,t,r){e.writeUint16(r.x*65535),e.writeUint16(r.y*65535)},unorm16x4(e,t,r){e.writeUint16(r.x*65535),e.writeUint16(r.y*65535),e.writeUint16(r.z*65535),e.writeUint16(r.w*65535)},snorm16(e,t,r){e.writeInt16(Math.round(r*32767))},snorm16x2(e,t,r){e.writeInt16(Math.round(r.x*32767)),e.writeInt16(Math.round(r.y*32767))},snorm16x4(e,t,r){e.writeInt16(Math.round(r.x*32767)),e.writeInt16(Math.round(r.y*32767)),e.writeInt16(Math.round(r.z*32767)),e.writeInt16(Math.round(r.w*32767))},float16(e,t,r){e.writeFloat16(r)},float16x2(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y)},float16x4(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y),e.writeFloat16(r.z),e.writeFloat16(r.w)},float32(e,t,r){e.writeFloat32(r)},float32x2(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y)},float32x3(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z)},float32x4(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z),e.writeFloat32(r.w)},uint32(e,t,r){e.writeUint32(r)},uint32x2(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y)},uint32x3(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z)},uint32x4(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z),e.writeUint32(r.w)},sint32(e,t,r){e.writeInt32(r)},sint32x2(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y)},sint32x3(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z)},sint32x4(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z),e.writeInt32(r.w)},"unorm10-10-10-2"(e,t,r){let n=0;n|=(r.x*1023&1023)<<22,n|=(r.y*1023&1023)<<12,n|=(r.z*1023&1023)<<2,n|=r.w*3&3,e.writeUint32(n)},"unorm8x4-bgra"(e,t,r){e.writeUint8(r.z*255),e.writeUint8(r.y*255),e.writeUint8(r.x*255),e.writeUint8(r.w*255)},disarray(e,t,r){var a,i;let n=Re(t);Ze(e,n);let s=e.currentByteOffset;for(let o=0;o<Math.min(t.elementCount,r.length);o++)Ze(e,n),(i=wt[(a=t.elementType)==null?void 0:a.type])==null||i.call(wt,e,t.elementType,r[o]);e.seekTo(s+le(t))},unstruct(e,t,r){var s;let n=t.propTypes;for(let[a,i]of Object.entries(n))(s=wt[i.type])==null||s.call(wt,e,i,r[a])},"loose-decorated"(e,t,r){var i;let n=Dt(t);Ze(e,n);let s=e.currentByteOffset,a=wt[(i=t.inner)==null?void 0:i.type];return a==null||a(e,t.inner,r),e.seekTo(s+le(t)),r}};function Aa(e,t,r){let n=wt[t.type];if(!n)throw new Error(`Cannot write data of type '${t.type}'.`);n(e,t,r)}var Zg={bool(){throw new Error("Booleans are not host-shareable")},f32(e){return e.readFloat32()},f16(e){return e.readFloat16()},i32(e){return e.readInt32()},u32(e){return e.readUint32()},u16(e){return e.readUint16()},vec2f(e){return me(e.readFloat32(),e.readFloat32())},vec3f(e){return He(e.readFloat32(),e.readFloat32(),e.readFloat32())},vec4f(e){return $(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32())},vec2h(e){return cr(e.readFloat16(),e.readFloat16())},vec3h(e){return hr(e.readFloat16(),e.readFloat16(),e.readFloat16())},vec4h(e){return pr(e.readFloat16(),e.readFloat16(),e.readFloat16(),e.readFloat16())},vec2i(e){return st(e.readInt32(),e.readInt32())},vec3i(e){return It(e.readInt32(),e.readInt32(),e.readInt32())},vec4i(e){return $e(e.readInt32(),e.readInt32(),e.readInt32(),e.readInt32())},vec2u(e){return kt(e.readUint32(),e.readUint32())},vec3u(e){return De(e.readUint32(),e.readUint32(),e.readUint32())},vec4u(e){return Se(e.readUint32(),e.readUint32(),e.readUint32(),e.readUint32())},"vec2<bool>"(){throw new Error("Booleans are not host-shareable")},"vec3<bool>"(){throw new Error("Booleans are not host-shareable")},"vec4<bool>"(){throw new Error("Booleans are not host-shareable")},mat2x2f(e){return fr(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32())},mat3x3f(e){let t=()=>{let r=e.readFloat32();return e.readFloat32(),r};return dr(e.readFloat32(),e.readFloat32(),t(),e.readFloat32(),e.readFloat32(),t(),e.readFloat32(),e.readFloat32(),t())},mat4x4f(e){return Ne(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32())},struct(e,t){let r=Re(t);Ze(e,r);let n={},s=t.propTypes;for(let[a,i]of Object.entries(s))Ze(e,Re(i)),n[a]=ir(e,i);return Ze(e,r),n},array(e,t){if(t.elementCount===0)throw new Error("Cannot read using a runtime-sized schema.");let r=Re(t),n=[];for(let s=0;s<t.elementCount;s++){Ze(e,r);let a=t.elementType,i=ir(e,a);n.push(i)}return Ze(e,r),n},ptr(){throw new Error("Pointers are not host-shareable")},atomic(e,t){return ir(e,t.inner)},decorated(e,t){let r=Dt(t);Ze(e,r);let n=e.currentByteOffset,s=ir(e,t.inner);return e.seekTo(n+le(t)),s},uint8:e=>e.readUint8(),uint8x2:e=>kt(e.readUint8(),e.readUint8()),uint8x4:e=>Se(e.readUint8(),e.readUint8(),e.readUint8(),e.readUint8()),sint8:e=>e.readInt8(),sint8x2:e=>st(e.readInt8(),e.readInt8()),sint8x4:e=>$e(e.readInt8(),e.readInt8(),e.readInt8(),e.readInt8()),unorm8:e=>e.readUint8()/255,unorm8x2:e=>me(e.readUint8()/255,e.readUint8()/255),unorm8x4:e=>$(e.readUint8()/255,e.readUint8()/255,e.readUint8()/255,e.readUint8()/255),snorm8:e=>e.readInt8()/127,snorm8x2:e=>me(e.readInt8()/127,e.readInt8()/127),snorm8x4:e=>$(e.readInt8()/127,e.readInt8()/127,e.readInt8()/127,e.readInt8()/127),uint16:e=>e.readUint16(),uint16x2:e=>kt(e.readUint16(),e.readUint16()),uint16x4:e=>Se(e.readUint16(),e.readUint16(),e.readUint16(),e.readUint16()),sint16:e=>e.readInt16(),sint16x2:e=>st(e.readInt16(),e.readInt16()),sint16x4:e=>$e(e.readInt16(),e.readInt16(),e.readInt16(),e.readInt16()),unorm16:e=>e.readUint16()/65535,unorm16x2:e=>me(e.readUint16()/65535,e.readUint16()/65535),unorm16x4:e=>$(e.readUint16()/65535,e.readUint16()/65535,e.readUint16()/65535,e.readUint16()/65535),snorm16:e=>e.readInt16()/32767,snorm16x2:e=>me(e.readInt16()/32767,e.readInt16()/32767),snorm16x4:e=>$(e.readInt16()/32767,e.readInt16()/32767,e.readInt16()/32767,e.readInt16()/32767),float16(e){return e.readFloat16()},float16x2:e=>me(e.readFloat16(),e.readFloat16()),float16x4:e=>$(e.readFloat16(),e.readFloat16(),e.readFloat16(),e.readFloat16()),float32:e=>e.readFloat32(),float32x2:e=>me(e.readFloat32(),e.readFloat32()),float32x3:e=>He(e.readFloat32(),e.readFloat32(),e.readFloat32()),float32x4:e=>$(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32()),uint32:e=>e.readUint32(),uint32x2:e=>kt(e.readUint32(),e.readUint32()),uint32x3:e=>De(e.readUint32(),e.readUint32(),e.readUint32()),uint32x4:e=>Se(e.readUint32(),e.readUint32(),e.readUint32(),e.readUint32()),sint32:e=>e.readInt32(),sint32x2:e=>st(e.readInt32(),e.readInt32()),sint32x3:e=>It(e.readInt32(),e.readInt32(),e.readInt32()),sint32x4:e=>$e(e.readInt32(),e.readInt32(),e.readInt32(),e.readInt32()),"unorm10-10-10-2"(e){let t=e.readUint32(),r=(t>>22)/1023,n=(t>>12&1023)/1023,s=(t>>2&1023)/1023,a=(t&3)/3;return $(r,n,s,a)},"unorm8x4-bgra"(e){let t=e.readByte()/255,r=e.readByte()/255,n=e.readByte()/255,s=e.readByte()/255;return $(n,r,t,s)},unstruct(e,t){let r={},n=t.propTypes;for(let[s,a]of Object.entries(n))r[s]=ir(e,a);return r},disarray(e,t){let r=Re(t),n=[];for(let s=0;s<t.elementCount;s++)Ze(e,r),n.push(ir(e,t.elementType));return Ze(e,r),n},"loose-decorated"(e,t){Ze(e,Dt(t));let r=e.currentByteOffset,n=ir(e,t.inner);return e.seekTo(r+le(t)),n}};function ir(e,t){let r=Zg[t.type];if(!r)throw new Error(`Cannot read data of type '${t.type}'.`);return r(e,t)}function Xg(e,t){let r=le(e);if(r===0||t===void 0||t===null)return[];let n=new ArrayBuffer(r),s=new wn(n),a=[];function i(u,c,h,f){if(c!=null){if(pt(u)||Gr(u)){let d=bh(u);for(let[p,g]of Object.entries(d)){let z=u.propTypes[p];if(!z)continue;let M=c[p];M!==void 0&&i(z,M,h+g.offset,g.padding??f)}return}if(Xt(u)||ls(u)){let d=u,p=Pt(le(d.elementType),Re(d.elementType));if(!Array.isArray(c))throw new Error("Partial value for array must be an array");let g=c??[];g.sort((z,M)=>z.idx-M.idx);for(let{idx:z,value:M}of g)i(d.elementType,M,h+z*p,p-le(d.elementType))}else{let d=le(u);s.seekTo(h),Aa(s,u,c),a.push({start:h,end:h+d,padding:f})}}}if(i(e,t,0),a.length===0)return[];let o=[],l=a[0];for(let u=1;u<a.length;u++){let c=a[u];if(!c||!l)throw new Error("Internal error: missing segment");c.start===l.end+(l.padding??0)?(l.end=c.end,l.padding=c.padding):(o.push({data:new Uint8Array(n,l.start,l.end-l.start)}),l=c)}if(!l)throw new Error("Internal error: missing segment");return o.push({data:new Uint8Array(n,l.start,l.end-l.start)}),o}function Oa(e){return!!(e!=null&&e.usableAsStorage)}var hl=class Th extends Error{constructor(t){super(`Resource '${U(t)??"<unnamed>"}' cannot be bound as 'storage'. Use .$usage('storage') to allow it.`),Object.setPrototypeOf(this,Th.prototype)}};function $h(e){return!!e.usableAsUniform}var _h={uniform:"uniform",mutable:"storage, read_write",readonly:"storage, read"},Xl,Hl,Mo=class{constructor(e,t){y(this,"resourceType","buffer-usage");y(this,Hl);y(this,Xl);this.usage=e,this.buffer=t,this[m]={dataType:t.dataType},this[Ae]=t}$name(e){return this.buffer.$name(e),this}[(Hl=m,Xl=Ae,H)](e){let t=this.buffer.dataType,r=e.getUniqueName(this),{group:n,binding:s}=e.allocateFixedEntry(this.usage==="uniform"?{uniform:t}:{storage:t,access:this.usage},this.buffer),a=_h[this.usage];return e.addDeclaration(`@group(${n}) @binding(${s}) var<${a}> ${r}: ${e.resolve(t).value};`),_(r,t)}toString(){return`${this.usage}:${U(this)??"<unnamed>"}`}get[ge](){let e=this.buffer.dataType;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`${this.usage}:${U(this)??"<unnamed>"}.$`},Kt)}get $(){let e=Ua(),t=Ea();if(e.type==="normal")throw new qo(t?`Cannot access ${String(this.buffer)}. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:".$ and .value are inaccessible during normal JS execution. Try `.read()`");return e.type==="codegen"?this[ge]:e.type==="simulate"?(e.buffers.has(this.buffer)||e.buffers.set(this.buffer,Fs(this.buffer.dataType,this.buffer.initial)),e.buffers.get(this.buffer)):is(e,"bufferUsage.ts#TgpuFixedBufferImpl/$")}get value(){return this.$}set $(e){let t=Ua(),r=Ea();if(t.type==="normal")throw new qo(r?`Cannot access ${String(this.buffer)}. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:".$ and .value are inaccessible during normal JS execution. Try `.write()`");if(t.type==="codegen")throw new Error("Unreachable bufferUsage.ts#TgpuFixedBufferImpl/$");if(t.type==="simulate"){t.buffers.set(this.buffer,e);return}is(t,"bufferUsage.ts#TgpuFixedBufferImpl/$")}set value(e){this.$=e}},Kl,Wn,Ql,pl=(Ql=class{constructor(e,t,r){y(this,Kl);y(this,"resourceType","buffer-usage");Y(this,Wn);this.usage=e,this.dataType=t,this[m]={dataType:t},q(this,Wn,r),ve(this,r.key)}[(Kl=m,H)](e){let t=this.dataType,r=e.getUniqueName(this),n=e.allocateLayoutEntry(w(this,Wn).layout),s=_h[this.usage];return e.addDeclaration(`@group(${n}) @binding(${w(this,Wn).idx}) var<${s}> ${r}: ${e.resolve(t).value};`),_(r,t)}toString(){return`${this.usage}:${U(this)??"<unnamed>"}`}get[ge](){let e=this.dataType;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`${this.usage}:${U(this)??"<unnamed>"}.$`},Kt)}get $(){if(yr())return this[ge];throw new Error("Direct access to buffer values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}},Wn=new WeakMap,Ql),fl=new WeakMap;function Hg(e){if(!Oa(e))throw new Error(`Cannot pass ${e} to asMutable, as it is not allowed to be used as storage. To allow it, call .$usage('storage') when creating the buffer.`);let t=fl.get(e);return t||(t=new Mo("mutable",e),fl.set(e,t)),t}var dl=new WeakMap;function Kg(e){if(!Oa(e))throw new Error(`Cannot pass ${e} to asReadonly, as it is not allowed to be used as storage. To allow it, call .$usage('storage') when creating the buffer.`);let t=dl.get(e);return t||(t=new Mo("readonly",e),dl.set(e,t)),t}var ml=new WeakMap;function Qg(e){if(!$h(e))throw new Error(`Cannot pass ${e} to asUniform, as it is not allowed to be used as a uniform. To allow it, call .$usage('uniform') when creating the buffer.`);let t=ml.get(e);return t||(t=new Mo("uniform",e),ml.set(e,t)),t}var pi={uniform:Qg,mutable:Hg,readonly:Kg};function va(e,t,r){return hn(t)?new yl(e,t,r):new yl(e,t,r,["storage","uniform"])}function Rs(e){return e.resourceType==="buffer"}var Jg=ih(),Jl,vt,eu,yl=(Jl=m,eu=class{constructor(e,t,r,n){y(this,Jl,!0);y(this,"resourceType","buffer");y(this,"flags",GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC);Y(this,vt);y(this,"_buffer",null);y(this,"_ownBuffer");y(this,"_destroyed",!1);y(this,"_hostBuffer");y(this,"initial");y(this,"usableAsUniform",!1);y(this,"usableAsStorage",!1);y(this,"usableAsVertex",!1);y(this,"usableAsIndex",!1);this.dataType=t,this.initialOrBuffer=r,this._disallowedUsages=n,q(this,vt,e.device),zi(r)?(this._ownBuffer=!1,this._buffer=r):(this._ownBuffer=!0,this.initial=r)}get buffer(){if(this._destroyed)throw new Error("This buffer has been destroyed");return this._buffer||(this._buffer=w(this,vt).createBuffer({size:le(this.dataType),usage:this.flags,mappedAtCreation:!!this.initial,label:U(this)??"<unnamed>"}),this.initial&&(this._writeToTarget(this._buffer.getMappedRange(),this.initial),this._buffer.unmap())),this._buffer}get destroyed(){return this._destroyed}$name(e){return ve(this,e),this._buffer&&(this._buffer.label=e),this}$usage(...e){var t;for(let r of e){if((t=this._disallowedUsages)!=null&&t.includes(r))throw new Error(`Buffer of type ${this.dataType.type} cannot be used as ${r}`);this.flags|=r==="uniform"?GPUBufferUsage.UNIFORM:0,this.flags|=r==="storage"?GPUBufferUsage.STORAGE:0,this.flags|=r==="vertex"?GPUBufferUsage.VERTEX:0,this.flags|=r==="index"?GPUBufferUsage.INDEX:0,this.usableAsUniform=this.usableAsUniform||r==="uniform",this.usableAsStorage=this.usableAsStorage||r==="storage",this.usableAsVertex=this.usableAsVertex||r==="vertex",this.usableAsIndex=this.usableAsIndex||r==="index"}return this}$addFlags(e){if(!this._ownBuffer)throw new Error("Cannot add flags to a buffer that is not managed by TypeGPU.");return e&GPUBufferUsage.MAP_READ?(this.flags=GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ,this):e&GPUBufferUsage.MAP_WRITE?(this.flags=GPUBufferUsage.COPY_SRC|GPUBufferUsage.MAP_WRITE,this):(this.flags|=e,this)}compileWriter(){cl(this.dataType)}_writeToTarget(e,t){let r=cl(this.dataType);if(r)try{r(new DataView(e),0,t,Jg==="little");return}catch(n){console.error(`Error when using compiled writer for buffer ${U(this)??"<unnamed>"} - this is likely a bug, please submit an issue at https://github.com/software-mansion/TypeGPU/issues
Using fallback writer instead.`,n)}Aa(new wn(e),this.dataType,t)}write(e){let t=this.buffer;if(t.mapState==="mapped"){let n=t.getMappedRange();this._writeToTarget(n,e);return}let r=le(this.dataType);this._hostBuffer||(this._hostBuffer=new ArrayBuffer(r)),this._writeToTarget(this._hostBuffer,e),w(this,vt).queue.writeBuffer(t,0,this._hostBuffer,0,r)}writePartial(e){let t=this.buffer,r=Xg(this.dataType,e);if(t.mapState==="mapped"){let n=t.getMappedRange(),s=new Uint8Array(n);for(let a of r)s.set(a.data,a.data.byteOffset)}else for(let n of r)w(this,vt).queue.writeBuffer(t,n.data.byteOffset,n.data,0,n.data.byteLength)}clear(){let e=this.buffer;if(e.mapState==="mapped"){new Uint8Array(e.getMappedRange()).fill(0);return}let t=w(this,vt).createCommandEncoder();t.clearBuffer(e),w(this,vt).queue.submit([t.finish()])}copyFrom(e){if(this.buffer.mapState==="mapped")throw new Error("Cannot copy to a mapped buffer.");let t=le(this.dataType),r=w(this,vt).createCommandEncoder();r.copyBufferToBuffer(e.buffer,0,this.buffer,0,t),w(this,vt).queue.submit([r.finish()])}async read(){let e=this.buffer;if(e.mapState==="mapped"){let s=e.getMappedRange();return ir(new Ar(s),this.dataType)}if(e.usage&GPUBufferUsage.MAP_READ){await e.mapAsync(GPUMapMode.READ);let s=e.getMappedRange(),a=ir(new Ar(s),this.dataType);return e.unmap(),a}let t=(globalThis.__TYPEGPU_AUTONAME__??(s=>s))(w(this,vt).createBuffer({size:le(this.dataType),usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),"r"),r=w(this,vt).createCommandEncoder();r.copyBufferToBuffer(e,0,t,0,le(this.dataType)),w(this,vt).queue.submit([r.finish()]),await t.mapAsync(GPUMapMode.READ,0,le(this.dataType));let n=ir(new Ar(t.getMappedRange()),this.dataType);return t.unmap(),t.destroy(),n}as(e){var t;return(t=pi[e])==null?void 0:t.call(pi,this)}destroy(){var e;this._destroyed||(this._destroyed=!0,this._ownBuffer&&((e=this._buffer)==null||e.destroy()))}toString(){return`buffer:${U(this)??"<unnamed>"}`}},vt=new WeakMap,eu);function ew(e,t){return new Mh(Nc(),e,t)}function tw(e,t){return new Mh(qc(),e,t)}function zh(e){let t=e;return(t==null?void 0:t.resourceType)==="sampler"&&!!t[m]}function Sh(e){let t=e;return(t==null?void 0:t.resourceType)==="sampler-comparison"&&!!t[m]}var tu,Yn,ru,rw=(ru=class{constructor(e,t){y(this,tu,{unwrap:void 0});y(this,"resourceType");Y(this,Yn);this.schema=e,q(this,Yn,t),this.resourceType=e.type==="sampler_comparison"?"sampler-comparison":"sampler",ve(this,t.key)}[(tu=m,H)](e){let t=e.getUniqueName(this),r=e.allocateLayoutEntry(w(this,Yn).layout);return e.addDeclaration(`@group(${r}) @binding(${w(this,Yn).idx}) var ${t}: ${e.resolve(this.schema).value};`),_(t,this.schema)}get[ge](){let e=this.schema;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},Kt)}get $(){if(yr())return this[ge];throw new Error("Direct access to sampler values is possible only as part of a compute dispatch or draw call.")}get value(){return this.$}toString(){return`${this.resourceType}:${U(this)??"<unnamed>"}`}},Yn=new WeakMap,ru),nu,Ns,Zn,qs,Ws,su,Mh=(su=class{constructor(e,t,r){y(this,nu);y(this,"resourceType");Y(this,Ns);Y(this,Zn,null);Y(this,qs);Y(this,Ws);this.schema=e,q(this,qs,t),q(this,Ws,r),this.resourceType=e.type==="sampler_comparison"?"sampler-comparison":"sampler",this[m]={unwrap:()=>(w(this,Zn)||q(this,Zn,w(this,Ws).device.createSampler({...w(this,qs),label:U(this)??"<unnamed>"})),w(this,Zn))},q(this,Ns,t.minFilter==="linear"||t.magFilter==="linear"||t.mipmapFilter==="linear")}[(nu=m,H)](e){let t=e.getUniqueName(this),{group:r,binding:n}=e.allocateFixedEntry(this.schema.type==="sampler_comparison"?{sampler:"comparison"}:{sampler:w(this,Ns)?"filtering":"non-filtering"},this);return e.addDeclaration(`@group(${r}) @binding(${n}) var ${t}: ${e.resolve(this.schema).value};`),_(t,this.schema)}get[ge](){let e=this.schema;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},Kt)}get $(){if(yr())return this[ge];throw new Error("Direct access to sampler values is possible only as part of a compute dispatch or draw call.")}get value(){return this.$}$name(e){return ve(this,e),this}toString(){return`${this.resourceType}:${U(this)??"<unnamed>"}`}},Ns=new WeakMap,Zn=new WeakMap,qs=new WeakMap,Ws=new WeakMap,su),au,Xn,iu,nw=(iu=class{constructor(e,t){y(this,"resourceType","external-texture");y(this,au,!0);Y(this,Xn);this.schema=e,q(this,Xn,t),ve(this,t.key)}[(au=m,H)](e){let t=e.getUniqueName(this),r=e.allocateLayoutEntry(w(this,Xn).layout);return e.addDeclaration(`@group(${r}) @binding(${w(this,Xn).idx}) var ${t}: ${e.resolve(this.schema).value};`),_(t,rm())}get[ge](){let e=this.schema;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`textureExternal:${U(this)??"<unnamed>"}.$`},Kt)}get $(){if(yr())return this[ge];throw new Error("Direct access to texture views values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}toString(){return`textureExternal:${U(this)??"<unnamed>"}`}},Xn=new WeakMap,iu);function Ci(e){let{videoWidth:t,videoHeight:r}=e;if(t&&r)return{width:t,height:r};let{naturalWidth:n,naturalHeight:s}=e;if(n&&s)return{width:n,height:s};let{codedWidth:a,codedHeight:i}=e;if(a&&i)return{width:a,height:i};let{width:o,height:l}=e||HTMLCanvasElement||OffscreenCanvas||HTMLImageElement||ImageData;if(!o||!l)throw new Error("Cannot determine dimensions of the provided image source.");return{width:o,height:l}}var Ri=new WeakMap;function kh(e){let t=Ri.get(e);return t||(t=new Map,Ri.set(e,t)),t}function sw(e){let t=Ri.get(e);t&&t.clear()}function aw(e,t,r=0,n){if(t.dimension!=="2d")throw new Error("Cannot generate mipmaps for non-2D textures: only 2D textures are currently supported.");let s=n??t.mipLevelCount-r,a=uh(t.format,e);if(![...a.sampleTypes].some(i=>i==="float"||i==="unfilterable-float"))throw new Error(`Cannot generate mipmaps for format '${t.format}': only float and unfilterable-float formats are currently supported.`);if(!a.canRenderAttachment)throw new Error(`Cannot generate mipmaps for format '${t.format}': format does not support render attachments.`);for(let i=0;i<t.depthOrArrayLayers;i++)for(let o=r;o<r+s-1;o++){let l=o,u=o+1;lw(e,t,l,u,i)}}function iw(e,t,r,n){if(t.dimension==="3d")throw new Error("Cannot resample to 3D textures: only 2D textures are currently supported.");let s=la[t.format];if(![...s.sampleTypes].some(a=>a==="float"||a==="unfilterable-float"))throw new Error(`Cannot resample to format '${t.format}': only float and unfilterable-float formats are currently supported.`);if(!s.canRenderAttachment)throw new Error(`Cannot resample to format '${t.format}': format does not support render attachments.`);return ow(e,t,r,n)}function ow(e,t,r,n=0){let s=[...la[t.format].sampleTypes].includes("float"),a=`${s?"filterable":"unfilterable"}`,i=kh(e),o=i.get(a);if(!o){let z=e.createShaderModule({code:`
struct VertexOutput {
  @builtin(position) pos: vec4f,
  @location(0) uv: vec2f,
}

@vertex
fn vs_main(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
  let pos = array<vec2f, 3>(vec2f(-1, -1), vec2f(3, -1), vec2f(-1, 3));
  let uv = array<vec2f, 3>(vec2f(0, 1), vec2f(2, 1), vec2f(0, -1));

  var output: VertexOutput;
  output.pos = vec4f(pos[vertexIndex], 0, 1);
  output.uv = uv[vertexIndex];
  return output;
}
      `}),M=(globalThis.__TYPEGPU_AUTONAME__??(j=>j))(e.createSampler({magFilter:s?"linear":"nearest",minFilter:s?"linear":"nearest"}),"R"),A=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:s?"filtering":"non-filtering"}}]}),ne=e.createPipelineLayout({bindGroupLayouts:[A]}),X=e.createShaderModule({code:`
@group(0) @binding(0) var inputTexture: texture_2d<f32>;
@group(0) @binding(1) var inputSampler: sampler;

@fragment
fn fs_main(@location(0) uv: vec2f) -> @location(0) vec4f {
  ${s?"return textureSample(inputTexture, inputSampler, uv);":`let texelCoord = vec2u(uv * vec2f(textureDimensions(inputTexture)));
        return textureLoad(inputTexture, texelCoord, 0);`}
}
      `});o={vertexShader:z,fragmentShader:X,bindGroupLayout:A,pipelineLayout:ne,sampler:M},i.set(a,o)}let l=(globalThis.__TYPEGPU_AUTONAME__??(z=>z))(e.createTexture({size:[...Object.values(Ci(r))],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST}),"l"),{width:u,height:c}=Ci(r);e.queue.copyExternalImageToTexture({source:r},{texture:l},[u,c,1]);let h=(globalThis.__TYPEGPU_AUTONAME__??(z=>z))(e.createTexture({size:[t.width,t.height,1],format:t.format,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),"f"),f=e.createRenderPipeline({layout:o.pipelineLayout,vertex:{module:o.vertexShader},fragment:{module:o.fragmentShader,targets:[{format:t.format}]},primitive:{topology:"triangle-list"}}),d=e.createBindGroup({layout:o.bindGroupLayout,entries:[{binding:0,resource:l.createView()},{binding:1,resource:o.sampler}]}),p=e.createCommandEncoder(),g=p.beginRenderPass({colorAttachments:[{view:h.createView(),loadOp:"clear",storeOp:"store"}]});g.setPipeline(f),g.setBindGroup(0,d),g.draw(3),g.end(),p.copyTextureToTexture({texture:h},{texture:t,origin:{x:0,y:0,z:n}},{width:t.width,height:t.height,depthOrArrayLayers:1}),e.queue.submit([p.finish()]),l.destroy(),h.destroy()}function lw(e,t,r,n,s){let a=[...uh(t.format,e).sampleTypes].includes("float"),i=`${a?"filterable":"unfilterable"}`,o=kh(e),l=o.get(i);if(!l){let g=e.createShaderModule({code:`
struct VertexOutput {
  @builtin(position) pos: vec4f,
  @location(0) uv: vec2f,
}

@vertex
fn vs_main(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
  let pos = array<vec2f, 3>(vec2f(-1, -1), vec2f(3, -1), vec2f(-1, 3));
  let uv = array<vec2f, 3>(vec2f(0, 1), vec2f(2, 1), vec2f(0, -1));

  var output: VertexOutput;
  output.pos = vec4f(pos[vertexIndex], 0, 1);
  output.uv = uv[vertexIndex];
  return output;
}
      `}),z=e.createShaderModule({code:`
@group(0) @binding(0) var inputTexture: texture_2d<f32>;
@group(0) @binding(1) var inputSampler: sampler;

@fragment
fn fs_main(@location(0) uv: vec2f) -> @location(0) vec4f {
  return textureSample(inputTexture, inputSampler, uv);
}
      `}),M=(globalThis.__TYPEGPU_AUTONAME__??(X=>X))(e.createSampler({magFilter:a?"linear":"nearest",minFilter:a?"linear":"nearest"}),"R"),A=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:a?"float":"unfilterable-float"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:a?"filtering":"non-filtering"}}]}),ne=e.createPipelineLayout({bindGroupLayouts:[A]});l={vertexShader:g,fragmentShader:z,bindGroupLayout:A,pipelineLayout:ne,sampler:M},o.set(i,l)}let u=e.createRenderPipeline({layout:l.pipelineLayout,vertex:{module:l.vertexShader},fragment:{module:l.fragmentShader,targets:[{format:t.format}]},primitive:{topology:"triangle-list"}}),c=t.createView({baseMipLevel:r,dimension:"2d",mipLevelCount:1,...s!==void 0&&{baseArrayLayer:s,arrayLayerCount:1}}),h=t.createView({baseMipLevel:n,dimension:"2d",mipLevelCount:1,...s!==void 0&&{baseArrayLayer:s,arrayLayerCount:1}}),f=e.createBindGroup({layout:l.bindGroupLayout,entries:[{binding:0,resource:c},{binding:1,resource:l.sampler}]}),d=e.createCommandEncoder(),p=d.beginRenderPass({colorAttachments:[{view:h,loadOp:"clear",storeOp:"store"}]});p.setPipeline(u),p.setBindGroup(0,f),p.draw(3),p.end(),e.queue.submit([d.finish()])}function uw(e){return{dimension:e.dimension??"2d",sampleType:la[e.format].channelType,multisampled:(e.sampleCount??1)!==1}}function cw(e){return e==="depth24plus-stencil8"||e==="depth32float-stencil8"?["depth","stencil"]:e==="depth16unorm"||e==="depth24plus"||e==="depth32float"?["depth"]:e==="stencil8"?["stencil"]:["color"]}function hw(e,t){return new pw(e,t)}function Ds(e){return(e==null?void 0:e.resourceType)==="texture"&&!!e[m]}function Fa(e){return(e==null?void 0:e.resourceType)==="texture-view"&&!!e[m]}var ou,xr,ja,Qr,Jr,en,qt,mr,Ai,Ph,Oi,lu,pw=(ou=m,lu=class{constructor(e,t){Y(this,mr);y(this,ou);y(this,"resourceType","texture");y(this,"aspects");y(this,"usableAsSampled",!1);y(this,"usableAsStorage",!1);y(this,"usableAsRender",!1);Y(this,xr);Y(this,ja);Y(this,Qr,!1);Y(this,Jr,GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC);Y(this,en,null);Y(this,qt);this.props=e;let r=e.format;q(this,qt,t),q(this,xr,la[r]),q(this,ja,e.size[0]*(e.size[1]??1)*(e.size[2]??1)*w(this,xr).texelSize),this.aspects=cw(r),this[m]={unwrap:()=>{if(w(this,Qr))throw new Error("This texture has been destroyed");return w(this,en)||q(this,en,t.device.createTexture({label:U(this)??"<unnamed>",format:e.format,size:e.size,usage:w(this,Jr),dimension:e.dimension??"2d",viewFormats:e.viewFormats??[],mipLevelCount:e.mipLevelCount??1,sampleCount:e.sampleCount??1})),w(this,en)}}}$name(e){return ve(this,e),this}$usage(...e){let t=e.includes("storage"),r=e.includes("sampled"),n=e.includes("render");return q(this,Jr,w(this,Jr)|(r?GPUTextureUsage.TEXTURE_BINDING:0)),q(this,Jr,w(this,Jr)|(t?GPUTextureUsage.STORAGE_BINDING:0)),q(this,Jr,w(this,Jr)|(n?GPUTextureUsage.RENDER_ATTACHMENT:0)),this.usableAsStorage||(this.usableAsStorage=t),this.usableAsSampled||(this.usableAsSampled=r),this.usableAsRender||(this.usableAsRender=n),this}createView(e,t){return new fw(e??Ii(uw(this.props)),this,t)}clear(e="all"){if(e==="all"){let t=this.props.mipLevelCount??1;for(let r=0;r<t;r++)Br(this,mr,Ai).call(this,r)}else Br(this,mr,Ai).call(this,e)}generateMipmaps(e=0,t){if(this.usableAsRender===!1)throw new Error("generateMipmaps called without specifying 'render' usage. Add it via the $usage('render') method.");let r=t??(this.props.mipLevelCount??1)-e;if(r<=1){console.warn(`generateMipmaps is a no-op: would generate ${r} mip levels (base: ${e}, total: ${this.props.mipLevelCount??1})`);return}if(e>=(this.props.mipLevelCount??1))throw new Error(`Base mip level ${e} is out of range. Texture has ${this.props.mipLevelCount??1} mip levels.`);aw(w(this,qt).device,this[m].unwrap(),e,r)}write(e,t=0){if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){Br(this,mr,Ph).call(this,e,t);return}let r=this.props.dimension??"2d";if(!Array.isArray(e)){Br(this,mr,Oi).call(this,e,r==="3d"?0:void 0);return}let n=this.props.size[2]??1;e.length>n&&console.warn(`Too many image sources provided. Expected ${n} layers, got ${e.length}. Extra sources will be ignored.`);for(let s=0;s<Math.min(e.length,n);s++){let a=e[s];a&&Br(this,mr,Oi).call(this,a,s)}}copyFrom(e){if(e.props.format!==this.props.format)throw new Error(`Texture format mismatch. Source texture has format ${e.props.format}, target texture has format ${this.props.format}`);if(e.props.size[0]!==this.props.size[0]||(e.props.size[1]??1)!==(this.props.size[1]??1)||(e.props.size[2]??1)!==(this.props.size[2]??1))throw new Error(`Texture size mismatch. Source texture has size ${e.props.size.join("x")}, target texture has size ${this.props.size.join("x")}`);let t=w(this,qt).device.createCommandEncoder();t.copyTextureToTexture({texture:e[m].unwrap()},{texture:this[m].unwrap()},e.props.size),w(this,qt).device.queue.submit([t.finish()])}get destroyed(){return w(this,Qr)}destroy(){var e;w(this,Qr)||(q(this,Qr,!0),(e=w(this,en))==null||e.destroy())}},xr=new WeakMap,ja=new WeakMap,Qr=new WeakMap,Jr=new WeakMap,en=new WeakMap,qt=new WeakMap,mr=new WeakSet,Ai=function(e=0){let t=2**e,[r,n,s]=[Math.max(1,Math.floor((this.props.size[0]??1)/t)),Math.max(1,Math.floor((this.props.size[1]??1)/t)),Math.max(1,Math.floor((this.props.size[2]??1)/t))];w(this,qt).device.queue.writeTexture({texture:this[m].unwrap(),mipLevel:e},new Uint8Array(r*n*s*w(this,xr).texelSize),{bytesPerRow:w(this,xr).texelSize*r,rowsPerImage:n},[r,n,s])},Ph=function(e,t){let r=Math.max(1,this.props.size[0]>>t),n=Math.max(1,(this.props.size[1]??1)>>t),s=Math.max(1,(this.props.size[2]??1)>>t),a=r*n*s*w(this,xr).texelSize,i=e.byteLength??e.byteLength;if(i!==a)throw new Error(`Buffer size mismatch. Expected ${a} bytes for mip level ${t}, got ${i} bytes.`);w(this,qt).device.queue.writeTexture({texture:this[m].unwrap(),mipLevel:t},e,{bytesPerRow:w(this,xr).texelSize*r,rowsPerImage:n},[r,n,s])},Oi=function(e,t){let r=this.props.size[0],n=this.props.size[1]??1,{width:s,height:a}=Ci(e);if(s!==r||a!==n){iw(w(this,qt).device,this[m].unwrap(),e,t);return}w(this,qt).device.queue.copyExternalImageToTexture({source:e},{texture:this[m].unwrap(),...t!==void 0&&{origin:{x:0,y:0,z:t}}},t!==void 0?[r,n,1]:this.props.size)},lu),uu,Hn,Er,Wt,cu,fw=(cu=class{constructor(e,t,r){y(this,uu);y(this,"resourceType","texture-view");Y(this,Hn);Y(this,Er);Y(this,Wt);this.schema=e,q(this,Hn,t),q(this,Wt,r),this[m]={unwrap:()=>{var n,s,a,i;if(!w(this,Er)){let o=this.schema,l;Ei(o)?l={label:U(this)??"<unnamed>",format:((n=w(this,Wt))==null?void 0:n.format)??o.format,dimension:o.dimension}:l={label:U(this)??"<unnamed>",format:((s=w(this,Wt))==null?void 0:s.format)??w(this,Hn).props.format,dimension:o.dimension},((a=w(this,Wt))==null?void 0:a.mipLevelCount)!==void 0&&(l.mipLevelCount=w(this,Wt).mipLevelCount),((i=w(this,Wt))==null?void 0:i.arrayLayerCount)!==void 0&&(l.arrayLayerCount=w(this,Wt).arrayLayerCount),q(this,Er,w(this,Hn)[m].unwrap().createView(l))}return w(this,Er)}}}$name(e){return ve(this,e),w(this,Er)&&(w(this,Er).label=e),this}get[(uu=m,ge)](){let e=this.schema;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},Kt)}get $(){if(yr())return this[ge];throw new Error("Direct access to texture view values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}toString(){return`textureView:${U(this)??"<unnamed>"}`}[H](e){var s;let t=e.getUniqueName(this),{group:r,binding:n}=e.allocateFixedEntry(Ei(this.schema)?{storageTexture:this.schema}:{texture:this.schema,sampleType:((s=w(this,Wt))==null?void 0:s.sampleType)??this.schema.bindingSampleType[0]},this);return e.addDeclaration(`@group(${r}) @binding(${n}) var ${t}: ${e.resolve(this.schema).value};`),_(t,this.schema)}},Hn=new WeakMap,Er=new WeakMap,Wt=new WeakMap,cu),hu,Kn,pu,gl=(pu=class{constructor(e,t){y(this,hu,{unwrap:void 0});y(this,"resourceType","texture-view");Y(this,Kn);this.schema=e,q(this,Kn,t),ve(this,t.key)}toString(){return`textureView:${U(this)??"<unnamed>"}`}[(hu=m,H)](e){let t=e.getUniqueName(this),r=e.allocateLayoutEntry(w(this,Kn).layout);return e.addDeclaration(`@group(${r}) @binding(${w(this,Kn).idx}) var ${t}: ${e.resolve(this.schema).value};`),_(t,this.schema)}get[ge](){let e=this.schema;return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},Kt)}get $(){if(yr())return this[ge];throw new Error("Direct access to texture views values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}},Kn=new WeakMap,pu);function dw(e){return!!(e!=null&&e.usableAsSampled)}var mw=class Bh extends Error{constructor(t){super(`Resource '${U(t)??"<unnamed>"}' cannot be bound as 'sampled'. Use .$usage('sampled') to allow it.`),Object.setPrototypeOf(this,Bh.prototype)}};function yw(e){let t={};for(let[r,n]of Object.entries(e)){if(n===null){t[r]=null;continue}if("texture"in n&&typeof n.texture=="string"){let s=n.texture;t[r]={...n,texture:Ii({dimension:n.viewDimension??"2d",sampleType:s==="sint"?we:s==="uint"?O:v,multisampled:n.multisampled??!1})}}else if("storageTexture"in n&&typeof n.storageTexture=="string"){let s={readonly:"read-only",writeonly:"write-only",mutable:"read-write"};t[r]={...n,storageTexture:Ii({access:s[n.access??"writeonly"],format:n.storageTexture,dimension:n.viewDimension??"2d"})}}else"externalTexture"in n&&Object.keys(n.externalTexture).length===0?t[r]={...n,externalTexture:{type:"texture_external",dimension:"2d"}}:t[r]=n}return t}function Ih(e){let t=yw(e);return new ww(t)}function Eh(e){return!!e&&e.resourceType==="bind-group-layout"}function La(e){return!!e&&e.resourceType==="bind-group"}var gw=class Uh extends Error{constructor(t,r){super(`Bind group '${t??"<unnamed>"}' is missing a required binding '${r}'`),Object.setPrototypeOf(this,Uh.prototype)}},wl=["compute","fragment"],bs=["compute","vertex","fragment"],fu,ww=class{constructor(e){y(this,fu,!0);y(this,"_index");y(this,"resourceType","bind-group-layout");y(this,"bound",{});y(this,"value",{});y(this,"$",this.value);this.entries=e;let t=0;for(let[r,n]of Object.entries(e)){if(n===null){t++;continue}let s={layout:this,key:r,idx:t};if("uniform"in n&&(this.bound[r]=new pl("uniform",n.uniform,s)),"storage"in n){let a="type"in n.storage?n.storage:n.storage(0);this.bound[r]=new pl(n.access??"readonly",a,s)}"texture"in n&&(this.bound[r]=new gl(n.texture,s)),"storageTexture"in n&&(this.bound[r]=new gl(n.storageTexture,s)),"externalTexture"in n&&(this.bound[r]=new nw(n.externalTexture,s)),"sampler"in n&&(this.bound[r]=new rw(n.sampler==="comparison"?qc():Nc(),s)),Object.defineProperty(this.value,r,{get:()=>this.bound[r].value}),t++}}get[(fu=m,ge)](){return this.$}toString(){return`bindGroupLayout:${U(this)??"<unnamed>"}`}get index(){return this._index}$name(e){return ve(this,e),this}$idx(e){return this._index=e,this}unwrap(e){return e.device.createBindGroupLayout({label:U(this)??"<unnamed>",entries:Object.values(this.entries).map((t,r)=>{if(t===null)return null;let n=t.visibility,s={binding:r,visibility:0};if("uniform"in t)n=n??bs,s.buffer={type:"uniform"};else if("storage"in t)n=n??(t.access==="mutable"?wl:bs),s.buffer={type:t.access==="mutable"?"storage":"read-only-storage"};else if("sampler"in t)n=n??bs,s.sampler={type:t.sampler};else if("texture"in t){n=n??bs;let{multisampled:a,dimension:i,bindingSampleType:o}=t.texture;s.texture={sampleType:t.sampleType??o[0],viewDimension:i,multisampled:a}}else if("storageTexture"in t){n=n??wl;let{dimension:a,access:i,format:o}=t.storageTexture;s.storageTexture={access:i,format:o,viewDimension:a}}else"externalTexture"in t&&(n=n??bs,s.externalTexture={});return n!=null&&n.includes("compute")&&(s.visibility|=GPUShaderStage.COMPUTE),n!=null&&n.includes("vertex")&&(s.visibility|=GPUShaderStage.VERTEX),n!=null&&n.includes("fragment")&&(s.visibility|=GPUShaderStage.FRAGMENT),s}).filter(t=>t!==null)})}},Vh=class{constructor(e,t){y(this,"resourceType","bind-group");this.layout=e,this.entries=t;for(let r of Object.keys(e.entries))if(e.entries[r]!==null&&!(r in t))throw new gw(U(e),r)}unwrap(e){return e.device.createBindGroup({label:U(this.layout)??"<unnamed>",layout:e.unwrap(this.layout),entries:Object.entries(this.layout.entries).map(([t,r],n)=>{if(r===null)return null;let s=this.entries[t];if(s===void 0)throw new Error(`'${t}' is a resource required to populate bind group layout '${U(this.layout)??"<unnamed>"}'.`);if("uniform"in r){let a;if(Rs(s)){if(!$h(s))throw new Mf(s);a={buffer:e.unwrap(s)}}else a={buffer:s};return{binding:n,resource:a}}if("storage"in r){let a;if(Rs(s)){if(!Oa(s))throw new hl(s);a={buffer:e.unwrap(s)}}else a={buffer:s};return{binding:n,resource:a}}if("texture"in r){let a;if(Ds(s)){if(!dw(s))throw new mw(s);a=e.unwrap(s.createView(r.texture))}else Fa(s)?a=e.unwrap(s):a=s;return{binding:n,resource:a}}if("storageTexture"in r){let a;if(Ds(s)){if(!Oa(s))throw new hl(s);a=e.unwrap(s.createView(r.storageTexture))}else Fa(s)?a=e.unwrap(s):a=s;return{binding:n,resource:a}}if("sampler"in r)return Sh(s)||zh(s)?{binding:n,resource:e.unwrap(s)}:{binding:n,resource:s};if("externalTexture"in r)return{binding:n,resource:s};throw new Error(`Malformed bind group entry: ${Os(s)}`)}).filter(t=>t!==null)})}};function Ga(e){return new vw(e)}var du,vw=class{constructor(e=void 0){y(this,du,!0);y(this,"resourceType","slot");this.defaultValue=e}$name(e){return ve(this,e),this}areEqual(e,t){return Object.is(e,t)}toString(){return`slot:${U(this)??"<unnamed>"}`}get[(du=m,ge)](){let e=un();if(!e)throw new Error("Cannot access tgpu.slot's value outside of resolution.");return Ka(e.unwrap(this))}get value(){return this[ge]}get $(){return this.value}};function Da(e,t){return new Ch("private",e,t)}function vl(e){return new Ch("workgroup",e)}var mu,br,Ur,tn,yu,Ch=(yu=class{constructor(e,t,r){y(this,mu,{});Y(this,br);Y(this,Ur);Y(this,tn);q(this,br,e),q(this,Ur,t),q(this,tn,r)}[(mu=m,H)](e){let t=e.getUniqueName(this),r=`var<${w(this,br)}> ${t}: ${e.resolve(w(this,Ur)).value}`;return w(this,tn)?e.addDeclaration(`${r} = ${e.resolve(w(this,tn),w(this,Ur)).value};`):e.addDeclaration(`${r};`),_(t,w(this,Ur))}$name(e){return ve(this,e),this}toString(){return`var:${U(this)??"<unnamed>"}`}get[ge](){let e=w(this,Ur);return new Proxy({[m]:!0,get[bt](){return _(this,e)},[H]:t=>t.resolve(this),toString:()=>`var:${U(this)??"<unnamed>"}.$`},Kt)}get $(){let e=Ua(),t=Ea();if(e.type==="normal")throw new No(t?`Cannot access variable '${U(this)??"<unnamed>"}'. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:"TypeGPU variables are inaccessible during normal JS execution. If you wanted to simulate GPU behavior, try `tgpu.simulate()`");return e.type==="codegen"?this[ge]:e.type==="simulate"?(e.vars[w(this,br)].has(this)||e.vars[w(this,br)].set(this,w(this,tn)),e.vars[w(this,br)].get(this)):is(e,"tgpuVariable.ts#TgpuVarImpl/$")}set $(e){let t=Ua(),r=Ea();if(t.type==="normal")throw new No(r?`Cannot access ${String(this)}. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:"TypeGPU variables are inaccessible during normal JS execution. If you wanted to simulate GPU behavior, try `tgpu.simulate()`");if(t.type==="codegen")throw new Error("Unreachable tgpuVariable.ts#TgpuVarImpl/$");if(t.type==="simulate"){t.vars[w(this,br)].set(this,e);return}is(t,"tgpuVariable.ts#TgpuVarImpl/$")}get value(){return this.$}set value(e){this.$=e}},br=new WeakMap,Ur=new WeakMap,tn=new WeakMap,yu),Rh=Da(O,0).$name("dataBlockIndex"),Ah=Da(O,0).$name("dataByteIndex"),Oh=Ga().$name("dataBuffer"),xw=fe([],O)`() {
  let i = dataByteIndex;
  dataByteIndex = dataByteIndex + 1u;
  return i;
}`.$uses({dataByteIndex:Ah}).$name("nextByteIndex"),B="dataBuffer[dataBlockIndex].serializedData[nextByteIndex()]",Fh={f32:fe([v])`(n) => {
  ${B} = bitcast<u32>(n);
}`,f16:fe([je])`(n) => {
  ${B} = pack2x16float(vec2f(f32(n), 0.0));
}`,i32:fe([we])`(n) => {
  ${B} = bitcast<u32>(n);
}`,u32:fe([O])`(n) => {
  ${B} = n;
}`,bool:fe([Ue])`(b) => {
  ${B} = u32(b);
}`,vec2f:fe([me])`(v) => {
  ${B} = bitcast<u32>(v.x);
  ${B} = bitcast<u32>(v.y);
}`,vec3f:fe([He])`(v) => {
  ${B} = bitcast<u32>(v.x);
  ${B} = bitcast<u32>(v.y);
  ${B} = bitcast<u32>(v.z);
}`,vec4f:fe([$])`(v) => {
  ${B} = bitcast<u32>(v.x);
  ${B} = bitcast<u32>(v.y);
  ${B} = bitcast<u32>(v.z);
  ${B} = bitcast<u32>(v.w);
}`,vec2h:fe([cr])`(v) => {
  ${B} = pack2x16float(vec2f(f32(v.x), f32(v.y)));
}`,vec3h:fe([hr])`(v) => {
  ${B} = pack2x16float(vec2f(f32(v.x), f32(v.y)));
  ${B} = pack2x16float(vec2f(f32(v.z), 0.0));
}`,vec4h:fe([pr])`(v) => {
  ${B} = pack2x16float(vec2f(f32(v.x), f32(v.y)));
  ${B} = pack2x16float(vec2f(f32(v.z), f32(v.w)));
}`,vec2i:fe([st])`(v) => {
  ${B} = bitcast<u32>(v.x);
  ${B} = bitcast<u32>(v.y);
}`,vec3i:fe([It])`(v) => {
  ${B} = bitcast<u32>(v.x);
  ${B} = bitcast<u32>(v.y);
  ${B} = bitcast<u32>(v.z);
}`,vec4i:fe([$e])`(v) => {
  ${B} = bitcast<u32>(v.x);
  ${B} = bitcast<u32>(v.y);
  ${B} = bitcast<u32>(v.z);
  ${B} = bitcast<u32>(v.w);
}`,vec2u:fe([kt])`(v) => {
  ${B} = v.x;
  ${B} = v.y;
}`,vec3u:fe([De])`(v) => {
  ${B} = v.x;
  ${B} = v.y;
  ${B} = v.z;
}`,vec4u:fe([Se])`(v) => {
  ${B} = v.x;
  ${B} = v.y;
  ${B} = v.z;
  ${B} = v.w;
}`,"vec2<bool>":fe([dn])`(v) => {
  ${B} = u32(v.x);
  ${B} = u32(v.y);
}`,"vec3<bool>":fe([mn])`(v) => {
  ${B} = u32(v.x);
  ${B} = u32(v.y);
  ${B} = u32(v.z);
}`,"vec4<bool>":fe([yn])`(v) => {
  ${B} = u32(v.x);
  ${B} = u32(v.y);
  ${B} = u32(v.z);
  ${B} = u32(v.w);
}`,mat2x2f:fe([fr])`(m) => {
  ${B} = bitcast<u32>(m[0][0]);
  ${B} = bitcast<u32>(m[0][1]);
  ${B} = bitcast<u32>(m[1][0]);
  ${B} = bitcast<u32>(m[1][1]);
}`,mat3x3f:fe([dr])`(m) => {
  ${B} = bitcast<u32>(m[0][0]);
  ${B} = bitcast<u32>(m[0][1]);
  ${B} = bitcast<u32>(m[0][2]);
  ${B} = 0u;
  ${B} = bitcast<u32>(m[1][0]);
  ${B} = bitcast<u32>(m[1][1]);
  ${B} = bitcast<u32>(m[1][2]);
  ${B} = 0u;
  ${B} = bitcast<u32>(m[2][0]);
  ${B} = bitcast<u32>(m[2][1]);
  ${B} = bitcast<u32>(m[2][2]);
  ${B} = 0u;
}`,mat4x4f:fe([Ne])`(m) => {
  ${B} = bitcast<u32>(m[0][0]);
  ${B} = bitcast<u32>(m[0][1]);
  ${B} = bitcast<u32>(m[0][2]);
  ${B} = bitcast<u32>(m[0][3]);
  ${B} = bitcast<u32>(m[1][0]);
  ${B} = bitcast<u32>(m[1][1]);
  ${B} = bitcast<u32>(m[1][2]);
  ${B} = bitcast<u32>(m[1][3]);
  ${B} = bitcast<u32>(m[2][0]);
  ${B} = bitcast<u32>(m[2][1]);
  ${B} = bitcast<u32>(m[2][2]);
  ${B} = bitcast<u32>(m[2][3]);
  ${B} = bitcast<u32>(m[3][0]);
  ${B} = bitcast<u32>(m[3][1]);
  ${B} = bitcast<u32>(m[3][2]);
  ${B} = bitcast<u32>(m[3][3]);
}`};for(let[e,t]of Object.entries(Fh))t.$name(`serialize${e[0].toLocaleUpperCase()}${e.slice(1)}`).$uses({dataBlockIndex:Rh,nextByteIndex:xw,dataBuffer:Oh});function Lh(e){return`(${e.map((t,r)=>`_arg_${r}`).join(", ")})`}function Gh(e,t){let r=Fh[e.type];if(r)return r.with(Oh,t);if(pt(e)){let n=Object.keys(e.propTypes),s=Object.values(e.propTypes),a=Dh(s,t);return fe([e])`(arg) {\n  propsSerializer(${n.map(i=>`arg.${i}`).join(", ")});\n}`.$uses({propsSerializer:a}).$name(`${U(e)??"struct"}Serializer`)}if(Xt(e)){let n=e.elementType,s=e.elementCount,a=Gh(n,t);return fe([e])`(arg) {\n${Array.from({length:s},(i,o)=>`  elementSerializer(arg[${o}]);`).join(`
`)}\n}`.$uses({elementSerializer:a}).$name("arraySerializer")}throw new Error(`Cannot serialize data of type ${e.type}`)}function Dh(e,t){let r={},n=fe(e),s=Lh(e),a=e.map((i,o)=>(r[`serializer${o}`]=Gh(i,t),`  serializer${o}(_arg_${o});`)).join(`
`);return n`${s} {\n${a}\n}`.$uses(r).$name("compoundSerializer")}function bw(e,t,r,n,s){let a=t.map(le).reduce((l,u)=>l+u,0);if(a>s.logSizeLimit)throw new Error(`Logged data needs to fit in ${s.logSizeLimit} bytes (one of the logs requires ${a} bytes). Consider increasing the limit by passing appropriate options to tgpu.init().`);let i=Dh(t,r).$name(`log${e}serializer`),o=Lh(t);return fe(t)`${o} {
  dataBlockIndex = atomicAdd(&indexBuffer, 1);
  if (dataBlockIndex >= ${s.logCountLimit}) {
    return;
  }
  dataBuffer[dataBlockIndex].id = ${e};
  dataByteIndex = 0;

  compoundSerializer${o};
}`.$uses({indexBuffer:n,dataBuffer:r,dataBlockIndex:Rh,dataByteIndex:Ah,compoundSerializer:i}).$name(`log${e}`)}var Tw=["log","debug","info","warn","error","clear"],$w={logCountLimit:64,logSizeLimit:252,messagePrefix:" GPU "},jh=_("/* console.log() */",xt),_w=class{get logResources(){}generateLog(){return console.warn("'console.log' is currently only supported in compute pipelines."),jh}},Vr,Qn,Ys,Jn,es,gu,zw=(gu=class{constructor(e){Y(this,Vr);Y(this,Qn);Y(this,Ys,1);Y(this,Jn);Y(this,es);q(this,Vr,{...$w,...e[m].logOptions}),q(this,Qn,new Map);let t=ra({id:O,serializedData:Ls(O,Math.ceil(w(this,Vr).logSizeLimit/4))}).$name("SerializedLogData");q(this,es,e.createMutable(Ls(t,w(this,Vr).logCountLimit)).$name("dataBuffer")),q(this,Jn,e.createMutable(sm(O)).$name("indexBuffer"))}generateLog(e,t,r){if(!Tw.includes(t))return console.warn(`Unsupported log method '${t}' was used in TGSL.`),jh;let n=Gd(r),s=Eo(this,Ys)._++,a=n.filter(l=>l.dataType!==ht),i=bw(s,a.map(l=>l.dataType),w(this,es),w(this,Jn),w(this,Vr)),o=n.map(l=>l.dataType===ht?l.value:l.dataType);return w(this,Qn).set(s,{op:t,argTypes:o}),_(x`${e.resolve(i).value}(${a})`,xt)}get logResources(){return w(this,Ys)===1?void 0:{dataBuffer:w(this,es),indexBuffer:w(this,Jn),options:w(this,Vr),logIdToMeta:w(this,Qn)}}},Vr=new WeakMap,Qn=new WeakMap,Ys=new WeakMap,Jn=new WeakMap,es=new WeakMap,gu),Nh="#CATCHALL#",Sw=class{constructor(){y(this,"_stack",[]);y(this,"_itemDepth",0)}get itemDepth(){return this._itemDepth}get topItem(){let e=this._stack[this._stack.length-1];if(!e||e.type!=="item")throw new Error("Internal error, expected item layer to be on top.");return e}get topFunctionScope(){return this._stack.findLast(e=>e.type==="functionScope")}pushItem(){this._itemDepth++,this._stack.push({type:"item",usedSlots:new Set})}popItem(){this.pop("item")}pushSlotBindings(e){this._stack.push({type:"slotBinding",bindingMap:new WeakMap(e)})}popSlotBindings(){this.pop("slotBinding")}pushFunctionScope(e,t,r,n){let s={type:"functionScope",args:e,argAliases:t,returnType:r,externalMap:n,reportedReturnTypes:new Set};return this._stack.push(s),s}popFunctionScope(){this.pop("functionScope")}pushBlockScope(){this._stack.push({type:"blockScope",declarations:new Map})}popBlockScope(){this.pop("blockScope")}pop(e){let t=this._stack[this._stack.length-1];if(!t||e&&t.type!==e)throw new Error(`Internal error, expected a ${e} layer to be on top.`);this._stack.pop(),e==="item"&&this._itemDepth--}readSlot(e){for(let t=this._stack.length-1;t>=0;--t){let r=this._stack[t];if((r==null?void 0:r.type)==="item")r.usedSlots.add(e);else if((r==null?void 0:r.type)==="slotBinding"){let n=r.bindingMap.get(e);if(n!==void 0)return n}else if(!((r==null?void 0:r.type)==="functionScope"||(r==null?void 0:r.type)==="blockScope"))throw new Error("Unknown layer type.")}return e.defaultValue}getSnippetById(e){for(let t=this._stack.length-1;t>=0;--t){let r=this._stack[t];if((r==null?void 0:r.type)==="functionScope"){let n=r.args.find(a=>a.value===e);if(n!==void 0)return n;if(r.argAliases[e])return r.argAliases[e];let s=r.externalMap[e];return s!=null?_a(s):void 0}if((r==null?void 0:r.type)==="blockScope"){let n=r.declarations.get(e);if(n!==void 0)return n}}}defineBlockVariable(e,t){if(t.dataType.type==="unknown")throw Error(`Tried to define variable '${e}' of unknown type`);for(let r=this._stack.length-1;r>=0;--r){let n=this._stack[r];if((n==null?void 0:n.type)==="blockScope"){n.declarations.set(e,t);return}}throw new Error("No block scope found to define a variable in.")}},Sa=["","  ","    ","      ","        ","          ","            ","              ","                "],fi=Sa.length-1,Mw=class{constructor(){y(this,"identLevel",0)}get pre(){return Sa[this.identLevel]??Sa[fi].repeat(this.identLevel/fi)+Sa[this.identLevel%fi]}indent(){let e=this.pre;return this.identLevel++,e}dedent(){return this.identLevel--,this.pre}withResetLevel(e){let t=this.identLevel;this.identLevel=0;try{return e()}finally{this.identLevel=t}}},wu,St,ts,rn,Zs,rs,vu,qh=(wu=m,vu=class{constructor(e){Y(this,St);Y(this,ts);y(this,"_indentController",new Mw);y(this,"_itemStateStack",new Sw);Y(this,rn,[]);y(this,"_declarations",[]);y(this,"_varyingLocations");Y(this,Zs,new WeakSet);Y(this,rs);y(this,wu,{itemStateStack:this._itemStateStack});y(this,"bindGroupLayoutsToPlaceholderMap",new Map);y(this,"_nextFreeLayoutPlaceholderIdx",0);y(this,"fixedBindings",[]);y(this,"enableExtensions");y(this,"expectedType");this.enableExtensions=e.enableExtensions,q(this,ts,e.shaderGenerator??Hc),q(this,rs,e.root?new zw(e.root):new _w),q(this,St,e.namespace[m])}get varyingLocations(){return this._varyingLocations}getUniqueName(e){return Cg(w(this,St),e)}makeNameValid(e){return w(this,St).nameRegistry.makeValid(e)}get pre(){return this._indentController.pre}get topFunctionReturnType(){let e=this._itemStateStack.topFunctionScope;return Tr(e),e.returnType}get shelllessRepo(){return w(this,St).shelllessRepo}indent(){return this._indentController.indent()}dedent(){return this._indentController.dedent()}withResetIndentLevel(e){return this._indentController.withResetLevel(e)}getById(e){let t=this._itemStateStack.getSnippetById(e);return t===void 0?null:t}defineVariable(e,t){this._itemStateStack.defineBlockVariable(e,t)}reportReturnType(e){let t=this._itemStateStack.topFunctionScope;Tr(t),t.reportedReturnTypes.add(e)}pushBlockScope(){this._itemStateStack.pushBlockScope()}popBlockScope(){this._itemStateStack.popBlockScope()}generateLog(e,t){return w(this,rs).generateLog(this,e,t)}get logResources(){return w(this,rs).logResources}fnToWgsl(e){let t=this._itemStateStack.pushFunctionScope(e.args,e.argAliases,e.returnType,e.externalMap);try{w(this,ts).initGenerator(this);let r=w(this,ts).functionDefinition(e.body),n=e.returnType;if(!n){let s=[...t.reportedReturnTypes];if(s.length===0)n=xt;else{let a=to(s);a&&!a.hasImplicitConversions&&(n=a.targetType)}if(!n)throw new Error(`Expected function to have a single return type, got [${s.join(", ")}]. Cast explicitly to the desired type.`);n=Gs(n)}return{head:kw(this,e.args,n),body:r,returnType:n}}finally{this._itemStateStack.popFunctionScope()}}addDeclaration(e){this._declarations.push(e)}allocateLayoutEntry(e){let t=this.bindGroupLayoutsToPlaceholderMap,r=t.get(e);return r||(r=`#BIND_GROUP_LAYOUT_${this._nextFreeLayoutPlaceholderIdx++}#`,t.set(e,r)),r}allocateFixedEntry(e,t){let r=this.fixedBindings.length;return this.fixedBindings.push({layoutEntry:e,resource:t}),{group:Nh,binding:r}}readSlot(e){let t=this._itemStateStack.readSlot(e);if(t===void 0)throw new Sf(e);return t}withSlots(e,t){this._itemStateStack.pushSlotBindings(e);try{return t()}finally{this._itemStateStack.popSlotBindings()}}withVaryingLocations(e,t){this._varyingLocations=e;try{return t()}finally{this._varyingLocations=void 0}}unwrap(e){if(_i(e))return this.withSlots(e[Hr].pairs,()=>this.unwrap(e[Hr].inner));let t=e;for(;;)if(Ti(t))t=this.readSlot(t);else if($i(t))t=this._getOrCompute(t);else break;return t}_getOrCompute(e){let t=w(this,St).memoizedDerived.get(e)??[];this._itemStateStack.pushItem();try{for(let s of t)if([...s.slotToValueMap.entries()].every(([a,i])=>a.areEqual(this._itemStateStack.readSlot(a),i)))return s.result;this.pushMode(new yc);let r;try{r=e["~compute"]()}finally{this.popMode("normal")}let n=new Map;for(let s of this._itemStateStack.topItem.usedSlots)n.set(s,this._itemStateStack.readSlot(s));return t.push({slotToValueMap:n,result:r}),w(this,St).memoizedDerived.set(e,t),r}catch(r){throw r instanceof zs?r.appendToTrace(e):new zs(r,[e])}finally{this._itemStateStack.popItem()}}_getOrInstantiate(e){let t=w(this,St).memoizedResolves.get(e)??[];this._itemStateStack.pushItem();try{for(let s of t)if([...s.slotToValueMap.entries()].every(([a,i])=>a.areEqual(this._itemStateStack.readSlot(a),i)))return s.result;let r;if(us(e))r=_(vh(this,e),xt);else if($i(e)||Ti(e))r=this.resolve(this.unwrap(e));else if(gc(e))r=e[H](this);else if(ks(e)){let s=w(this,St).shelllessRepo.get(e,void 0);if(!s)throw new Error(`Couldn't resolve ${e.name}. Make sure it's a function that accepts no arguments, or call it from another TypeGPU function.`);return this.withResetIndentLevel(()=>this.resolve(s))}else throw new TypeError(`Unresolvable internal value: ${Os(e)}`);let n=new Map;for(let s of this._itemStateStack.topItem.usedSlots)n.set(s,this._itemStateStack.readSlot(s));return t.push({slotToValueMap:n,result:r}),w(this,St).memoizedResolves.set(e,t),r}catch(r){throw r instanceof zs?r.appendToTrace(e):new zs(r,[e])}finally{this._itemStateStack.popItem()}}resolve(e,t){if(fh(e)||ks(e)){if(w(this,Zs).has(e)&&!w(this,St).memoizedResolves.has(e))throw new Error(`Recursive function ${e} detected. Recursion is not allowed on the GPU.`);w(this,Zs).add(e)}if(_i(e))return this.withSlots(e[Hr].pairs,()=>this.resolve(e[Hr].inner,t));if(ye(e)||ks(e)){if(this._itemStateStack.itemDepth===0)try{this.pushMode(new Pf);let r=wc(this,()=>this._getOrInstantiate(e));return _(`${[...this._declarations].join(`

`)}${r.value}`,xt)}finally{this.popMode("codegen")}return this._getOrInstantiate(e)}if(typeof e=="number"){let r=t??Ra(e).dataType;if(Tr(r.type!=="unknown"),r.type==="abstractInt")return _(`${e}`,r);if(r.type==="u32")return _(`${e}u`,r);if(r.type==="i32")return _(`${e}i`,r);let n=e.toExponential(),s=r.type==="abstractFloat"&&Number.isInteger(e)?`${e}.`:`${e}`,a=n.length<s.length?n:s;return r.type==="f32"?_(`${a}f`,r):r.type==="f16"?_(`${a}h`,r):_(a,r)}if(typeof e=="boolean")return _(e?"true":"false",Ue);if(typeof e=="string")return _(e,xt);if(t&&Xt(t)){if(!Array.isArray(e))throw new Lt(`Cannot coerce ${e} into value of type '${t}'`);if(t.elementCount!==e.length)throw new Lt(`Cannot create value of type '${t}' from an array of length: ${e.length}`);let r=this.resolve(t.elementType);return _(x`array<${r}, ${t.elementCount}>(${e.map(n=>_(n,t.elementType))})`,t)}if(Array.isArray(e))return _(x`array(${e.map(r=>this.resolve(r))})`,ht);if(t&&pt(t))return _(x`${this.resolve(t)}(${Object.entries(t.propTypes).map(([r,n])=>_(e[r],n))})`,t);throw new Lt(`Value ${e} (as json: ${Os(e)}) is not resolvable${t?` to type ${t.type}`:""}`)}pushMode(e){w(this,rn).push(e)}popMode(e){let t=w(this,rn).pop();e!==void 0&&Tr((t==null?void 0:t.type)===e)}get mode(){return w(this,rn)[w(this,rn).length-1]??vc}},St=new WeakMap,ts=new WeakMap,rn=new WeakMap,Zs=new WeakMap,rs=new WeakMap,vu);function ko(e,t){let r=new qh(t),n=(t.config?r.withSlots(t.config(new xh([])).bindings,()=>r.resolve(e)):r.resolve(e)).value,s=r.bindGroupLayoutsToPlaceholderMap,a=[],i=new Set([...s.keys()].map(h=>h.index).filter(h=>h!==void 0)),o=jg(i),l=r.fixedBindings.map((h,f)=>[String(f),h.layoutEntry]),u=()=>{let h=o.next().value,f=Ih(Object.fromEntries(l));return a[h]=f,n=n.replaceAll(Nh,String(h)),[h,new Vh(f,Object.fromEntries(r.fixedBindings.map((d,p)=>[String(p),d.resource])))]},c=l.length>0?u():void 0;for(let[h,f]of s.entries()){let d=h.index??o.next().value;a[d]=h,n=n.replaceAll(f,String(d))}return t.enableExtensions&&t.enableExtensions.length>0&&(n=`${t.enableExtensions.map(h=>`enable ${h};`).join(`
`)}

${n}`),{code:n,usedBindGroupLayouts:a,catchall:c,logResources:r.logResources}}function kw(e,t,r){let n=t.map(s=>`${s.value}: ${e.resolve(s.dataType).value}`).join(", ");return r.type!=="void"?`(${n}) -> ${vo(r)}${e.resolve(r).value} `:`(${n}) `}function Wh(e){let t=e;return(t==null?void 0:t.resourceType)==="compute-pipeline"&&!!t[m]}function Yh(e){let t=e;return(t==null?void 0:t.resourceType)==="render-pipeline"&&!!t[m]}function Pw(e){return Yh(e)||Wh(e)}function Zh(e){var c;let{externals:t,shaderGenerator:r,template:n,names:s="random",config:a,enableExtensions:i}=e,o={};Is(o,t??{});let l={[m]:!0,[H](h){return _(Xa(h,o,n??""),xt)},toString:()=>"<root>"},u=Object.values(t).filter(Pw);if(u.length>1)throw new Error(`Found ${u.length} pipelines but can only resolve one at a time.`);return ko(l,{namespace:typeof s=="string"?ua({names:s}):s,enableExtensions:i,shaderGenerator:r,config:a,root:(c=u[0])==null?void 0:c[m].branch})}function Bw(e){return Zh(e).code}function Iw(e){let t=un()??new qh({namespace:ua(),shaderGenerator:Hc}),r=[1,1,1],n=[1,1,1],s=[r[0]*n[0],r[1]*n[1],r[2]*n[2]],a=new Map,i=Array.from({length:r[0]},()=>Array.from({length:r[1]},()=>Array.from({length:r[2]},()=>new Map))),o=Array.from({length:s[0]},()=>Array.from({length:s[1]},()=>Array.from({length:s[2]},()=>new Map))),l=Array.from({length:s[0]},(u,c)=>Array.from({length:s[1]},(h,f)=>Array.from({length:s[2]},(d,p)=>{let g=Math.floor(c/n[0]),z=Math.floor(f/n[1]),M=Math.floor(p/n[2]);return new Bf(a,{private:o[c][f][p],workgroup:i[g][z][M]})})));t.pushMode(l[0][0][0]);try{return{value:wc(t,e),buffers:a,privateVars:o,workgroupVars:i}}finally{t.popMode("simulate")}}function Ew(e,t,r,n){return new Uw(e,t,r,n)}function Po(e){let t=e;return(t==null?void 0:t.resourceType)==="query-set"&&!!t[m]}var Yt,xu,Uw=(xu=class{constructor(e,t,r,n){y(this,"resourceType","query-set");Y(this,Yt);y(this,"_querySet",null);y(this,"_ownQuerySet");y(this,"_destroyed",!1);y(this,"_available",!0);y(this,"_readBuffer",null);y(this,"_resolveBuffer",null);this.type=t,this.count=r,this.rawQuerySet=n,q(this,Yt,e.device),this._ownQuerySet=!n,this._querySet=n||null}get querySet(){if(this._destroyed)throw new Error("This QuerySet has been destroyed.");return this.rawQuerySet?this.rawQuerySet:this._querySet?this._querySet:(this._querySet=w(this,Yt).createQuerySet({type:this.type,count:this.count}),this._querySet)}get destroyed(){return this._destroyed}get available(){return this._available}get[m](){let e=this;return{get readBuffer(){return e._readBuffer||(e._readBuffer=w(e,Yt).createBuffer({size:e.count*BigUint64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e._readBuffer},get resolveBuffer(){return e._resolveBuffer||(e._resolveBuffer=w(e,Yt).createBuffer({size:e.count*BigUint64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC})),e._resolveBuffer}}}$name(e){return ve(this,e),this._querySet&&(this._querySet.label=e),this}resolve(){if(this._destroyed)throw new Error("This QuerySet has been destroyed.");if(!this._available)throw new Error("This QuerySet is busy resolving or reading.");let e=w(this,Yt).createCommandEncoder();e.resolveQuerySet(this.querySet,0,this.count,this[m].resolveBuffer,0),w(this,Yt).queue.submit([e.finish()])}async read(){if(!this._resolveBuffer)throw new Error("QuerySet must be resolved before reading.");this._available=!1;try{let e=w(this,Yt).createCommandEncoder();e.copyBufferToBuffer(this[m].resolveBuffer,0,this[m].readBuffer,0,this.count*BigUint64Array.BYTES_PER_ELEMENT),w(this,Yt).queue.submit([e.finish()]);let t=this[m].readBuffer;await t.mapAsync(GPUMapMode.READ);let r=new BigUint64Array(t.getMappedRange().slice());return t.unmap(),Array.from(r)}finally{this._available=!0}}destroy(){var e,t;this._destroyed||(this._destroyed=!0,this._querySet&&this._ownQuerySet&&this._querySet.destroy(),(e=this._readBuffer)==null||e.destroy(),(t=this._resolveBuffer)==null||t.destroy(),this._readBuffer=this._resolveBuffer=null)}},Yt=new WeakMap,xu),xl=class{constructor(e){y(this,"_map",new WeakMap);this._make=e}getOrMake(e,...t){if(this._map.has(e))return this._map.get(e);let r=this._make(e,...t);return this._map.set(e,r),r}},bu,Tu,nn,$u,di=($u=class{constructor(e,t){y(this,Tu,!0);y(this,bu);Y(this,nn);this.resourceType=e,this.buffer=t,this[Ae]=t,q(this,nn,this.buffer.as(this.resourceType))}$name(e){return ve(this[Ae],e),this}write(e){this.buffer.write(e)}writePartial(e){this.buffer.writePartial(e)}read(){return this.buffer.read()}get[(Tu=m,bu=Ae,ge)](){return w(this,nn).$}get $(){return w(this,nn).$}get value(){return this.$}[H](e){return e.resolve(w(this,nn))}},nn=new WeakMap,$u),re=e=>wg(e??0),Jt=e=>vg(e??0),Cn=e=>xg(e??0),Vw={f32:e=>re(e[0]),f16:e=>Cn(e[0]).x,i32:e=>Jt(e[0]),u32:e=>e[0]??0,bool:e=>!!e[0],vec2f:e=>me(re(e[0]),re(e[1])),vec3f:e=>He(re(e[0]),re(e[1]),re(e[2])),vec4f:e=>$(re(e[0]),re(e[1]),re(e[2]),re(e[3])),vec2h(e){let t=Cn(e[0]);return cr(t.x,t.y)},vec3h(e){let t=Cn(e[0]),r=Cn(e[1]);return hr(t.x,t.y,r.x)},vec4h(e){let t=Cn(e[0]),r=Cn(e[1]);return pr(t.x,t.y,r.x,r.y)},vec2i:e=>st(Jt(e[0]),Jt(e[1])),vec3i:e=>It(Jt(e[0]),Jt(e[1]),Jt(e[2])),vec4i:e=>$e(Jt(e[0]),Jt(e[1]),Jt(e[2]),Jt(e[3])),vec2u:e=>kt(e[0]??0,e[1]??0),vec3u:e=>De(e[0]??0,e[1]??0,e[2]??0),vec4u:e=>Se(e[0]??0,e[1]??0,e[2]??0,e[3]??0),"vec2<bool>":e=>dn(!!e[0],!!e[1]),"vec3<bool>":e=>mn(!!e[0],!!e[1],!!e[2]),"vec4<bool>":e=>yn(!!e[0],!!e[1],!!e[2],!!e[3]),mat2x2f:e=>fr(re(e[0]),re(e[1]),re(e[2]),re(e[3])),mat3x3f:e=>dr(re(e[0]),re(e[1]),re(e[2]),re(e[4]),re(e[5]),re(e[6]),re(e[8]),re(e[9]),re(e[10])),mat4x4f:e=>Ne(re(e[0]),re(e[1]),re(e[2]),re(e[3]),re(e[4]),re(e[5]),re(e[6]),re(e[7]),re(e[8]),re(e[9]),re(e[10]),re(e[11]),re(e[12]),re(e[13]),re(e[14]),re(e[15]))};function Cw(e,t){let r=Vw[t.type];if(r)return r(e);if(pt(t)){let n=Object.keys(t.propTypes),s=Object.values(t.propTypes),a=Fi(e,s);return Object.fromEntries(n.map((i,o)=>[i,a[o]]))}if(Xt(t)){let n=t.elementType,s=t.elementCount;return Fi(e,Array.from({length:s},()=>n))}throw new Error(`Cannot deserialize data of type ${t.type}`)}function Fi(e,t){let r=0;return t.map(n=>{if(!hn(n))return n;let s=Math.ceil(le(n)/4),a=Cw(e.subarray(r,r+s),n);return r+=s,a})}function Rw(e,t){return Fi(e,t).map(Mi)}function Li(e){let{indexBuffer:t,dataBuffer:r,logIdToMeta:n,options:s}=e;r.read().then(a=>{a.filter(i=>i.id).forEach(({id:i,serializedData:o})=>{let{argTypes:l,op:u}=n.get(i),c=Rw(new Uint32Array(o),l);c.length===0&&c.push(""),console[u](`%c${s.messagePrefix}%c ${c[0]}`,"background: #936ff5; color: white;","color: inherit; background: none",...c.slice(1))})}),t.read().then(a=>{a>s.logCountLimit&&console.warn(`Log count limit per dispatch (${s.logCountLimit}) exceeded by ${a-s.logCountLimit} calls. Consider increasing the limit by passing appropriate options to tgpu.init().`)}),r.buffer.clear(),t.buffer.clear()}function Xh(e,t,r){if(!r.enabledFeatures.has("timestamp-query"))throw new Error('Performance callback requires the "timestamp-query" feature to be enabled on GPU device.');return e.timestampWrites?{...e,performanceCallback:t}:{...e,performanceCallback:t,hasAutoQuerySet:!0,timestampWrites:{querySet:(globalThis.__TYPEGPU_AUTONAME__??(n=>n))(r.createQuerySet("timestamp",2),"querySet"),beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}}}function Hh(e,t,r){if(!r.enabledFeatures.has("timestamp-query"))throw new Error('Timestamp writes require the "timestamp-query" feature to be enabled on GPU device.');e.hasAutoQuerySet&&e.timestampWrites&&e.timestampWrites.querySet.destroy();let n={querySet:t.querySet};return t.beginningOfPassWriteIndex!==void 0&&(n.beginningOfPassWriteIndex=t.beginningOfPassWriteIndex),t.endOfPassWriteIndex!==void 0&&(n.endOfPassWriteIndex=t.endOfPassWriteIndex),{...e,hasAutoQuerySet:!1,timestampWrites:n}}function Kh(e,t){if(!e.timestampWrites)return{};let{querySet:r,beginningOfPassWriteIndex:n,endOfPassWriteIndex:s}=e.timestampWrites,a={querySet:Po(r)?t.unwrap(r):r};return n!==void 0&&(a.beginningOfPassWriteIndex=n),s!==void 0&&(a.endOfPassWriteIndex=s),{timestampWrites:a}}function Gi({root:e,priors:t}){var a;let r=(a=t.timestampWrites)==null?void 0:a.querySet,n=t.performanceCallback;if(!r)throw new Error("Cannot dispatch workgroups with performance callback without a query set.");if(!Po(r))throw new Error("Performance callback with raw GPUQuerySet is not supported. Use TgpuQuerySet instead.");let s=e.device.createCommandEncoder();s.resolveQuerySet(e.unwrap(r),0,r.count,r[m].resolveBuffer,0),e.device.queue.submit([s.finish()]),e.device.queue.onSubmittedWorkDone().then(async()=>{var u,c;if(!r.available)return;let i=await r.read(),o=i[((u=t.timestampWrites)==null?void 0:u.beginningOfPassWriteIndex)??0],l=i[((c=t.timestampWrites)==null?void 0:c.endOfPassWriteIndex)??1];if(o===void 0||l===void 0)throw new Error("QuerySet did not return valid timestamps.");await n(o,l)})}function Aw(e,t,r){return new Ow(new Fw(e,t,r),{})}var _u,zu,Ow=class Ms{constructor(t,r){y(this,zu);y(this,"resourceType","compute-pipeline");y(this,_u);this._core=t,this._priors=r,this[m]={get rawPipeline(){return t.unwrap().pipeline},get priors(){return r},get branch(){return t.branch}},this[Ae]=t}[(zu=m,_u=Ae,H)](t){return t.resolve(this._core)}toString(){return`computePipeline:${U(this)??"<unnamed>"}`}get rawPipeline(){return this._core.unwrap().pipeline}with(t,r){return La(t)?new Ms(this._core,{...this._priors,bindGroupLayoutMap:new Map([...this._priors.bindGroupLayoutMap??[],[t.layout,t]])}):new Ms(this._core,{...this._priors,bindGroupLayoutMap:new Map([...this._priors.bindGroupLayoutMap??[],[t,r]])})}withPerformanceCallback(t){let r=Xh(this._priors,t,this._core.branch);return new Ms(this._core,r)}withTimestampWrites(t){let r=Hh(this._priors,t,this._core.branch);return new Ms(this._core,r)}dispatchWorkgroups(t,r,n){let s=this._core.unwrap(),{branch:a}=this._core,i={label:U(this._core)??"<unnamed>",...Kh(this._priors,a)},o=a.device.createCommandEncoder(),l=o.beginComputePass(i);l.setPipeline(s.pipeline);let u=new Set(s.usedBindGroupLayouts);if(s.usedBindGroupLayouts.forEach((c,h)=>{var f;if(s.catchall&&h===s.catchall[0])l.setBindGroup(h,a.unwrap(s.catchall[1])),u.delete(c);else{let d=(f=this._priors.bindGroupLayoutMap)==null?void 0:f.get(c);d!==void 0&&(u.delete(c),l.setBindGroup(h,a.unwrap(d)))}}),u.size>0)throw new Ki(u);l.dispatchWorkgroups(t,r,n),l.end(),a.device.queue.submit([o.finish()]),s.logResources&&Li(s.logResources),this._priors.performanceCallback&&Gi({root:a,priors:this._priors})}$name(t){return ve(this._core,t),this}},Su,Fw=class{constructor(e,t,r){y(this,Su,!0);y(this,"_memo");this.branch=e,this._slotBindings=t,this._entryFn=r}[(Su=m,H)](e){return e.withSlots(this._slotBindings,()=>(e.resolve(this._entryFn),_("",xt)))}toString(){return"computePipelineCore"}unwrap(){var e;if(this._memo===void 0){let t=this.branch.device,r=ch.filter(c=>this.branch.enabledFeatures.has(hh[c])),n,s=ua({names:this.branch.nameRegistrySetting});n=ko(this,{namespace:s,enableExtensions:r,shaderGenerator:this.branch.shaderGenerator,root:this.branch});let{code:a,usedBindGroupLayouts:i,catchall:o,logResources:l}=n;o!==void 0&&((e=i[o[0]])==null||e.$name(`${U(this)??"<unnamed>"} - Automatic Bind Group & Layout`));let u=t.createShaderModule({label:`${U(this)??"<unnamed>"} - Shader`,code:a});this._memo={pipeline:t.createComputePipeline({label:U(this)??"<unnamed>",layout:t.createPipelineLayout({label:`${U(this)??"<unnamed>"} - Pipeline Layout`,bindGroupLayouts:i.map(c=>this.branch.unwrap(c))}),compute:{module:u}}),usedBindGroupLayouts:i,catchall:o,logResources:l}}return this._memo}};function bl(e,t="vertex"){return new Lw(e,t)}function Qh(e){return(e==null?void 0:e.resourceType)==="vertex-layout"}var Di=Symbol("defaultAttribEntry");function Ma(e,t,r,n,s){if(pn(t)||fn(t)){let a=Fr(t);return a!==void 0&&(n[s??Di]=a),Ma(e,t.inner,Pt(r,Dt(t)),n)}if(pt(t)){let a=r,i=t.propTypes;return Object.fromEntries(Object.entries(i).map(([o,l])=>{a=Pt(a,Re(l));let u=[o,Ma(e,l,a,n,o)];return a+=le(l),u}))}if(Gr(t)){let a=r,i=t.propTypes;return Object.fromEntries(Object.entries(i).map(([o,l])=>{a=Pt(a,Dt(l));let u=[o,Ma(e,l,a,n,o)];return a+=le(l),u}))}if("type"in t&&typeof t.type=="string"){if(ac.includes(t.type))return{_layout:e,format:t.type,offset:r};let a=Tf[t.type];if(a)return{_layout:e,format:a,offset:r}}throw new Error(`Unsupported data used in vertex layout: ${String(t)}`)}var Mu,Lw=(Mu=m,class{constructor(e,t){y(this,Mu,!0);y(this,"resourceType","vertex-layout");y(this,"stride");y(this,"attrib");y(this,"_customLocationMap",{});this.schemaForCount=e,this.stepMode=t;let r=e(0);this.stride=Pt(le(r.elementType),Re(r)),this.attrib=Ma(this,r.elementType,0,this._customLocationMap)}get vertexLayout(){if(this._customLocationMap[Di]!==void 0){if(typeof this.attrib.format!="string"||typeof this.attrib.offset!="number")throw new Error("Single attribute vertex layouts must have a format and offset.");return{arrayStride:this.stride,stepMode:this.stepMode,attributes:[{format:this.attrib.format,offset:this.attrib.offset,shaderLocation:this._customLocationMap[Di]}]}}if(!Object.keys(this.attrib).every(e=>this._customLocationMap[e]!==void 0))throw new Error("All attributes must have custom locations in order to unwrap a vertex layout.");return{arrayStride:this.stride,stepMode:this.stepMode,attributes:[...Object.entries(this.attrib).map(([e,t])=>({format:t.format,offset:t.offset,shaderLocation:this._customLocationMap[e]}))]}}$name(e){return ve(this,e),this}});function Gw(e){return typeof(e==null?void 0:e.loadOp)=="string"}function Dw(e,t){if(us(e)){if(!Gw(t))throw new Error("Expected a single color attachment, not a record.");return[t]}let r=[];for(let n of Object.keys(e)){let s=e[n];if(ta(s))continue;let a=t[n];if(!a)throw new Error(`A color attachment by the name of '${n}' was not provided to the shader.`);r.push(a)}return r}function jw(e){return typeof(e==null?void 0:e.format)=="string"}function Nw(e,t){if(us(e)){if(nc(e))return[];if(!jw(t))throw new Error("Expected a single color target configuration, not a record.");return[t]}let r=[];for(let n of Object.keys(e)){let s=e[n];if(ta(s))continue;let a=t[n];if(!a)throw new Error(`A color target by the name of '${n}' was not provided to the shader.`);r.push(a)}return r}function Jh(e){return new qw(new Ww(e),{})}var ku,Pu,qw=class rr{constructor(t,r){y(this,Pu);y(this,"resourceType","render-pipeline");y(this,ku);y(this,"hasIndexBuffer",!1);this[m]={core:t,priors:r,branch:t.options.branch},this[Ae]=t}[(Pu=m,ku=Ae,H)](t){return t.resolve(this[m].core)}toString(){return`renderPipeline:${U(this)??"<unnamed>"}`}$name(t){return ve(this[m].core,t),this}with(t,r){let n=this[m];if(La(t))return new rr(n.core,{...n.priors,bindGroupLayoutMap:new Map([...n.priors.bindGroupLayoutMap??[],[t.layout,t]])});if(Eh(t))return new rr(n.core,{...n.priors,bindGroupLayoutMap:new Map([...n.priors.bindGroupLayoutMap??[],[t,r]])});if(Qh(t))return new rr(n.core,{...n.priors,vertexLayoutMap:new Map([...n.priors.vertexLayoutMap??[],[t,r]])});throw new Error("Unsupported value passed into .with()")}withPerformanceCallback(t){let r=this[m],n=Xh(r.priors,t,r.core.options.branch);return new rr(r.core,n)}withTimestampWrites(t){let r=this[m],n=Hh(r.priors,t,r.core.options.branch);return new rr(r.core,n)}withColorAttachment(t){let r=this[m];return new rr(r.core,{...r.priors,colorAttachment:t})}withDepthStencilAttachment(t){let r=this[m];return new rr(r.core,{...r.priors,depthStencilAttachment:t})}withIndexBuffer(t,r,n,s){let a=this[m];if(zi(t)){if(typeof r!="string")throw new Error("If a GPUBuffer is passed, indexFormat must be provided.");return new rr(a.core,{...a.priors,indexBuffer:{buffer:t,indexFormat:r,offsetBytes:n,sizeBytes:s}})}let i={u32:"uint32",u16:"uint16"},o=t.dataType.elementType;return new rr(a.core,{...a.priors,indexBuffer:{buffer:t,indexFormat:i[o.type],offsetBytes:r!==void 0?r*le(o):void 0,sizeBytes:s!==void 0?s*le(o):void 0}})}setupRenderPass(t){let r=this[m],n=r.core.unwrap(),{branch:s,fragmentFn:a}=r.core.options,i=a?Dw(a.shell.out,r.priors.colorAttachment??{}).map(h=>Ds(h.view)?{...h,view:s.unwrap(h.view).createView()}:Fa(h.view)?{...h,view:s.unwrap(h.view)}:h):[null],o={label:U(r.core)??"<unnamed>",colorAttachments:i,...Kh(r.priors,s)};if(r.priors.depthStencilAttachment!==void 0){let h=r.priors.depthStencilAttachment;Ds(h.view)?o.depthStencilAttachment={...h,view:s.unwrap(h.view).createView()}:o.depthStencilAttachment=h}let l=t.beginRenderPass(o);l.setPipeline(n.pipeline);let u=new Set(n.usedBindGroupLayouts);n.usedBindGroupLayouts.forEach((h,f)=>{var d;if(n.catchall&&f===n.catchall[0])l.setBindGroup(f,s.unwrap(n.catchall[1])),u.delete(h);else{let p=(d=r.priors.bindGroupLayoutMap)==null?void 0:d.get(h);p!==void 0&&(u.delete(h),l.setBindGroup(f,s.unwrap(p)))}});let c=new Set(r.core.usedVertexLayouts);if(r.core.usedVertexLayouts.forEach((h,f)=>{var p;let d=(p=r.priors.vertexLayoutMap)==null?void 0:p.get(h);d&&(c.delete(h),l.setVertexBuffer(f,s.unwrap(d)))}),u.size>0)throw new Ki(u);if(c.size>0)throw new cc(c);return l}draw(t,r,n,s){let a=this[m],{branch:i}=a.core.options,{logResources:o}=a.core.unwrap(),l=i.device.createCommandEncoder(),u=this.setupRenderPass(l);u.draw(t,r,n,s),u.end(),i.device.queue.submit([l.finish()]),o&&Li(o),a.priors.performanceCallback&&Gi({root:i,priors:a.priors})}drawIndexed(t,r,n,s,a){let i=this[m];if(!i.priors.indexBuffer)throw new Error("No index buffer set for this render pipeline.");let{logResources:o}=i.core.unwrap(),{branch:l}=i.core.options,{buffer:u,indexFormat:c,offsetBytes:h,sizeBytes:f}=i.priors.indexBuffer,d=l.device.createCommandEncoder(),p=this.setupRenderPass(d);zi(u)?p.setIndexBuffer(u,c,h,f):p.setIndexBuffer(l.unwrap(u),c,h,f),p.drawIndexed(t,r,n,s,a),p.end(),l.device.queue.submit([d.finish()]),o&&Li(o),i.priors.performanceCallback&&Gi({root:l,priors:i.priors})}},Bu,Ww=class{constructor(e){y(this,Bu,!0);y(this,"usedVertexLayouts");y(this,"_memo");y(this,"_vertexBufferLayouts");y(this,"_targets");this.options=e;let t=Rg(e.vertexFn.shell.in??{},e.vertexAttribs);this._vertexBufferLayouts=t.bufferDefinitions,this.usedVertexLayouts=t.usedVertexLayouts,this._targets=e.fragmentFn&&e.targets?Nw(e.fragmentFn.shell.out,e.targets):[null]}[(Bu=m,H)](e){let{vertexFn:t,fragmentFn:r,slotBindings:n}=this.options,s=Yw(t.shell.out,r==null?void 0:r.shell.in,U(t)??"<unnamed>",U(r)??"<unnamed>");return e.withVaryingLocations(s,()=>e.withSlots(n,()=>(e.resolve(t),r&&e.resolve(r),_("",xt))))}toString(){return"renderPipelineCore"}unwrap(){var e;if(this._memo===void 0){let{branch:t,primitiveState:r,depthStencilState:n,multisampleState:s}=this.options,a=t.device,i=ch.filter(z=>t.enabledFeatures.has(hh[z])),o,l=ua({names:t.nameRegistrySetting});o=ko(this,{namespace:l,enableExtensions:i,shaderGenerator:t.shaderGenerator,root:t});let{code:u,usedBindGroupLayouts:c,catchall:h,logResources:f}=o;h!==void 0&&((e=c[h[0]])==null||e.$name(`${U(this)??"<unnamed>"} - Automatic Bind Group & Layout`));let d=a.createShaderModule({label:`${U(this)??"<unnamed>"} - Shader`,code:u}),p={layout:a.createPipelineLayout({label:`${U(this)??"<unnamed>"} - Pipeline Layout`,bindGroupLayouts:c.map(z=>t.unwrap(z))}),vertex:{module:d,buffers:this._vertexBufferLayouts}},g=U(this);g!==void 0&&(p.label=g),this.options.fragmentFn&&(p.fragment={module:d,targets:this._targets}),r&&(hn(r.stripIndexFormat)?p.primitive={...r,stripIndexFormat:{u32:"uint32",u16:"uint16"}[r.stripIndexFormat.type]}:p.primitive=r),n&&(p.depthStencil=n),s&&(p.multisample=s),this._memo={pipeline:a.createRenderPipeline(p),usedBindGroupLayouts:c,catchall:h,logResources:f}}return this._memo}};function Yw(e,t,r,n){let s={},a=new Set;function i(l,u){s[l]=u,a.add(u)}for(let[l,u]of Object.entries(e)){let c=Fr(u);c!==void 0&&i(l,c)}for(let[l,u]of Object.entries(t??{})){let c=Fr(u);c!==void 0&&(s[l]===void 0?i(l,c):s[l]!==c&&console.warn(`Mismatched location between vertexFn (${r}) output (${s[l]}) and fragmentFn (${n}) input (${c}) for the key "${l}", using the location set on vertex output.`))}let o=0;for(let l of Object.keys(e??{}))if(!(ta(e[l])||s[l]!==void 0)){for(;a.has(o);)o++;i(l,o)}return s}function Zw(e){if(e.includes(0))throw new Error("Size and workgroupSize cannot contain zeroes.");return De(e[0]??1,e[1]??1,e[2]??1)}var Xw=[De(1,1,1),De(256,1,1),De(16,16,1),De(8,8,4)],Xs,sn,an,ns,ss,as,Hw=(as=class{constructor(t,r,n,s){Y(this,Xs);Y(this,sn);Y(this,an);Y(this,ns);Y(this,ss);q(this,Xs,t),q(this,sn,r),q(this,an,n),q(this,ns,s),q(this,ss,De())}with(t){return new as(w(this,Xs),w(this,sn).with(t),w(this,an),w(this,ns))}dispatchThreads(...t){let r=Zw(t),n=Mm(He(r).div(He(w(this,ns))));bg(r,w(this,ss))||(q(this,ss,r),w(this,an).write(r)),w(this,sn).dispatchWorkgroups(n.x,n.y,n.z)}get pipeline(){return w(this,sn)}get sizeUniform(){return w(this,an)}},Xs=new WeakMap,sn=new WeakMap,an=new WeakMap,ns=new WeakMap,ss=new WeakMap,as),Kw=class ji{constructor(t,r){this._getRoot=t,this._slotBindings=r}with(t,r){return new ji(this._getRoot,[...this._slotBindings,[Ya(t)?t.slot:t,r]])}withCompute(t){return new Qw(this._getRoot(),this._slotBindings,t)}createGuardedComputePipeline(t){let r=this._getRoot();if(t.length>=4)throw new Error("Guarded compute callback only supports up to three dimensions.");let n=Xw[t.length],s=fe([O,O,O])(t),a=(globalThis.__TYPEGPU_AUTONAME__??(l=>l))(r.createUniform(De),"o"),i=ph({workgroupSize:n,in:{id:Lc.globalInvocationId}})`{
  if (any(in.id >= sizeUniform)) {
    return;
  }
  wrappedCallback(in.id.x, in.id.y, in.id.z);
}`.$uses({sizeUniform:a,wrappedCallback:s}),o=(globalThis.__TYPEGPU_AUTONAME__??(l=>l))(this.withCompute(i).createPipeline(),"i");return new Hw(r,o,a,n)}withVertex(t,r){return new Jw({branch:this._getRoot(),primitiveState:void 0,depthStencilState:void 0,slotBindings:this._slotBindings,vertexFn:t,vertexAttribs:r,multisampleState:void 0})}pipe(t){let r=t(new xh([]));return new ji(this._getRoot,[...this._slotBindings,...r.bindings])}},Qw=class{constructor(e,t,r){this._root=e,this._slotBindings=t,this._entryFn=r}createPipeline(){return Aw(this._root,this._slotBindings,this._entryFn)}},Jw=class ka{constructor(t){this._options=t}withFragment(t,r,n){return Tr(typeof t!="string"),Tr(typeof r!="string"),new ev({...this._options,fragmentFn:t,targets:r})}withPrimitive(t){return new ka({...this._options,primitiveState:t})}withDepthStencil(t){return new ka({...this._options,depthStencilState:t})}withMultisample(t){return new ka({...this._options,multisampleState:t})}createPipeline(){return Jh({...this._options,fragmentFn:null,targets:null})}},ev=class Pa{constructor(t){this._options=t}withPrimitive(t){return new Pa({...this._options,primitiveState:t})}withDepthStencil(t){return new Pa({...this._options,depthStencilState:t})}withMultisample(t){return new Pa({...this._options,multisampleState:t})}createPipeline(){return Jh(this._options)}},Iu,Eu,ep=class extends(Eu=Kw,Iu=m,Eu){constructor(t,r,n,s,a){super(()=>this,[]);y(this,"~unstable");y(this,"_unwrappedBindGroupLayouts",new xl(t=>t.unwrap(this)));y(this,"_unwrappedBindGroups",new xl(t=>t.unwrap(this)));y(this,Iu);this.device=t,this.nameRegistrySetting=r,this._ownDevice=n,this.shaderGenerator=a,this["~unstable"]=this,this[m]={logOptions:s}}get enabledFeatures(){return new Set(this.device.features)}createBuffer(t,r){return va(this,t,r)}createUniform(t,r){let n=va(this,t,r).$usage("uniform");return new di("uniform",n)}createMutable(t,r){let n=va(this,t,r).$usage("storage");return new di("mutable",n)}createReadonly(t,r){let n=va(this,t,r).$usage("storage");return new di("readonly",n)}createQuerySet(t,r,n){return Ew(this,t,r,n)}createBindGroup(t,r){return new Vh(t,r)}destroy(){sw(this.device),this._ownDevice&&this.device.destroy()}createTexture(t){return hw(t,this)}createSampler(t){return ew(t,this)}createComparisonSampler(t){return tw(t,this)}unwrap(t){if(Wh(t))return t[m].rawPipeline;if(Yh(t))return t[m].core.unwrap().pipeline;if(Eh(t))return this._unwrappedBindGroupLayouts.getOrMake(t);if(La(t))return this._unwrappedBindGroups.getOrMake(t);if(Rs(t))return t.buffer;if(Ds(t))return t[m].unwrap();if(Fa(t)){if(!t[m].unwrap)throw new Error("Cannot unwrap laid-out texture view as it has no underlying resource.");return t[m].unwrap()}if(Qh(t))return t.vertexLayout;if(zh(t)||Sh(t)){if(t[m].unwrap)return t[m].unwrap();throw new Error("Cannot unwrap laid-out sampler.")}if(Po(t))return t.querySet;throw new Error(`Unknown resource type: ${t}`)}beginRenderPass(t,r){let n=this.device.createCommandEncoder(),s=n.beginRenderPass(t),a=new Map,i=new Map,o,l=()=>{if(!o)throw new Error("Cannot draw without a call to pass.setPipeline");let{core:u,priors:c}=o[m],h=u.unwrap();s.setPipeline(h.pipeline);let f=new Set(h.usedBindGroupLayouts);h.usedBindGroupLayouts.forEach((p,g)=>{var z;if(h.catchall&&g===h.catchall[0])s.setBindGroup(g,this.unwrap(h.catchall[1])),f.delete(p);else{let M=((z=c.bindGroupLayoutMap)==null?void 0:z.get(p))??a.get(p);M!==void 0&&(f.delete(p),La(M)?s.setBindGroup(g,this.unwrap(M)):s.setBindGroup(g,M))}});let d=new Set;if(u.usedVertexLayouts.forEach((p,g)=>{var A;let z=(A=c.vertexLayoutMap)==null?void 0:A.get(p),M=z?{buffer:z,offset:void 0,size:void 0}:i.get(p);!M||!M.buffer?d.add(p):Rs(M.buffer)?s.setVertexBuffer(g,this.unwrap(M.buffer),M.offset,M.size):s.setVertexBuffer(g,M.buffer,M.offset,M.size)}),f.size>0)throw new Ki(f);if(d.size>0)throw new cc(d)};r({setViewport(...u){s.setViewport(...u)},setScissorRect(...u){s.setScissorRect(...u)},setBlendConstant(...u){s.setBlendConstant(...u)},setStencilReference(...u){s.setStencilReference(...u)},beginOcclusionQuery(...u){s.beginOcclusionQuery(...u)},endOcclusionQuery(...u){s.endOcclusionQuery(...u)},executeBundles(...u){s.executeBundles(...u)},setPipeline(u){o=u},setIndexBuffer:(u,c,h,f)=>{Rs(u)?s.setIndexBuffer(this.unwrap(u),c,h,f):s.setIndexBuffer(u,c,h,f)},setVertexBuffer(u,c,h,f){i.set(u,{buffer:c,offset:h,size:f})},setBindGroup(u,c){a.set(u,c)},draw(u,c,h,f){l(),s.draw(u,c,h,f)},drawIndexed(...u){l(),s.drawIndexed(...u)},drawIndirect(...u){l(),s.drawIndirect(...u)},drawIndexedIndirect(...u){l(),s.drawIndexedIndirect(...u)}}),s.end(),this.device.queue.submit([n.finish()])}flush(){console.warn("flush() has been deprecated, and has no effect.")}};async function tv(e){let{adapter:t,device:r,unstable_names:n="random",unstable_logOptions:s}=e??{};if(!navigator.gpu)throw new Error("WebGPU is not supported by this browser.");let a=await navigator.gpu.requestAdapter(t);if(!a)throw new Error("Could not find a compatible GPU");let i=[];for(let l of(r==null?void 0:r.requiredFeatures)??[]){if(!a.features.has(l))throw new Error(`Requested feature "${l}" is not supported by the adapter.`);i.push(l)}for(let l of(r==null?void 0:r.optionalFeatures)??[])a.features.has(l)?i.push(l):console.warn(`Optional feature "${l}" is not supported by the adapter.`);let o=await a.requestDevice({...r,requiredFeatures:i});return new ep(o,n,!0,s??{},e==null?void 0:e.shaderGenerator)}function rv(e){let{device:t,unstable_names:r="random",unstable_logOptions:n}=e??{};return new ep(t,r,!1,n??{},e==null?void 0:e.shaderGenerator)}function nv(e,t){return new sv(e,t)}var Uu,Vu,Hs,Ni,Cu,sv=(Cu=class{constructor(e,t=void 0){Y(this,Hs);y(this,Vu,!0);y(this,Uu);y(this,"resourceType","accessor");y(this,"slot");this.schema=e,this.defaultValue=t,this.slot=Ga(t),this[Ae]=this.slot}get[(Vu=m,Uu=Ae,ge)](){return new Proxy({[m]:!0,[bt]:Br(this,Hs,Ni).call(this),[H]:e=>e.resolve(this),toString:()=>`accessor:${U(this)??"<unnamed>"}.$`},Kt)}$name(e){return this.slot.$name(e),this}toString(){return`accessor:${U(this)??"<unnamed>"}`}get value(){if(yr())return this[ge];throw new Error("`tgpu.accessor` relies on GPU resources and cannot be accessed outside of a compute dispatch or draw call")}get $(){return this.value}[H](e){let t=Br(this,Hs,Ni).call(this);return _(e.resolve(t.value,t.dataType).value,t.dataType)}},Hs=new WeakSet,Ni=function(){let e=un(),t=Ka(e.unwrap(this.slot));return fh(t)?t[m].gpuImpl():_(t,this.schema)},Cu);function av(e){return ov(e)}function iv([e,t]){return`${U(e)??"<unnamed>"}=${t}`}function ov(e){if(un())throw new Error("Cannot create tgpu.derived objects at the resolution stage.");return{[m]:!0,resourceType:"derived","~compute":e,get[ge](){let t=un();if(!t)throw new Error("Cannot access tgpu.derived's value outside of resolution.");return Ka(t.unwrap(this))},get value(){return this[ge]},get $(){return this.value},with(t,r){return tp(this,[[t,r]])},toString(){return"derived"}}}function tp(e,t){return{[m]:!0,resourceType:"derived","~compute"(){throw new Error("'~compute' should never be read on bound derived items.")},[Hr]:{inner:e,pairs:t},get[ge](){let r=un();if(!r)throw new Error("Cannot access tgpu.derived's value outside of resolution.");return Ka(r.unwrap(this))},get value(){return this[ge]},get $(){return this.value},with(r,n){return tp(e,[...t,[r,n]])},toString(){return`derived[${t.map(iv).join(", ")}]`}}}var lv={fn:fe,bindGroupLayout:Ih,vertexLayout:bl,slot:Ga,init:tv,initFromDevice:rv,resolve:Bw,resolveWithContext:Zh,privateVar:Da,workgroupVar:vl,const:Bi,"~unstable":{fn:fe,fragmentFn:kg,vertexFn:bd,computeFn:ph,vertexLayout:bl,namespace:ua,derived:av,slot:Ga,accessor:nv,privateVar:Da,workgroupVar:vl,const:Bi,declare:$g,simulate:Iw}},hs=lv;const Bo=(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(ra({brushColor:He,brushOpacity:v,hardness:v,screenSize:me,brushShape:O}),"BrushUniforms"),uv=(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(ra({pos:lr(0,me),size:lr(1,v),pressure:lr(2,v)}),"StrokePoint"),rp=(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(ra({position:Lc.position,localUV:lr(0,me),color:lr(1,He),opacity:lr(2,v),hardness:lr(3,v)}),"VertexOutput"),cv=`
@group(0) @binding(0) var<uniform> globals: BrushUniforms;

@vertex
fn vs(
  @location(0) quadPos: vec2<f32>,
  @location(1) pos: vec2<f32>,
  @location(2) size: f32,
  @location(3) pressure: f32
) -> VertexOutput {
  // Convert diameter to radius
  let radius = size * pressure;
  let pixelPos = pos + (quadPos * radius);
  
  // Convert pixel coordinates to Normalized Device Coordinates (NDC)
  let ndcX = (pixelPos.x / globals.screenSize.x) * 2.0 - 1.0;
  let ndcY = 1.0 - ((pixelPos.y / globals.screenSize.y) * 2.0);  // Flip Y axis for WebGPU coordinate system

  return VertexOutput(
    vec4<f32>(ndcX, ndcY, 0.0, 1.0),
    quadPos,
    globals.brushColor,
    pressure * globals.brushOpacity,
    globals.hardness
  );
}
`,hv=hs.resolve({template:cv,externals:{BrushUniforms:Bo,VertexOutput:rp}}),pv=`
@group(0) @binding(0) var<uniform> globals: BrushUniforms;

@fragment
fn fs(v: VertexOutput) -> @location(0) vec4<f32> {
  var dist: f32;
  if (globals.brushShape == 1u) {
    // Calculate Chebyshev distance for square shape
    dist = max(abs(v.localUV.x), abs(v.localUV.y));
  } else {
    // Calculate Euclidean distance for circle shape
    dist = length(v.localUV);
  }

  if (dist > 1.0) { discard; }

  // Calculate alpha with hardness and anti-aliasing
  let edgeWidth = fwidth(dist);
  let startFade = min(v.hardness, 1.0 - edgeWidth * 2.0);
  let linearAlpha = 1.0 - smoothstep(startFade, 1.0, dist);
  // Apply quadratic falloff for smoother edges
  let alphaShape = pow(linearAlpha, 2.0);
  
  // Return premultiplied alpha color
  let alpha = alphaShape * v.opacity;
  return vec4<f32>(v.color * alpha, alpha);
}
`,fv=hs.resolve({template:pv,externals:{VertexOutput:rp,BrushUniforms:Bo}}),dv=`
@vertex fn vs(@builtin(vertex_index) vIdx: u32) -> @builtin(position) vec4<f32> {
  var pos = array<vec2<f32>, 3>(
    vec2<f32>(-1.0, -1.0), vec2<f32>(3.0, -1.0), vec2<f32>(-1.0, 3.0)
  );
  return vec4<f32>(pos[vIdx], 0.0, 1.0);
}

@group(0) @binding(0) var myTexture: texture_2d<f32>;

@fragment fn fs(@builtin(position) pos: vec4<f32>) -> @location(0) vec4<f32> {
  let c = textureLoad(myTexture, vec2<i32>(pos.xy), 0);
  // Treat texture as premultiplied to prevent double-darkening on overlaps
  return c;
}
`,Tl=hs.resolve({template:dv,externals:{}}),mv=`
@vertex fn vs(@builtin(vertex_index) vIdx: u32) -> @builtin(position) vec4<f32> {
  var pos = array<vec2<f32>, 3>(
    vec2<f32>(-1.0, -1.0), vec2<f32>(3.0, -1.0), vec2<f32>(-1.0, 3.0)
  );
  return vec4<f32>(pos[vIdx], 0.0, 1.0);
}

@group(0) @binding(0) var myTexture: texture_2d<f32>;
@group(1) @binding(0) var<uniform> globals: BrushUniforms;

@fragment fn fs(@builtin(position) pos: vec4<f32>) -> @location(0) vec4<f32> {
  let sampled = textureLoad(myTexture, vec2<i32>(pos.xy), 0);
  // Apply global brush opacity to accumulated coverage
  return sampled * globals.brushOpacity;
}
`,Ir=hs.resolve({template:mv,externals:{BrushUniforms:Bo}}),yv=`
@group(0) @binding(0) var inputTex: texture_2d<f32>;
@group(0) @binding(1) var<storage, read_write> outputBuf: array<u32>;

@compute @workgroup_size(8, 8)
fn main(@builtin(global_invocation_id) id: vec3<u32>) {
  let dims = textureDimensions(inputTex);
  if (id.x >= dims.x || id.y >= dims.y) { return; }

  let color = textureLoad(inputTex, vec2<i32>(id.xy), 0);
  
  var r = color.r;
  var g = color.g;
  var b = color.b;
  let a = color.a;

  if (a > 0.0) {
    r = r / a;
    g = g / a;
    b = b / a;
  }

  let ir = u32(clamp(r * 255.0, 0.0, 255.0));
  let ig = u32(clamp(g * 255.0, 0.0, 255.0));
  let ib = u32(clamp(b * 255.0, 0.0, 255.0));
  let ia = u32(clamp(a * 255.0, 0.0, 255.0));

  // Pack RGBA channels into a single u32 (Little Endian)
  let packed = ir | (ig << 8u) | (ib << 16u) | (ia << 24u);

  let index = id.y * dims.x + id.x;
  outputBuf[index] = packed;
}
`,gv=hs.resolve({template:yv,externals:{}}),$l=new Float32Array([-1,-1,1,-1,1,1,-1,1]),_l=new Uint16Array([0,1,2,0,2,3]),xa=48,wv=rd(uv),zl=1e4;class vv{constructor(t,r="rgba8unorm"){y(this,"device");y(this,"quadVertexBuffer");y(this,"indexBuffer");y(this,"instanceBuffer");y(this,"uniformBuffer");y(this,"renderPipeline");y(this,"accumulatePipeline");y(this,"blitPipeline");y(this,"compositePipeline");y(this,"compositePipelinePreview");y(this,"erasePipeline");y(this,"erasePipelinePreview");y(this,"readbackPipeline");y(this,"uniformBindGroupLayout");y(this,"textureBindGroupLayout");y(this,"mainUniformBindGroup");y(this,"currentStrokeTexture",null);y(this,"currentStrokeView",null);y(this,"compositeTextureBindGroup",null);y(this,"previewTextureBindGroup",null);y(this,"lastReadbackTexture",null);y(this,"lastReadbackBuffer",null);y(this,"readbackBindGroup",null);y(this,"lastBackgroundTexture",null);y(this,"backgroundBindGroup",null);this.device=t,this.quadVertexBuffer=t.createBuffer({size:$l.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.quadVertexBuffer.getMappedRange()).set($l),this.quadVertexBuffer.unmap(),this.indexBuffer=t.createBuffer({size:_l.byteLength,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),new Uint16Array(this.indexBuffer.getMappedRange()).set(_l),this.indexBuffer.unmap(),this.instanceBuffer=t.createBuffer({size:zl*wv,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.uniformBuffer=t.createBuffer({size:xa,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const n=t.createShaderModule({code:hv}),s=t.createShaderModule({code:fv});this.uniformBindGroupLayout=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.textureBindGroupLayout=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),this.mainUniformBindGroup=t.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]});const a=t.createPipelineLayout({bindGroupLayouts:[this.uniformBindGroupLayout]});this.renderPipeline=t.createRenderPipeline({layout:a,vertex:{module:n,entryPoint:"vs",buffers:[{arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]},{arrayStride:16,stepMode:"instance",attributes:[{shaderLocation:1,offset:0,format:"float32x2"},{shaderLocation:2,offset:8,format:"float32"},{shaderLocation:3,offset:12,format:"float32"}]}]},fragment:{module:s,entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.accumulatePipeline=t.createRenderPipeline({layout:a,vertex:{module:n,entryPoint:"vs",buffers:[{arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]},{arrayStride:16,stepMode:"instance",attributes:[{shaderLocation:1,offset:0,format:"float32x2"},{shaderLocation:2,offset:8,format:"float32"},{shaderLocation:3,offset:12,format:"float32"}]}]},fragment:{module:s,entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}});const i=t.createPipelineLayout({bindGroupLayouts:[this.textureBindGroupLayout]});this.blitPipeline=t.createRenderPipeline({layout:i,vertex:{module:t.createShaderModule({code:Tl}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:Tl}),entryPoint:"fs",targets:[{format:r,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}});const o=t.createPipelineLayout({bindGroupLayouts:[this.textureBindGroupLayout,this.uniformBindGroupLayout]});this.compositePipeline=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:Ir}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:Ir}),entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.compositePipelinePreview=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:Ir}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:Ir}),entryPoint:"fs",targets:[{format:r,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.erasePipeline=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:Ir}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:Ir}),entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.erasePipelinePreview=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:Ir}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:Ir}),entryPoint:"fs",targets:[{format:r,blend:{color:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.readbackPipeline=t.createComputePipeline({layout:"auto",compute:{module:t.createShaderModule({code:gv}),entryPoint:"main"}})}prepareStroke(t,r){(!this.currentStrokeTexture||this.currentStrokeTexture.width!==t||this.currentStrokeTexture.height!==r)&&(this.currentStrokeTexture&&this.currentStrokeTexture.destroy(),this.currentStrokeTexture=this.device.createTexture({size:[t,r],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC}),this.currentStrokeView=this.currentStrokeTexture.createView(),this.compositeTextureBindGroup=null,this.previewTextureBindGroup=null,this.lastReadbackTexture===this.currentStrokeTexture&&(this.readbackBindGroup=null,this.lastReadbackTexture=null));const n=this.device.createCommandEncoder();n.beginRenderPass({colorAttachments:[{view:this.currentStrokeView,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]}).end(),this.device.queue.submit([n.finish()])}renderStrokeToAccumulator(t,r){this.currentStrokeView&&this.renderStrokeInternal(this.currentStrokeView,this.accumulatePipeline,t,r)}compositeStroke(t,r){if(!this.currentStrokeTexture)return;const n=new ArrayBuffer(xa),s=new Float32Array(n),a=new Uint32Array(n);s[0]=r.color[0],s[1]=r.color[1],s[2]=r.color[2],s[3]=r.opacity,s[4]=r.hardness,s[5]=0,s[6]=r.screenSize[0],s[7]=r.screenSize[1],a[8]=r.brushShape,this.device.queue.writeBuffer(this.uniformBuffer,0,n);const i=this.device.createCommandEncoder(),o=r.isErasing?this.erasePipeline:this.compositePipeline;this.compositeTextureBindGroup||(this.compositeTextureBindGroup=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:this.currentStrokeTexture.createView()}]}));const l=i.beginRenderPass({colorAttachments:[{view:t,loadOp:"load",storeOp:"store"}]});l.setPipeline(o),l.setBindGroup(0,this.compositeTextureBindGroup),l.setBindGroup(1,this.mainUniformBindGroup),l.draw(3),l.end(),this.device.queue.submit([i.finish()])}renderStroke(t,r,n){this.renderStrokeInternal(t,this.renderPipeline,r,n)}renderStrokeInternal(t,r,n,s){if(n.length===0)return;const a=new ArrayBuffer(xa),i=new Float32Array(a),o=new Uint32Array(a);i[0]=s.color[0],i[1]=s.color[1],i[2]=s.color[2],i[3]=s.opacity,i[4]=s.hardness,i[5]=0,i[6]=s.width,i[7]=s.height,o[8]=s.brushShape,this.device.queue.writeBuffer(this.uniformBuffer,0,a);let l=0;for(;l<n.length;){const u=Math.min(n.length-l,zl),c=new Float32Array(u*4);for(let d=0;d<u;d++){const p=n[l+d];c[d*4+0]=p.x,c[d*4+1]=p.y,c[d*4+2]=s.size,c[d*4+3]=p.pressure}this.device.queue.writeBuffer(this.instanceBuffer,0,c);const h=this.device.createCommandEncoder(),f=h.beginRenderPass({colorAttachments:[{view:t,loadOp:"load",storeOp:"store"}]});f.setPipeline(r),f.setBindGroup(0,this.mainUniformBindGroup),f.setVertexBuffer(0,this.quadVertexBuffer),f.setVertexBuffer(1,this.instanceBuffer),f.setIndexBuffer(this.indexBuffer,"uint16"),f.drawIndexed(6,u),f.end(),this.device.queue.submit([h.finish()]),l+=u}}blitToCanvas(t,r,n){const s=this.device.createCommandEncoder(),a=t.getCurrentTexture().createView();if(n){(this.lastBackgroundTexture!==n||!this.backgroundBindGroup)&&(this.backgroundBindGroup=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:n.createView()}]}),this.lastBackgroundTexture=n);const i=s.beginRenderPass({colorAttachments:[{view:a,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]});i.setPipeline(this.blitPipeline),i.setBindGroup(0,this.backgroundBindGroup),i.draw(3),i.end()}else s.beginRenderPass({colorAttachments:[{view:a,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]}).end();if(this.currentStrokeTexture){const i=new ArrayBuffer(xa),o=new Float32Array(i),l=new Uint32Array(i);o[0]=r.color[0],o[1]=r.color[1],o[2]=r.color[2],o[3]=r.opacity,o[4]=r.hardness,o[5]=0,o[6]=r.screenSize[0],o[7]=r.screenSize[1],l[8]=r.brushShape,this.device.queue.writeBuffer(this.uniformBuffer,0,i);const u=r.isErasing?this.erasePipelinePreview:this.compositePipelinePreview;this.previewTextureBindGroup||(this.previewTextureBindGroup=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:this.currentStrokeTexture.createView()}]}));const c=s.beginRenderPass({colorAttachments:[{view:a,loadOp:"load",storeOp:"store"}]});c.setPipeline(u),c.setBindGroup(0,this.previewTextureBindGroup),c.setBindGroup(1,this.mainUniformBindGroup),c.draw(3),c.end()}this.device.queue.submit([s.finish()])}clearPreview(t){const r=this.device.createCommandEncoder();r.beginRenderPass({colorAttachments:[{view:t.getCurrentTexture().createView(),loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]}).end(),this.device.queue.submit([r.finish()])}prepareReadback(t,r){(this.lastReadbackTexture!==t||this.lastReadbackBuffer!==r||!this.readbackBindGroup)&&(this.readbackBindGroup=this.device.createBindGroup({layout:this.readbackPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:t.createView()},{binding:1,resource:{buffer:r}}]}),this.lastReadbackTexture=t,this.lastReadbackBuffer=r);const n=this.device.createCommandEncoder(),s=n.beginComputePass();s.setPipeline(this.readbackPipeline),s.setBindGroup(0,this.readbackBindGroup);const a=t.width,i=t.height;s.dispatchWorkgroups(Math.ceil(a/8),Math.ceil(i/8)),s.end(),this.device.queue.submit([n.finish()])}destroy(){this.quadVertexBuffer.destroy(),this.indexBuffer.destroy(),this.instanceBuffer.destroy(),this.uniformBuffer.destroy(),this.currentStrokeTexture&&this.currentStrokeTexture.destroy(),this.compositeTextureBindGroup=null,this.previewTextureBindGroup=null,this.readbackBindGroup=null,this.backgroundBindGroup=null,this.lastReadbackTexture=null,this.lastReadbackBuffer=null,this.lastBackgroundTexture=null}}class xv{constructor(t){y(this,"controlPoints",[]);y(this,"remainder",0);y(this,"spacing");y(this,"isFirstPoint",!0);y(this,"hasProcessedSegment",!1);this.spacing=t}addPoint(t){if(this.isFirstPoint)return this.controlPoints.push(t),this.controlPoints.push(t),this.isFirstPoint=!1,[];if(this.controlPoints.push(t),this.controlPoints.length<4)return[];const r=this.controlPoints[0],n=this.controlPoints[1],s=this.controlPoints[2],a=this.controlPoints[3],i=this.processSegment(r,n,s,a);return this.controlPoints.shift(),i}endStroke(){if(this.controlPoints.length<2)return[];const t=[];for(;this.controlPoints.length>=3;){const r=this.controlPoints[0],n=this.controlPoints[1],s=this.controlPoints[2],a=s,i=this.processSegment(r,n,s,a);t.push(...i),this.controlPoints.shift()}if(!this.hasProcessedSegment&&this.controlPoints.length>=2){const r=this.controlPoints[1],n=this.processSegment(r,r,r,r);t.push(...n)}return t}processSegment(t,r,n,s){this.hasProcessedSegment=!0;const a=[],i=Math.hypot(n.x-r.x,n.y-r.y),o=Math.max(5,Math.ceil(i));for(let c=0;c<o;c++){const h=c/o;a.push(df(t,r,n,s,h))}a.push(n);const{points:l,remainder:u}=Ku(a,this.spacing,this.remainder);return this.remainder=u,l}}function Xr(e,t){const n=1+(1-t)*.5;return e*n}function An(e,t,r){return r<=0?0:e*t/r}const bv=af(function(e,t){try{const r=JSON.stringify(t);pf(e,r)}catch(r){console.error("Failed to save brush to cache:",r)}},300);function Tv(e){try{const t=hf(e);return t?JSON.parse(t):null}catch(t){return console.error("Failed to load brush from cache:",t),null}}function $v(e){const t=Je(),r=Hu();let n=null,s=null,a=null,i=null,o=null,l=null,u=null,c=null,h=null,f=null,d=0;const p=S(!1),g=new nf({maxSize:20});function z(T,b,P,E){const D=`${T}_${b}_${P}_${E}`;if(g.has(D))return g.get(D);const W=Math.ceil(T*2),F=document.createElement("canvas"),Z=F.getContext("2d");F.width=W,F.height=W;const ee=W/2,oe=W/2,he=T*b,K=Z.createImageData(W,W),te=K.data,{r:Ke,g:Ye,b:Pr}=ha(P),ri=T-he;for(let Dr=0;Dr<W;Dr++){const ys=Dr+.5-oe;for(let jr=0;jr<W;jr++){const ni=jr+.5-ee,bn=(Dr*W+jr)*4,gs=Math.max(Math.abs(ni),Math.abs(ys));let si=0;if(gs<=he)si=E;else if(gs<=T){const np=(gs-he)/ri;si=E*Math.pow(1-np,2)}te[bn]=Ke,te[bn+1]=Ye,te[bn+2]=Pr,te[bn+3]=si*255}}return Z.putImageData(K,0,0),g.set(D,F),F}const M=S(!1),A=S(!1),ne=S(null),X=S(0),j=S(new Date),V=S(!0),G=S({minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0});function N(){G.value={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Q(T,b,P){G.value.minX=Math.min(G.value.minX,T-P-2),G.value.minY=Math.min(G.value.minY,b-P-2),G.value.maxX=Math.max(G.value.maxX,T+P+2),G.value.maxY=Math.max(G.value.maxY,b+P+2)}let ue=null;const pe=S(null),Oe=S((e==null?void 0:e.useDominantAxis)??!1),ke=S((e==null?void 0:e.brushAdjustmentSpeed)??1),qe=Tv("maskeditor_brush_settings");qe&&(t.setBrushSize(qe.size),t.setBrushOpacity(qe.opacity),t.setBrushHardness(qe.hardness),t.brushSettings.type=qe.type,t.setBrushStepSize(qe.stepSize??5)),$r(()=>t.clearTrigger,()=>{xn()}),$r(()=>t.canvasHistory.currentStateIndex,async()=>{p.value||(await _t(),i&&o&&i.clearPreview(o))}),up(()=>{i&&(i.destroy(),i=null),n&&(n.destroy(),n=null),s&&(s.destroy(),s=null),u&&(u.destroy(),u=null),c&&(c.destroy(),c=null),h&&(h.destroy(),h=null),f&&(f.destroy(),f=null)});async function mt(){if(t.tgpuRoot){a=t.tgpuRoot.device;return}try{const T=await hs.init();t.tgpuRoot=T,a=T.device,console.warn(" TypeGPU initialized! Root:",T),console.warn("Device info:",T.device.limits)}catch(T){console.warn("Failed to initialize TypeGPU:",T.message)}}function $t(T){for(let b=0;b<T.length;b+=4){const P=T[b+3]/255;T[b]=Math.round(T[b]*P),T[b+1]=Math.round(T[b+1]*P),T[b+2]=Math.round(T[b+2]*P)}}async function _t(){if(!a||!n||!s||!t.maskCanvas||!t.rgbCtx)return;const T=t.maskCanvas.width,b=t.maskCanvas.height,P=t.maskCtx.getImageData(0,0,T,b);$t(P.data),a.queue.writeTexture({texture:n},P.data,{bytesPerRow:T*4},{width:T,height:b});const E=t.rgbCtx.getImageData(0,0,T,b);$t(E.data),a.queue.writeTexture({texture:s},E.data,{bytesPerRow:T*4},{width:T,height:b})}async function ps(){if(await mt(),!t.tgpuRoot||!a){console.warn("TypeGPU not initialized, skipping GPU resource setup");return}if(!t.maskCanvas||!t.rgbCanvas||!t.maskCtx||!t.rgbCtx){console.warn("Canvas contexts not ready, skipping GPU resource setup");return}const T=t.maskCanvas.width,b=t.maskCanvas.height;try{console.warn(` Initializing GPU resources for ${T}x${b} canvas`),n=(globalThis.__TYPEGPU_AUTONAME__??(E=>E))(a.createTexture({size:[T,b],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC}),"maskTexture"),s=(globalThis.__TYPEGPU_AUTONAME__??(E=>E))(a.createTexture({size:[T,b],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC}),"rgbTexture"),await _t(),console.warn(" GPU resources initialized successfully");const P=navigator.gpu.getPreferredCanvasFormat();i=new vv(a,P),console.warn(" Brush renderer initialized")}catch(P){console.error("Failed to initialize GPU resources:",P),n=null,s=null}}function Nt(T,b){const P=t.brushSettings,E=t.maskCtx,D=t.rgbCtx;if(!E||!D)throw new Error("Canvas contexts are required");const W=P.type,F=P.size,Z=P.hardness,ee=b??P.opacity,oe=E.globalCompositeOperation==="destination-out",he=t.currentTool;if(t.activeLayer==="rgb"&&he&&(he===ae.Eraser||he===ae.PaintPen)){const Ye=Xr(F,Z),Pr=An(F,Z,Ye);fs(D,T,W,Ye,Pr,ee);return}const te=Xr(F,Z),Ke=An(F,Z,te);ds(E,T,W,te,Ke,ee,oe),Q(T.x,T.y,te)}function fs(T,b,P,E,D,W){const{x:F,y:Z}=b,ee=t.rgbColor;if(P===nt.Rect&&D<1){const he=J(ee,W),K=z(E,D,he,W);T.drawImage(K,F-E,Z-E),Q(F,Z,E);return}if(D===1){const he=J(ee,W);T.fillStyle=he,C(T,P,F,Z,E),Q(F,Z,E);return}const oe=ce(T,F,Z,E,D,ee,W,!1);T.fillStyle=oe,C(T,P,F,Z,E),Q(F,Z,E)}function ds(T,b,P,E,D,W,F){const{x:Z,y:ee}=b,oe=t.maskColor;if(P===nt.Rect&&D<1){const te=F?`rgba(255, 255, 255, ${W})`:`rgba(${oe.r}, ${oe.g}, ${oe.b}, ${W})`,Ke=z(E,D,te,W);T.drawImage(Ke,Z-E,ee-E),Q(Z,ee,E);return}if(D===1){T.fillStyle=F?`rgba(255, 255, 255, ${W})`:`rgba(${oe.r}, ${oe.g}, ${oe.b}, ${W})`,C(T,P,Z,ee,E),Q(Z,ee,E);return}const he=`rgb(${oe.r}, ${oe.g}, ${oe.b})`,K=ce(T,Z,ee,E,D,he,W,F);T.fillStyle=K,C(T,P,Z,ee,E),Q(Z,ee,E)}function C(T,b,P,E,D){T.beginPath(),b===nt.Rect?T.rect(P-D,E-D,D*2,D*2):T.arc(P,E,D,0,Math.PI*2,!1),T.fill()}function J(T,b){const{r:P,g:E,b:D}=Wu(T);return`rgba(${P}, ${E}, ${D}, ${b})`}function ce(T,b,P,E,D,W,F,Z){if(!Number.isFinite(b)||!Number.isFinite(P)||!Number.isFinite(E))return T.createRadialGradient(0,0,0,0,0,0);const ee=T.createRadialGradient(b,P,0,b,P,E);if(Z)ee.addColorStop(0,`rgba(255, 255, 255, ${F})`),ee.addColorStop(D,`rgba(255, 255, 255, ${F})`),ee.addColorStop(1,"rgba(255, 255, 255, 0)");else{const{r:oe,g:he,b:K}=ha(W);ee.addColorStop(0,`rgba(${oe}, ${he}, ${K}, ${F})`),ee.addColorStop(D,`rgba(${oe}, ${he}, ${K}, ${F})`),ee.addColorStop(1,`rgba(${oe}, ${he}, ${K}, 0)`)}return ee}async function Le(T){if(!ue)return;const b=ue.addPoint(T);if(b.length===0){i&&V.value&&kr([],!0);return}if(i)kr(b,!0);else for(const P of b)Nt(P);V.value=!1}function We(T){const b=t.maskBlendMode,P=t.maskCtx,E=t.rgbCtx;if(!P||!E)throw new Error("Canvas contexts are required");P.beginPath(),E.beginPath(),T===At.SourceOver?(P.fillStyle=b,P.globalCompositeOperation=At.SourceOver,E.globalCompositeOperation=At.SourceOver):T===At.DestinationOut&&(P.globalCompositeOperation=At.DestinationOut,E.globalCompositeOperation=At.DestinationOut)}async function Ge(T,b,P,E){const{points:D,remainder:W}=Ku([T,b],E,X.value);if(X.value=W,We(P),i)kr(D);else for(const F of D)Nt(F,1)}async function rt(T){M.value=!0,N();try{i&&t.maskCanvas&&i.prepareStroke(t.maskCanvas.width,t.maskCanvas.height);let b;const P=t.currentTool,E={x:T.offsetX,y:T.offsetY},D=r.screenToCanvas(E);P==="eraser"||T.buttons===2?b=At.DestinationOut:b=At.SourceOver;const W=t.brushSettings.stepSize/100,F=Math.max(1,t.brushSettings.size*W);if(T.shiftKey&&ne.value?(A.value=!0,await Ge(ne.value,D,b,F)):(A.value=!1,We(b),X.value=F),ne.value=D,i){const Z=t.activeLayer==="rgb";Z&&t.rgbCanvas?(t.rgbCanvas.style.opacity="0",l&&(l.style.opacity="1")):!Z&&t.maskCanvas&&(t.maskCanvas.style.opacity="0",l&&(l.style.opacity=String(t.maskOpacity)))}ue=new xv(F),await Le(D),j.value=new Date}catch(b){console.error("[useBrushDrawing] Failed to start drawing:",b),M.value=!1,A.value=!1}}async function at(T){const b=performance.now()-j.value.getTime(),P={x:T.offsetX,y:T.offsetY},E=r.screenToCanvas(P),D=t.currentTool;b>20&&!M.value?requestAnimationFrame(async()=>{if(M.value)try{We(At.SourceOver),await ms(E)}catch(W){console.error("[useBrushDrawing] Drawing error:",W)}}):requestAnimationFrame(async()=>{if(M.value)try{D==="eraser"||T.buttons===2?We(At.DestinationOut):We(At.SourceOver),await Le(E)}catch(W){console.error("[useBrushDrawing] Drawing error:",W)}}),j.value=new Date}async function lt(T){var E;const b={x:T.offsetX,y:T.offsetY},P=r.screenToCanvas(b);if(M.value){if(M.value=!1,ne.value=P,V.value=!0,ue){const F=ue.endStroke();if(F.length>0)if(i)kr(F,!0);else for(const Z of F)Nt(Z);ue=null}if(i&&n&&s){const Z=t.activeLayer==="rgb"?s:n,ee=t.brushSettings.size,oe=t.brushSettings.hardness,he=Xr(ee,oe),K=An(ee,oe,he),te=t.currentTool==="eraser"||((E=t.maskCtx)==null?void 0:E.globalCompositeOperation)==="destination-out",Ke=t.brushSettings.type===nt.Rect?1:0;i.compositeStroke(Z.createView(),{opacity:t.brushSettings.opacity,color:[0,0,0],hardness:K,screenSize:[t.maskCanvas.width,t.maskCanvas.height],brushShape:Ke,isErasing:te})}let D,W;if(i&&n&&s)try{const F=await gt();D=F.maskData,W=F.rgbData}catch(F){console.warn("GPU readback failed, falling back to CPU:",F)}p.value=!0,t.canvasHistory.saveState(D,W),await cp(),p.value=!1,i&&o&&i.clearPreview(o),t.activeLayer==="rgb"&&t.rgbCanvas?t.rgbCanvas.style.opacity="1":t.activeLayer==="mask"&&t.maskCanvas&&(t.maskCanvas.style.opacity=String(t.maskOpacity)),l&&(l.style.opacity="1")}}async function Et(T){T.preventDefault();const b={x:T.offsetX,y:T.offsetY},P=r.screenToCanvas(b);t.brushPreviewGradientVisible=!0,pe.value=P}async function yt(T){if(!pe.value)return;const b={x:T.offsetX,y:T.offsetY},P=5,E=r.screenToCanvas(b),D=E.x-pe.value.x,W=E.y-pe.value.y,F=Math.abs(D)<P?0:D,Z=Math.abs(W)<P?0:W;let ee=F,oe=Z;if(Oe.value){const Ye=Math.abs(F)/Math.abs(Z),Pr=2;Ye>Pr?oe=0:Ye<1/Pr&&(ee=0)}const he=Math.max(-100,Math.min(100,ee)),K=Math.max(-100,Math.min(100,oe)),te=Math.max(1,Math.min(500,t.brushSettings.size+he/35*ke.value)),Ke=Math.max(0,Math.min(1,t.brushSettings.hardness-K/4e3*ke.value));t.setBrushSize(te),t.setBrushHardness(Ke)}function it(){bv("maskeditor_brush_settings",t.brushSettings)}async function gt(){if(!a||!n||!s||!t.maskCanvas||!t.rgbCanvas||!t.maskCtx||!t.rgbCtx||!i)throw new Error("GPU resources not ready");const T=t.maskCanvas.width,b=t.maskCanvas.height,P=T*b*4;(!u||!c||!h||!f||d!==P)&&(u==null||u.destroy(),c==null||c.destroy(),h==null||h.destroy(),f==null||f.destroy(),u=(globalThis.__TYPEGPU_AUTONAME__??(te=>te))(a.createBuffer({size:P,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),"readbackStorageMask"),c=(globalThis.__TYPEGPU_AUTONAME__??(te=>te))(a.createBuffer({size:P,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),"readbackStorageRgb"),h=(globalThis.__TYPEGPU_AUTONAME__??(te=>te))(a.createBuffer({size:P,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),"readbackStagingMask"),f=(globalThis.__TYPEGPU_AUTONAME__??(te=>te))(a.createBuffer({size:P,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),"readbackStagingRgb"),d=P),i.prepareReadback(n,u),i.prepareReadback(s,c);const E=a.createCommandEncoder();E.copyBufferToBuffer(u,0,h,0,P),E.copyBufferToBuffer(c,0,f,0,P),a.queue.submit([E.finish()]),await Promise.all([h.mapAsync(GPUMapMode.READ),f.mapAsync(GPUMapMode.READ)]);const D=new Uint8ClampedArray(h.getMappedRange().slice(0)),W=new Uint8ClampedArray(f.getMappedRange().slice(0));h.unmap(),f.unmap();const F=new ImageData(D,T,b),Z=new ImageData(W,T,b);let ee=0,oe=0,he=T,K=b;if(G.value.minX!==1/0&&G.value.maxX!==-1/0){const te=G.value;ee=Math.floor(Math.max(0,te.minX)),oe=Math.floor(Math.max(0,te.minY));const Ke=Math.ceil(Math.min(T,te.maxX)),Ye=Math.ceil(Math.min(b,te.maxY));he=Ke-ee,K=Ye-oe}return he>0&&K>0?(t.maskCtx.putImageData(F,0,0,ee,oe,he,K),t.rgbCtx.putImageData(Z,0,0,ee,oe,he,K)):(t.maskCtx.putImageData(F,0,0),t.rgbCtx.putImageData(Z,0,0)),{maskData:F,rgbData:Z}}function Ut(){i==null||i.destroy(),n&&(n.destroy(),n=null),s&&(s.destroy(),s=null),u==null||u.destroy(),c==null||c.destroy(),h==null||h.destroy(),f==null||f.destroy(),u=null,c=null,h=null,f=null,d=0,t.tgpuRoot&&(t.tgpuRoot.destroy(),t.tgpuRoot=null),a=null}async function ms(T,b=1){var P;if(i){const E=t.maskCanvas.width,D=t.maskCanvas.height,W=[{x:T.x,y:T.y,pressure:b}],F=t.brushSettings.size,Z=t.brushSettings.hardness,ee=Xr(F,Z),oe=An(F,Z,ee),he=t.brushSettings.type===nt.Rect?1:0;if(i.renderStrokeToAccumulator(W,{size:ee,opacity:.5,hardness:oe,color:[1,1,1],width:E,height:D,brushShape:he}),n&&o){const K=t.activeLayer==="rgb";let te=[1,1,1];if(K){const Ye=ha(t.rgbColor);te=[Ye.r/255,Ye.g/255,Ye.b/255]}else{const Ye=t.maskColor;te=[Ye.r/255,Ye.g/255,Ye.b/255]}const Ke=t.currentTool==="eraser"||((P=t.maskCtx)==null?void 0:P.globalCompositeOperation)==="destination-out";i.blitToCanvas(o,{opacity:t.brushSettings.opacity,color:te,hardness:oe,screenSize:[E,D],brushShape:he,isErasing:Ke},void 0)}}else Nt(T,b)}function vn(T){if(!a)return;const b=T.getContext("webgpu");b&&(b.configure({device:a,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"premultiplied"}),o=b,l=T,console.warn(" Preview Canvas Initialized"))}function kr(T,b=!1){var he;if(!i||!n||!s)return;const P=t.activeLayer==="rgb";let E=[1,1,1];if(P){const K=ha(t.rgbColor);E=[K.r/255,K.g/255,K.b/255]}else{const K=t.maskColor;E=[K.r/255,K.g/255,K.b/255]}let D=[];if(b)D=T.map(K=>({x:K.x,y:K.y,pressure:1}));else for(let K=0;K<T.length-1;K++){const te=T[K],Ke=T[K+1],Ye=Math.hypot(Ke.x-te.x,Ke.y-te.y),Pr=t.brushSettings.stepSize/100,ri=Math.max(1,t.brushSettings.size*Pr),Dr=Math.max(1,Math.ceil(Ye/ri));for(let ys=0;ys<=Dr;ys++){const jr=ys/Dr,ni=1,bn=te.x+(Ke.x-te.x)*jr,gs=te.y+(Ke.y-te.y)*jr;D.push({x:bn,y:gs,pressure:ni})}}const W=t.brushSettings.size,F=t.brushSettings.hardness,Z=Xr(W,F),ee=An(W,F,Z),oe=t.brushSettings.type===nt.Rect?1:0;i.renderStrokeToAccumulator(D,{size:Z,opacity:.5,hardness:ee,color:E,width:t.maskCanvas.width,height:t.maskCanvas.height,brushShape:oe});for(const K of D)Q(K.x,K.y,Z);if(o){const K=t.currentTool==="eraser"||((he=t.maskCtx)==null?void 0:he.globalCompositeOperation)==="destination-out",te=P?s:n;i.blitToCanvas(o,{opacity:t.brushSettings.opacity,color:E,hardness:ee,screenSize:[t.maskCanvas.width,t.maskCanvas.height],brushShape:oe,isErasing:K},te??void 0)}}function xn(){if(!a||!n||!s||!t.maskCanvas)return;const T=t.maskCanvas.width,b=t.maskCanvas.height;a.queue.writeTexture({texture:n},new Uint8Array(T*b*4),{bytesPerRow:T*4},{width:T,height:b}),a.queue.writeTexture({texture:s},new Uint8Array(T*b*4),{bytesPerRow:T*4},{width:T,height:b})}return{startDrawing:rt,handleDrawing:at,drawEnd:lt,startBrushAdjustment:Et,handleBrushAdjustment:yt,saveBrushSettings:it,destroy:Ut,initGPUResources:ps,initPreviewCanvas:vn,clearGPU:xn}}const ba=(e,t,r,n)=>e[(r*n+t)*4+3],Ts=(e,t,r,n)=>{const s=(r*n+t)*4;return{r:e[s],g:e[s+1],b:e[s+2]}},mi=(e,t,r,n,s,a)=>{const i=(r*n+t)*4;e[i]=a.r,e[i+1]=a.g,e[i+2]=a.b,e[i+3]=s},Sl=(e,t,r)=>{e/=255,t/=255,r/=255;const n=Math.max(e,t,r),s=Math.min(e,t,r);let a=0,i=0;const o=(n+s)/2;if(n!==s){const l=n-s;switch(i=o>.5?l/(2-n-s):l/(n+s),n){case e:a=(t-r)/l+(t<r?6:0);break;case t:a=(r-e)/l+2;break;case r:a=(e-t)/l+4;break}a/=6}return{h:a*360,s:i*100,l:o*100}},Ml=e=>{let t=e.r/255,r=e.g/255,n=e.b/255;t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,t*=100,r*=100,n*=100;const s=t*.4124+r*.3576+n*.1805,a=t*.2126+r*.7152+n*.0722,i=t*.0193+r*.1192+n*.9505,c=[s/95.047,a/100,i/108.883];for(let h=0;h<c.length;h++)c[h]=c[h]>.008856?Math.pow(c[h],1/3):7.787*c[h]+16/116;return{l:116*c[1]-16,a:500*(c[0]-c[1]),b:200*(c[1]-c[2])}},kl=(e,t,r)=>Math.sqrt(Math.pow(e.r-t.r,2)+Math.pow(e.g-t.g,2)+Math.pow(e.b-t.b,2))<=r,_v=(e,t,r)=>{const n=Sl(e.r,e.g,e.b),s=Sl(t.r,t.g,t.b),a=Math.abs(n.h-s.h),i=Math.abs(n.s-s.s),o=Math.abs(n.l-s.l);return Math.sqrt(Math.pow(a/360*255,2)+Math.pow(i/100*255,2)+Math.pow(o/100*255,2))<=r},zv=(e,t,r)=>{const n=Ml(e),s=Ml(t);return Math.sqrt(Math.pow(n.l-s.l,2)+Math.pow(n.a-s.a,2)+Math.pow(n.b-s.b,2))/100*255<=r},yi=(e,t,r,n)=>{switch(n){case on.Simple:return kl(e,t,r);case on.HSL:return _v(e,t,r);case on.LAB:return zv(e,t,r);default:return kl(e,t,r)}};function Sv(){const e=Je(),t=S(null),r=o=>{const l=e.maskCtx,u=e.maskCanvas;if(!l||!u)return;const c=Math.floor(o.x),h=Math.floor(o.y),f=u.width,d=u.height;if(c<0||c>=f||h<0||h>=d)return;const p=l.getImageData(0,0,f,d),g=p.data,z=ba(g,c,h,f),M=z!==255;if(z===-1)return;const A=e.maskColor,ne=e.paintBucketTolerance,X=Math.floor(e.fillOpacity/100*255),j=[],V=new Uint8Array(f*d),G=(N,Q,ue,pe)=>N===-1?!1:pe?N!==255&&Math.abs(N-Q)<=ue:N===255||Math.abs(N-Q)<=ue;for(G(z,z,ne,M)&&j.push([c,h]);j.length>0;){const[N,Q]=j.pop(),ue=Q*f+N;if(V[ue])continue;const pe=ba(g,N,Q,f);if(!G(pe,z,ne,M))continue;V[ue]=1,mi(g,N,Q,f,M?X:0,A);const Oe=(ke,qe)=>{if(!(ke<0||ke>=f||qe<0||qe>=d)&&!V[qe*f+ke]){const mt=ba(g,ke,qe,f);G(mt,z,ne,M)&&j.push([ke,qe])}};Oe(N-1,Q),Oe(N+1,Q),Oe(N,Q-1),Oe(N,Q+1)}l.putImageData(p,0,0),e.canvasHistory.saveState()},n=async o=>{const l=e.maskCtx,u=e.imgCtx,c=e.imgCanvas;if(!l||!u||!c)return;const h=c.width,f=c.height;t.value=o;const d=l.getImageData(0,0,h,f),p=d.data,g=u.getImageData(0,0,h,f).data,z=e.colorSelectTolerance,M=e.colorComparisonMethod,A=e.maskColor,ne=Math.floor(e.selectionOpacity/100*255),X=e.applyWholeImage,j=e.maskBoundary,V=e.maskTolerance;if(X){const G=Ts(g,Math.floor(o.x),Math.floor(o.y),h),N=1e4;for(let Q=0;Q<h*f;Q+=N){const ue=Math.min(Q+N,h*f);for(let pe=Q;pe<ue;pe++){const Oe=pe%h,ke=Math.floor(pe/h);yi(Ts(g,Oe,ke,h),G,z,M)&&mi(p,Oe,ke,h,ne,A)}await new Promise(pe=>setTimeout(pe,0))}}else{const G=Math.floor(o.x),N=Math.floor(o.y);if(G<0||G>=h||N<0||N>=f)return;const Q=Ts(g,G,N,h),ue=[],pe=new Uint8Array(h*f);for(ue.push([G,N]);ue.length>0;){const[Oe,ke]=ue.pop(),qe=ke*h+Oe;if(pe[qe]||!yi(Ts(g,Oe,ke,h),Q,z,M))continue;pe[qe]=1,mi(p,Oe,ke,h,ne,A);const mt=($t,_t)=>{$t<0||$t>=h||_t<0||_t>=f||pe[_t*h+$t]||yi(Ts(g,$t,_t,h),Q,z,M)&&(j&&255-ba(p,$t,_t,h)<=V||ue.push([$t,_t]))};mt(Oe-1,ke),mt(Oe+1,ke),mt(Oe,ke-1),mt(Oe,ke+1)}}l.putImageData(d,0,0),e.canvasHistory.saveState()},s=()=>{const o=e.maskCtx,l=e.maskCanvas;if(!o||!l)return;const u=o.getImageData(0,0,l.width,l.height),c=u.data;let h=0,f=0,d=0;for(let p=0;p<c.length;p+=4)if(c[p+3]>0){h=c[p],f=c[p+1],d=c[p+2];break}for(let p=0;p<c.length;p+=4){const g=c[p+3];c[p+3]=255-g,g===0&&(c[p]=h,c[p+1]=f,c[p+2]=d)}o.putImageData(u,0,0),e.canvasHistory.saveState()},a=()=>{const o=e.maskCtx,l=e.maskCanvas,u=e.rgbCtx,c=e.rgbCanvas;o&&l&&o.clearRect(0,0,l.width,l.height),u&&c&&u.clearRect(0,0,c.width,c.height),e.canvasHistory.saveState()},i=()=>{t.value=null};return $r([()=>e.colorSelectTolerance,()=>e.colorComparisonMethod,()=>e.selectionOpacity],async()=>{t.value&&e.colorSelectLivePreview&&e.canUndo&&(e.canvasHistory.undo(),await n(t.value))}),{paintBucketFill:r,colorSelectFill:n,clearLastColorSelectPoint:i,invertMask:s,clearMask:a}}function Mv(e,t){const r=Je(),n=Hu(),s=$v({useDominantAxis:ln.extensionManager.setting.get("Comfy.MaskEditor.UseDominantAxis"),brushAdjustmentSpeed:ln.extensionManager.setting.get("Comfy.MaskEditor.BrushAdjustmentSpeed")}),a=Sv(),i=S(null),o={[ae.MaskPen]:{newActiveLayerOnSet:"mask"},[ae.Eraser]:{},[ae.PaintPen]:{newActiveLayerOnSet:"rgb"},[ae.MaskBucket]:{cursor:"url('/cursor/paintBucket.png') 30 25, auto",newActiveLayerOnSet:"mask"},[ae.MaskColorFill]:{cursor:"url('/cursor/colorSelect.png') 15 25, auto",newActiveLayerOnSet:"mask"}},l=p=>{r.activeLayer=p;const g=r.currentTool;[ae.MaskPen,ae.MaskBucket,ae.MaskColorFill].includes(g)&&p==="rgb"&&u(ae.PaintPen),g===ae.PaintPen&&p==="mask"&&u(ae.MaskPen)},u=p=>{r.currentTool=p;const g=o[p].newActiveLayerOnSet;g&&(r.activeLayer=g);const z=o[p].cursor,M=r.pointerZone;z&&M?(r.brushVisible=!1,M.style.cursor=z):M&&(r.brushVisible=!0,M.style.cursor="none")},c=()=>{const p=r.currentTool,g=o[p].cursor,z=r.pointerZone;g&&z?(r.brushVisible=!1,z.style.cursor=g):z&&(r.brushVisible=!0,z.style.cursor="none"),r.brushPreviewGradientVisible=!1};return $r(()=>r.currentTool,p=>{p!==ae.MaskColorFill&&a.clearLastColorSelectPoint()}),{switchTool:u,setActiveLayer:l,updateCursor:c,handlePointerDown:async p=>{if(p.preventDefault(),p.pointerType==="touch")return;const g=e.isKeyDown(" ");if(p.buttons===4||p.buttons===1&&g){t.handlePanStart(p),r.brushVisible=!1;return}if(r.currentTool===ae.PaintPen&&p.button===0){await s.startDrawing(p);return}if(r.currentTool===ae.PaintPen&&p.buttons===1){await s.handleDrawing(p);return}if(r.currentTool===ae.MaskBucket&&p.button===0){const M={x:p.offsetX,y:p.offsetY},A=n.screenToCanvas(M);a.paintBucketFill(A);return}if(r.currentTool===ae.MaskColorFill&&p.button===0){const M={x:p.offsetX,y:p.offsetY},A=n.screenToCanvas(M);await a.colorSelectFill(A);return}if(p.altKey&&p.button===2){r.isAdjustingBrush=!0,await s.startBrushAdjustment(p);return}const z=[ae.MaskPen,ae.Eraser,ae.PaintPen].includes(r.currentTool);if([0,2].includes(p.button)&&z){await s.startDrawing(p);return}},handlePointerMove:async p=>{if(p.preventDefault(),p.pointerType==="touch")return;const g={x:p.clientX,y:p.clientY};t.updateCursorPosition(g);const z=e.isKeyDown(" ");if(p.buttons===4||p.buttons===1&&z){await t.handlePanMove(p);return}if([ae.MaskPen,ae.Eraser,ae.PaintPen].includes(r.currentTool)){if(r.isAdjustingBrush&&(r.currentTool===ae.MaskPen||r.currentTool===ae.Eraser)&&p.altKey&&p.buttons===2){await s.handleBrushAdjustment(p);return}if(p.buttons===1||p.buttons===2){await s.handleDrawing(p);return}}},handlePointerUp:async p=>{r.isPanning=!1,r.brushVisible=!0,p.pointerType!=="touch"&&(c(),r.isAdjustingBrush=!1,await s.drawEnd(p),i.value=null)},brushDrawing:s}}const kv=Na("dialog",()=>{const e=S([]),t=S(null),r=()=>`dialog-${Math.random().toString(36).slice(2,9)}`;function n(h){const f=e.value.findIndex(d=>d.priority<=h.priority);e.value.splice(f===-1?e.value.length:f,0,h)}function s(h){const f=h.key,d=e.value.findIndex(p=>p.key===f);if(d!==-1){const[p]=e.value.splice(d,1);n(p),t.value=f,o()}}function a(h){var p,g;const f=h?e.value.find(z=>z.key===h.key):e.value.find(z=>z.key===t.value);if(!f)return;(g=(p=f.dialogComponentProps)==null?void 0:p.onClose)==null||g.call(p);const d=e.value.indexOf(f);e.value.splice(d,1),t.value=e.value.length>0?e.value[e.value.length-1].key:null,o()}function i(h){var d;e.value.length>=10&&e.value.shift();const f={key:h.key,visible:!0,title:h.title,headerComponent:h.headerComponent?ii(h.headerComponent):void 0,footerComponent:h.footerComponent?ii(h.footerComponent):void 0,component:ii(h.component),contentProps:{...h.props},footerProps:{...h.footerProps},priority:h.priority??1,dialogComponentProps:{maximizable:!1,modal:!0,closable:!0,closeOnEscape:!0,dismissableMask:!0,...h.dialogComponentProps,maximized:!1,onMaximize:()=>{f.dialogComponentProps.maximized=!0},onUnmaximize:()=>{f.dialogComponentProps.maximized=!1},onAfterHide:()=>{a(f)},pt:uf(((d=h.dialogComponentProps)==null?void 0:d.pt)||{},{root:{onMousedown:()=>{s(f)}}})}};return n(f),t.value=h.key,o(),f}function o(){const h=e.value.find(d=>d.key===t.value),f=h==null?void 0:h.dialogComponentProps.closable;e.value.forEach(d=>{d.dialogComponentProps={...d.dialogComponentProps,closeOnEscape:d===h&&!!f}})}function l(h){const f=h.key||r();let d=e.value.find(p=>p.key===f);return d?(d.visible=!0,s(d)):d=i({...h,key:f}),d}function u(h){const{key:f}=h;if(!f){console.error("Extension dialog key is required");return}const d=f.startsWith("extension-")?f:`extension-${f}`,p=e.value.find(g=>g.key===d);return p?(p.visible=!0,s(p),p):i({...h,key:d})}function c(h){return e.value.some(f=>f.key===h)}return{dialogStack:e,riseDialog:s,showDialog:l,closeDialog:a,showExtensionDialog:u,isDialogOpen:c,activeKey:t}}),Pv=Tt({__name:"BrushCursor",props:{containerRef:{}},setup(e){const t=Je(),r=Ee(()=>t.brushVisible?1:0),n=Ee(()=>{const c=t.brushSettings.size,h=t.brushSettings.hardness;return Xr(c,h)*t.zoomRatio}),s=Ee(()=>n.value*2),a=Ee(()=>{var f;const c=(f=e.containerRef)==null?void 0:f.getBoundingClientRect(),h=(c==null?void 0:c.left)||0;return t.cursorPoint.x+t.panOffset.x-n.value-h}),i=Ee(()=>{var f;const c=(f=e.containerRef)==null?void 0:f.getBoundingClientRect(),h=(c==null?void 0:c.top)||0;return t.cursorPoint.y+t.panOffset.y-n.value-h}),o=Ee(()=>t.brushSettings.type===nt.Rect?"0%":"50%"),l=Ee(()=>t.brushPreviewGradientVisible),u=Ee(()=>{const c=t.brushSettings.size,h=t.brushSettings.hardness,f=Xr(c,h),d=An(c,h,f);if(d===1)return"rgba(255, 0, 0, 0.5)";const p=d*100,g=100,z=p+(g-p)*.5;return`radial-gradient(
    circle,
    rgba(255, 0, 0, 0.5) 0%,
    rgba(255, 0, 0, 0.5) ${p}%,
    rgba(255, 0, 0, 0.125) ${z}%,
    rgba(255, 0, 0, 0) ${g}%
  )`});return(c,h)=>(ze(),Xe("div",{id:"maskEditor_brush",style:Cr({position:"absolute",opacity:r.value,width:`${s.value}px`,height:`${s.value}px`,left:`${a.value}px`,top:`${i.value}px`,borderRadius:o.value,pointerEvents:"none",zIndex:1e3})},[R("div",{id:"maskEditor_brushPreviewGradient",style:Cr({display:l.value?"block":"none",background:u.value})},null,4)],4))}}),Bv=Tt({__name:"PointerZone",props:{toolManager:{},panZoom:{}},setup(e){const t=Je(),r=S();qi(()=>{if(!r.value){console.error("[PointerZone] Pointer zone ref not initialized");return}t.pointerZone=r.value}),$r(()=>t.isPanning,f=>{r.value&&(f?r.value.style.cursor="grabbing":e.toolManager.updateCursor())});const n=async f=>{await e.toolManager.handlePointerDown(f)},s=async f=>{await e.toolManager.handlePointerMove(f)},a=f=>{e.toolManager.handlePointerUp(f)},i=()=>{t.brushVisible=!1,r.value&&(r.value.style.cursor="")},o=()=>{e.toolManager.updateCursor()},l=f=>{e.panZoom.handleTouchStart(f)},u=async f=>{await e.panZoom.handleTouchMove(f)},c=f=>{e.panZoom.handleTouchEnd(f)},h=async f=>{await e.panZoom.zoom(f);const d={x:f.clientX,y:f.clientY};e.panZoom.updateCursorPosition(d)};return(f,d)=>(ze(),Xe("div",{ref_key:"pointerZoneRef",ref:r,class:"w-[calc(100%-4rem-220px)] h-full",onPointerdown:n,onPointermove:s,onPointerup:a,onPointerleave:i,onPointerenter:o,onTouchstart:l,onTouchmove:u,onTouchend:c,onWheel:h,onContextmenu:d[0]||(d[0]=Rn(()=>{},["prevent"]))},null,544))}}),Iv={"g.save":"Save","g.saving":"Saving...","g.cancel":"Cancel","g.undo":"Undo","g.redo":"Redo","maskeditor.invert":"Invert","maskeditor.clear":"Clear"};function de(e){return Iv[e]||e}const Ev={class:"flex flex-col gap-3 pb-3"},Uv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Vv=["min","max","step","value"],ur=Tt({__name:"SliderControl",props:{label:{},min:{},max:{},step:{default:1},modelValue:{}},emits:["update:modelValue"],setup(e,{emit:t}){const r=t,n=s=>{const a=Number(s.target.value);r("update:modelValue",a)};return(s,a)=>(ze(),Xe("div",Ev,[R("span",Uv,Ce(e.label),1),R("input",{type:"range",class:"maskEditor_sidePanelBrushRange",min:e.min,max:e.max,step:e.step,value:e.modelValue,onInput:n},null,40,Vv)]))}}),Cv={class:"flex flex-col gap-3 pb-3"},Rv={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},Av={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Ov={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] -mt-2 -mb-1.5"},Fv=["value"],Lv={value:"black"},Gv={value:"white"},Dv={value:"negative"},jv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Nv=["checked"],qv={class:"maskEditor_sidePanelLayerPreviewContainer"},Wv={viewBox:"0 0 20 20",style:{}},Yv=["disabled"],Zv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Xv=["checked"],Hv=["disabled"],Kv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Qv={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]"},Jv=["checked"],ex={class:"maskEditor_sidePanelLayerPreviewContainer"},tx=["src","alt"],rx=Tt({__name:"ImageLayerSettingsPanel",props:{toolManager:{}},setup(e){const t=Je(),r=qu(),n=S(!0),s=S(!0),a=S(!0),i=Ee(()=>{var p;return((p=t.image)==null?void 0:p.src)??""}),o=Ee(()=>t.currentTool===ae.Eraser),l=p=>{const g=p.target.checked;n.value=g;const z=t.maskCanvas;z&&(z.style.opacity=g?String(t.maskOpacity):"0")},u=p=>{const g=p.target.checked;s.value=g;const z=t.rgbCanvas;z&&(z.style.opacity=g?"1":"0")},c=p=>{const g=p.target.checked;a.value=g;const z=t.imgCanvas;z&&(z.style.opacity=g?"1":"0")},h=p=>{t.setMaskOpacity(p);const g=t.maskCanvas;g&&(g.style.opacity=String(p)),n.value=p!==0},f=async p=>{const g=p.target.value;let z;switch(g){case"white":z=Mt.White;break;case"negative":z=Mt.Negative;break;default:z=Mt.Black}t.maskBlendMode=z,await r.updateMaskColor()},d=p=>{var g;(g=e.toolManager)==null||g.setActiveLayer(p)};return(p,g)=>(ze(),Xe("div",Cv,[R("h3",Rv,Ce(I(de)("maskEditor.layers")),1),ot(ur,{label:I(de)("maskEditor.maskOpacity"),min:0,max:1,step:.01,"model-value":I(t).maskOpacity,"onUpdate:modelValue":h},null,8,["label","model-value"]),R("span",Av,Ce(I(de)("maskEditor.maskBlendingOptions")),1),R("div",Ov,[R("select",{class:"maskEditor_sidePanelDropdown",value:I(t).maskBlendMode,onChange:f},[R("option",Lv,Ce(I(de)("maskEditor.black")),1),R("option",Gv,Ce(I(de)("maskEditor.white")),1),R("option",Dv,Ce(I(de)("maskEditor.negative")),1)],40,Fv)]),R("span",jv,Ce(I(de)("maskEditor.maskLayer")),1),R("div",{class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]",style:Cr({border:I(t).activeLayer==="mask"?"2px solid #007acc":"none"})},[R("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:n.value,onChange:l},null,40,Nv),R("div",qv,[(ze(),Xe("svg",Wv,[...g[2]||(g[2]=[R("path",{class:"cls-1",d:"M1.31,5.32v9.36c0,.55.45,1,1,1h15.38c.55,0,1-.45,1-1V5.32c0-.55-.45-1-1-1H2.31c-.55,0-1,.45-1,1ZM11.19,13.44c-2.91.94-5.57-1.72-4.63-4.63.34-1.05,1.19-1.9,2.24-2.24,2.91-.94,5.57,1.72,4.63,4.63-.34,1.05-1.19-1.9-2.24,2.24Z"},null,-1)])]))]),R("button",{style:Cr([{"font-size":"12px"},{opacity:I(t).activeLayer==="mask"?"0.5":"1"}]),disabled:I(t).activeLayer==="mask",onClick:g[0]||(g[0]=z=>d("mask"))},Ce(I(de)("maskEditor.activateLayer")),13,Yv)],4),R("span",Zv,Ce(I(de)("maskEditor.paintLayer")),1),R("div",{class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]",style:Cr({border:I(t).activeLayer==="rgb"?"2px solid #007acc":"none"})},[R("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:s.value,onChange:u},null,40,Xv),g[3]||(g[3]=R("div",{class:"maskEditor_sidePanelLayerPreviewContainer"},[R("svg",{viewBox:"0 0 20 20"},[R("path",{class:"cls-1",d:"M 17 6.965 c 0 0.235 -0.095 0.47 -0.275 0.655 l -6.51 6.52 c -0.045 0.035 -0.09 0.075 -0.135 0.11 c -0.035 -0.695 -0.605 -1.24 -1.305 -1.245 c 0.035 -0.06 0.08 -0.12 0.135 -0.17 l 6.52 -6.52 c 0.36 -0.36 0.945 -0.36 1.3 0 c 0.175 0.175 0.275 0.415 0.275 0.65 Z"}),R("path",{class:"cls-1",d:"M 9.82 14.515 c 0 2.23 -3.23 1.59 -4.82 0 c 1.65 -0.235 2.375 -1.29 3.53 -1.29 c 0.715 0 1.29 0.58 1.29 1.29 Z"})])],-1)),R("button",{style:Cr([{"font-size":"12px"},{opacity:I(t).activeLayer==="rgb"?"0.5":"1",display:o.value?"block":"none"}]),disabled:I(t).activeLayer==="rgb",onClick:g[1]||(g[1]=z=>d("rgb"))},Ce(I(de)("maskEditor.activateLayer")),13,Hv)],4),R("span",Kv,Ce(I(de)("maskEditor.baseImageLayer")),1),R("div",Qv,[R("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:a.value,onChange:c},null,40,Jv),R("div",ex,[R("img",{class:"maskEditor_sidePanelImageLayerImage",src:i.value,alt:I(de)("maskEditor.baseLayerPreview")},null,8,tx)])])]))}}),nx={class:"flex flex-col gap-3 pb-3"},sx={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},ax={class:"flex flex-col gap-3 pb-3"},ix={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},ox={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]"},lx={class:"flex flex-col gap-3 pb-3"},ux={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},cx=["value"],hx=Tt({__name:"BrushSettingsPanel",setup(e){const t=Je(),r=u=>{t.brushSettings.type=u},n=u=>{t.rgbColor=u.target.value},s=u=>{t.setBrushSize(u)},a=u=>{t.setBrushOpacity(u)},i=u=>{t.setBrushHardness(u)},o=u=>{t.setBrushStepSize(u)},l=()=>{t.resetBrushToDefault()};return(u,c)=>(ze(),Xe("div",nx,[R("h3",sx,Ce(I(de)("maskEditor.brushSettings")),1),R("button",{class:"w-45 h-7.5 border-none bg-black/20 border border-[var(--border-color)] text-[var(--input-text)] font-sans text-[15px] pointer-events-auto transition-colors duration-100 hover:bg-[var(--p-overlaybadge-outline-color)] hover:border-none",onClick:l},Ce(I(de)("maskEditor.resetToDefault")),1),R("div",ax,[R("span",ix,Ce(I(de)("maskEditor.brushShape")),1),R("div",ox,[R("div",{class:Ba(["maskEditor_sidePanelBrushShapeCircle bg-transparent hover:bg-[var(--comfy-menu-bg)] dark-theme:hover:bg-[var(--p-surface-900)]",{active:I(t).brushSettings.type===I(nt).Arc}]),style:Cr({background:I(t).brushSettings.type===I(nt).Arc?"var(--p-button-text-primary-color)":""}),onClick:c[0]||(c[0]=h=>r(I(nt).Arc))},null,6),R("div",{class:Ba(["maskEditor_sidePanelBrushShapeSquare bg-transparent hover:bg-[var(--comfy-menu-bg)] dark-theme:hover:bg-[var(--p-surface-900)]",{active:I(t).brushSettings.type===I(nt).Rect}]),style:Cr({background:I(t).brushSettings.type===I(nt).Rect?"var(--p-button-text-primary-color)":""}),onClick:c[1]||(c[1]=h=>r(I(nt).Rect))},null,6)])]),R("div",lx,[R("span",ux,Ce(I(de)("maskEditor.colorSelector")),1),R("input",{type:"color",value:I(t).rgbColor,onInput:n},null,40,cx)]),ot(ur,{label:I(de)("maskEditor.thickness"),min:1,max:500,step:1,"model-value":I(t).brushSettings.size,"onUpdate:modelValue":s},null,8,["label","model-value"]),ot(ur,{label:I(de)("maskEditor.opacity"),min:0,max:1,step:.01,"model-value":I(t).brushSettings.opacity,"onUpdate:modelValue":a},null,8,["label","model-value"]),ot(ur,{label:I(de)("maskEditor.hardness"),min:0,max:1,step:.01,"model-value":I(t).brushSettings.hardness,"onUpdate:modelValue":i},null,8,["label","model-value"]),ot(ur,{label:"Stepsize",min:1,max:100,step:1,"model-value":I(t).brushSettings.stepSize,"onUpdate:modelValue":o},null,8,["model-value"])]))}}),px={class:"flex flex-row gap-2.5 items-center min-h-6 relative"},fx={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},dx=["value"],mx=["value"],yx=Tt({__name:"DropdownControl",props:{label:{},options:{},modelValue:{}},emits:["update:modelValue"],setup(e,{emit:t}){const r=e,n=t,s=Ee(()=>r.options.map(i=>typeof i=="string"?{label:i,value:i}:i)),a=i=>{const o=i.target.value;n("update:modelValue",o)};return(i,o)=>(ze(),Xe("div",px,[R("span",fx,Ce(e.label),1),R("select",{class:"absolute right-0 h-6 px-1.5 rounded-md border border-[var(--p-form-field-border-color)] transition-colors duration-100 bg-[var(--comfy-menu-bg)] focus:outline focus:outline-1 focus:outline-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-900)] dark-theme:focus:outline-[var(--p-button-text-primary-color)]",value:e.modelValue,onChange:a},[(ze(!0),Xe(Ru,null,Au(s.value,l=>(ze(),Xe("option",{key:l.value,value:l.value},Ce(l.label),9,mx))),128))],40,dx)]))}}),gx={class:"flex flex-row gap-2.5 items-center min-h-6 relative"},wx={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},vx={class:"maskEditor_sidePanelToggleContainer"},xx=["checked"],gi=Tt({__name:"ToggleControl",props:{label:{},modelValue:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const r=t,n=s=>{const a=s.target.checked;r("update:modelValue",a)};return(s,a)=>(ze(),Xe("div",gx,[R("span",wx,Ce(e.label),1),R("label",vx,[R("input",{type:"checkbox",class:"maskEditor_sidePanelToggleCheckbox",checked:e.modelValue,onChange:n},null,40,xx),a[0]||(a[0]=R("div",{class:"maskEditor_sidePanelToggleSwitch"},null,-1))])]))}}),bx={class:"flex flex-col gap-3 pb-3"},Tx={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},$x=Tt({__name:"ColorSelectSettingsPanel",setup(e){const t=Je(),r=Object.values(on),n=c=>{t.setColorSelectTolerance(c)},s=c=>{t.setSelectionOpacity(c)},a=c=>{t.colorSelectLivePreview=c},i=c=>{t.applyWholeImage=c},o=c=>{t.colorComparisonMethod=c},l=c=>{t.maskBoundary=c},u=c=>{t.setMaskTolerance(c)};return(c,h)=>(ze(),Xe("div",bx,[R("h3",Tx,Ce(I(de)("maskEditor.colorSelectSettings")),1),ot(ur,{label:I(de)("maskEditor.tolerance"),min:0,max:255,step:1,"model-value":I(t).colorSelectTolerance,"onUpdate:modelValue":n},null,8,["label","model-value"]),ot(ur,{label:I(de)("maskEditor.selectionOpacity"),min:0,max:100,step:1,"model-value":I(t).selectionOpacity,"onUpdate:modelValue":s},null,8,["label","model-value"]),ot(gi,{label:I(de)("maskEditor.livePreview"),"model-value":I(t).colorSelectLivePreview,"onUpdate:modelValue":a},null,8,["label","model-value"]),ot(gi,{label:I(de)("maskEditor.applyToWholeImage"),"model-value":I(t).applyWholeImage,"onUpdate:modelValue":i},null,8,["label","model-value"]),ot(yx,{label:I(de)("maskEditor.method"),options:I(r),"model-value":I(t).colorComparisonMethod,"onUpdate:modelValue":o},null,8,["label","options","model-value"]),ot(gi,{label:I(de)("maskEditor.stopAtMask"),"model-value":I(t).maskBoundary,"onUpdate:modelValue":l},null,8,["label","model-value"]),ot(ur,{label:I(de)("maskEditor.maskTolerance"),min:0,max:255,step:1,"model-value":I(t).maskTolerance,"onUpdate:modelValue":u},null,8,["label","model-value"])]))}}),_x={class:"flex flex-col gap-3 pb-3"},zx={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},Sx=Tt({__name:"PaintBucketSettingsPanel",setup(e){const t=Je(),r=s=>{t.setPaintBucketTolerance(s)},n=s=>{t.setFillOpacity(s)};return(s,a)=>(ze(),Xe("div",_x,[R("h3",zx,Ce(I(de)("maskEditor.paintBucketSettings")),1),ot(ur,{label:I(de)("maskEditor.tolerance"),min:0,max:255,step:1,"model-value":I(t).paintBucketTolerance,"onUpdate:modelValue":r},null,8,["label","model-value"]),ot(ur,{label:I(de)("maskEditor.fillOpacity"),min:0,max:100,step:1,"model-value":I(t).fillOpacity,"onUpdate:modelValue":n},null,8,["label","model-value"])]))}}),Mx={class:"maskEditor_sidePanel"},kx={class:"maskEditor_sidePanelContainer"},Px=Tt({__name:"SettingsPanelContainer",setup(e){const t=Ee(()=>{const r=Je().currentTool;return r===ae.MaskBucket?Sx:r===ae.MaskColorFill?$x:hx});return(r,n)=>(ze(),Xe("div",Mx,[R("div",kx,[(ze(),On(hp(t.value)))])]))}}),Bx={class:"flex flex-col gap-3 pb-3 h-full !items-stretch bg-[var(--comfy-menu-bg)] overflow-y-auto w-55 px-2.5"},Ix={class:"w-full min-h-full"},Ex=Tt({__name:"SidePanel",props:{toolManager:{}},setup(e){return(t,r)=>(ze(),Xe("div",Bx,[R("div",Ix,[ot(Px),r[0]||(r[0]=R("div",{class:"w-full h-0.5 bg-[var(--border-color)] mt-6 mb-1.5"},null,-1)),ot(rx,{"tool-manager":e.toolManager},null,8,["tool-manager"])])]))}}),Ux={[ae.MaskPen]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M10.97,15.98v14.04c0,.825.675,1.5,1.5,1.5h23.07c.825,0,1.5-.675,1.5-1.5V15.98c0-.825-.675-1.5-1.5-1.5H12.47c-.825,0-1.5.675-1.5,1.5ZM25.79,28.16c-4.365,1.41-8.355-2.58-6.945-6.945.51-1.575,1.785-2.85,3.36-3.36,4.365-1.41,8.355,2.58,6.945,6.945-.51,1.575-1.785,2.85-3.36,3.36Z"/>
    </svg>
  `,[ae.Eraser]:`
    <svg viewBox="0 0 44 44">
      <g>
        <rect class="cls-2" x="16.68" y="10" width="10.63" height="24" rx="1.16" ry="1.16" transform="translate(22 -9.11) rotate(45)"/>
        <path class="cls-1" d="M17.27,34.27c-.42,0-.85-.16-1.17-.48l-5.88-5.88c-.31-.31-.48-.73-.48-1.17s.17-.86.48-1.17l15.34-15.34c.62-.62,1.72-.62,2.34,0l5.88,5.88c.65.65.65,1.7,0,2.34l-15.34,15.34c-.32.32-.75.48-1.17.48ZM26.73,10.73c-.18,0-.34.07-.46.19l-15.34,15.34c-.12.12-.19.29-.19.46s.07.34.19.46l5.88,5.88c.26.26.67.26.93,0l15.34-15.34c.26-.26.26-.67,0-.93l-5.88-5.88c-.12-.12-.29-.19-.46-.19Z"/>
      </g>
      <path class="cls-3" d="M20.33,11.03h8.32c.64,0,1.16.52,1.16,1.16v15.79h-10.63v-15.79c0-.64.52-1.16,1.16-1.16Z" transform="translate(20.97 -11.61) rotate(45)"/>
    </svg>
  `,[ae.MaskBucket]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M33.4,21.76l-11.42,11.41-.04.05c-.61.61-1.6.61-2.21,0l-8.91-8.91c-.61-.61-.61-1.6,0-2.21l.04-.05.3-.29h22.24Z"/>
      <path class="cls-1" d="M20.83,34.17c-.55,0-1.07-.21-1.46-.6l-8.91-8.91c-.8-.8-.8-2.11,0-2.92l11.31-11.31c.8-.8,2.11-.8,2.92,0l8.91,8.91c.39.39.6.91.6,1.46s-.21,1.07-.6,1.46l-11.31,11.31c-.39.39-.91.6-1.46.6ZM23.24,10.83c-.27,0-.54.1-.75.31l-11.31,11.31c-.41.41-.41,1.09,0,1.5l8.91,8.91c.4.4,1.1.4,1.5,0l11.31-11.31c.2-.2.31-.47.31-.75s-.11-.55-.31-.75l-8.91-8.91c-.21-.21-.48-.31-.75-.31Z"/>
      <path class="cls-1" d="M34.28,26.85c0,.84-.68,1.52-1.52,1.52s-1.52-.68-1.52-1.52,1.52-2.86,1.52-2.86c0,0,1.52,2.02,1.52,2.86Z"/>
    </svg>
  `,[ae.MaskColorFill]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M30.29,13.72c-1.09-1.1-2.85-1.09-3.94,0l-2.88,2.88-.75-.75c-.2-.19-.51-.19-.71,0-.19.2-.19.51,0,.71l1.4,1.4-9.59,9.59c-.35.36-.54.82-.54,1.32,0,.14,0,.28.05.41-.05.04-.1.08-.15.13-.39.39-.39,1.01,0,1.4.38.39,1.01.39,1.4,0,.04-.04.08-.09.11-.13.14.04.3.06.45.06.5,0,.97-.19,1.32-.55l9.59-9.59,1.38,1.38c.1.09.22.14.35.14s.26-.05.35-.14c.2-.2.2-.52,0-.71l-.71-.72,2.88-2.89c1.08-1.08,1.08-2.85-.01-3.94ZM19.43,25.82h-2.46l7.15-7.15,1.23,1.23-5.92,5.92Z"/>
    </svg>
  `,[ae.PaintPen]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M34,13.93c0,.47-.19.94-.55,1.31l-13.02,13.04c-.09.07-.18.15-.27.22-.07-1.39-1.21-2.48-2.61-2.49.07-.12.16-.24.27-.34l13.04-13.04c.72-.72,1.89-.72,2.6,0,.35.35.55.83.55,1.3Z"/>
      <path class="cls-1" d="M19.64,29.03c0,4.46-6.46,3.18-9.64,0,3.3-.47,4.75-2.58,7.06-2.58,1.43,0,2.58,1.16,2.58,2.58Z"/>
    </svg>
  `},Vx={class:"h-full z-[8888] flex flex-col justify-between bg-[var(--comfy-menu-bg)]"},Cx={class:"flex flex-col"},Rx=["onClick"],Ax=["innerHTML"],Ox=["title"],Fx={class:"text-sm text-[var(--p-button-text-secondary-color)]"},Lx={class:"text-xs text-[var(--p-button-text-secondary-color)]"},Gx=Tt({__name:"ToolPanel",props:{toolManager:{}},setup(e){const t=Je(),r=o=>{e.toolManager.switchTool(o)},n=Ee(()=>t.currentTool),s=Ee(()=>`${Math.round(t.displayZoomRatio*100)}%`),a=Ee(()=>{const o=t.image;return o?`${o.width}x${o.height}`:" "}),i=()=>{t.resetZoom()};return(o,l)=>(ze(),Xe("div",Vx,[R("div",Cx,[(ze(!0),Xe(Ru,null,Au(I(Gp),u=>(ze(),Xe("div",{key:u,class:Ba(["maskEditor_toolPanelContainer hover:bg-[var(--p-surface-300)] dark-theme:hover:bg-[var(--p-surface-800)]",{maskEditor_toolPanelContainerSelected:n.value===u}]),onClick:c=>r(u)},[R("div",{class:"flex items-center justify-center",innerHTML:I(Ux)[u]},null,8,Ax),l[0]||(l[0]=R("div",{class:"maskEditor_toolPanelIndicator"},null,-1))],10,Rx))),128))]),R("div",{class:"flex flex-col items-center cursor-pointer rounded-md mb-2 transition-colors duration-200 hover:bg-[var(--p-surface-300)] dark-theme:hover:bg-[var(--p-surface-800)]",title:I(de)("maskEditor.clickToResetZoom"),onClick:i},[R("span",Fx,Ce(s.value),1),R("span",Lx,Ce(a.value),1)],8,Ox)]))}}),Dx={class:"maskEditor-ui-container flex min-h-0 flex-1 flex-col"},jx={class:"flex min-h-0 flex-1 overflow-hidden"},Nx=Tt({__name:"MaskEditorContent",props:{node:{}},setup(e){const t=Je(),r=Zi(),n=kv(),s=Qp(),a=S(),i=S(),o=S(),l=S(),u=S(),c=S(),h=S(),f=S(),d=S(),p=S(!1),g=Wp(),z=Jp(),M=Mv(g,z);let A=null;const ne=j=>{j.ctrlKey&&j.preventDefault()},X=async()=>{var j,V;if(!a.value){console.error("[MaskEditorContent] Cannot initialize - missing required refs");return}if(!o.value||!l.value||!u.value||!i.value||!h.value){console.error("[MaskEditorContent] Cannot initialize - missing canvas refs");return}t.maskCanvas=l.value,t.rgbCanvas=u.value,t.imgCanvas=o.value,t.canvasContainer=i.value,t.canvasBackground=h.value;try{await s.loadFromNode(e.node);const N=await qp().loadImages();await z.initializeCanvasPanZoom(N,a.value,(j=f.value)==null?void 0:j.$el,(V=d.value)==null?void 0:V.$el),t.canvasHistory.saveInitialState(),M.brushDrawing&&(await M.brushDrawing.initGPUResources(),c.value&&M.brushDrawing.initPreviewCanvas&&(c.value.width=l.value.width,c.value.height=l.value.height,M.brushDrawing.initPreviewCanvas(c.value))),p.value=!0}catch(G){console.error("[MaskEditorContent] Initialization failed:",G),n.closeDialog()}};return qi(()=>{g.addListeners(),a.value&&(A=new ResizeObserver(async()=>{z&&await z.invalidatePanZoom()}),A.observe(a.value)),X()}),pp(()=>{M.brushDrawing.saveBrushSettings(),g==null||g.removeListeners(),A&&(A.disconnect(),A=null),t.canvasHistory.clearStates(),t.resetState(),r.reset()}),(j,V)=>(ze(),Xe("div",{ref_key:"containerRef",ref:a,class:"maskEditor-dialog-root flex h-full w-full flex-col",onContextmenu:V[4]||(V[4]=Rn(()=>{},["prevent"])),onDragstart:ne},[R("div",{id:"maskEditorCanvasContainer",ref_key:"canvasContainerRef",ref:i,onContextmenu:V[3]||(V[3]=Rn(()=>{},["prevent"]))},[R("canvas",{ref_key:"imgCanvasRef",ref:o,class:"absolute top-0 left-0 w-full h-full z-0",onContextmenu:V[0]||(V[0]=Rn(()=>{},["prevent"]))},null,544),R("canvas",{ref_key:"rgbCanvasRef",ref:u,class:"absolute top-0 left-0 w-full h-full z-10",onContextmenu:V[1]||(V[1]=Rn(()=>{},["prevent"]))},null,544),R("canvas",{ref_key:"maskCanvasRef",ref:l,class:"absolute top-0 left-0 w-full h-full z-30",onContextmenu:V[2]||(V[2]=Rn(()=>{},["prevent"]))},null,544),R("canvas",{ref_key:"gpuCanvasRef",ref:c,class:Ba(["absolute top-0 left-0 w-full h-full pointer-events-none",{"z-20":I(t).activeLayer==="rgb","z-40":I(t).activeLayer==="mask"}])},null,2),R("div",{ref_key:"canvasBackgroundRef",ref:h,class:"bg-white w-full h-full"},null,512)],544),R("div",Dx,[R("div",jx,[p.value?(ze(),On(Gx,{key:0,ref_key:"toolPanelRef",ref:f,"tool-manager":I(M)},null,8,["tool-manager"])):$s("",!0),p.value?(ze(),On(Bv,{key:1,"tool-manager":I(M),"pan-zoom":I(z)},null,8,["tool-manager","pan-zoom"])):$s("",!0),p.value?(ze(),On(Ex,{key:2,ref_key:"sidePanelRef",ref:d,"tool-manager":I(M)},null,8,["tool-manager"])):$s("",!0)])]),p.value?(ze(),On(Pv,{key:0,"container-ref":a.value},null,8,["container-ref"])):$s("",!0)],544))}}),qx=fp(Nx,[["__scopeId","data-v-6c02c403"]]),Wx={class:"mask-editor-app"},Yx=Tt({__name:"MaskEditorApp",props:{nodeData:{}},setup(e){const t=e,r=S(null);return qi(()=>{t.nodeData&&(r.value=t.nodeData)}),(n,s)=>(ze(),Xe("div",Wx,[r.value?(ze(),On(qx,{key:0,node:r.value},null,8,["node"])):$s("",!0)]))}});function Zx(e,t={}){const r=dp(Yx,{nodeData:t.nodeData,...t.props}),n=mp();return r.use(n),r.mount(e),r}window.createMaskEditorApp=Zx;
